System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:Qe,CCClass:Wt,CacheMode:void 0,DebugMode:void 0,Enum:Ze,Eventify:cn,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:yw,WorldNode3DToWorldNodeUI:Sw,absMax:Xn,absMaxComponent:jn,approx:Pn,assert:m,assertID:P,bezier:yf,bezierByTime:Ff,ccenum:et,clamp:In,clamp01:On,color:Qn,computeRatioByType:VF,createDefaultPipeline:BO,debug:v,deserialize:Eh,earcut:hQ,enumerableProps:qn,equals:Rn,error:d,errorID:C,find:bI,fragmentText:hV,getBaselineOffset:function(){return 0},getError:I,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[nl]},getWorldTransformUntilRoot:function(e,t,n){for(_i.identity(n);e!==t;)_i.fromRTS(vk,e.rotation,e.position,e.scale),_i.multiply(n,vk,n),e=e.parent;return n},instantiate:Uh,inverseLerp:Wn,isCustomTargetModifier:Ak,isDisplayStats:O,isElementModifier:xk,isPropertyModifier:Ek,isUnicodeCJK:sV,isUnicodeSpace:cV,isValid:$t,lerp:Dn,log:f,logID:E,markAsWarning:void 0,mat4:di,murmurhash2_32_gc:xa,nextPow2:Gn,pingPong:Vn,pseudoRandom:zn,pseudoRandomRange:Un,pseudoRandomRangeInt:kn,quat:ui,randomRange:Bn,randomRangeInt:Fn,rect:Ci,removeProperty:void 0,repeat:Hn,replaceProperty:void 0,safeMeasureText:lV,sampleAnimationCurve:HF,setDefaultLogTimes:function(e){e>0&&(En=e)},setDisplayStats:D,size:Ai,toDegree:Mn,toRadian:Nn,tween:Nte,tweenUtil:Mte,v2:yi,v3:ei,v4:Ti,warn:p,warnID:A});var n="undefined"==typeof window?global:window,i=e("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!1,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0;var r=e("VERSION","3.3.1");n.CocosEngine=i.ENGINE_VERSION=r,n.cc=i;var o="https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md",a=null,s=console.log.bind(console),c=s,l=s,u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+_.apply(void 0,[t].concat(i)))}},h=s;function _(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return i.js.formatStr.apply(null,[e].concat(n))}function f(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return s.apply(void 0,[e].concat(n))}function p(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return c.apply(void 0,[e].concat(n))}function d(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.apply(void 0,[e].concat(n))}function m(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return u.apply(void 0,[e,t].concat(i))}function v(){return h.apply(void 0,arguments)}function g(e){if(s=c=l=u=h=function(){},e!==w.NONE){if(e>w.ERROR){var t=function(e){if(i.game.canvas){if(!a){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",i.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(a=document.createElement("textarea")).setAttribute("rows","20"),a.setAttribute("cols","30"),a.setAttribute("disabled","true");var r=a.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",t.appendChild(a),i.game.canvas.parentNode.appendChild(t)}a.value=a.value+e+"\r\n",a.scrollTop=a.scrollHeight}};l=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+_.apply(void 0,[e].concat(i)))},u=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+_.apply(void 0,[n].concat(r)))}},e!==w.ERROR_FOR_WEB_PAGE&&(c=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+_.apply(void 0,[e].concat(i)))}),e===w.INFO_FOR_WEB_PAGE&&(s=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(_.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=_.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==w.ERROR&&(c=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e===w.INFO&&(s=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=w.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);h=function(){return n.apply(void 0,arguments)}}}}function y(e){d(e.stack||e)}function S(e){return function(t){for(var n=e+" "+t+", please go to "+o+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var T=S("Log");function E(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];f(T.apply(void 0,[e].concat(n)))}var x=S("Warning");function A(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];p(x.apply(void 0,[e].concat(n)))}var b=S("Error");function C(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];d(b.apply(void 0,[e].concat(n)))}var w,R=S("Assert");function P(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];m(!1,R.apply(void 0,[t].concat(i)))}}function I(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return b.apply(void 0,[e].concat(n))}function O(){return!!i.profiler&&i.profiler.isShowingStats()}function D(e){i.profiler&&(e?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(w||(w=e("DebugMode",{})));var N,M,L,B,F,z=Object.freeze({__proto__:null,log:f,warn:p,error:d,assert:m,debug:v,_resetDebugSetting:g,_throw:y,logID:E,warnID:A,errorID:C,assertID:P,get DebugMode(){return w},getError:I,isDisplayStats:O,setDisplayStats:D});function U(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function k(e,t,n){return t&&U(e.prototype,t),n&&U(e,n),e}function G(){return(G=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function H(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,W(e,t)}function V(e){return(V=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function W(e,t){return(W=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function j(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function X(e,t,n){return(X=j()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&W(r,n.prototype),r}).apply(null,arguments)}function q(e){var t="function"==typeof Map?new Map:void 0;return(q=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return X(e,arguments,V(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),W(i,e)})(e)}function Y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function K(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Q(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return K(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?K(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function Z(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function J(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(N||(N={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(M||(M={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(L||(L={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(B||(B={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(F||(F={}));var $=e("Pool",function(){function e(e,t){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=e,this._elementsPerBatch=Math.max(t,1),this._nextAvail=this._elementsPerBatch-1;for(var n=0;n<this._elementsPerBatch;++n)this._freepool.push(e())}var t=e.prototype;return t.alloc=function(){if(this._nextAvail<0){for(var e=this._elementsPerBatch,t=0;t<e;t++)this._freepool.push(this._ctor());this._nextAvail=e-1}var n=this._freepool[this._nextAvail--];return this._freepool.length--,n},t.free=function(e){this._freepool.push(e),this._nextAvail++},t.freeArray=function(e){Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},t.destroy=function(e){if(e)for(var t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1},e}()),ee=e("RecyclePool",function(){function e(e,t){this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var n=0;n<t;++n)this._data[n]=e()}var t=e.prototype;return t.reset=function(){this._count=0},t.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},t.add=function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]},t.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},k(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),te=e("CachedArray",function(){function e(e,t){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(e),this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}var t=e.prototype;return t.push=function(e){this.array[this.length++]=e},t.pop=function(){return this.array[--this.length]},t.get=function(e){return this.array[e]},t.clear=function(){this.length=0},t.destroy=function(){this.length=0,this.array.length=0},t.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},t.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},t.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},t.indexOf=function(e){return this.array.indexOf(e)},e}());e("memop",Object.freeze({__proto__:null,Pool:$,RecyclePool:ee,CachedArray:te}));var ne=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},k(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ie(e,t){e.splice(t,1)}function re(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function oe(e,t){var n=e.indexOf(t);return n>=0&&(ie(e,n),!0)}function ae(e,t){return e.indexOf(t)>=0}var se=Object.freeze({__proto__:null,removeAt:ie,fastRemoveAt:re,remove:oe,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ie(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=Q(e);!(n=i()).done;)if(!(n.value instanceof t))return E(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)oe(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:ae,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:ne}),ce=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();ce.global=new ce("global");var le=new ce("TmpCId."),ue="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),he="__cid__";function _e(e){return"number"==typeof e||e instanceof Number}function fe(e){return"string"==typeof e||e instanceof String}function pe(e){for(var t in e)return!1;return!0}var de,me=(de={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){de.value=n,de.writable=i,de.enumerable=r,Object.defineProperty(e,t,de),de.value=void 0}),ve=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),ge=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),ye=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function Se(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Te(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Te(e.constructor):""}function Ee(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?ve(e,o,s,(function(e){this[a]=e})):ge(e,o,s)}function xe(e,t,n,i){for(var r in n)Ee(e,t+"."+r,n[r],i)}var Ae=/(%d)|(%s)/,be=/%s/;function Ce(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&Ae.test(e);if(r)for(var o,a=Q(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Ae:be;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=Q(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function we(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Re(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Pe(e,t,n){var i=Re(t,e);i&&Object.defineProperty(n,e,i)}function Ie(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){C(5402,a);continue}for(var s in a)s in e||Pe(s,a,e)}}return e}function Oe(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){C(5403,a);continue}for(var s in a)Pe(s,a,e)}}return e}function De(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ne(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Me(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ne(e)))return!1;if(e===t)return!0}}return!1}function Le(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Be=Se(!0),Fe=Se(!0);function ze(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],me(i.prototype,e,n),n){var r=t[n];r&&r!==i?d("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Ue=ze("__cid__",Be),ke=ze("__classname__",Fe);function Ge(e,t){if(ke(e,t),!t.prototype.hasOwnProperty(he)){var n=e||le.getNewId();n&&Ue(n,t)}}function He(e,t){var n=Fe[t],i=Be[t],r=!0;if(n&&n!==e&&(d('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(d('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ue];o||(o=[],e[ue]=o),o.push(t),Fe[t]=e,Be[t]=e}}function Ve(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Be[s];var c=a.__classname__;c&&delete Fe[c];var l=a[ue];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Fe[h],delete Be[h]}}}function We(e){return Be[e]}function je(e){return Fe[e]}function Xe(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(he))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(he))return e.__cid__}return""}var qe=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),Ye=se,Ke={IDGenerator:ce,Pool:qe,array:se,isNumber:_e,isString:fe,isEmptyObject:pe,getPropertyDescriptor:Re,addon:Ie,mixin:Oe,extend:De,getSuper:Ne,isChildClassOf:Me,clear:Le,value:me,getset:ve,get:ge,set:ye,unregisterClass:Ve,getClassName:Te,setClassName:Ge,setClassAlias:He,getClassByName:je,get _registeredClassNames(){return G({},Fe)},set _registeredClassNames(e){Le(Fe),Object.assign(Fe,e)},get _registeredClassIds(){return G({},Be)},set _registeredClassIds(e){Le(Be),Object.assign(Be,e)},_getClassId:Xe,_setClassId:Ue,_getClassById:We,obsolete:Ee,obsoletes:xe,formatStr:Ce,shiftArguments:we,createMap:Se};function Qe(e){if("__bitmask__"in e)return e;me(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&me(e,a,r)}return e}function Ze(e){return"__enums__"in e?e:(me(e,"__enums__",null,!0),Ze.update(e))}function Je(e){e.hasOwnProperty("__enums__")}function $e(e){Je(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function et(e){"__enums__"in e||me(e,"__enums__",null,!0)}i.js=Ke,e("js",Object.freeze({__proto__:null,array:Ye,js:Ke,IDGenerator:ce,Pool:qe,isNumber:_e,isString:fe,isEmptyObject:pe,value:me,getset:ve,get:ge,set:ye,createMap:Se,getClassName:Te,obsolete:Ee,obsoletes:xe,formatStr:Ce,shiftArguments:we,getPropertyDescriptor:Re,addon:Ie,mixin:Oe,extend:De,getSuper:Ne,isChildClassOf:Me,clear:Le,_idToClass:Be,_nameToClass:Fe,_setClassId:Ue,setClassName:Ge,setClassAlias:He,unregisterClass:Ve,_getClassById:We,getClassByName:je,_getClassId:Xe})),Qe.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Qe.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},i.BitMask=Qe,Ze.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&me(e,a,r)}return Array.isArray(e.__enums__)&&$e(e),e},Ze||(Ze=e("Enum",{})),Ze.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Ze.getList=function(e){return Je(e),e.__enums__?e.__enums__:$e(e)},i.Enum=Ze;var tt=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return C(100,Te(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){C(100,Te(this)+".set")},t.toString=function(){return""+{}},e}());Ge("cc.ValueType",tt),i.ValueType=tt;var nt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});i.macro=nt;for(var it=/^(?:cc|dragonBones|sp|ccsg)\..+/,rt=new Array(123),ot=0;ot<123;++ot)rt[ot]=64;for(var at=0;at<64;++at)rt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(at)]=at;var st=rt;function ct(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];ve(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function lt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function ut(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function ht(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function _t(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ft(e){return!(!e||e.constructor!==Object)&&pe(e)}function pt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function dt(e){return e*nt.RAD}function mt(e){return e*nt.DEG}i.misc={BUILTIN_CLASSID_RE:it,BASE64_VALUES:st,propertyDefine:ct,pushToMap:lt,contains:ut,isDomNode:ht,callInNextTick:_t,isPlainEmptyObj_DEV:ft,clampf:pt,degreesToRadians:dt,radiansToDegrees:mt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:it,BASE64_VALUES:st,propertyDefine:ct,pushToMap:lt,contains:ut,isDomNode:ht,callInNextTick:_t,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ft,clampf:pt,degreesToRadians:dt,radiansToDegrees:mt}));var vt="$_$";function gt(e,t){var n=t?Object.create(t):{};return me(e,"__attrs__",n),n}function yt(e){if("function"!=typeof e)return gt(e,Tt(e.constructor));for(var t,n=i.Class.getInheritanceChain(e),r=n.length-1;r>=0;r--){var o=n[r];o.hasOwnProperty("__attrs__")&&o.__attrs__||gt(o,(t=n[r+1])&&t.__attrs__)}return gt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function St(e,t){var n=Tt(e),i=t+vt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function Tt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||yt(e)}function Et(e,t,n,i){Tt(e)[t+vt+n]=i}var xt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),At=e("CCInteger",new xt("Integer",0));i.Integer=At,i.CCInteger=At;var bt=e("CCFloat",new xt("Float",0));i.Float=bt,i.CCFloat=bt;var Ct=e("CCBoolean",new xt("Boolean",!1));i.Boolean=Ct,i.CCBoolean=Ct;var wt=e("CCString",new xt("String",""));function Rt(e,t){return function(n,i){var r='"'+Te(n)+"."+i+'"',o=St(n,i),a=o.type;if(a===At||a===bt?a="Number":a!==wt&&a!==Ct||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ft(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;A(3605,r,Te(o.ctor))}else"Number"!==e&&A(3606,t,r,e);else{if("function"===c)return;e===wt.default&&null==s?A(3607,r):A(3611,t,r,c)}delete o.type}}}else A(3604,r)}}i.String=wt,i.CCString=wt;var Pt=Object.freeze({__proto__:null,DELIMETER:vt,createAttrsSingle:gt,createAttrs:yt,attr:St,getClassAttrs:Tt,setClassAttr:Et,PrimitiveType:xt,CCInteger:At,CCFloat:bt,CCBoolean:Ct,CCString:wt,getTypeChecker_ET:Rt,getObjTypeChecker_ET:function(e){return function(t,n){Rt("Object","type")(t,n);var r=Tt(t)[n+vt+"default"],o=i.Class.getDefault(r);if(!Array.isArray(o)&&Me(e,i.ValueType)){var a=Te(e),s=Ce('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Te(t),n,a);r?f(s):A(3612,s,a,Te(t),n,a)}}}}),It={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ot(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,It){var s=It[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Dt(e,t,n,r){if(Array.isArray(t)){if(!(t.length>0))return C(5508,n,r);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=i.String:t===Boolean?e.type=i.Boolean:t===Number&&(e.type=i.Float))}function Nt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Mt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Nt(t,[],e);if("function"==typeof e){var n=e;return Nt(t,Me(n,i.ValueType)?new n:null,n)}return Nt(t,e instanceof xt?e.default:e)}return null}var Lt=[];function Bt(){return Lt[Lt.length-1]}i._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Lt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Lt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Bt};var Ft=vt,zt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Te(i);r?Vt(i,o,r,i.$super,n.mixins):C(3633,o)}this.datas=null}}};function Ut(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Xt(e,i,t,n)}function kt(e,t,n,i){var r=i.get;i.set,r&&(Xt(e,i,t,n),Et(e,n,"serializable",!1))}function Gt(e){return"function"==typeof e?e():e}function Ht(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Re(t,i))}function Vt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Mt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Ot(i,n,o,e),"type"in i&&Dt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?kt(e,t,s,c):Ut(e,t,s,c)}var l=Tt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Ft+"serializable"]}))}function Wt(e){var t=e.name,n=e.extends,r=e.mixins,o=function(e,t,n,r){var o=i.Component,a=Bt();if(a&&Me(t,o)){if(Me(a.cls,o))return C(3615),null;e=e||a.script}var s=function(e,t,n,i){var r=i.ctor,o=[r],a=r;me(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ht(s,l.prototype),Wt._isCCClass(l)&&Ht(Tt(a),Tt(l))}s.constructor=a}return Ge(e,a),a}(e,t,n,r);if(a)if(Me(t,o)){var c=a.uuid;c&&Ue(c,s),a.cls=s}else Me(a.cls,o)||(a.cls=s);return s}(t,n,r,e);t||(t=i.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var a=e.properties;"function"==typeof a||n&&null===n.__props__||r&&r.some((function(e){return null===e.__props__}))?(zt.push({cls:o,props:a,mixins:r}),o.__props__=o.__values__=null):Vt(o,t,a,n,e.mixins);var s=e.editor;return s&&Me(n,i.Component)&&i.Component._registerEditorProps(o,s),o}Wt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Wt.fastDefine=function(e,t,n){Ge(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=Tt(t),o=0;o<i.length;o++){var a=i[o];r[a+Ft+"visible"]=!1,r[a+Ft+"default"]=n[a]}},Wt.Attr=Pt,Wt.attr=St,Wt.getInheritanceChain=function(e){for(var t=[];e=Ne(e);)e!==Object&&t.push(e);return t};var jt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Xt(e,t,n,i){var r=null,o="";function a(){return o=i+Ft,r=Tt(e)}"type"in t&&void 0===t.type&&A(3660,i,n);var s=t.type;s&&(jt[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Ze.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Ze.getList(s)):Qe.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Qe.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__noImplicit?(r||a())[o+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Wt.isArray=function(e){return e=Gt(e),Array.isArray(e)},Wt.getDefault=Gt,Wt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Wt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Wt.getNewValueTypeCode=function(e){for(var t=Te(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},i.Class=Wt;var qt,Yt=e("editorExtrasTag","__editorExtras__"),Kt=1<<22,Qt=[],Zt=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=Qt.length,t=0;t<e;++t){var n=Qt[t];1&n._objFlags||n._destroyImmediate()}e===Qt.length?Qt.length=0:Qt.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(A(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Qt.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,r=e instanceof i._BaseNode||e instanceof i.Component,o=r?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===o)continue;switch(typeof e[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Wt._isCCClass(t))for(var s=i.Class.Attr.getClassAttrs(t),c=t.__props__,l=0;l<c.length;l++){var u=(n=c[l])+i.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(typeof s[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var _;_=Wt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Wt.escapeForJS(n)+"]=";var f=a[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,e),me(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?C(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},k(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&Kt)},set:function(e){e?this._objFlags|=Kt:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Jt=Zt.prototype;function $t(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Jt._deserialize=null,Jt._onPreDestroy=null,Wt.fastDefine("cc.Object",Zt,((qt={_name:"",_objFlags:0})[Yt]={},qt)),Wt.Attr.setClassAttr(Zt,Yt,"editorOnly",!0),me(Zt,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=$t,i.Object=Zt;var en=Ye.fastRemoveAt;function tn(){}var nn=function(){function e(){this.callback=tn,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||tn,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=tn,this.once=!1},t.check=function(){return!(this.target instanceof Zt&&!$t(this.target,!0))},e}(),rn=new $((function(){return new nn}),32),on=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),rn.free(n),en(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),rn.free(n),en(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:en(this.callbackInfos,e),rn.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),rn.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||en(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),an=new $((function(){return new on}),16),sn=function(){function e(){this._callbackTable=Se(!0)}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=an.alloc());var o=rn.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),an.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(i){var r=i.callbackInfos;if(t)for(var o=0;o<r.length;++o){var a=r[o];if(a&&a.callback===t&&a.target===n){i.cancel(o);break}}else this.removeAll(e)}},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),an.free(t),delete this._callbackTable[e])}},e}();function cn(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=Se(!0),t}H(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=sn.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var ln=e("EventTarget",cn((function(){})));i.EventTarget=ln;var un=new(function(e){function t(){var t,n;(n=e.call(this)||this).networkType=void 0,n.isNative=void 0,n.isBrowser=void 0,n.isMobile=void 0,n.isLittleEndian=void 0,n.platform=void 0,n.language=void 0,n.nativeLanguage=void 0,n.os=void 0,n.osVersion=void 0,n.osMainVersion=void 0,n.browserType=void 0,n.browserVersion=void 0,n.pixelRatio=void 0,n.supportCapability=void 0,n._battery=void 0;var i,r=window.navigator,o=r.userAgent.toLowerCase();null===(t=r.getBattery)||void 0===t||t.call(r).then((function(e){n._battery=e})),n.networkType=L.LAN,n.isNative=!1,n.isBrowser=!0,n.isMobile=/mobile|android|iphone|ipad/.test(o),n.platform=n.isMobile?F.MOBILE_BROWSER:F.DESKTOP_BROWSER,n.isLittleEndian=(i=new ArrayBuffer(2),new DataView(i).setInt16(0,256,!0),256===new Int16Array(i)[0]);var a=r.language;n.nativeLanguage=a.toLowerCase(),a=(a=a||r.browserLanguage)?a.split("-")[0]:M.ENGLISH,n.language=a;var s=!1,c=!1,l="",u=0,h=/android\s*(\d+(?:\.\d+)*)/i.exec(o)||/android\s*(\d+(?:\.\d+)*)/i.exec(r.platform);h&&(s=!0,l=h[1]||"",u=parseInt(l)||0),(h=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(o))?(c=!0,l=h[2]||"",u=parseInt(l)||0):(/(iPhone|iPad|iPod)/.exec(r.platform)||"MacIntel"===r.platform&&r.maxTouchPoints&&r.maxTouchPoints>1)&&(c=!0,l="",u=0);var _=B.UNKNOWN;-1!==r.appVersion.indexOf("Win")?_=B.WINDOWS:c?_=B.IOS:-1!==r.appVersion.indexOf("Mac")?_=B.OSX:-1!==r.appVersion.indexOf("X11")&&-1===r.appVersion.indexOf("Linux")?_=B.LINUX:s?_=B.ANDROID:-1===r.appVersion.indexOf("Linux")&&-1===o.indexOf("ubuntu")||(_=B.LINUX),n.os=_,n.osVersion=l,n.osMainVersion=u,n.browserType=N.UNKNOWN;var f=/wechat|weixin|micromessenger/i.exec(o)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(o)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(o)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(o),p=f?f[0].toLowerCase():B.UNKNOWN;("safari"===p&&s||"qq"===p&&/android.*applewebkit/i.test(o))&&(p=N.ANDROID);var d={micromessenger:N.WECHAT,wechat:N.WECHAT,weixin:N.WECHAT,trident:N.IE,edge:N.EDGE,"360 aphone":N.BROWSER_360,mxbrowser:N.MAXTHON,"opr/":N.OPERA,ubrowser:N.UC,huaweibrowser:N.HUAWEI};n.browserType=d[p]||p,n.browserVersion="";var m=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(o);m||(m=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(o)),n.browserVersion=m?m[4]:"",n.pixelRatio=window.devicePixelRatio||1;var v,g=document.createElement("canvas"),y=!!g.getContext("2d"),S=!1;window.WebGLRenderingContext&&(S=!0);try{v=g.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){v=!1}var T=!1;return"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(g.width=g.height=2,createImageBitmap(g,{}).then((function(e){T=!0,null==e||e.close()})).catch((function(){}))),n.supportCapability={webp:v,gl:S,canvas:y,imageBitmap:T},n._registerEvent(),n}H(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(ln));function hn(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function _n(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function fn(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var pn=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(pn);var dn=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:hn,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:_n,nextPow2:fn,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return pn[255&e]<<24|pn[e>>>8&255]<<16|pn[e>>>16&255]<<8|pn[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>_n(e)+1}});e("bits",dn);var mn,vn,gn,yn,Sn,Tn,En=10,xn=0,An=new Map;yn=function(e,t,n,i,r,o,a){var s=An.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},mn=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=xn++;An.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:En});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return yn(t,n.name,a,o,p,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return yn(t,n.name,a,o,p,i,c),n.customGetter.call(this)},set:function(e){yn(t,n.name,a,o,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){yn(t,n.name,a,o,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return yn(t,n.name,a,o,p,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return yn(t,n.name,a,o,p,i,c),s?this[o]:r[o]},set:function(e){yn(t,n.name,a,o,p,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),Tn=function(e,t,n,i,r){var o=An.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},vn=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=xn++;An.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:En});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return Tn(t,n.name,d,i,r)},set:function(){Tn(t,n.name,d,i,r)},enumerable:!1})}))})),Sn=function(e,t,n,i,r){var o=An.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},gn=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=xn++;An.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:En});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return Sn(t,i,p,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return Sn(t,i,p,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){Sn(t,i,p,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return Sn(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){Sn(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,p,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var bn=Math.PI/180,Cn=180/Math.PI,wn=e("EPSILON",1e-6);function Rn(e,t){return Math.abs(e-t)<=wn*Math.max(1,Math.abs(e),Math.abs(t))}function Pn(e,t,n){return n=n||wn,Math.abs(e-t)<=n}function In(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function On(e){return e<0?0:e>1?1:e}function Dn(e,t,n){return e+(t-e)*n}function Nn(e){return e*bn}function Mn(e){return e*Cn}var Ln=e("random",Math.random);function Bn(e,t){return Math.random()*(t-e)+e}function Fn(e,t){return Math.floor(Bn(e,t))}function zn(e){return(e=(9301*e+49297)%233280)/233280}function Un(e,t,n){return zn(e)*(n-t)+t}function kn(e,t,n){return Math.floor(Un(e,t,n))}function Gn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Hn(e,t){return e-Math.floor(e/t)*t}function Vn(e,t){return e=Hn(e,2*t),t-Math.abs(e-t)}function Wn(e,t,n){return(n-e)/(t-e)}function jn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Xn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function qn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var Yn=1/255,Kn=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}H(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Yn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16)||255;return this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*Yn,t=this.g*Yn,n=this.b*Yn,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},k(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~In(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~In(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~In(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~In(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*Yn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*Yn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*Yn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*Yn},set:function(e){this.a=255*e}}]),t}(tt));function Qn(e,t,n,i){return new Kn(e,t,n,i)}Kn.WHITE=Object.freeze(new Kn(255,255,255,255)),Kn.GRAY=Object.freeze(new Kn(127,127,127,255)),Kn.BLACK=Object.freeze(new Kn(0,0,0,255)),Kn.TRANSPARENT=Object.freeze(new Kn(0,0,0,0)),Kn.RED=Object.freeze(new Kn(255,0,0,255)),Kn.GREEN=Object.freeze(new Kn(0,255,0,255)),Kn.BLUE=Object.freeze(new Kn(0,0,255,255)),Kn.CYAN=Object.freeze(new Kn(0,255,255,255)),Kn.MAGENTA=Object.freeze(new Kn(255,0,255,255)),Kn.YELLOW=Object.freeze(new Kn(255,255,0,255)),Wt.fastDefine("cc.Color",Kn,{r:0,g:0,b:0,a:255}),i.Color=Kn,i.color=Qn;var Zn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}H(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<wn?e.x=0:e.x=1/n,Math.abs(i)<wn?e.y=0:e.y=1/i,Math.abs(r)<wn?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*Ln()*Math.PI,i=2*Ln()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.x=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=wn);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(Jn,e),t.normalize($n,n);var i=t.dot(Jn,$n);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=wn),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=In(this.x,e.x,t.x),this.y=In(this.y,e.y,t.y),this.z=In(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(tt));Zn.UNIT_X=Object.freeze(new Zn(1,0,0)),Zn.UNIT_Y=Object.freeze(new Zn(0,1,0)),Zn.UNIT_Z=Object.freeze(new Zn(0,0,1)),Zn.RIGHT=Object.freeze(new Zn(1,0,0)),Zn.UP=Object.freeze(new Zn(0,1,0)),Zn.FORWARD=Object.freeze(new Zn(0,0,-1)),Zn.ZERO=Object.freeze(new Zn(0,0,0)),Zn.ONE=Object.freeze(new Zn(1,1,1)),Zn.NEG_ONE=Object.freeze(new Zn(-1,-1,-1));var Jn=new Zn,$n=new Zn;function ei(e,t,n){return new Zn(e,t,n)}Wt.fastDefine("cc.Vec3",Zn,{x:0,y:0,z:0}),i.Vec3=Zn,i.v3=ei;var ti=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}H(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,p=n*h+i*_+r*f;return 0===p?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(p=1/p,e.m00=h*p,e.m01=(-u*i+r*l)*p,e.m02=(s*i-r*a)*p,e.m03=_*p,e.m04=(u*n-r*c)*p,e.m05=(-s*n+r*o)*p,e.m06=f*p,e.m07=(-l*n+i*c)*p,e.m08=(a*n-i*o)*p,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,S=n.m08;return e.m00=_*i+f*a+p*l,e.m01=_*r+f*s+p*u,e.m02=_*o+f*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,S=n.m10;return e.m00=_*i+f*a+p*l,e.m01=_*r+f*s+p*u,e.m02=_*o+f*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return Zn.lengthSqr(n)<wn*wn?(t.identity(e),e):(i=i||Zn.UNIT_Y,Zn.normalize(ni,Zn.cross(ni,i,n)),Zn.lengthSqr(ni)<wn*wn?(t.identity(e),e):(Zn.cross(ii,n,ni),t.set(e,ni.x,ni.y,ni.z,ii.x,ii.y,ii.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-p,e.m07=f-d,e.m02=_-m,e.m05=f+d,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,T=i*c-r*s,E=i*l-o*s,x=r*l-o*c,A=u*d-h*p,b=u*m-_*p,C=u*v-f*p,w=h*m-_*d,R=h*v-f*d,P=_*v-f*m,I=g*P-y*R+S*w+T*C-E*b+x*A;return I?(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(c*C-a*P-l*b)*I,e.m02=(a*R-s*C+l*A)*I,e.m03=(r*R-i*P-o*w)*I,e.m04=(n*P-r*C+o*b)*I,e.m05=(i*C-n*R-o*A)*I,e.m06=(d*x-m*E+v*T)*I,e.m07=(m*S-p*x-v*y)*I,e.m08=(p*E-d*S+v*g)*I,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,p=e.m04,d=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+p*r+d*s,this.m04=f*n+p*o+d*c,this.m05=f*i+p*a+d*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},t}(tt));ti.IDENTITY=Object.freeze(new ti);var ni=new Zn,ii=new Zn;Wt.fastDefine("cc.Mat3",ti,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=ti;var ri=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}H(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=Zn.dot(n,i);return r<-.999999?(Zn.cross(si,Zn.UNIT_X,n),si.length()<1e-6&&Zn.cross(si,Zn.UNIT_Y,n),Zn.normalize(si,si),t.fromAxisAngle(e,si,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Zn.cross(si,n,i),e.x=si.x,e.y=si.y,e.z=si.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(oi,n),Zn.transformQuat(si,i,oi),t.fromAxisAngle(oi,si,r),t.multiply(e,n,oi),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(oi,i,r),t.multiply(e,n,oi),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(oi,n,o,a),t.slerp(ai,i,r,a),t.slerp(e,oi,ai,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return ti.set(ci,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,ci))},t.fromViewUp=function(e,n,i){return ti.fromViewUp(ci,n,i),t.normalize(e,t.fromMat3(e,ci))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var p=2*Math.sqrt(1+a-n-u);e.w=(r-c)/p,e.x=(i+o)/p,e.y=.25*p,e.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);e.w=(o-i)/d,e.x=(r+c)/d,e.y=(s+l)/d,e.z=.25*d}return e},t.fromEuler=function(e,t,n,i){t*=li,n*=li,i*=li;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=li,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=Mn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-Mn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=Mn(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=Mn(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=Mn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(tt));ri.IDENTITY=Object.freeze(new ri);var oi=new ri,ai=new ri,si=new Zn,ci=new ti,li=.5*Math.PI/180;function ui(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new ri(e,t,n,i)}Wt.fastDefine("cc.Quat",ri,{x:0,y:0,z:0,w:1}),i.Quat=ri,i.quat=ui;var hi=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),_i=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}H(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=p,e.m14=d,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,T=i*c-r*s,E=i*l-o*s,x=r*l-o*c,A=u*d-h*p,b=u*m-_*p,C=u*v-f*p,w=h*m-_*d,R=h*v-f*d,P=_*v-f*m,I=g*P-y*R+S*w+T*C-E*b+x*A;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(r*R-i*P-o*w)*I,e.m02=(d*x-m*E+v*T)*I,e.m03=(_*E-h*x-f*T)*I,e.m04=(c*C-a*P-l*b)*I,e.m05=(n*P-r*C+o*b)*I,e.m06=(m*S-p*x-v*y)*I,e.m07=(u*x-_*S+f*y)*I,e.m08=(a*R-s*C+l*A)*I,e.m09=(i*C-n*R-o*A)*I,e.m10=(p*E-d*S+v*g)*I,e.m11=(h*S-u*E-f*g)*I,e.m12=(s*b-a*w-c*A)*I,e.m13=(n*w-i*b+r*A)*I,e.m14=(d*y-p*T-m*g)*I,e.m15=(u*T-h*y+_*g)*I,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,p=e.m13,d=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*d)-(t*s-i*o)*(u*m-_*p)+(t*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*d-h*f)+(i*c-r*s)*(l*p-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,p=t.m11,d=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,S=n.m01,T=n.m02,E=n.m03;return e.m00=y*i+S*s+T*h+E*d,e.m01=y*r+S*c+T*_+E*m,e.m02=y*o+S*l+T*f+E*v,e.m03=y*a+S*u+T*p+E*g,y=n.m04,S=n.m05,T=n.m06,E=n.m07,e.m04=y*i+S*s+T*h+E*d,e.m05=y*r+S*c+T*_+E*m,e.m06=y*o+S*l+T*f+E*v,e.m07=y*a+S*u+T*p+E*g,y=n.m08,S=n.m09,T=n.m10,E=n.m11,e.m08=y*i+S*s+T*h+E*d,e.m09=y*r+S*c+T*_+E*m,e.m10=y*o+S*l+T*f+E*v,e.m11=y*a+S*u+T*p+E*g,y=n.m12,S=n.m13,T=n.m14,E=n.m15,e.m12=y*i+S*s+T*h+E*d,e.m13=y*r+S*c+T*_+E*m,e.m14=y*o+S*l+T*f+E*v,e.m15=y*a+S*u+T*p+E*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,p=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=p,e.m09=d,e.m10=m,e.m11=v,e.m12=a*i+u*r+p*o+t.m12,e.m13=s*i+h*r+d*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<wn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,p=t.m03,d=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,S=t.m09,T=t.m10,E=t.m11,x=r*r*u+l,A=o*r*u+a*c,b=a*r*u-o*c,C=r*o*u-a*c,w=o*o*u+l,R=a*o*u+r*c,P=r*a*u+o*c,I=o*a*u-r*c,O=a*a*u+l;return e.m00=h*x+d*A+y*b,e.m01=_*x+m*A+S*b,e.m02=f*x+v*A+T*b,e.m03=p*x+g*A+E*b,e.m04=h*C+d*w+y*R,e.m05=_*C+m*w+S*R,e.m06=f*C+v*w+T*R,e.m07=p*C+g*w+E*R,e.m08=h*P+d*I+y*O,e.m09=_*P+m*I+S*O,e.m10=f*P+v*I+T*O,e.m11=p*P+g*I+E*O,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<wn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+d),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+d),e.m06=p+m,e.m07=0,e.m08=_+v,e.m09=p-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=pi.m00=t.m00,i=pi.m01=t.m01,r=pi.m02=t.m02,o=pi.m03=t.m04,a=pi.m04=t.m05,s=pi.m05=t.m06,c=pi.m06=t.m08,l=pi.m07=t.m09,u=pi.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),ti.determinant(pi)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=Zn.set(fi,e.m00,e.m01,e.m02).length(),pi.m00=e.m00/i.x,pi.m01=e.m01/i.x,pi.m02=e.m02/i.x,i.y=Zn.set(fi,e.m04,e.m05,e.m06).length(),pi.m03=e.m04/i.y,pi.m04=e.m05/i.y,pi.m05=e.m06/i.y,i.z=Zn.set(fi,e.m08,e.m09,e.m10).length(),pi.m06=e.m08/i.z,pi.m07=e.m09/i.z,pi.m08=e.m10/i.z,ti.determinant(pi)<0&&(i.x*=-1,pi.m00*=-1,pi.m01*=-1,pi.m02*=-1),ri.fromMat3(t,pi),Zn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,S=i.x,T=i.y,E=i.z;return e.m00=(1-(p+m))*S,e.m01=(_+y)*S,e.m02=(f-g)*S,e.m03=0,e.m04=(_-y)*T,e.m05=(1-(h+m))*T,e.m06=(d+v)*T,e.m07=0,e.m08=(f+g)*E,e.m09=(d-v)*E,e.m10=(1-(h+p))*E,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,S=c*h,T=i.x,E=i.y,x=i.z,A=r.x,b=r.y,C=r.z;return e.m00=(1-(d+v))*T,e.m01=(f+S)*T,e.m02=(p-y)*T,e.m03=0,e.m04=(f-S)*E,e.m05=(1-(_+v))*E,e.m06=(m+g)*E,e.m07=0,e.m08=(p+y)*x,e.m09=(m-g)*x,e.m10=(1-(_+d))*x,e.m11=0,e.m12=n.x+A-(e.m00*A+e.m04*b+e.m08*C),e.m13=n.y+b-(e.m01*A+e.m05*b+e.m09*C),e.m14=n.z+C-(e.m02*A+e.m06*b+e.m10*C),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-p,e.m06=f+d,e.m07=0,e.m08=_+m,e.m09=f-d,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=hi[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,p=-2*h,d=(t+n)*u,m=(r+i)*h,v=hi[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=p*v[2],e.m05=p*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=d*v[0]+m*v[2],e.m13=d*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return e.m00=p,e.m01=v,e.m02=u,e.m03=0,e.m04=d,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(p*r+d*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,T=i*c-r*s,E=i*l-o*s,x=r*l-o*c,A=u*d-h*p,b=u*m-_*p,C=u*v-f*p,w=h*m-_*d,R=h*v-f*d,P=_*v-f*m,I=g*P-y*R+S*w+T*C-E*b+x*A;return I?(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(c*C-a*P-l*b)*I,e.m02=(a*R-s*C+l*A)*I,e.m03=0,e.m04=(r*R-i*P-o*w)*I,e.m05=(n*P-r*C+o*b)*I,e.m06=(i*C-n*R-o*A)*I,e.m07=0,e.m08=(d*x-m*E+v*T)*I,e.m09=(m*S-p*x-v*y)*I,e.m10=(p*E-d*S+v*g)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,S=t*s-i*o,T=n*s-i*a,E=c*f-l*_,x=c*p-u*_,A=c*d-h*_,b=l*p-u*f,C=l*d-h*f,w=u*d-h*p,R=m*w-v*C+g*b+y*A-S*x+T*E;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(o*w-a*C+s*b)*R,this.m01=(n*C-t*w-i*b)*R,this.m02=(f*T-p*S+d*y)*R,this.m03=(u*S-l*T-h*y)*R,this.m04=(a*A-r*w-s*x)*R,this.m05=(e*w-n*A+i*x)*R,this.m06=(p*g-_*T-d*v)*R,this.m07=(c*T-u*g+h*v)*R,this.m08=(r*C-o*A+s*E)*R,this.m09=(t*A-e*C-i*E)*R,this.m10=(_*S-f*g+d*m)*R,this.m11=(l*g-c*S-h*m)*R,this.m12=(o*x-r*b-a*E)*R,this.m13=(e*b-t*x+n*E)*R,this.m14=(f*v-_*y-p*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(e*o-t*r)*(u*d-h*p)-(e*a-n*r)*(l*d-h*f)+(e*s-i*r)*(l*p-u*f)+(t*a-n*o)*(c*d-h*_)-(t*s-i*o)*(c*p-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,S=e.m03;return this.m00=v*t+g*o+y*l+S*f,this.m01=v*n+g*a+y*u+S*p,this.m02=v*i+g*s+y*h+S*d,this.m03=v*r+g*c+y*_+S*m,v=e.m04,g=e.m05,y=e.m06,S=e.m07,this.m04=v*t+g*o+y*l+S*f,this.m05=v*n+g*a+y*u+S*p,this.m06=v*i+g*s+y*h+S*d,this.m07=v*r+g*c+y*_+S*m,v=e.m08,g=e.m09,y=e.m10,S=e.m11,this.m08=v*t+g*o+y*l+S*f,this.m09=v*n+g*a+y*u+S*p,this.m10=v*i+g*s+y*h+S*d,this.m11=v*r+g*c+y*_+S*m,v=e.m12,g=e.m13,y=e.m14,S=e.m15,this.m12=v*t+g*o+y*l+S*f,this.m13=v*n+g*a+y*u+S*p,this.m14=v*i+g*s+y*h+S*d,this.m15=v*r+g*c+y*_+S*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<wn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,S=this.m11,T=n*n*c+s,E=i*n*c+r*a,x=r*n*c-i*a,A=n*i*c-r*a,b=i*i*c+s,C=r*i*c+n*a,w=n*r*c+i*a,R=i*r*c-n*a,P=r*r*c+s;return this.m00=l*T+f*E+v*x,this.m01=u*T+p*E+g*x,this.m02=h*T+d*E+y*x,this.m03=_*T+m*E+S*x,this.m04=l*A+f*b+v*C,this.m05=u*A+p*b+g*C,this.m06=h*A+d*b+y*C,this.m07=_*A+m*b+S*C,this.m08=l*w+f*R+v*P,this.m09=u*w+p*R+g*P,this.m10=h*w+d*R+y*P,this.m11=_*w+m*R+S*P,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=pi.m00=this.m00,n=pi.m01=this.m01,i=pi.m02=this.m02,r=pi.m03=this.m04,o=pi.m04=this.m05,a=pi.m05=this.m06,s=pi.m06=this.m08,c=pi.m07=this.m09,l=pi.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),ti.determinant(pi)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,S=n.y,T=n.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*S,this.m05=(1-(u+d))*S,this.m06=(p+m)*S,this.m07=0,this.m08=(_+v)*T,this.m09=(p-m)*T,this.m10=(1-(u+f))*T,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(tt));_i.IDENTITY=Object.freeze(new _i);var fi=new Zn,pi=new ti;function di(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new _i(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d)}Wt.fastDefine("cc.Mat4",_i,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=_i,i.mat4=di;var mi=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}H(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<wn?e.x=0:e.x=1/n,Math.abs(i)<wn?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*Ln()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(vi,e),t.normalize(gi,n);var i=t.dot(vi,gi);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=wn),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=In(this.x,e.x,t.x),this.y=In(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=In(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(tt));mi.ZERO=Object.freeze(new mi(0,0)),mi.ONE=Object.freeze(new mi(1,1)),mi.NEG_ONE=Object.freeze(new mi(-1,-1)),mi.UNIT_X=Object.freeze(new mi(1,0)),mi.UNIT_Y=Object.freeze(new mi(0,1));var vi=new mi,gi=new mi;function yi(e,t){return new mi(e,t)}Wt.fastDefine("cc.Vec2",mi,{x:0,y:0}),i.Vec2=mi,i.v2=yi;var Si=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}H(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<wn?e.x=0:e.x=1/n,Math.abs(i)<wn?e.y=0:e.y=1/i,Math.abs(r)<wn?e.z=0:e.z=1/r,Math.abs(o)<wn?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*Ln()*Math.PI,i=2*Ln()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,e.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,e.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=wn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=wn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=wn),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=In(this.x,e.x,t.x),this.y=In(this.y,e.y,t.y),this.z=In(this.z,e.z,t.z),this.w=In(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(tt));function Ti(e,t,n,i){return new Si(e,t,n,i)}Si.ZERO=Object.freeze(new Si(0,0,0,0)),Si.ONE=Object.freeze(new Si(1,1,1,1)),Si.NEG_ONE=Object.freeze(new Si(-1,-1,-1,-1)),Wt.fastDefine("cc.Vec4",Si,{x:0,y:0,z:0,w:0}),i.Vec4=Si,i.v4=Ti,mn(mi,"Vec2",[{name:"sub",newName:"subtract",target:mi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:mi,targetName:"Vec2"},{name:"div",newName:"divide",target:mi,targetName:"Vec2"},{name:"dist",newName:"distance",target:mi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:mi,targetName:"Vec2"},{name:"mag",newName:"len",target:mi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:mi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:mi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:mi,targetName:"Vec2"}]),mn(mi.prototype,"Vec2",[{name:"mag",newName:"length",target:mi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:mi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:mi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:mi.prototype,targetName:"Vec2"}]),mn(Zn,"Vec3",[{name:"sub",newName:"subtract",target:Zn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Zn,targetName:"Vec3"},{name:"div",newName:"divide",target:Zn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Zn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Zn,targetName:"Vec3"},{name:"mag",newName:"len",target:Zn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Zn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Zn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Zn,targetName:"Vec3"}]),mn(Zn.prototype,"Vec3",[{name:"mag",newName:"length",target:Zn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Zn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Zn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Zn.prototype,targetName:"Vec3"}]),mn(Si,"Vec4",[{name:"sub",newName:"subtract",target:Si,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Si,targetName:"Vec4"},{name:"div",newName:"divide",target:Si,targetName:"Vec4"},{name:"dist",newName:"distance",target:Si,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Si,targetName:"Vec4"},{name:"mag",newName:"len",target:Si,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Si,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Si,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Si,targetName:"Vec4"}]),mn(Si.prototype,"Vec4",[{name:"mag",newName:"length",target:Si.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Si.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Si.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Si.prototype,targetName:"Vec4"}]),mn(ri,"Quat",[{name:"mag",newName:"len",target:ri,targetName:"Quat"},{name:"mul",newName:"multiply",target:ri,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:ri,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:ri,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ri,targetName:"Quat"}]),mn(ri.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:ri.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ri.prototype,targetName:"Quat"}]),mn(Kn,"Color",[{name:"sub",newName:"subtract",target:Kn,targetName:"Color"},{name:"mul",newName:"multiply",target:Kn,targetName:"Color"},{name:"div",newName:"divide",target:Kn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Kn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[1].toString(16);return i.Color.fromHEX(t[0],r)}}]),mn(ti,"Mat3",[{name:"sub",newName:"subtract",target:ti,targetName:"Mat3"},{name:"mul",newName:"multiply",target:ti,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:ti,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:ti,targetName:"Mat3"}]),mn(ti.prototype,"Mat3",[{name:"sub",newName:"subtract",target:ti.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:ti.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:ti.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:ti.prototype,targetName:"Mat3"}]),mn(_i,"Mat4",[{name:"sub",newName:"subtract",target:_i,targetName:"Mat4"},{name:"mul",newName:"multiply",target:_i,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:_i,targetName:"Mat4"}]),mn(_i.prototype,"Mat4",[{name:"sub",newName:"subtract",target:_i.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:_i.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:_i.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:_i.prototype,targetName:"Mat4"}]);var Ei=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;void 0===i?(i=n,r=t.x,o=t.y):(r=t,o=n),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=d,e.width=p-f,e.height=m-d},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());i.AffineTransform=Ei;var xi=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}H(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},k(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(tt));function Ai(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new xi(e,t)}xi.ZERO=Object.freeze(new xi(0,0)),xi.ONE=Object.freeze(new xi(1,1)),Wt.fastDefine("cc.Size",xi,{width:0,height:0}),i.size=Ai,i.Size=xi;var bi=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}H(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},k(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new mi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new mi(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new xi(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(tt));function Ci(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new bi(e,t,n,i)}Wt.fastDefine("cc.Rect",bi,{x:0,y:0,width:0,height:0}),i.Rect=bi,i.rect=Ci;var wi=e("MATH_FLOAT_ARRAY",Float64Array),Ri=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t.createFloatArray=function(e){return new wi(e)},k(t,[{key:"array",get:function(){return this._array}}]),t}(tt)),Pi=Object.freeze({__proto__:null,bits:dn,Vec2:mi,v2:yi,Vec3:Zn,v3:ei,Vec4:Si,v4:Ti,Quat:ri,quat:ui,Mat3:ti,Mat4:_i,mat4:di,AffineTransform:Ei,Size:xi,size:Ai,Rect:bi,rect:Ci,Color:Kn,color:Qn,EPSILON:wn,equals:Rn,approx:Pn,clamp:In,clamp01:On,lerp:Dn,toRadian:Nn,toDegree:Mn,random:Ln,randomRange:Bn,randomRangeInt:Fn,pseudoRandom:zn,pseudoRandomRange:Un,pseudoRandomRangeInt:kn,nextPow2:Gn,repeat:Hn,pingPong:Vn,inverseLerp:Wn,absMaxComponent:jn,absMax:Xn,enumerableProps:qn,MATH_FLOAT_ARRAY:wi,MathBase:Ri});e("math",Pi);var Ii=new(function(e){function t(){var t,n;(t=e.call(this)||this)._gameFrame=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._gameFrame=document.getElementById("GameDiv");for(var i=t._fnGroup,r=0;r<i.length;r++)if(n=i[r],void 0!==document[n[1]]){for(var o=0;o<n.length;o++)t._fn[i[0][o]]=n[o];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}H(t,e);var n=t.prototype;return n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.emit("window-resize")})),window.addEventListener("orientationchange",(function(){e.emit("orientation-change")})),document.addEventListener(this._fn.fullscreenchange,(function(){e.emit("fullscreen-change")}))},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._gameFrame)if(e._supportFullScreen){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var i=e._gameFrame[e._fn.requestFullscreen]();window.Promise&&i instanceof Promise?i.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("fullscreen is not supported"));else n(new Error("Cannot access game frame"))}))},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e._doRequestFullScreen().then((function(){t()})).catch((function(){e._gameFrame?e._gameFrame.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access game frame"))}))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then(t).catch(n):t()}))},k(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"windowSize",get:function(){return this._gameFrame?new xi(this._gameFrame.clientWidth,this._gameFrame.clientHeight):new xi(window.innerWidth,window.innerHeight)},set:function(){console.warn("Setting window size is not supported yet.")}},{key:"orientation",get:function(){throw new Error("Method not implemented.")}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}}]),t}(ln)),Oi=Ii.windowSize,Di=un.pixelRatio,Ni=e("sys",{NetworkType:L,Language:M,OS:B,Platform:F,BrowserType:N,isNative:un.isNative,isBrowser:un.isBrowser,isMobile:un.isMobile,isLittleEndian:un.isLittleEndian,platform:un.platform,language:un.language,languageCode:un.nativeLanguage,os:un.os,osVersion:un.osVersion,osMainVersion:un.osMainVersion,browserType:un.browserType,browserVersion:un.browserVersion,windowPixelResolution:{width:Oi.width*Di,height:Oi.height*Di},capabilities:{canvas:un.supportCapability.canvas,opengl:un.supportCapability.gl,webp:un.supportCapability.webp,imageBitmap:un.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:{},getNetworkType:function(){return un.networkType},getBatteryLevel:function(){return un.getBatteryLevel()},garbageCollect:function(){un.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",f(e+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){un.openURL(e)},now:function(){return un.now()},restartVM:function(){un.restartJSVM()},getSafeAreaRect:function(){var e=i.view,t=Ii.safeAreaEdge,n=Ii.windowSize,r=new mi(t.left,n.height-t.bottom),o=new mi(n.width-t.right,t.top),a={left:0,top:0,width:n.width,height:n.height};e.convertToLocationInView(r.x,r.y,a,r),e.convertToLocationInView(o.x,o.y,a,o),e._convertPointWithScale(r),e._convertPointWithScale(o);var s=r.x,c=r.y,l=o.x-r.x,u=o.y-r.y;return new bi(s,c,l,u)}});!function(){try{var e=Ni.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){A(5200)};Ni.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}var n=window,i=n.navigator,r=document,o=r.documentElement,a=Ni.capabilities;(void 0!==o.ontouchstart||void 0!==r.ontouchstart||i.msPointerEnabled)&&(a.touches=!0),void 0!==o.onmouseup&&(a.mouse=!0),void 0!==o.onkeyup&&(a.keyboard=!0),(n.DeviceMotionEvent||n.DeviceOrientationEvent)&&(a.accelerometer=!0),Ni.__isWebIOS14OrIPadOS14Env=(Ni.os===B.IOS||Ni.os===B.OSX)&&un.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),Ii.on("window-resize",(function(){var e=Ii.windowSize;Ni.windowPixelResolution={width:Math.round(e.width*Di),height:Math.round(e.height*Di)}}))}(),i.sys=Ni;var Mi=/(\.[^\.\/\?\\]*)(\?.*)?$/,Li=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Bi=/[^\.\/]+\/\.\.\//;function Fi(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function zi(e){var t=Mi.exec(e);return t?t[1]:""}function Ui(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function ki(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Gi(e){var t=Li.exec(e);return t?t[2]:""}function Hi(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Vi(e,t,n){if(0===t.indexOf("."))return Hi(e,t);var i=e.indexOf("?"),r="",o=n?zi(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function Wi(e){var t=e=String(e);do{t=e,e=e.replace(Bi,"")}while(t.length!==e.length);return e}function ji(e){return e.replace(/[\/\\]$/,"")}function Xi(){return Ni.os===B.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:Fi,extname:zi,mainFileName:Ui,basename:ki,dirname:Gi,changeExtname:Hi,changeBasename:Vi,_normalize:Wi,stripSep:ji,getSeperator:Xi})),i.log=f,i.warn=p,i.error=d,i.assert=m,i._throw=y,i.logID=E,i.warnID=A,i.errorID=C,i.assertID=P,i.debug=z,i.path={join:Fi,extname:zi,mainFileName:Ui,basename:ki,dirname:Gi,changeExtname:Hi,changeBasename:Vi,_normalize:Wi,stripSep:ji,get sep(){return Xi()}};var qi=0,Yi={},Ki=function(){function e(){this._skyColor=new Kn(51,128,204,1),this._groundAlbedo=new Kn(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._enabled=!1,this._skyIllum=0}var t=e.prototype;return t.initialize=function(e){this.skyColor=e.skyColor,this.groundAlbedo=e.groundAlbedo,this.skyIllum=e.skyIllum},t._destroy=function(){},t.destroy=function(){this._destroy()},k(e,[{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),Kn.toArray(this._colorArray,this._skyColor)}},{key:"skyIllum",get:function(){return this._skyIllum},set:function(e){this._skyIllum=e}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),Zn.toArray(this._albedoArray,this._groundAlbedo)}},{key:"native",get:function(){return this._nativeObj}}]),e}();Ki.SUN_ILLUM=65e3,Ki.SKY_ILLUM=2e4,i.Ambient=Ki;var Qi=new Zn,Zi=new Zn,Ji=new Zn,$i=new Zn,er=new Zn,tr=new Zn,nr=new Array(3),ir=new Array(3);function rr(e,t){return Zn.dot(t.n,e)-t.d}function or(e,t,n){return Zn.copy(e,t),Zn.subtract(er,n.center,n.halfExtents),Zn.add(tr,n.center,n.halfExtents),e.x=e.x<er.x?er.x:e.x,e.y=e.y<er.y?er.y:e.y,e.z=e.z<er.z?er.z:e.z,e.x=e.x>tr.x?tr.x:e.x,e.y=e.y>tr.y?tr.y:e.y,e.z=e.z>tr.z?tr.z:e.z,e}function ar(e,t,n){Zn.set(Qi,n.orientation.m00,n.orientation.m01,n.orientation.m02),Zn.set(Zi,n.orientation.m03,n.orientation.m04,n.orientation.m05),Zn.set(Ji,n.orientation.m06,n.orientation.m07,n.orientation.m08),nr[0]=Qi,nr[1]=Zi,nr[2]=Ji,ir[0]=n.halfExtents.x,ir[1]=n.halfExtents.y,ir[2]=n.halfExtents.z,Zn.subtract($i,t,n.center),Zn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Zn.dot($i,nr[i]);r>ir[i]&&(r=ir[i]),r<-ir[i]&&(r=-ir[i]),e.x+=r*nr[i].x,e.y+=r*nr[i].y,e.z+=r*nr[i].z}return e}var sr=Object.freeze({__proto__:null,point_plane:rr,pt_point_plane:function(e,t,n){var i=rr(t,n);return Zn.subtract(e,t,Zn.multiplyScalar(e,n.n,i))},pt_point_aabb:or,pt_point_obb:ar,pt_point_line:function(e,t,n,i){Zn.subtract(Qi,n,i);var r=Qi,o=Zn.lengthSqr(r);if(0==o)Zn.copy(e,n);else{Zn.subtract(Qi,t,n);var a=Zn.dot(Qi,r)/o;a<0?Zn.copy(e,n):a>1?Zn.copy(e,i):Zn.scaleAndAdd(e,n,r,a)}}}),cr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},lr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=cr.SHAPE_LINE,this.s=new Zn(e,t,n),this.e=new Zn(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return Zn.copy(e.s,t.s),Zn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return Zn.copy(e.s,t),Zn.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return Zn.distance(e.s,e.e)},e.prototype.length=function(){return Zn.distance(this.s,this.e)},k(e,[{key:"type",get:function(){return this._type}}]),e}(),ur=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=cr.SHAPE_RAY,this.o=new Zn(e,t,n),this.d=new Zn(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return Zn.copy(e.o,t.o),Zn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return Zn.copy(e.o,t),Zn.normalize(e.d,Zn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){Zn.normalize(e,this.d),Zn.scaleAndAdd(e,this.o,e,t)},k(e,[{key:"type",get:function(){return this._type}}]),e}(),hr=new Zn,_r=new Zn,fr=new Zn,pr=new Zn;function dr(e){return Math.max(Math.max(e.x,e.y),e.z)}var mr,vr,gr,yr,Sr,Tr,Er,xr,Ar,br,Cr,wr,Rr,Pr,Ir,Or,Dr,Nr,Mr,Lr,Br,Fr,zr,Ur,kr,Gr,Hr,Vr,Wr,jr,Xr,qr,Yr,Kr,Qr,Zr,Jr,$r,eo,to=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Zn(0,0,0),this._radius=0,this._type=void 0,this._type=cr.SHAPE_SPHERE,this._center=new Zn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return Zn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return Zn.multiplyScalar(e.center,Zn.add(hr,t,n),.5),e.radius=.5*Zn.subtract(hr,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){Zn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Zn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){Zn.transformMat4(r.center,this.center,e),r.radius=this.radius*dr(i)},t.translateAndRotate=function(e,t,n){Zn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*dr(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),Zn.subtract(_r,e,this.center);var t=_r.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,Zn.multiplyScalar(_r,_r,n/t),Zn.add(this.center,this.center,_r)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(fr,pr),this.mergePoint(fr),this.mergePoint(pr)},k(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),no=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=cr.SHAPE_TRIANGLE,this.a=new Zn(e,t,n),this.b=new Zn(i,r,o),this.c=new Zn(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return Zn.copy(e.a,t.a),Zn.copy(e.b,t.b),Zn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return Zn.copy(e.a,t),Zn.copy(e.b,n),Zn.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},k(e,[{key:"type",get:function(){return this._type}}]),e}(),io=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.QUEUE=13]="QUEUE",e[e.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(mr||(mr={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(vr||(vr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(gr||(gr={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(yr||(yr={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.COUNT=19]="COUNT"}(Sr||(Sr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=93]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=94]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=95]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=96]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=97]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=98]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=99]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=100]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=101]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=102]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=103]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=104]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=105]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=106]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=107]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=108]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=109]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=110]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=111]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=112]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=113]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=114]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=115]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=116]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=117]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=118]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=119]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=120]="ASTC_SRGBA_12X12",e[e.COUNT=121]="COUNT"}(Tr||(Tr={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Er||(Er={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(xr||(xr={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Ar||(Ar={})),function(e){e[e.NONE=0]="NONE"}(br||(br={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Cr||(Cr={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(wr||(wr={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Rr||(Rr={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Pr||(Pr={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.IMMUTABLE=2]="IMMUTABLE",e[e.GENERAL_LAYOUT=4]="GENERAL_LAYOUT"}(Ir||(Ir={})),function(e){e[e.X1=1]="X1",e[e.X2=2]="X2",e[e.X4=4]="X4",e[e.X8=8]="X8",e[e.X16=16]="X16",e[e.X32=32]="X32",e[e.X64=64]="X64"}(Or||(Or={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Dr||(Dr={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Nr||(Nr={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Mr||(Mr={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Lr||(Lr={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Br||(Br={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Fr||(Fr={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(zr||(zr={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Ur||(Ur={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(kr||(kr={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Gr||(Gr={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Hr||(Hr={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Vr||(Vr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Wr||(Wr={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(jr||(jr={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Xr||(Xr={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(qr||(qr={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Yr||(Yr={})),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Kr||(Kr={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Qr||(Qr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Zr||(Zr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Jr||(Jr={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}($r||($r={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(eo||(eo={}));var ro,oo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ao=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,S,T,E){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),void 0===m&&(m=0),void 0===v&&(v=0),void 0===g&&(g=new oo),void 0===y&&(y=new oo),void 0===S&&(S=-1),void 0===T&&(T=1),void 0===E&&(E=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.depthBits=f,this.stencilBits=p,this.uboOffsetAlignment=d,this.maxComputeSharedMemorySize=m,this.maxComputeWorkGroupInvocations=v,this.maxComputeWorkGroupSize=g,this.maxComputeWorkGroupCount=y,this.clipSpaceMinZ=S,this.screenSpaceSignY=T,this.clipSpaceSignY=E}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.depthBits=e.depthBits,this.stencilBits=e.stencilBits,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),so=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),co=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),lo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),uo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),ho=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),_o=function(){function e(e,t,n,i,r){void 0===e&&(e=new uo),void 0===t&&(t=new so),void 0===n&&(n=new uo),void 0===i&&(i=new so),void 0===r&&(r=new lo),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),fo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new uo),void 0===t&&(t=new so),void 0===n&&(n=new lo),void 0===i&&(i=new uo),void 0===r&&(r=new so),void 0===o&&(o=new lo),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),po=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new so),void 0===i&&(i=new lo),void 0===r&&(r=new uo),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),mo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),vo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),go=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),yo=function(){function e(e,t,n,i,r){void 0===e&&(e=Ar.NONE),void 0===t&&(t=wr.NONE),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=br.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),So=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),To=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),Eo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),xo=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return io(this.drawInfos,e.drawInfos,To),this},e}(),Ao=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=Rr.TEX2D),void 0===t&&(t=Pr.NONE),void 0===n&&(n=Tr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Ir.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Or.X1),void 0===l&&(l=1),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this},e}(),bo=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=Rr.TEX2D),void 0===n&&(n=Tr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),Co=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=Dr.LINEAR),void 0===t&&(t=Dr.LINEAR),void 0===n&&(n=Dr.NONE),void 0===i&&(i=Nr.WRAP),void 0===r&&(r=Nr.WRAP),void 0===o&&(o=Nr.WRAP),void 0===a&&(a=0),void 0===s&&(s=Mr.ALWAYS),void 0===c&&(c=new vo),void 0===l&&(l=0),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s,this.borderColor=c,this.mipLODBias=l}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this.borderColor.copy(e.borderColor),this.mipLODBias=e.mipLODBias,this},e}(),wo=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=xr.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ro=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,io(this.members,e.members,wo),this.count=e.count,this},e}(),Po=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=xr.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Io=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Oo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=xr.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Do=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=xr.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Cr.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),No=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=Cr.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Mo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Lo=function(){function e(e,t){void 0===e&&(e=Ur.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Bo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=Tr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Fo=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,io(this.stages,e.stages,Lo),io(this.attributes,e.attributes,Bo),io(this.blocks,e.blocks,Ro),io(this.buffers,e.buffers,No),io(this.samplerTextures,e.samplerTextures,Po),io(this.samplers,e.samplers,Io),io(this.textures,e.textures,Oo),io(this.images,e.images,Do),io(this.subpassInputs,e.subpassInputs,Mo),this},e}(),zo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return io(this.attributes,e.attributes,Bo),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Uo=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=Tr.UNKNOWN),void 0===t&&(t=Or.X1),void 0===n&&(n=kr.CLEAR),void 0===i&&(i=Gr.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Hr.PRESENT]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),ko=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=Tr.UNKNOWN),void 0===t&&(t=Or.X1),void 0===n&&(n=kr.CLEAR),void 0===i&&(i=Gr.STORE),void 0===r&&(r=kr.CLEAR),void 0===o&&(o=Gr.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Go=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Vr.NONE),void 0===s&&(s=Vr.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Ho=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),Vo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new ko),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return io(this.colorAttachments,e.colorAttachments,Uo),this.depthStencilAttachment.copy(e.depthStencilAttachment),io(this.subpasses,e.subpasses,Go),io(this.dependencies,e.dependencies,Ho),this},e}(),Wo=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),jo=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Xo=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),qo=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=Zr.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Ur.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Yo=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return io(this.bindings,e.bindings,qo),this},e}(),Ko=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Qo=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),Zo=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return io(this.attributes,e.attributes,Bo),this},e}(),Jo=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=$r.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),$o=function(){function e(e){void 0===e&&(e=Jr.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),ea=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=Er.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},ta=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),na=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),ia=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new mo),void 0===t&&(t=new co),void 0===n&&(n=new vo),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new na),void 0===u&&(u=new na),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),ra=function(){function e(e){this._gfxType=mr.UNKNOWN,this._gfxType=e}return k(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}(),oa=function(e,t,n,i,r,o,a){void 0===t&&(t=!0),void 0===n&&(n=!0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=new go),this.canvasElm=e,this.isAntialias=t,this.isPremultipliedAlpha=n,this.devicePixelRatio=i,this.width=r,this.height=o,this.bindingMappingInfo=a};!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(ro||(ro={}));var aa=Object.freeze([new ea("UNKNOWN",0,0,Er.NONE,!1,!1,!1,!1),new ea("A8",1,1,Er.UNORM,!0,!1,!1,!1),new ea("L8",1,1,Er.UNORM,!1,!1,!1,!1),new ea("LA8",1,2,Er.UNORM,!0,!1,!1,!1),new ea("R8",1,1,Er.UNORM,!1,!1,!1,!1),new ea("R8SN",1,1,Er.SNORM,!1,!1,!1,!1),new ea("R8UI",1,1,Er.UINT,!1,!1,!1,!1),new ea("R8I",1,1,Er.INT,!1,!1,!1,!1),new ea("R16F",2,1,Er.FLOAT,!1,!1,!1,!1),new ea("R16UI",2,1,Er.UINT,!1,!1,!1,!1),new ea("R16I",2,1,Er.INT,!1,!1,!1,!1),new ea("R32F",4,1,Er.FLOAT,!1,!1,!1,!1),new ea("R32UI",4,1,Er.UINT,!1,!1,!1,!1),new ea("R32I",4,1,Er.INT,!1,!1,!1,!1),new ea("RG8",2,2,Er.UNORM,!1,!1,!1,!1),new ea("RG8SN",2,2,Er.SNORM,!1,!1,!1,!1),new ea("RG8UI",2,2,Er.UINT,!1,!1,!1,!1),new ea("RG8I",2,2,Er.INT,!1,!1,!1,!1),new ea("RG16F",4,2,Er.FLOAT,!1,!1,!1,!1),new ea("RG16UI",4,2,Er.UINT,!1,!1,!1,!1),new ea("RG16I",4,2,Er.INT,!1,!1,!1,!1),new ea("RG32F",8,2,Er.FLOAT,!1,!1,!1,!1),new ea("RG32UI",8,2,Er.UINT,!1,!1,!1,!1),new ea("RG32I",8,2,Er.INT,!1,!1,!1,!1),new ea("RGB8",3,3,Er.UNORM,!1,!1,!1,!1),new ea("SRGB8",3,3,Er.UNORM,!1,!1,!1,!1),new ea("RGB8SN",3,3,Er.SNORM,!1,!1,!1,!1),new ea("RGB8UI",3,3,Er.UINT,!1,!1,!1,!1),new ea("RGB8I",3,3,Er.INT,!1,!1,!1,!1),new ea("RGB16F",6,3,Er.FLOAT,!1,!1,!1,!1),new ea("RGB16UI",6,3,Er.UINT,!1,!1,!1,!1),new ea("RGB16I",6,3,Er.INT,!1,!1,!1,!1),new ea("RGB32F",12,3,Er.FLOAT,!1,!1,!1,!1),new ea("RGB32UI",12,3,Er.UINT,!1,!1,!1,!1),new ea("RGB32I",12,3,Er.INT,!1,!1,!1,!1),new ea("RGBA8",4,4,Er.UNORM,!0,!1,!1,!1),new ea("BGRA8",4,4,Er.UNORM,!0,!1,!1,!1),new ea("SRGB8_A8",4,4,Er.UNORM,!0,!1,!1,!1),new ea("RGBA8SN",4,4,Er.SNORM,!0,!1,!1,!1),new ea("RGBA8UI",4,4,Er.UINT,!0,!1,!1,!1),new ea("RGBA8I",4,4,Er.INT,!0,!1,!1,!1),new ea("RGBA16F",8,4,Er.FLOAT,!0,!1,!1,!1),new ea("RGBA16UI",8,4,Er.UINT,!0,!1,!1,!1),new ea("RGBA16I",8,4,Er.INT,!0,!1,!1,!1),new ea("RGBA32F",16,4,Er.FLOAT,!0,!1,!1,!1),new ea("RGBA32UI",16,4,Er.UINT,!0,!1,!1,!1),new ea("RGBA32I",16,4,Er.INT,!0,!1,!1,!1),new ea("R5G6B5",2,3,Er.UNORM,!1,!1,!1,!1),new ea("R11G11B10F",4,3,Er.FLOAT,!1,!1,!1,!1),new ea("RGB5A1",2,4,Er.UNORM,!0,!1,!1,!1),new ea("RGBA4",2,4,Er.UNORM,!0,!1,!1,!1),new ea("RGB10A2",2,4,Er.UNORM,!0,!1,!1,!1),new ea("RGB10A2UI",2,4,Er.UINT,!0,!1,!1,!1),new ea("RGB9E5",2,4,Er.FLOAT,!0,!1,!1,!1),new ea("D16",2,1,Er.UINT,!1,!0,!1,!1),new ea("D16S8",3,2,Er.UINT,!1,!0,!0,!1),new ea("D24",3,1,Er.UINT,!1,!0,!1,!1),new ea("D24S8",4,2,Er.UINT,!1,!0,!0,!1),new ea("D32F",4,1,Er.FLOAT,!1,!0,!1,!1),new ea("D32FS8",5,2,Er.FLOAT,!1,!0,!0,!1),new ea("BC1",1,3,Er.UNORM,!1,!1,!1,!0),new ea("BC1_ALPHA",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC1_SRGB",1,3,Er.UNORM,!1,!1,!1,!0),new ea("BC1_SRGB_ALPHA",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC2",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC2_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC3",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC3_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC4",1,1,Er.UNORM,!1,!1,!1,!0),new ea("BC4_SNORM",1,1,Er.SNORM,!1,!1,!1,!0),new ea("BC5",1,2,Er.UNORM,!1,!1,!1,!0),new ea("BC5_SNORM",1,2,Er.SNORM,!1,!1,!1,!0),new ea("BC6H_UF16",1,3,Er.UFLOAT,!1,!1,!1,!0),new ea("BC6H_SF16",1,3,Er.FLOAT,!1,!1,!1,!0),new ea("BC7",1,4,Er.UNORM,!0,!1,!1,!0),new ea("BC7_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ETC_RGB8",1,3,Er.UNORM,!1,!1,!1,!0),new ea("ETC2_RGB8",1,3,Er.UNORM,!1,!1,!1,!0),new ea("ETC2_SRGB8",1,3,Er.UNORM,!1,!1,!1,!0),new ea("ETC2_RGB8_A1",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ETC2_SRGB8_A1",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ETC2_RGBA8",2,4,Er.UNORM,!0,!1,!1,!0),new ea("ETC2_SRGB8_A8",2,4,Er.UNORM,!0,!1,!1,!0),new ea("EAC_R11",1,1,Er.UNORM,!1,!1,!1,!0),new ea("EAC_R11SN",1,1,Er.SNORM,!1,!1,!1,!0),new ea("EAC_RG11",2,2,Er.UNORM,!1,!1,!1,!0),new ea("EAC_RG11SN",2,2,Er.SNORM,!1,!1,!1,!0),new ea("PVRTC_RGB2",2,3,Er.UNORM,!1,!1,!1,!0),new ea("PVRTC_RGBA2",2,4,Er.UNORM,!0,!1,!1,!0),new ea("PVRTC_RGB4",2,3,Er.UNORM,!1,!1,!1,!0),new ea("PVRTC_RGBA4",2,4,Er.UNORM,!0,!1,!1,!0),new ea("PVRTC2_2BPP",2,4,Er.UNORM,!0,!1,!1,!0),new ea("PVRTC2_4BPP",2,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_4x4",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_5x4",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_5x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_6x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_6x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_8x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_8x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_8x8",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_10x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_10x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_10x8",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_10x10",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_12x10",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_RGBA_12x12",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_4x4",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_5x4",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_5x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_6x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_6x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_8x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_8x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_8x8",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_10x5",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_10x6",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_10x8",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_10x10",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_12x10",1,4,Er.UNORM,!0,!1,!1,!0),new ea("ASTC_SRGBA_12x12",1,4,Er.UNORM,!0,!1,!1,!0)]),sa=Zr.UNIFORM_BUFFER|Zr.DYNAMIC_UNIFORM_BUFFER|Zr.STORAGE_BUFFER|Zr.DYNAMIC_STORAGE_BUFFER,ca=Zr.SAMPLER_TEXTURE|Zr.SAMPLER|Zr.TEXTURE|Zr.STORAGE_IMAGE|Zr.INPUT_ATTACHMENT,la=Zr.DYNAMIC_STORAGE_BUFFER|Zr.DYNAMIC_UNIFORM_BUFFER;function ua(e){return e>0&&0==(e&e-1)}function ha(e,t,n,i){if(!aa[e].isCompressed)return t*n*i*aa[e].size;switch(e){case Tr.BC1:case Tr.BC1_ALPHA:case Tr.BC1_SRGB:case Tr.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Tr.BC2:case Tr.BC2_SRGB:case Tr.BC3:case Tr.BC3_SRGB:case Tr.BC4:case Tr.BC4_SNORM:case Tr.BC6H_SF16:case Tr.BC6H_UF16:case Tr.BC7:case Tr.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Tr.BC5:case Tr.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Tr.ETC_RGB8:case Tr.ETC2_RGB8:case Tr.ETC2_SRGB8:case Tr.ETC2_RGB8_A1:case Tr.EAC_R11:case Tr.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Tr.ETC2_RGBA8:case Tr.ETC2_SRGB8_A1:case Tr.EAC_RG11:case Tr.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Tr.PVRTC_RGB2:case Tr.PVRTC_RGBA2:case Tr.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Tr.PVRTC_RGB4:case Tr.PVRTC_RGBA4:case Tr.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Tr.ASTC_RGBA_4X4:case Tr.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Tr.ASTC_RGBA_5X4:case Tr.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Tr.ASTC_RGBA_5X5:case Tr.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_6X5:case Tr.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_6X6:case Tr.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_8X5:case Tr.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_8X6:case Tr.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_8X8:case Tr.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Tr.ASTC_RGBA_10X5:case Tr.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_10X6:case Tr.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_10X8:case Tr.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Tr.ASTC_RGBA_10X10:case Tr.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Tr.ASTC_RGBA_12X10:case Tr.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Tr.ASTC_RGBA_12X12:case Tr.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function _a(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=ha(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var fa=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function pa(e){return fa[e]||0}function da(e){var t=e.size/e.count;switch(e.type){case Er.UNORM:case Er.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Er.SNORM:case Er.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Er.FLOAT:return Float32Array}return Float32Array}var ma=Object.freeze({__proto__:null,get ObjectType(){return mr},get Status(){return vr},get API(){return gr},get SurfaceTransform(){return yr},get Feature(){return Sr},get Format(){return Tr},get FormatType(){return Er},get Type(){return xr},get BufferUsageBit(){return Ar},get BufferFlagBit(){return br},get MemoryAccessBit(){return Cr},get MemoryUsageBit(){return wr},get TextureType(){return Rr},get TextureUsageBit(){return Pr},get TextureFlagBit(){return Ir},get SampleCount(){return Or},get Filter(){return Dr},get Address(){return Nr},get ComparisonFunc(){return Mr},get StencilOp(){return Lr},get BlendFactor(){return Br},get BlendOp(){return Fr},get ColorMask(){return zr},get ShaderStageFlagBit(){return Ur},get LoadOp(){return kr},get StoreOp(){return Gr},get AccessType(){return Hr},get ResolveMode(){return Vr},get PipelineBindPoint(){return Wr},get PrimitiveMode(){return jr},get PolygonMode(){return Xr},get ShadeModel(){return qr},get CullMode(){return Yr},get DynamicStateFlagBit(){return Kr},get StencilFace(){return Qr},get DescriptorType(){return Zr},get QueueType(){return Jr},get CommandBufferType(){return $r},get ClearFlagBit(){return eo},Size:oo,DeviceCaps:ao,Offset:so,Rect:co,Extent:lo,TextureSubresLayers:uo,TextureSubresRange:ho,TextureCopy:_o,TextureBlit:fo,BufferTextureCopy:po,Viewport:mo,Color:vo,BindingMappingInfo:go,BufferInfo:yo,BufferViewInfo:So,DrawInfo:To,DispatchInfo:Eo,IndirectBuffer:xo,TextureInfo:Ao,TextureViewInfo:bo,SamplerInfo:Co,Uniform:wo,UniformBlock:Ro,UniformSamplerTexture:Po,UniformSampler:Io,UniformTexture:Oo,UniformStorageImage:Do,UniformStorageBuffer:No,UniformInputAttachment:Mo,ShaderStage:Lo,Attribute:Bo,ShaderInfo:Fo,InputAssemblerInfo:zo,ColorAttachment:Uo,DepthStencilAttachment:ko,SubpassInfo:Go,SubpassDependency:Ho,RenderPassInfo:Vo,GlobalBarrierInfo:Wo,TextureBarrierInfo:jo,FramebufferInfo:Xo,DescriptorSetLayoutBinding:qo,DescriptorSetLayoutInfo:Yo,DescriptorSetInfo:Ko,PipelineLayoutInfo:Qo,InputState:Zo,CommandBufferInfo:Jo,QueueInfo:$o,FormatInfo:ea,MemoryStatus:ta,DynamicStencilStates:na,DynamicStates:ia,Obj:ra,DeviceInfo:oa,get AttributeName(){return ro},FormatInfos:aa,DESCRIPTOR_BUFFER_TYPE:sa,DESCRIPTOR_SAMPLER_TYPE:ca,DESCRIPTOR_DYNAMIC_TYPE:la,DRAW_INFO_SIZE:28,IsPowerOf2:ua,FormatSize:ha,FormatSurfaceSize:_a,GetTypeSize:pa,getTypedArrayConstructor:da}),va=function(e){function t(t){var n;return(n=e.call(this,mr.BUFFER)||this)._device=void 0,n._usage=Ar.NONE,n._memUsage=wr.NONE,n._size=0,n._stride=1,n._count=0,n._flags=br.NONE,n._indirectBuffer=null,n._isBufferView=!1,n._device=t,n}return H(t,e),k(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(ra),ga=function(e){function t(t){var n;return(n=e.call(this,mr.COMMAND_BUFFER)||this)._device=void 0,n._queue=null,n._type=$r.PRIMARY,n._numDrawCalls=0,n._numInstances=0,n._numTris=0,n._device=t,n}return H(t,e),k(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(ra);et(Tr);var ya=function(){function e(){this._canvas=null,this._canvas2D=null,this._gfxAPI=gr.UNKNOWN,this._transform=yr.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Sr.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._colorFmt=Tr.UNKNOWN,this._depthStencilFmt=Tr.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ta,this._caps=new ao}return e.prototype.hasFeature=function(e){return this._features[e]},k(e,[{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"surfaceTransform",get:function(){return this._transform}}]),e}(),Sa=function(e){function t(t){var n;return(n=e.call(this,mr.FRAMEBUFFER)||this)._device=void 0,n._renderPass=null,n._colorTextures=[],n._depthStencilTexture=null,n._device=t,n}return H(t,e),k(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(ra),Ta=String.prototype.charCodeAt;function Ea(e){return this[e]}function xa(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?Ta:Ea;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Aa=function(e){function t(t){var n;return(n=e.call(this,mr.INPUT_ASSEMBLER)||this)._device=void 0,n._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._attributesHash=0,n._indirectBuffer=null,n._device=t,n}H(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return xa(e,666)},k(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),t}(ra),ba=function(e){function t(t){var n;return(n=e.call(this,mr.DESCRIPTOR_SET)||this)._device=void 0,n._layout=null,n._buffers=[],n._textures=[],n._samplers=[],n._isDirty=!1,n._device=t,n}H(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&sa){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ca){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ca){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},k(t,[{key:"layout",get:function(){return this._layout}}]),t}(ra),Ca=function(e){function t(t){var n;return(n=e.call(this,mr.DESCRIPTOR_SET_LAYOUT)||this)._device=void 0,n._bindings=[],n._bindingIndices=[],n._descriptorIndices=[],n._device=t,n}return H(t,e),k(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(ra),wa=function(e){function t(t){var n;return(n=e.call(this,mr.PIPELINE_LAYOUT)||this)._device=void 0,n._setLayouts=[],n._device=t,n}return H(t,e),k(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(ra),Ra=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Xr.FILL),void 0===n&&(n=qr.GOURAND),void 0===i&&(i=Yr.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Xr.FILL,this.shadeModel=qr.GOURAND,this.cullMode=Yr.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},k(e,[{key:"native",get:function(){return this}}]),e}(),Pa=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Mr.LESS),void 0===i&&(i=!1),void 0===r&&(r=Mr.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Lr.KEEP),void 0===c&&(c=Lr.KEEP),void 0===l&&(l=Lr.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Mr.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=Lr.KEEP),void 0===m&&(m=Lr.KEEP),void 0===v&&(v=Lr.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Mr.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Mr.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Lr.KEEP,this.stencilZFailOpFront=Lr.KEEP,this.stencilPassOpFront=Lr.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Mr.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Lr.KEEP,this.stencilZFailOpBack=Lr.KEEP,this.stencilPassOpBack=Lr.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},k(e,[{key:"native",get:function(){return this}}]),e}(),Ia=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Br.ONE),void 0===n&&(n=Br.ZERO),void 0===i&&(i=Fr.ADD),void 0===r&&(r=Br.ONE),void 0===o&&(o=Br.ZERO),void 0===a&&(a=Fr.ADD),void 0===s&&(s=zr.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Br.ONE,this.blendDst=Br.ZERO,this.blendEq=Fr.ADD,this.blendSrcAlpha=Br.ONE,this.blendDstAlpha=Br.ZERO,this.blendAlphaEq=Fr.ADD,this.blendColorMask=zr.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Oa=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new vo),void 0===i&&(i=[new Ia]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Ia),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},k(e,[{key:"native",get:function(){return this}}]),e}(),Da=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new Zo),void 0===r&&(r=new Ra),void 0===o&&(o=new Pa),void 0===a&&(a=new Oa),void 0===s&&(s=jr.TRIANGLE_LIST),void 0===c&&(c=Kr.NONE),void 0===l&&(l=Wr.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Na=function(e){function t(t){var n;return(n=e.call(this,mr.PIPELINE_STATE)||this)._device=void 0,n._shader=null,n._pipelineLayout=null,n._primitive=jr.TRIANGLE_LIST,n._is=null,n._rs=new Ra,n._dss=new Pa,n._bs=new Oa,n._dynamicStates=Kr.NONE,n._renderPass=null,n._device=t,n}return H(t,e),k(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(ra),Ma=function(e){function t(t){var n;return(n=e.call(this,mr.QUEUE)||this)._device=void 0,n._type=Jr.GRAPHICS,n._isAsync=!1,n._device=t,n}return H(t,e),t.prototype.isAsync=function(){return this._isAsync},k(t,[{key:"type",get:function(){return this._type}}]),t}(ra),La=function(e){function t(t){var n;return(n=e.call(this,mr.RENDER_PASS)||this)._device=void 0,n._colorInfos=[],n._depthStencilInfo=null,n._subpasses=[],n._hash=0,n._device=t,n}return H(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return xa(e,666)},k(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(ra),Ba=function(e){function t(t){var n;return(n=e.call(this,mr.SAMPLER)||this)._device=void 0,n._minFilter=Dr.LINEAR,n._magFilter=Dr.LINEAR,n._mipFilter=Dr.NONE,n._addressU=Nr.WRAP,n._addressV=Nr.WRAP,n._addressW=Nr.WRAP,n._maxAnisotropy=16,n._cmpFunc=Mr.NEVER,n._borderColor=new vo,n._mipLODBias=0,n._device=t,n}return H(t,e),k(t,[{key:"minFilter",get:function(){return this._minFilter}},{key:"magFilter",get:function(){return this._magFilter}},{key:"mipFilter",get:function(){return this._mipFilter}},{key:"addressU",get:function(){return this._addressU}},{key:"addressV",get:function(){return this._addressV}},{key:"addressW",get:function(){return this._addressW}},{key:"maxAnisotropy",get:function(){return this._maxAnisotropy}},{key:"cmpFunc",get:function(){return this._cmpFunc}},{key:"borderColor",get:function(){return this._borderColor}},{key:"mipLODBias",get:function(){return this._mipLODBias}}]),t}(ra),Fa=function(e){function t(n){var i;return(i=e.call(this,mr.SHADER)||this)._device=void 0,i._id=void 0,i._name="",i._stages=[],i._attributes=[],i._blocks=[],i._samplers=[],i._device=n,i._id=t._shaderIdGen++,i}return H(t,e),k(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(ra);Fa._shaderIdGen=0;var za=function(e){function t(t){var n;return(n=e.call(this,mr.TEXTURE)||this)._device=void 0,n._type=Rr.TEX2D,n._usage=Pr.NONE,n._format=Tr.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._layerCount=1,n._levelCount=1,n._samples=Or.X1,n._flags=Ir.NONE,n._isPowerOf2=!1,n._size=0,n._device=t,n}return H(t,e),k(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(ra),Ua=function(e){function t(t){var n;return(n=e.call(this,mr.GLOBAL_BARRIER)||this)._device=void 0,n._info=new Wo,n._device=t,n}return H(t,e),t.prototype.initialize=function(e){return this._info.copy(e),!0},t}(ra),ka=function(e){function t(t){var n;return(n=e.call(this,mr.TEXTURE_BARRIER)||this)._device=void 0,n._info=new jo,n._device=t,n}return H(t,e),t.prototype.initialize=function(e){return this._info.copy(e),!0},t}(ra),Ga={Device:ya,Buffer:va,Texture:za,Sampler:Ba,Shader:Fa,InputAssembler:Aa,RenderPass:La,Framebuffer:Sa,DescriptorSet:ba,DescriptorSetLayout:Ca,PipelineLayout:wa,PipelineState:Na,CommandBuffer:ga,Queue:Ma,GlobalBarrier:Ua,TextureBarrier:ka,RasterizerState:Ra,BlendState:Oa,BlendTarget:Ia,DepthStencilState:Pa,PipelineStateInfo:Da};Object.assign(Ga,ma),i.gfx=Ga;var Ha,Va={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var Wa in i.gfx)if("__esModule"!==Wa){var ja=Va[Wa];""===ja?ja=Wa:void 0===ja&&(ja="GFX"+Wa),mn(i,"cc",[{name:ja,newName:Wa,target:i.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:ba,Buffer:va,CommandBuffer:ga,get ObjectType(){return mr},get Status(){return vr},get API(){return gr},get SurfaceTransform(){return yr},get Feature(){return Sr},get Format(){return Tr},get FormatType(){return Er},get Type(){return xr},get BufferUsageBit(){return Ar},get BufferFlagBit(){return br},get MemoryAccessBit(){return Cr},get MemoryUsageBit(){return wr},get TextureType(){return Rr},get TextureUsageBit(){return Pr},get TextureFlagBit(){return Ir},get SampleCount(){return Or},get Filter(){return Dr},get Address(){return Nr},get ComparisonFunc(){return Mr},get StencilOp(){return Lr},get BlendFactor(){return Br},get BlendOp(){return Fr},get ColorMask(){return zr},get ShaderStageFlagBit(){return Ur},get LoadOp(){return kr},get StoreOp(){return Gr},get AccessType(){return Hr},get ResolveMode(){return Vr},get PipelineBindPoint(){return Wr},get PrimitiveMode(){return jr},get PolygonMode(){return Xr},get ShadeModel(){return qr},get CullMode(){return Yr},get DynamicStateFlagBit(){return Kr},get StencilFace(){return Qr},get DescriptorType(){return Zr},get QueueType(){return Jr},get CommandBufferType(){return $r},get ClearFlagBit(){return eo},Size:oo,DeviceCaps:ao,Offset:so,Rect:co,Extent:lo,TextureSubresLayers:uo,TextureSubresRange:ho,TextureCopy:_o,TextureBlit:fo,BufferTextureCopy:po,Viewport:mo,Color:vo,BindingMappingInfo:go,BufferInfo:yo,BufferViewInfo:So,DrawInfo:To,DispatchInfo:Eo,IndirectBuffer:xo,TextureInfo:Ao,TextureViewInfo:bo,SamplerInfo:Co,Uniform:wo,UniformBlock:Ro,UniformSamplerTexture:Po,UniformSampler:Io,UniformTexture:Oo,UniformStorageImage:Do,UniformStorageBuffer:No,UniformInputAttachment:Mo,ShaderStage:Lo,Attribute:Bo,ShaderInfo:Fo,InputAssemblerInfo:zo,ColorAttachment:Uo,DepthStencilAttachment:ko,SubpassInfo:Go,SubpassDependency:Ho,RenderPassInfo:Vo,GlobalBarrierInfo:Wo,TextureBarrierInfo:jo,FramebufferInfo:Xo,DescriptorSetLayoutBinding:qo,DescriptorSetLayoutInfo:Yo,DescriptorSetInfo:Ko,PipelineLayoutInfo:Qo,InputState:Zo,CommandBufferInfo:Jo,QueueInfo:$o,FormatInfo:ea,MemoryStatus:ta,DynamicStencilStates:na,DynamicStates:ia,Obj:ra,DeviceInfo:oa,get AttributeName(){return ro},FormatInfos:aa,DESCRIPTOR_BUFFER_TYPE:sa,DESCRIPTOR_SAMPLER_TYPE:ca,DESCRIPTOR_DYNAMIC_TYPE:la,DRAW_INFO_SIZE:28,IsPowerOf2:ua,FormatSize:ha,FormatSurfaceSize:_a,GetTypeSize:pa,getTypedArrayConstructor:da,Device:ya,Framebuffer:Sa,InputAssembler:Aa,DescriptorSetLayout:Ca,PipelineLayout:wa,RasterizerState:Ra,DepthStencilState:Pa,BlendTarget:Ia,BlendState:Oa,PipelineStateInfo:Da,PipelineState:Na,Queue:Ma,RenderPass:La,Sampler:Ba,Shader:Fa,Texture:za,GlobalBarrier:Ua,TextureBarrier:ka})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Ha||(Ha={}));var Xa,qa,Ya,Ka,Qa,Za,Ja,$a,es=(Xa=new Zn(0,0,0),function(e,t){var n=Zn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;Zn.multiplyScalar(Xa,t.n,t.d);var i=Zn.dot(Zn.subtract(Xa,Xa,e.o),t.n)/n;return i<0?0:i}),ts=(qa=new Zn(0,0,0),Ya=new Zn(0,0,0),Ka=new Zn(0,0,0),Qa=new Zn(0,0,0),Za=new Zn(0,0,0),function(e,t,n){Zn.subtract(qa,t.b,t.a),Zn.subtract(Ya,t.c,t.a),Zn.cross(Ka,e.d,Ya);var i=Zn.dot(qa,Ka);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Zn.subtract(Qa,e.o,t.a);var o=Zn.dot(Qa,Ka)*r;if(o<0||o>1)return 0;Zn.cross(Za,Qa,qa);var a=Zn.dot(e.d,Za)*r;if(a<0||o+a>1)return 0;var s=Zn.dot(Ya,Za)*r;return s<0?0:s}),ns=function(){var e=new Zn(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;Zn.subtract(e,r,o);var c=e.lengthSqr(),l=Zn.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),is=(Ja=new Zn,$a=new Zn,function(e,t){return Zn.subtract(Ja,t.center,t.halfExtents),Zn.add($a,t.center,t.halfExtents),rs(e,Ja,$a)});function rs(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var os,as,ss,cs,ls=function(){var e=new Zn,t=new Zn,n=new Zn,i=new Zn,r=new Zn,o=new Zn,a=new Zn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,Zn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),Zn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),Zn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),Zn.subtract(a,e,t),c[0]=Zn.dot(i,n),c[1]=Zn.dot(r,n),c[2]=Zn.dot(o,n),l[0]=Zn.dot(i,a),l[1]=Zn.dot(r,a),l[2]=Zn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),us=function(){var e=new Zn,t=new Zn,n=new Zn,i=new Zn,r=new Zn,o=new Zn,a=new Zn,s=new to;return function(c,l){var u=l.radius*l.radius,h=Zn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=Zn.subtract(t,f,_);if(p.equals(Zn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),Ys.raySphere(c,s);var d=c.o,m=Zn.subtract(n,d,_),v=Zn.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Zn.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ys.raySphere(c,s)}var S=Zn.cross(r,m,p),T=p.lengthSqr(),E=2*Zn.dot(v,S),x=E*E-4*g*(S.lengthSqr()-u*T);if(x<0)return 0;var A=(-E-Math.sqrt(x))/(2*g);if(A<0){s.radius=l.radius;var b=Zn.subtract(o,f,d);return m.lengthSqr()<b.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ys.raySphere(c,s)}var C=Zn.scaleAndAdd(o,c.o,h,A),w=Zn.subtract(a,C,_),R=Zn.dot(w,p)/T;return R>=0&&R<=1?A:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),Ys.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),Ys.raySphere(c,s)):0}}(),hs=(os=no.create(),as={distance:1/0,doubleSided:!1,mode:Ha.ANY},ss=0,cs=function(e,t,n,i,r,o){e===Ha.CLOSEST?(ss>t||0===ss)&&(ss=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(ss=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(ss=0,0===t.geometricInfo.positions.length)return ss;var i=void 0===n?as:n;if(rs(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===jr.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];Zn.set(os.a,e[s],e[s+1],e[s+2]),Zn.set(os.b,e[c],e[c+1],e[c+2]),Zn.set(os.c,e[l],e[l+1],e[l+2]);var u=Ys.rayTriangle(i,os,r.doubleSided);if(!(0===u||u>r.distance)&&(cs(r.mode,u,s,c,l,r.result),r.mode===Ha.ANY))return u}else if(n===jr.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var p=3*t[f-_],d=3*t[f+_+1],m=3*t[f+2];Zn.set(os.a,e[p],e[p+1],e[p+2]),Zn.set(os.b,e[d],e[d+1],e[d+2]),Zn.set(os.c,e[m],e[m+1],e[m+2]),_=~_;var v=Ys.rayTriangle(i,os,r.doubleSided);if(!(0===v||v>r.distance)&&(cs(r.mode,v,p,d,m,r.result),r.mode===Ha.ANY))return v}else if(n===jr.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];Zn.set(os.a,e[y],e[y+1],e[y+2]);for(var S=1;S<g;S+=1){var T=3*t[S],E=3*t[S+1];Zn.set(os.b,e[T],e[T+1],e[T+2]),Zn.set(os.c,e[E],e[E+1],e[E+2]);var x=Ys.rayTriangle(i,os,r.doubleSided);if(!(0===x||x>r.distance)&&(cs(r.mode,x,y,T,E,r.result),r.mode===Ha.ANY))return x}}}(o.positions,o.indices,r,e,i)}return ss}),_s=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ha.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!rs(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=hs(n,u,o);if(h)if(o.mode===Ha.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===Ha.ANY)return h}return e&&o.mode===Ha.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),fs=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ha.ANY},n=new ur,i=new _i;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!is(r,c))return e;ur.copy(n,r),o.node&&(_i.invert(i,o.node.getWorldMatrix(i)),Zn.transformMat4(n.o,r.o,i),Zn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=hs(n,h,s);if(_)if(s.mode===Ha.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===Ha.ANY)return _}return e&&s.mode===Ha.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),ps=function(){var e=new Zn(0,0,0);return function(t,n){Zn.subtract(e,t.e,t.s);var i=(n.d-Zn.dot(t.s,n.n))/Zn.dot(e,n.n);return i<0||i>1?0:i}}(),ds=function(){var e=new Zn(0,0,0),t=new Zn(0,0,0),n=new Zn(0,0,0),i=new Zn(0,0,0),r=new Zn(0,0,0),o=new Zn(0,0,0);return function(a,s,c){Zn.subtract(e,s.b,s.a),Zn.subtract(t,s.c,s.a),Zn.subtract(n,a.s,a.e),Zn.cross(r,e,t);var l=Zn.dot(n,r);if(l<=0)return 0;Zn.subtract(i,a.s,s.a);var u=Zn.dot(i,r);if(u<0||u>l)return 0;Zn.cross(o,n,i);var h=Zn.dot(t,o);if(h<0||h>l)return 0;var _=-Zn.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);Zn.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),ms=new ur;function vs(e,t){ms.o.set(e.s),Zn.subtract(ms.d,e.e,e.s),ms.d.normalize();var n=is(ms,t);return n<=e.length()?n:0}function gs(e,t){ms.o.set(e.s),Zn.subtract(ms.d,e.e,e.s),ms.d.normalize();var n=ls(ms,t);return n<=e.length()?n:0}function ys(e,t){ms.o.set(e.s),Zn.subtract(ms.d,e.e,e.s),ms.d.normalize();var n=ns(ms,t);return n<=e.length()?n:0}var Ss,Ts,Es,xs,As=(Ss=new Zn,Ts=new Zn,Es=new Zn,xs=new Zn,function(e,t){return Zn.subtract(Ss,e.center,e.halfExtents),Zn.add(Ts,e.center,e.halfExtents),Zn.subtract(Es,t.center,t.halfExtents),Zn.add(xs,t.center,t.halfExtents),Ss.x<=xs.x&&Ts.x>=Es.x&&Ss.y<=xs.y&&Ts.y>=Es.y&&Ss.z<=xs.z&&Ts.z>=Es.z});function bs(e,t,n,i,r,o){Zn.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),Zn.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),Zn.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),Zn.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),Zn.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),Zn.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),Zn.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),Zn.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Cs(e,t){for(var n=Zn.dot(t,e[0]),i=n,r=1;r<8;++r){var o=Zn.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var ws,Rs,Ps,Is=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Zn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Zn(0,0,0),i[r]=new Zn(0,0,0);var o=new Zn,a=new Zn;return function(t,r){Zn.set(e[0],1,0,0),Zn.set(e[1],0,1,0),Zn.set(e[2],0,0,1),Zn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Zn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Zn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Zn.cross(e[6+3*s],e[s],e[0]),Zn.cross(e[7+3*s],e[s],e[1]),Zn.cross(e[7+3*s],e[s],e[2]);Zn.subtract(o,t.center,t.halfExtents),Zn.add(a,t.center,t.halfExtents),function(e,t,n){Zn.set(n[0],e.x,t.y,t.z),Zn.set(n[1],e.x,t.y,e.z),Zn.set(n[2],e.x,e.y,t.z),Zn.set(n[3],e.x,e.y,e.z),Zn.set(n[4],t.x,t.y,t.z),Zn.set(n[5],t.x,t.y,e.z),Zn.set(n[6],t.x,e.y,t.z),Zn.set(n[7],t.x,e.y,e.z)}(o,a,n),bs(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Cs(n,e[c]),u=Cs(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Os=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=Zn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Ds=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Os(e,t.planes[n]))return 0;return 1},Ns=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new Zn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Os(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Zn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),Ms=(ws=new Zn(0,0,0),Rs=new ti,function(e,t){return Zn.subtract(ws,t,e.center),Zn.transformMat3(ws,ws,ti.transpose(Rs,e.orientation)),n=ws,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Ls=(Ps=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ps(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ps(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ps(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=Zn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),Bs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ls(e,t.planes[n]))return 0;return 1},Fs=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new Zn(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Ls(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Zn.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),zs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Zn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Zn(0,0,0),i[r]=new Zn(0,0,0);return function(t,r){Zn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),Zn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),Zn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),Zn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Zn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Zn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Zn.cross(e[6+3*o],e[o],e[3]),Zn.cross(e[7+3*o],e[o],e[4]),Zn.cross(e[8+3*o],e[o],e[5]);bs(t.center,t.halfExtents,e[0],e[1],e[2],n),bs(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Cs(n,e[a]),c=Cs(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Us=function(){for(var e=new to,t=new Zn,n=new Zn,i=new Zn,r=new Array(8),o=0;o<8;o++)r[o]=new Zn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Zn;return function(o,s){if(0===Zn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Ys.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,bs(o.center,o.halfExtents,t,n,i,r);var c=a,l=Zn.copy(c[0],t),u=Zn.copy(c[1],n),h=Zn.copy(c[2],i);Zn.subtract(c[3],s.center,o.center).normalize();var _=Zn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),Zn.cross(c[5],l,_),Zn.cross(c[6],u,_),Zn.cross(c[7],h,_);for(var f=0;f<8;++f){var p=Cs(r,c[f]),d=Zn.dot(c[f],s.ellipseCenter0),m=Zn.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),ks=function(e,t){var n=Zn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Gs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ks(e,t.planes[n]))return 0;return 1},Hs=function(){var e=new Zn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=Zn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Zn.add(e,s,Zn.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(Zn.dot(_.n,e)<_.d)return 0}}}return 1}}(),Vs=function(e,t){var n=e.radius+t.radius;return Zn.squaredDistance(e.center,t.center)<n*n},Ws=function(){var e=new Zn;return function(t,n){return or(e,t.center,n),Zn.squaredDistance(t.center,e)<t.radius*t.radius}}(),js=function(){var e=new Zn;return function(t,n){return ar(e,t.center,n),Zn.squaredDistance(t.center,e)<t.radius*t.radius}}(),Xs=function(){var e=new Zn,t=new Zn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=Zn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return Zn.squaredDistance(n.center,i.center)<o;Zn.subtract(e,n.center,i.ellipseCenter0),Zn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=Zn.dot(e,t)/a;return s<0?Zn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?Zn.squaredDistance(n.center,i.ellipseCenter1)<o:(Zn.scaleAndAdd(e,i.ellipseCenter0,t,s),Zn.squaredDistance(n.center,e)<o)}}(),qs=function(){var e=new Zn,t=new Zn,n=new Zn,i=new Zn,r=new Zn,o=new Zn;return function(a,s){var c,l,u=Zn.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=Zn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=Zn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=Zn.dot(u,u),p=Zn.dot(u,h),d=Zn.dot(h,h),m=Zn.dot(u,_),v=Zn.dot(h,_),g=f*d-p*p,y=g,S=g;g<wn?(c=0,y=1,l=v,S=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,S=d):c>y&&(c=y,l=v+p,S=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>S&&(l=S,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var T=Math.abs(c)<wn?0:c/y,E=Math.abs(l)<wn?0:l/S,x=i;x.set(_),x.add(Zn.multiplyScalar(r,u,T)),x.subtract(Zn.multiplyScalar(o,h,E));var A=a.radius+s.radius;return x.lengthSqr()<A*A}}(),Ys={raySphere:ns,rayAABB:is,rayOBB:ls,rayPlane:es,rayTriangle:ts,rayCapsule:us,raySubMesh:hs,rayMesh:_s,rayModel:fs,lineSphere:ys,lineAABB:vs,lineOBB:gs,linePlane:ps,lineTriangle:ds,sphereWithSphere:Vs,sphereAABB:Ws,sphereOBB:js,spherePlane:ks,sphereFrustum:Gs,sphereFrustumAccurate:Hs,sphereCapsule:Xs,aabbWithAABB:As,aabbWithOBB:Is,aabbPlane:Os,aabbFrustum:Ds,aabbFrustumAccurate:Ns,obbWithOBB:zs,obbPlane:Ls,obbFrustum:Bs,obbFrustumAccurate:Fs,obbPoint:Ms,obbCapsule:Us,capsuleWithCapsule:qs,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};Ys[cr.SHAPE_RAY|cr.SHAPE_SPHERE]=ns,Ys[cr.SHAPE_RAY|cr.SHAPE_AABB]=is,Ys[cr.SHAPE_RAY|cr.SHAPE_OBB]=ls,Ys[cr.SHAPE_RAY|cr.SHAPE_PLANE]=es,Ys[cr.SHAPE_RAY|cr.SHAPE_TRIANGLE]=ts,Ys[cr.SHAPE_RAY|cr.SHAPE_CAPSULE]=us,Ys[cr.SHAPE_LINE|cr.SHAPE_SPHERE]=ys,Ys[cr.SHAPE_LINE|cr.SHAPE_AABB]=vs,Ys[cr.SHAPE_LINE|cr.SHAPE_OBB]=gs,Ys[cr.SHAPE_LINE|cr.SHAPE_PLANE]=ps,Ys[cr.SHAPE_LINE|cr.SHAPE_TRIANGLE]=ds,Ys[cr.SHAPE_SPHERE]=Vs,Ys[cr.SHAPE_SPHERE|cr.SHAPE_AABB]=Ws,Ys[cr.SHAPE_SPHERE|cr.SHAPE_OBB]=js,Ys[cr.SHAPE_SPHERE|cr.SHAPE_PLANE]=ks,Ys[cr.SHAPE_SPHERE|cr.SHAPE_FRUSTUM]=Gs,Ys[cr.SHAPE_SPHERE|cr.SHAPE_FRUSTUM_ACCURATE]=Hs,Ys[cr.SHAPE_SPHERE|cr.SHAPE_CAPSULE]=Xs,Ys[cr.SHAPE_AABB]=As,Ys[cr.SHAPE_AABB|cr.SHAPE_OBB]=Is,Ys[cr.SHAPE_AABB|cr.SHAPE_PLANE]=Os,Ys[cr.SHAPE_AABB|cr.SHAPE_FRUSTUM]=Ds,Ys[cr.SHAPE_AABB|cr.SHAPE_FRUSTUM_ACCURATE]=Ns,Ys[cr.SHAPE_OBB]=zs,Ys[cr.SHAPE_OBB|cr.SHAPE_PLANE]=Ls,Ys[cr.SHAPE_OBB|cr.SHAPE_FRUSTUM]=Bs,Ys[cr.SHAPE_OBB|cr.SHAPE_FRUSTUM_ACCURATE]=Fs,Ys[cr.SHAPE_OBB|cr.SHAPE_CAPSULE]=Us,Ys[cr.SHAPE_CAPSULE]=qs,mn(lr.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),vn(Ys,"intersect",[{name:"line_quad"}]);var Ks,Qs,Zs,Js,$s,ec,tc,nc=new Zn(0,0,0),ic=new Zn(0,0,0),rc=i.mat4(),oc=i.v4(),ac=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=cr.SHAPE_PLANE,this.n=new Zn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return Zn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return Zn.subtract(nc,n,t),Zn.subtract(ic,i,t),Zn.normalize(e.n,Zn.cross(e.n,nc,ic)),e.d=Zn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return Zn.copy(e.n,t),e.d=Zn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return Zn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){_i.invert(rc,e),_i.transpose(rc,rc),Si.set(oc,this.n.x,this.n.y,this.n.z,this.d),Si.transformMat4(oc,oc,rc),Zn.set(this.n,oc.x,oc.y,oc.z),this.d=oc.w},k(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),sc=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(tc||(tc={}));var cc,lc,uc=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new sc(e,r,this._stride);var o=tc.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==tc.FLOAT32?s||o!==tc.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===tc.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(cc||(cc={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(lc||(lc={}));var hc,_c=((Ks={})[lc.DIRTY_FLAG]=tc.UINT32,Ks[lc.LAYER]=tc.UINT32,Ks[lc.WORLD_SCALE]=tc.FLOAT32,Ks[lc.WORLD_POSITION]=tc.FLOAT32,Ks[lc.WORLD_ROTATION]=tc.FLOAT32,Ks[lc.WORLD_MATRIX]=tc.FLOAT32,Ks[lc.LOCAL_SCALE]=tc.FLOAT32,Ks[lc.LOCAL_POSITION]=tc.FLOAT32,Ks[lc.LOCAL_ROTATION]=tc.FLOAT32,Ks[lc.COUNT]=tc.NEVER,Ks),fc=((Qs={})[lc.DIRTY_FLAG]=lc.LAYER-lc.DIRTY_FLAG,Qs[lc.LAYER]=lc.WORLD_SCALE-lc.LAYER,Qs[lc.WORLD_SCALE]=lc.WORLD_POSITION-lc.WORLD_SCALE,Qs[lc.WORLD_POSITION]=lc.WORLD_ROTATION-lc.WORLD_POSITION,Qs[lc.WORLD_ROTATION]=lc.WORLD_MATRIX-lc.WORLD_ROTATION,Qs[lc.WORLD_MATRIX]=lc.LOCAL_SCALE-lc.WORLD_MATRIX,Qs[lc.LOCAL_SCALE]=lc.LOCAL_POSITION-lc.LOCAL_SCALE,Qs[lc.LOCAL_POSITION]=lc.LOCAL_ROTATION-lc.LOCAL_POSITION,Qs[lc.LOCAL_ROTATION]=lc.COUNT-lc.LOCAL_ROTATION,Qs[lc.COUNT]=1,Qs),pc=new uc(cc.NODE,_c,fc,lc);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(hc||(hc={}));var dc,mc=((Zs={})[hc.PRIORITY]=tc.UINT32,Zs[hc.STAGE]=tc.UINT32,Zs[hc.PHASE]=tc.UINT32,Zs[hc.PRIMITIVE]=tc.UINT32,Zs[hc.BATCHING_SCHEME]=tc.UINT32,Zs[hc.DYNAMIC_STATE]=tc.UINT32,Zs[hc.HASH]=tc.UINT32,Zs[hc.COUNT]=tc.NEVER,Zs),vc=((Js={})[hc.PRIORITY]=hc.STAGE-hc.PRIORITY,Js[hc.STAGE]=hc.PHASE-hc.STAGE,Js[hc.PHASE]=hc.PRIMITIVE-hc.PHASE,Js[hc.PRIMITIVE]=hc.BATCHING_SCHEME-hc.PRIMITIVE,Js[hc.BATCHING_SCHEME]=hc.DYNAMIC_STATE-hc.BATCHING_SCHEME,Js[hc.DYNAMIC_STATE]=hc.HASH-hc.DYNAMIC_STATE,Js[hc.HASH]=hc.COUNT-hc.HASH,Js[hc.COUNT]=1,Js),gc=new uc(cc.PASS,mc,vc,hc);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(dc||(dc={}));var yc=(($s={})[dc.CENTER]=tc.FLOAT32,$s[dc.HALFEXTENTS]=tc.FLOAT32,$s[dc.COUNT]=tc.NEVER,$s),Sc=((ec={})[dc.CENTER]=dc.HALFEXTENTS-dc.CENTER,ec[dc.HALFEXTENTS]=dc.COUNT-dc.HALFEXTENTS,ec[dc.COUNT]=1,ec),Tc=new uc(cc.AABB,yc,Sc,dc),Ec=new Zn,xc=new Zn,Ac=new Zn,bc=new Zn,Cc=new ti,wc=function(e,t,n){Cc.m00=Math.abs(n.m00),Cc.m01=Math.abs(n.m01),Cc.m02=Math.abs(n.m02),Cc.m03=Math.abs(n.m04),Cc.m04=Math.abs(n.m05),Cc.m05=Math.abs(n.m06),Cc.m06=Math.abs(n.m08),Cc.m07=Math.abs(n.m09),Cc.m08=Math.abs(n.m10),Zn.transformMat3(e,t,Cc)},Rc=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=cr.SHAPE_AABB,this.center=new Zn(e,t,n),this.halfExtents=new Zn(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return Zn.copy(e.center,t.center),Zn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return Zn.add(Ec,n,t),Zn.subtract(xc,n,t),Zn.multiplyScalar(e.center,Ec,.5),Zn.multiplyScalar(e.halfExtents,xc,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return Zn.subtract(Ec,n.center,n.halfExtents),Zn.subtract(xc,i.center,i.halfExtents),Zn.add(Ac,n.center,n.halfExtents),Zn.add(bc,i.center,i.halfExtents),Zn.max(bc,Ac,bc),Zn.min(Ac,Ec,xc),e.fromPoints(t,Ac,bc)},e.toBoundingSphere=function(e,t){t.getBoundary(Ec,xc),e.center.set(Ec),e.radius=0,Zn.subtract(Ac,xc,e.center);var n=Ac.length(),i=.5*n;return e.radius+=i,Zn.multiplyScalar(Ac,Ac,i/n),Zn.add(e.center,e.center,Ac),e},e.transform=function(e,t,n){return Zn.transformMat4(e.center,t.center,n),wc(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){Zn.subtract(e,this.center,this.halfExtents),Zn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){Zn.transformMat4(r.center,this.center,e),wc(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Ec,xc),e.x<Ec.x&&(Ec.x=e.x),e.y<Ec.y&&(Ec.y=e.y),e.z<Ec.z&&(Ec.z=e.z),e.x>xc.x&&(xc.x=e.x),e.y>xc.y&&(xc.y=e.y),e.z>xc.z&&(xc.z=e.z),Zn.add(Ac,Ec,xc),this.center.set(Zn.multiplyScalar(Ac,Ac,.5)),this.halfExtents.set(xc.x-Ac.x,xc.y-Ac.y,xc.z-Ac.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},k(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Pc=new Zn,Ic=new Zn,Oc=new ti,Dc=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=cr.SHAPE_OBB,this.center=new Zn(e,t,n),this.halfExtents=new Zn(i,r,o),this.orientation=new ti(a,s,c,l,u,h,_,f,p)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return Zn.copy(e.center,t.center),Zn.copy(e.halfExtents,t.halfExtents),ti.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return Zn.multiplyScalar(e.center,Zn.add(Pc,t,n),.5),Zn.multiplyScalar(e.halfExtents,Zn.subtract(Ic,n,t),.5),ti.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return Zn.set(e.center,t,n,i),Zn.set(e.halfExtents,r,o,a),ti.set(e.orientation,s,c,l,u,h,_,f,p,d),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Oc.m00=Math.abs(n.m00),Oc.m01=Math.abs(n.m01),Oc.m02=Math.abs(n.m02),Oc.m03=Math.abs(n.m03),Oc.m04=Math.abs(n.m04),Oc.m05=Math.abs(n.m05),Oc.m06=Math.abs(n.m06),Oc.m07=Math.abs(n.m07),Oc.m08=Math.abs(n.m08),Zn.transformMat3(e,t,Oc)}(Pc,this.halfExtents,this.orientation),Zn.subtract(e,this.center,Pc),Zn.add(t,this.center,Pc)},t.transform=function(e,t,n,i,r){Zn.transformMat4(r.center,this.center,e),ti.fromQuat(r.orientation,n),Zn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){Zn.transformMat4(n.center,this.center,e),ti.fromQuat(n.orientation,t)},t.setScale=function(e,t){Zn.multiply(t.halfExtents,this.halfExtents,e)},k(e,[{key:"type",get:function(){return this._type}}]),e}(),Nc=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=cr.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new Zn,this.rotation=new ri,this.ellipseCenter0=new Zn(0,t,0),this.ellipseCenter1=new Zn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=jn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Zn.transformMat4(r.center,this.center,e),ri.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),Zn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Zn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},k(e,[{key:"type",get:function(){return this._type}}]),e}(),Mc=new Array(8);Mc[0]=new Zn(1,1,1),Mc[1]=new Zn(-1,1,1),Mc[2]=new Zn(-1,-1,1),Mc[3]=new Zn(1,-1,1),Mc[4]=new Zn(1,1,-1),Mc[5]=new Zn(-1,1,-1),Mc[6]=new Zn(-1,-1,-1),Mc[7]=new Zn(1,-1,-1);var Lc,Bc,Fc=new Zn,zc=new Zn,Uc=new Zn,kc=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=cr.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=ac.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Zn}e.createFromAABB=function(e,t){var n=new Zn,i=new Zn;return Zn.subtract(n,t.center,t.halfExtents),Zn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==cr.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;Fc.set(i*a,i*o,i),zc.set(r*a,r*o,r);var s=e.vertices;return Uc.set(Fc.x,Fc.y,Fc.z),Zn.transformMat4(s[0],Uc,n),Uc.set(-Fc.x,Fc.y,Fc.z),Zn.transformMat4(s[1],Uc,n),Uc.set(-Fc.x,-Fc.y,Fc.z),Zn.transformMat4(s[2],Uc,n),Uc.set(Fc.x,-Fc.y,Fc.z),Zn.transformMat4(s[3],Uc,n),Uc.set(zc.x,zc.y,zc.z),Zn.transformMat4(s[4],Uc,n),Uc.set(-zc.x,zc.y,zc.z),Zn.transformMat4(s[5],Uc,n),Uc.set(-zc.x,-zc.y,zc.z),Zn.transformMat4(s[6],Uc,n),Uc.set(zc.x,-zc.y,zc.z),Zn.transformMat4(s[7],Uc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)ac.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)Zn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(Zn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Zn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Zn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Zn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Zn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Zn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===cr.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Zn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)Zn.transformMat4(this.vertices[o],Mc[o],t)}},t.transform=function(e){if(this._type===cr.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Zn.transformMat4(this.vertices[t],this.vertices[t],e);ac.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),ac.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),ac.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),ac.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),ac.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),ac.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}},t.updatePlanes=function(){ac.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),ac.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),ac.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),ac.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),ac.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),ac.fromPoints(this.planes[5],this.vertices[7],this.vertices[6],this.vertices[5])},k(e,[{key:"accurate",set:function(e){this._type=e?cr.SHAPE_FRUSTUM_ACCURATE:cr.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();kc.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;Zn.set(Uc,a,s,i),Zn.transformMat4(e.vertices[0],Uc,o),Zn.set(Uc,-a,s,i),Zn.transformMat4(e.vertices[1],Uc,o),Zn.set(Uc,-a,-s,i),Zn.transformMat4(e.vertices[2],Uc,o),Zn.set(Uc,a,-s,i),Zn.transformMat4(e.vertices[3],Uc,o),Zn.set(Uc,a,s,r),Zn.transformMat4(e.vertices[4],Uc,o),Zn.set(Uc,-a,s,r),Zn.transformMat4(e.vertices[5],Uc,o),Zn.set(Uc,-a,-s,r),Zn.transformMat4(e.vertices[6],Uc,o),Zn.set(Uc,a,-s,r),Zn.transformMat4(e.vertices[7],Uc,o),ac.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),ac.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),ac.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),ac.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),ac.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),ac.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Lc||(Lc={})),function(e){e[e.Default=Lc.Default]="Default",e[e.Normal=Lc.Normal]="Normal",e[e.Reverse=Lc.Reverse]="Reverse",e[e.Loop=Lc.Loop]="Loop",e[e.LoopReverse=Lc.Loop|Lc.Reverse]="LoopReverse",e[e.PingPong=Lc.PingPong]="PingPong",e[e.PingPongReverse=Lc.PingPong|Lc.Reverse]="PingPongReverse"}(Bc||(Bc={})),et(Bc);var Gc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function Hc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}var Vc=function(){},Wc=function(){return Vc},jc=Xc((function(){}));function Xc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function qc(e){return function(t){return function(n){!function(e,t,n){var i=Kc(e);if(i){var r=Qc(i,"proto");Qc(r,"editor")[t]=n}}(n,e,t)}}}var Yc="__ccclassCache__";function Kc(e){return Qc(e,Yc)}function Qc(e,t){return e[t]||(e[t]={})}var Zc=Xc((function(e,t){var n=Ke.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[Yc];if(r){var o=r.proto;o&&Ke.mixin(i,o),e[Yc]=void 0}return Wt(i)})),Jc=qc("requireComponent"),$c=qc("executionOrder"),el=jc;function tl(e,t,n){var i=null;function r(e,t,n){var r=Kc(e.constructor);if(r){var o=Qc(r,"proto"),a=Qc(o,"properties");!function(e,t,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Mt(i,s));var c=t[n],l=Ke.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,r)}}return void 0===e?tl({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var nl=Symbol("cc:SerializationMetadata"),il=function(e,t,n){return tl(ol({}))(e,t,n)},rl=function(e,t,n){return tl({editorOnly:!0})(e,t,n)};function ol(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var al=Vc,sl=jc,cl=Wc,ll=jc,ul=Wc,hl=Wc,_l=Wc,fl=Vc,pl=Wc,dl=Wc,ml=Wc,vl=Wc,gl=Wc,yl=Wc,Sl=Wc,Tl=Vc,El=Wc,xl=Vc,Al=Vc,bl=Pl(At),Cl=Pl(bt),wl=Pl(Ct),Rl=Pl(wt);function Pl(e){return tl({type:e})}var Il,Ol,Dl,Nl,Ml,Ll,Bl,Fl,zl,Ul=function(e,t,n){return tl({__noImplicit:!0,override:!0})(e,t,n)},kl=Zc("cc.KeyframeCurve")((Il=Symbol.iterator,Ll=function(){function e(){Z(this,"_times",Nl,this),Z(this,"_values",Ml,this)}var t=e.prototype;return t[Il]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return Hc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return Hc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||Pn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=Hc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},k(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),Nl=J((Dl=Ll).prototype,"_times",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ml=J(Dl.prototype,"_values",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ol=Dl))||Ol;function Gl(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(Bl||(Bl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Fl||(Fl=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(zl||(zl=e("TangentWeightMode",{})));var Hl=Object,Vl=Object.freeze({__proto__:null,uniquelyReferenced:al,ccclass:Zc,property:tl,requireComponent:Jc,executionOrder:$c,disallowMultiple:el,executeInEditMode:sl,menu:cl,playOnFocus:ll,inspector:ul,icon:hl,help:_l,type:Pl,integer:bl,float:Cl,boolean:wl,string:Rl});e("_decorator",Vl);var Wl=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=Ke.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=Ke.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},k(e,[{key:"count",get:function(){return this._count}}]),e}(),jl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(A(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();jl._pipelineId=0,function(e){function t(t){var n;if((n=e.call(this)||this)._weakMap={},n._map=null,t)for(var i in t)n._weakMap[i]=new WeakRef(t[i]);return n}H(t,e);var n=t.prototype;n.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},n.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},n.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},n.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},n.clear=function(){this._weakMap=Ke.createMap(!0)},n.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},n.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},n.destroy=function(){this._weakMap={}},k(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}(Wl);var Xl,ql=new Wl,Yl=new Wl,Kl=new Wl,Ql=new Wl,Zl=new jl("normal load",[]),Jl=new jl("fetch",[]),$l=new jl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(Xl||(Xl={}));var eu,tu={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(eu||(eu={}));var nu=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();nu.MAX_DEAD_NUM=500,nu._taskId=0,nu._deadPool=[];var iu="0123456789abcdef".split(""),ru=["","","",""],ou=ru.concat(ru,"-",ru,"-",ru,"-",ru,"-",ru,ru,ru),au=ou.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function su(e){var t=e.split("@")[0];if(22!==t.length)return e;ou[0]=e[0],ou[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=st[e.charCodeAt(n)],o=st[e.charCodeAt(n+1)];ou[au[i++]]=iu[r>>2],ou[au[i++]]=iu[(3&r)<<2|o>>4],ou[au[i++]]=iu[15&o]}return e.replace(t,ou.join(""))}var cu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function lu(e){var t=cu.exec(e);return t?t[1]:""}function uu(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=Ql.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),fu(e,t)}function hu(e){return!!e&&(e instanceof i.SceneAsset||e instanceof i.Scene)}function _u(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function fu(e,t){var n=nu.create({input:e,options:t}),i=[];try{for(var r,o=Q($l.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=Q(n.output);!(c=l()).done;)c.value.recycle();d(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var pu=Object.freeze({__proto__:null,getUuidFromURL:lu,getUrlWithUuid:uu,isScene:hu,normalize:_u,transform:fu,decodeUuid:su}),du=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());du.NO_TYPE="no_type",du.TOUCH="touch",du.MOUSE="mouse",du.KEYBOARD="keyboard",du.ACCELERATION="acceleration",du.NONE=0,du.CAPTURING_PHASE=1,du.AT_TARGET=2,du.BUBBLING_PHASE=3,i.Event=du;var mu,vu,gu,yu,Su,Tu,Eu,xu,Au=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),bu=Zc("cc.GCObject")(mu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,Au.registerGCObject(Y(t))||Y(t)}H(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return Au.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(Zt))||mu,Cu=e("Asset",Zc("cc.Asset")((Su=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,Z(t,"_native",yu,Y(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(Y(t),"_uuid",{value:"",writable:!0}),t}H(t,e),t.deserialize=function(e){return i.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&i.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return v(I(12101,this._uuid)),e.prototype.destroy.call(this)},k(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=uu(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=uu(this._uuid,{__nativeName__:e,nativeExt:zi(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(cn(bu)),yu=J((gu=Su).prototype,"_native",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),J(gu.prototype,"_nativeAsset",[tl],Object.getOwnPropertyDescriptor(gu.prototype,"_nativeAsset"),gu.prototype),vu=gu))||vu);Cu.prototype.createNode=null,i.Asset=Cu;var wu=e("Script",Zc("cc.Script")(Tu=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(Cu))||Tu);i._Script=wu;var Ru=e("JavaScript",Zc("cc.JavaScript")(Eu=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(wu))||Eu);i._JavaScript=Ru;var Pu,Iu,Ou,Du,Nu,Mu,Lu,Bu,Fu,zu,Uu,ku=e("TypeScript",Zc("cc.TypeScript")(xu=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(wu))||xu);i._TypeScript=ku;var Gu,Hu,Vu,Wu,ju=new ce("Comp"),Xu=Zt.Flags.IsOnLoadCalled,qu=e("Component",(Pu=Zc("cc.Component"),Iu=dl(),Ou=Pl(wu),Du=ml(),Pu((Uu=zu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"node",Lu,Y(t)),Z(t,"_enabled",Bu,Y(t)),Z(t,"__prefab",Fu,Y(t)),t._sceneGetter=null,t._id=ju.getNewId(),t}H(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=i.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,r){void 0===t&&(t=0),void 0===n&&(n=i.macro.REPEAT_FOREVER),void 0===r&&(r=0),P(e,1619),P((t=t||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,r=r||0;var o=i.director.getScheduler(),a=o.isTargetPaused(this);o.schedule(e,this,t,n,r,a)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&i.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){i.director.getScheduler().unscheduleAllForTarget(this)},k(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Te(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=i.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Xu}}]),t}(Zt),zu.system=null,J((Mu=Uu).prototype,"__scriptAsset",[Iu,Ou,Du,Al],Object.getOwnPropertyDescriptor(Mu.prototype,"__scriptAsset"),Mu.prototype),Lu=J(Mu.prototype,"node",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bu=J(Mu.prototype,"_enabled",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fu=J(Mu.prototype,"__prefab",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nu=Mu))||Nu)),Yu=qu.prototype;Yu.update=null,Yu.lateUpdate=null,Yu.__preload=null,Yu.onLoad=null,Yu.start=null,Yu.onEnable=null,Yu.onDisable=null,Yu.onDestroy=null,Yu.onFocusInEditor=null,Yu.onLostFocusInEditor=null,Yu.resetInEditor=null,Yu._getLocalBounds=null,Yu.onRestore=null,qu._requireComponent=null,qu._executionOrder=0,me(qu,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),i.Component=qu;var Ku=e("MissingScript",Zc("cc.MissingScript")(Gu=ul()((Wu=function(e){function t(){var t;return Z(t=e.call(this)||this,"_$erialized",Vu,Y(t)),t}return H(t,e),t.safeFindClass=function(e){var t=We(e);if(t)return t;i.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){A(4600,this.node.name)},t}(qu),Vu=J((Hu=Wu).prototype,"_$erialized",[il,rl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gu=Hu))||Gu)||Gu);i._MissingScript=Ku;var Qu=e("serializeTag",Symbol("[[Serialize]]")),Zu=e("deserializeTag",Symbol("[[Deserialize]]")),Ju=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return k(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function $u(e){var t=e;return{chunks:t.chunks,document:t.document}}function eh(e){if(e.length<16)throw new th(I(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new th(I(13100));var n=t.getUint32(4,!0);if(1!==n)throw new th(I(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new th(I(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(I(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new th(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new th(I(13102));return new Ju(a,c)}var th=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(q(Error));function nh(e,t,n,r,o){if(t instanceof i.ValueType){o||e.push("if(prop){");var a=Te(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),o||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+r+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},k(e,[{key:"byteLength",get:function(){return this._length}}])}(),i.internal.parseCCONJson=$u,i.internal.decodeCCONBinary=eh,i.internal.CCON=Ju;var ih="$_$default",rh="$_$formerlySerializedAs",oh=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return H(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new ah(e,t,n,i,r)},t}(qe),ah=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof Ju?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===We&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,r){void 0===r&&(r=!1),r||!t[Zu]?t._deserialize?t._deserialize(e.content,this):i.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ne(n);r&&i._deserializeInto(e,t,r)}};t[Zu](r,this._context)},t._deserializeFireClass=function(e,t,n){var r;n.hasOwnProperty("__deserialize__")?r=n.__deserialize__:(r=function(e,t){for(var n=Tt(t),r=t.__values__,o=["var prop;"],a=it.test(Xe(t)),s=0;s<r.length;s++){var c=r[s],l=void 0,u=void 0;Wt.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=Wt.escapeForJS(c))+"]";var h=l;if(n[c+rh]){var _=n[c+rh];h=Wt.IDENTIFIER_RE.test(_)?"."+_:"["+Wt.escapeForJS(_)+"]"}o.push("prop=d"+h+";"),o.push('if(typeof prop!=="undefined"){');var f=Wt.getDefault(n[c+ih]);if(a){var p=void 0,d=n[c+"$_$type"];if(void 0===f&&d)p=d instanceof xt;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?o.push("o"+l+"=prop;"):nh(o,f,l,u,!0)}else o.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),nh(o,f,l,u,!1),o.push("}");o.push("}")}return(i.js.isChildClassOf(t,i._BaseNode)||i.js.isChildClassOf(t,i.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,n),me(n,"__deserialize__",r,!0)),r(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===i.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===i.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==i.Color){if(n===i.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=Tt(n),o=n.__values__,a=0;a<o.length;a++){var s=o[a],c=t[s];void 0!==c||t.hasOwnProperty(s)||(c=Wt.getDefault(r[s+ih])),"object"!=typeof c?e[s]=c:c?this._deserializeAndAssignField(e,c,s):e[s]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}},e}();ah.pool=new oh;var sh=[mi,Zn,Si,ri,Kn,xi,bi,_i];function ch(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var lh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},ch,ch,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){_i.fromArray(e,t,1)}],uh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function hh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,vh[u])(e,r,l,t[c])}return r}function _h(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):C(5303,Te(t)),i}function fh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function ph(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function dh(e,t,n,i){t[n]=null,e[8][i]=t}function mh(e,t,n,i){t[n]=hh(e,i)}uh.pool=new qe((function(e){e.reset()}),5),uh.pool.get=function(){return this._get()||new uh};var vh=new Array(13);function gh(e,t,n){return e||n(t),Object}function yh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||gh(o,i,a);return t[n]=r,new r}}(n,i,t));s=gh(o,t,a)}n[i]=s}function Sh(e,t,n,i){for(var r=n||We,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?yh(r,s[0],s,0,t,n,i):yh(r,s,o,a,t,n,i)}}function Th(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Eh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var r,o=!t;if(t=t||uh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof xh}return!1}(e)){t.init(e),n=n||{};var a,s=e[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(I(5304,s));n._version=s,n.result=t,e[0]=n,c||(Sh(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Eh.reportMissingClass),Th(e)),i.game._isCloning=!0;var l=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=hh(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=_h(e,h,u)}else(0,vh[l=~l])(e,t,a,u)}return r}(e);i.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],l,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),r=l[u]}else r=function(e,t,n){var r,o=(n=n||{}).classFinder||We,a=n.createAssetRefs||Ni.platform===F.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(r=n.reportMissingClass)&&void 0!==r?r:i.deserialize.reportMissingClass;t.init();var u=ah.pool.get(t,o,l,s,c);i.game._isCloning=!0;var h=u.deserialize(e);return i.game._isCloning=!1,ah.pool.put(u),a&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return o&&uh.pool.put(t),r}vh[0]=function(e,t,n,i){t[n]=i},vh[1]=fh,vh[2]=ph(fh),vh[3]=ph(dh),vh[4]=mh,vh[5]=function(e,t,n,i){lh[i[0]](t[n],i)},vh[6]=dh,vh[7]=function(e,t,n,i){t[n].set(i)},vh[8]=function(e,t,n,i){var r=new sh[i[0]];lh[i[0]](r,i),t[n]=r},vh[9]=ph(mh),vh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=_h(e,r,i[1])},vh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,vh[s])(e,r,a,c)}},vh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,vh[s])(e,r,o,a)}},Eh.Details=uh,Eh.reportMissingClass=function(e){A(5302,e)};var xh=function(e){this.preprocessed=!0,this.version=e};function Ah(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}i.deserialize=Eh;var bh,Ch,wh,Rh,Ph,Ih,Oh,Dh,Nh,Mh,Lh,Bh=Zt.Flags.Destroyed,Fh=Zt.Flags.PersistentMask,zh=[];function Uh(e){var t;if(e instanceof Zt){if(e._instantiate)return i.game._isCloning=!0,t=e._instantiate(null,!0),i.game._isCloning=!1,t;if(e instanceof i.Asset)throw new TypeError(I(6903))}return i.game._isCloning=!0,t=kh(e),i.game._isCloning=!1,t}function kh(e,t){var n;Gh(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=zh.length;i<r;++i)zh[i]._iN$t=null;return zh.length=0,n}function Gh(e,t,n){Ke.value(e,"_iN$t",t,!0),zh.push(e);var r=e.constructor;if(i.Class._isCCClass(r))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof tt&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Hh(s,i)}else n[a]=s}}(r,e,t,n);else for(var o in e)if(e.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o)){var a=e[o];if("object"==typeof a&&a){if(a===t)continue;t[o]=a._iN$t||Hh(a,n)}else t[o]=a}e instanceof Zt&&(t._objFlags&=Fh)}function Hh(e,t){if(e instanceof tt)return e.clone();if(e instanceof i.Asset)return e;var n;if(ArrayBuffer.isView(e)){var r=e.length;n=new e.constructor(r),e._iN$t=n,zh.push(e);for(var o=0;o<r;++o)n[o]=e[o];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,zh.push(e);for(var s=0;s<a;++s){var c=e[s];n[s]="object"==typeof c&&c?c._iN$t||Hh(c,t):c}return n}if(e._objFlags&Bh)return null;var l=e.constructor;if(i.Class._isCCClass(l)){if(t)if(t instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return e}else if(t instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof i.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return Gh(e,n,t),n}function Vh(e,t){return(t<<3)+e}function Wh(e){return Xh[e]}function jh(e){switch(e){case Mh.Uint8:return Uint8Array;case Mh.Uint16:return Uint16Array;case Mh.Uint32:return Uint32Array;case Mh.Int8:return Int8Array;case Mh.Int16:return Int16Array;case Mh.Int32:return Int32Array;case Mh.Float32:return Float32Array;case Mh.Float64:return Float64Array}}Uh._clone=kh,i.instantiate=Uh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Mh||(Mh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Lh||(Lh={})),e("CompactValueTypeArray",Zc("cc.CompactValueTypeArray")((Dh=Oh=function(){function e(){Z(this,"_byteOffset",wh,this),Z(this,"_unitCount",Rh,this),Z(this,"_unitElement",Ph,this),Z(this,"_length",Ih,this)}return e.lengthFor=function(e,t,n){return Wh(t).requiredUnits*e.length*jh(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=Wh(n),c=jh(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=Vh(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=Wh(n.elementType),o=new(jh(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Oh.StorageUnit=Mh,Oh.ElementType=Lh,wh=J((Ch=Dh).prototype,"_byteOffset",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rh=J(Ch.prototype,"_unitCount",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ph=J(Ch.prototype,"_unitElement",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vh(Mh.Uint8,Lh.Scalar)}}),Ih=J(Ch.prototype,"_length",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bh=Ch))||bh);var Xh=((Nh={})[Lh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Nh[Lh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new Zn(e[2*t],e[2*t+1])}},Nh[Lh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new Zn(e[3*t],e[3*t+1],e[3*t+2])}},Nh[Lh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Si(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Nh[Lh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new ri(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Nh[Lh.Mat4]={requiredUnits:16,compress:function(e,t,n){_i.toArray(e,n,16*t)},decompress:function(e,t){return _i.fromArray(new _i,e,16*t)}},Nh);function qh(){return 0}function Yh(e){return e}function Kh(e){return e*e}function Qh(e){return e*(2-e)}function Zh(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function Jh(e){return e*e*e}function $h(e){return--e*e*e+1}function e_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function t_(e){return e*e*e*e}function n_(e){return 1- --e*e*e*e}function i_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function r_(e){return e*e*e*e*e}function o_(e){return--e*e*e*e*e+1}function a_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function s_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function c_(e){return Math.sin(e*Math.PI/2)}function l_(e){return.5*(1-Math.cos(Math.PI*e))}function u_(e){return 0===e?0:Math.pow(1024,e-1)}function h_(e){return 1===e?1:1-Math.pow(2,-10*e)}function __(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function f_(e){return 1-Math.sqrt(1-e*e)}function p_(e){return Math.sqrt(1- --e*e)}function d_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function m_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function v_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function g_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function y_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function S_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function T_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function E_(e){return 1-x_(1-e)}function x_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function A_(e){return e<.5?.5*E_(2*e):.5*x_(2*e-1)+.5}function b_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function C_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}i._decorator=Vl;var w_=F_(Kh,Qh),R_=F_(Jh,$h),P_=F_(t_,n_),I_=F_(r_,o_),O_=F_(s_,c_),D_=F_(u_,h_),N_=F_(f_,p_),M_=F_(m_,v_),L_=F_(y_,S_),B_=F_(E_,x_);function F_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var z_,U_,k_=Object.freeze({__proto__:null,constant:qh,linear:Yh,quadIn:Kh,quadOut:Qh,quadInOut:Zh,cubicIn:Jh,cubicOut:$h,cubicInOut:e_,quartIn:t_,quartOut:n_,quartInOut:i_,quintIn:r_,quintOut:o_,quintInOut:a_,sineIn:s_,sineOut:c_,sineInOut:l_,expoIn:u_,expoOut:h_,expoInOut:__,circIn:f_,circOut:p_,circInOut:d_,elasticIn:m_,elasticOut:v_,elasticInOut:g_,backIn:y_,backOut:S_,backInOut:T_,bounceIn:E_,bounceOut:x_,bounceInOut:A_,smooth:b_,fade:C_,quadOutIn:w_,cubicOutIn:R_,quartOutIn:P_,quintOutIn:I_,sineOutIn:O_,expoOutIn:D_,circOutIn:N_,elasticOutIn:M_,backOutIn:L_,bounceOutIn:B_});e("easing",k_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(U_||(U_={}));var G_,H_,V_,W_,j_,X_=((z_={})[U_.CONSTANT]=qh,z_[U_.LINEAR]=Yh,z_[U_.QUAD_IN]=Kh,z_[U_.QUAD_OUT]=Qh,z_[U_.QUAD_IN_OUT]=Zh,z_[U_.QUAD_OUT_IN]=w_,z_[U_.CUBIC_IN]=Jh,z_[U_.CUBIC_OUT]=$h,z_[U_.CUBIC_IN_OUT]=e_,z_[U_.CUBIC_OUT_IN]=R_,z_[U_.QUART_IN]=t_,z_[U_.QUART_OUT]=n_,z_[U_.QUART_IN_OUT]=i_,z_[U_.QUART_OUT_IN]=P_,z_[U_.QUINT_IN]=r_,z_[U_.QUINT_OUT]=o_,z_[U_.QUINT_IN_OUT]=a_,z_[U_.QUINT_OUT_IN]=I_,z_[U_.SINE_IN]=s_,z_[U_.SINE_OUT]=c_,z_[U_.SINE_IN_OUT]=l_,z_[U_.SINE_OUT_IN]=O_,z_[U_.EXPO_IN]=u_,z_[U_.EXPO_OUT]=h_,z_[U_.EXPO_IN_OUT]=__,z_[U_.EXPO_OUT_IN]=D_,z_[U_.CIRC_IN]=f_,z_[U_.CIRC_OUT]=p_,z_[U_.CIRC_IN_OUT]=d_,z_[U_.CIRC_OUT_IN]=N_,z_[U_.ELASTIC_IN]=m_,z_[U_.ELASTIC_OUT]=v_,z_[U_.ELASTIC_IN_OUT]=g_,z_[U_.ELASTIC_OUT_IN]=M_,z_[U_.BACK_IN]=y_,z_[U_.BACK_OUT]=S_,z_[U_.BACK_IN_OUT]=T_,z_[U_.BACK_OUT_IN]=L_,z_[U_.BOUNCE_IN]=E_,z_[U_.BOUNCE_OUT]=x_,z_[U_.BOUNCE_IN_OUT]=A_,z_[U_.BOUNCE_OUT_IN]=B_,z_[U_.SMOOTH]=b_,z_[U_.FADE]=C_,z_);function q_(e){return X_[e]}var Y_,K_,Q_,Z_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=Bl.LINEAR,t.tangentWeightMode=zl.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=U_.LINEAR,t}return H(t,e),t}(Hl);function J_(e){var t=new Z_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[Yt];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[Yt]=u)}return t}Wt.fastDefine("cc.RealKeyframeValue",Z_,{interpolationMode:Bl.LINEAR,tangentWeightMode:zl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:U_.LINEAR}),Wt.Attr.setClassAttr(Z_,Yt,"editorOnly",!0),(Y_=Z_,null!==(Q_=(K_=Y_)[nl])&&void 0!==Q_?Q_:K_[nl]={}).uniquelyReferenced=!0;var $_,ef=e("RealCurve",Zc("cc.RealCurve")((j_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",V_,Y(t)),Z(t,"postExtrapolation",W_,Y(t)),t}H(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===Fl.CLAMP||i<2)return s.value;switch(a){case Fl.LINEAR:return vf(r,n[0].value,t[1],n[1].value,e);case Fl.LOOP:e=df(e,r,o);break;case Fl.PING_PONG:e=mf(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===Fl.CLAMP||i<2)return l.value;switch(c){case Fl.LINEAR:return vf(o,l.value,t[i-2],n[i-2].value,e);case Fl.LOOP:e=df(e,r,o);break;case Fl.PING_PONG:e=mf(e,r,o);break;default:return l.value}}var u=Hc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],p=n[_],d=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case Bl.CONSTANT:return t.value;case Bl.LINEAR:var a=t.easingMethod===U_.LINEAR?r:q_(t.easingMethod)(r);return Dn(t.value,i.value,a);case Bl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&zl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&zl.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+e,y=Math.sin(v)*p+t.value,S=0;if(f)S=_;else{var T=o,E=o*h;S=Math.sqrt(T*T+E*E)*s}var x=Math.atan(h),A=(g-e)/o,b=(-Math.cos(x)*S+n-e)/o,C=y,w=-Math.sin(x)*S+i.value,R=[0,0,0],P=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if(Gl(h)){if(Gl(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,S=0;S<_;++S)r[S]-=y;return _}(0-r,3*A,3*b-6*A,3*(A-b)+1,R),I=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(R,P,r);return gf(t.value,C,w,i.value,I)}var O=t.value+s*c*o,D=i.value-s*h*o;return gf(t.value,O,D,i.value,r)}}(f,p,d,n[h],(e-f)/(d-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,J_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return J_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return J_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return Pn(n.value,t,e)}))},n[Qu]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+tf+tf+nf+rf*r+_f*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=tf,o.setUint8(a,this.postExtrapolation),a+=tf,o.setUint32(a,r,!0),a+=nf,n.forEach((function(e,t){return o.setFloat32(a+rf*t,e,!0)})),a+=rf*r;for(var s,c=Q(i);!(s=c()).done;){var l=s.value;a=ff(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[Yt]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[Zu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=tf,this.postExtrapolation=i.getUint8(r),r+=tf;var o=i.getUint32(r,!0);r+=nf;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+rf*t,!0)}));r+=rf*o;for(var s=new Array(o),c=0;c<o;++c){var l=J_({});r=pf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][Yt]=e}))),this._times=a,this._values=s}else e.readThis()},t}(kl),V_=J((H_=j_).prototype,"preExtrapolation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fl.CLAMP}}),W_=J(H_.prototype,"postExtrapolation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fl.CLAMP}}),G_=H_))||G_);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}($_||($_={}));var tf=1,nf=4,rf=4,of=J_({}),af=of.interpolationMode,sf=of.tangentWeightMode,cf=of.leftTangent,lf=of.leftTangentWeight,uf=of.rightTangent,hf=of.rightTangentWeight,_f=26;function ff(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==af&&(i|=$_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==sf&&(i|=$_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==cf&&(i|=$_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==lf&&(i|=$_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==uf&&(i|=$_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==hf&&(i|=$_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function pf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&$_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&$_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&$_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&$_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&$_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&$_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function df(e,t,n){return t+Hn(e-t,n-t)}function mf(e,t,n){return t+Vn(e-t,n-t)}function vf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function gf(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function yf(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}i.bezier=yf;var Sf,Tf,Ef,xf,Af,bf,Cf,wf,Rf,Pf,If,Of=Math.cos,Df=Math.acos,Nf=Math.max,Mf=2*Math.PI,Lf=Math.sqrt;function Bf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Ff(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+a*h*27)/27,y=g/2,S=y*y+v*v*v;if(S<0){var T=-m*_,E=Lf(T*T*T),x=-g/(2*E),A=Df(x<-1?-1:x>1?1:x),b=2*Bf(E);return i=b*Of(A*_)-p,r=b*Of((A+Mf)*_)-p,o=b*Of((A+2*Mf)*_)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Nf(i,r,o):Nf(i,r):o>=0&&o<=1?Nf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Nf(r,o):r:o}if(0===S)return r=-(n=y<0?Bf(-y):-Bf(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?Nf(i,r):i:r;var C=Lf(S);return(n=Bf(-y+C))-Bf(y+C)-p}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}i.bezierByTime=Ff,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(If||(If=e("QuatInterpolationMode",{})));var zf=Zc("cc.QuatKeyframeValue")(Sf=al((Ef=J((Tf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;Z(this,"interpolationMode",Ef,this),Z(this,"value",xf,this),Z(this,"easingMethod",Af,this),this.value=n?ri.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return If.SLERP}}),xf=J(Tf.prototype,"value",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ri.clone(ri.IDENTITY)}}),Af=J(Tf.prototype,"easingMethod",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U_.LINEAR}}),Sf=Tf))||Sf)||Sf;function Uf(e){return new zf(e)}var kf,Gf=e("QuatCurve",Zc("cc.QuatCurve")((Pf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",wf,Y(t)),Z(t,"postExtrapolation",Rf,Y(t)),t}H(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new ri);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case Fl.LOOP:e=c+Hn(e-c,l-c);break;case Fl.PING_PONG:e=c+Vn(e-c,l-c);break;case Fl.CLAMP:default:return ri.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case Fl.LOOP:e=c+Hn(e-c,l-c);break;case Fl.PING_PONG:e=c+Vn(e-c,l-c);break;case Fl.CLAMP:default:return ri.copy(t,h.value)}}var _=Hc(i,e);if(_>=0)return ri.copy(t,r[_].value);var f=~_,p=f-1,d=i[p],m=r[p],v=i[f],g=r[f],y=(e-d)/(v-d);switch(m.interpolationMode){default:case If.CONSTANT:return ri.copy(t,m.value);case If.SLERP:var S=m.easingMethod,T=S===U_.LINEAR?y:Array.isArray(S)?Ff(S,y):q_(S)(y);return ri.slerp(t,m.value,g.value,T)}},n.addKeyFrame=function(t,n){var i=new zf(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Uf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Uf(e[1])})))}},n[Qu]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=Jf*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?$f+4*tp:$f)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Yf+Kf+Qf*o+4*Zf*o+s+a+0)),u=0,h=0;r&&(h|=kf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Yf,l.setUint32(u,o,!0),u+=Kf,n.forEach((function(e,t){return l.setFloat32(u+Qf*t,e,!0)})),u+=Qf*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*Zf*t;l.setFloat32(s+0*Zf,i,!0),l.setFloat32(s+1*Zf,r,!0),l.setFloat32(s+2*Zf,o,!0),l.setFloat32(s+3*Zf,a,!0)})),u+=4*Zf*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,ep),++u,l.setFloat32(u+0*tp,t[0],!0),l.setFloat32(u+1*tp,t[1],!0),l.setFloat32(u+2*tp,t[2],!0),l.setFloat32(u+3*tp,t[3],!0),u+=4*tp):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=Jf)}));var p=new Uint8Array(l.buffer);e.writeProperty("bytes",p)}else e.writeThis()},n[Zu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=Yf;var a=o&kf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=Kf;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+Qf*t,!0)})),l=r+=Qf*s;r+=4*Zf*s;var u=Array.from({length:s},(function(e,t){var n=l+4*Zf*t,o=i.getFloat32(n+0*Zf,!0),a=i.getFloat32(n+1*Zf,!0),s=i.getFloat32(n+2*Zf,!0),c=i.getFloat32(n+3*Zf,!0),u=i.getUint8(r);++r;var h=Uf({value:{x:o,y:a,z:s,w:c}});return u!==ep?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*tp,!0),i.getFloat32(r+1*tp,!0),i.getFloat32(r+2*tp,!0),i.getFloat32(r+3*tp,!0)],r+=4*tp),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=i.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else e.readThis()},t}(kl),wf=J((Cf=Pf).prototype,"preExtrapolation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fl.CLAMP}}),Rf=J(Cf.prototype,"postExtrapolation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fl.CLAMP}}),bf=Cf))||bf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(kf||(kf={}));var Hf,Vf,Wf,jf,Xf,qf,Yf=1,Kf=4,Qf=4,Zf=4,Jf=1,$f=1,ep=255,tp=4,np=e("ObjectCurve",Zc("cc.ObjectCurve")(Hf=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=In(~t-1,0,this._values.length-1);return this._values[n]},t}(kl))||Hf),ip=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Wt.fastDefine("cc.Keyframe",ip,{time:0,value:0,inTangent:0,outTangent:0});var rp=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),op=Zc("cc.AnimationCurve")((qf=Xf=function(){function e(e){if(void 0===e&&(e=null),Z(this,"_curve",jf,this),this.cachedKey=void 0,e instanceof ef)this._curve=e;else{var t=new ef;this._curve=t,t.preExtrapolation=Fl.LOOP,t.postExtrapolation=Fl.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Bl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:Bl.CUBIC,value:1}],[1,{interpolationMode:Bl.CUBIC,value:1}]])}this.cachedKey=new rp}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:Bl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Fl.LOOP:r=Hn(e-a,s-a)+a;break;case Fl.PING_PONG:r=Vn(e-a,s-a)+a;break;case Fl.CLAMP:default:r=In(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),p=s*h,d=u*h;e.coefficient[0]=(p+d-_-_)*f/h,e.coefficient[1]=(_+_+_-p-p-d)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},k(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new ip;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Bl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return sp(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=ap(e)}},{key:"postWrapMode",get:function(){return sp(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=ap(e)}}]),e}(),Xf.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],jf=J((Wf=qf).prototype,"_curve",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vf=Wf))||Vf;function ap(e){switch(e){default:case Lc.Default:case Lc.Normal:case Lc.Clamp:return Fl.CLAMP;case Lc.PingPong:return Fl.PING_PONG;case Lc.Loop:return Fl.LOOP}}function sp(e){switch(e){default:case Fl.LINEAR:case Fl.CLAMP:return Lc.Clamp;case Fl.PING_PONG:return Lc.PingPong;case Fl.LOOP:return Lc.Loop}}function cp(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}mn(Ys,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var lp=function(e){function t(){var t;return t=e.call(this)||this,cp("line","Line"),t}return H(t,e),t}(lr),up=function(e){function t(){var t;return t=e.call(this)||this,cp("plane","Plane"),t}return H(t,e),t}(ac),hp=function(e){function t(){var t;return t=e.call(this)||this,cp("ray","Ray"),t}return H(t,e),t}(ur),_p=function(e){function t(){var t;return t=e.call(this)||this,cp("triangle","Triangle"),t}return H(t,e),t}(no),fp=function(e){function t(){var t;return t=e.call(this)||this,cp("sphere","Sphere"),t}return H(t,e),t}(to),pp=function(e){function t(){var t;return t=e.call(this)||this,cp("aabb","AABB"),t}return H(t,e),t}(Rc),dp=function(e){function t(){var t;return t=e.call(this)||this,cp("obb","OBB"),t}return H(t,e),t}(Dc),mp=function(e){function t(){var t;return t=e.call(this)||this,cp("capsule","Capsule"),t}return H(t,e),t}(Nc),vp=function(e){function t(){var t;return t=e.call(this)||this,cp("frustum","Frustum"),t}return H(t,e),t}(kc),gp=Object.freeze({__proto__:null,distance:sr,enums:cr,intersect:Ys,Line:lr,Plane:ac,Ray:ur,Triangle:no,Sphere:to,AABB:Rc,OBB:Dc,Capsule:Nc,Frustum:kc,Keyframe:ip,AnimationCurve:op,get ERaycastMode(){return Ha},line:lp,plane:up,ray:hp,triangle:_p,sphere:fp,aabb:pp,obb:dp,capsule:mp,frustum:vp});e("geometry",gp);var yp={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Sp=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=Q(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){void 0!==n?n>19||n<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<n,e.Enum[n]=t,e.BitMask[t]=1<<n,e.BitMask[n]=t):console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):hn(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[t]},e}());Sp.Enum=Ze(yp),Sp.BitMask=Qe(G({},yp)),i.Layers=Sp;var Tp,Ep,xp="GbufferFlow",Ap="LightingFlow",bp="ForwardFlow",Cp="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Tp||(Tp={})),i.RenderPassStage=Tp,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Ep||(Ep={}));var wp,Rp={bindings:[],layouts:{}},Pp={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",e[e.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",e[e.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",e[e.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",e[e.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",e[e.COUNT=11]="COUNT"}(wp||(wp={}));var Ip,Op=wp.SAMPLER_SHADOWMAP,Dp=wp.COUNT-Op;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=11]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=12]="STORAGE_REFLECTION",e[e.COUNT=13]="COUNT"}(Ip||(Ip={}));var Np,Mp=Ip.SAMPLER_JOINTS,Lp=Ip.COUNT-Mp;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Np||(Np={}));var Bp=new go;Bp.bufferOffsets=[0,Op+Mp,Op],Bp.samplerOffsets=[-Op,Dp+Lp,Dp-Mp],Bp.flexibleSet=1;var Fp=function(){};Fp.SIZE=4*(Fp.COUNT=4+(Fp.SCREEN_SIZE_OFFSET=4+(Fp.NATIVE_SIZE_OFFSET=4+(Fp.TIME_OFFSET=0)))),Fp.NAME="CCGlobal",Fp.BINDING=wp.UBO_GLOBAL,Fp.DESCRIPTOR=new qo(Fp.BINDING,Zr.UNIFORM_BUFFER,1,Ur.ALL),Fp.LAYOUT=new Ro(Np.GLOBAL,Fp.BINDING,Fp.NAME,[new wo("cc_time",xr.FLOAT4,1),new wo("cc_screenSize",xr.FLOAT4,1),new wo("cc_nativeSize",xr.FLOAT4,1)],1),Rp.layouts[Fp.NAME]=Fp.LAYOUT,Rp.bindings[Fp.BINDING]=Fp.DESCRIPTOR;var zp=function(){};zp.SIZE=4*(zp.COUNT=4+(zp.GLOBAL_FOG_ADD_OFFSET=4+(zp.GLOBAL_FOG_BASE_OFFSET=4+(zp.GLOBAL_FOG_COLOR_OFFSET=4+(zp.AMBIENT_GROUND_OFFSET=4+(zp.AMBIENT_SKY_OFFSET=4+(zp.MAIN_LIT_COLOR_OFFSET=4+(zp.MAIN_LIT_DIR_OFFSET=4+(zp.EXPOSURE_OFFSET=4+(zp.SCREEN_SCALE_OFFSET=4+(zp.CAMERA_POS_OFFSET=16+(zp.MAT_VIEW_PROJ_INV_OFFSET=16+(zp.MAT_VIEW_PROJ_OFFSET=16+(zp.MAT_PROJ_INV_OFFSET=16+(zp.MAT_PROJ_OFFSET=16+(zp.MAT_VIEW_INV_OFFSET=16+(zp.MAT_VIEW_OFFSET=0))))))))))))))))),zp.NAME="CCCamera",zp.BINDING=wp.UBO_CAMERA,zp.DESCRIPTOR=new qo(zp.BINDING,Zr.UNIFORM_BUFFER,1,Ur.ALL),zp.LAYOUT=new Ro(Np.GLOBAL,zp.BINDING,zp.NAME,[new wo("cc_matView",xr.MAT4,1),new wo("cc_matViewInv",xr.MAT4,1),new wo("cc_matProj",xr.MAT4,1),new wo("cc_matProjInv",xr.MAT4,1),new wo("cc_matViewProj",xr.MAT4,1),new wo("cc_matViewProjInv",xr.MAT4,1),new wo("cc_cameraPos",xr.FLOAT4,1),new wo("cc_screenScale",xr.FLOAT4,1),new wo("cc_exposure",xr.FLOAT4,1),new wo("cc_mainLitDir",xr.FLOAT4,1),new wo("cc_mainLitColor",xr.FLOAT4,1),new wo("cc_ambientSky",xr.FLOAT4,1),new wo("cc_ambientGround",xr.FLOAT4,1),new wo("cc_fogColor",xr.FLOAT4,1),new wo("cc_fogBase",xr.FLOAT4,1),new wo("cc_fogAdd",xr.FLOAT4,1)],1),Rp.layouts[zp.NAME]=zp.LAYOUT,Rp.bindings[zp.BINDING]=zp.DESCRIPTOR;var Up=function(){};Up.SIZE=4*(Up.COUNT=4+(Up.SHADOW_COLOR_OFFSET=4+(Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Up.SHADOW_PROJ_INFO_OFFSET=4+(Up.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Up.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Up.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Up.MAT_LIGHT_VIEW_OFFSET=16+(Up.MAT_LIGHT_PLANE_PROJ_OFFSET=0))))))))))),Up.NAME="CCShadow",Up.BINDING=wp.UBO_SHADOW,Up.DESCRIPTOR=new qo(Up.BINDING,Zr.UNIFORM_BUFFER,1,Ur.ALL),Up.LAYOUT=new Ro(Np.GLOBAL,Up.BINDING,Up.NAME,[new wo("cc_matLightPlaneProj",xr.MAT4,1),new wo("cc_matLightView",xr.MAT4,1),new wo("cc_matLightViewProj",xr.MAT4,1),new wo("cc_shadowInvProjDepthInfo",xr.FLOAT4,1),new wo("cc_shadowProjDepthInfo",xr.FLOAT4,1),new wo("cc_shadowProjInfo",xr.FLOAT4,1),new wo("cc_shadowNFLSInfo",xr.FLOAT4,1),new wo("cc_shadowWHPBInfo",xr.FLOAT4,1),new wo("cc_shadowLPNNInfo",xr.FLOAT4,1),new wo("cc_shadowColor",xr.FLOAT4,1)],1),Rp.layouts[Up.NAME]=Up.LAYOUT,Rp.bindings[Up.BINDING]=Up.DESCRIPTOR;var kp=wp.SAMPLER_SHADOWMAP,Gp=new qo(kp,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Hp=new Po(Np.GLOBAL,kp,"cc_shadowMap",xr.SAMPLER2D,1);Rp.layouts.cc_shadowMap=Hp,Rp.bindings[kp]=Gp;var Vp=wp.SAMPLER_GBUFFER_ALBEDOMAP,Wp=new qo(Vp,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),jp=new Po(Np.GLOBAL,Vp,"cc_gbuffer_albedoMap",xr.SAMPLER2D,1);Rp.layouts.cc_gbuffer_albedoMap=jp,Rp.bindings[Vp]=Wp;var Xp=wp.SAMPLER_GBUFFER_POSITIONMAP,qp=new qo(Xp,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Yp=new Po(Np.GLOBAL,Xp,"cc_gbuffer_positionMap",xr.SAMPLER2D,1);Rp.layouts.cc_gbuffer_positionMap=Yp,Rp.bindings[Xp]=qp;var Kp=wp.SAMPLER_GBUFFER_NORMALMAP,Qp=new qo(Kp,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Zp=new Po(Np.GLOBAL,Kp,"cc_gbuffer_normalMap",xr.SAMPLER2D,1);Rp.layouts.cc_gbuffer_normalMap=Zp,Rp.bindings[Kp]=Qp;var Jp=wp.SAMPLER_LIGHTING_RESULTMAP,$p=new qo(Jp,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),ed=new Po(Np.GLOBAL,Jp,"cc_lighting_resultMap",xr.SAMPLER2D,1);Rp.layouts.cc_lighting_resultMap=ed,Rp.bindings[Jp]=$p;var td=wp.SAMPLER_GBUFFER_EMISSIVEMAP,nd=new qo(td,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),id=new Po(Np.GLOBAL,td,"cc_gbuffer_emissiveMap",xr.SAMPLER2D,1);Rp.layouts.cc_gbuffer_emissiveMap=id,Rp.bindings[td]=nd;var rd=wp.SAMPLER_ENVIRONMENT,od=new qo(rd,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),ad=new Po(Np.GLOBAL,rd,"cc_environment",xr.SAMPLER_CUBE,1);Rp.layouts.cc_environment=ad,Rp.bindings[rd]=od;var sd=wp.SAMPLER_SPOT_LIGHTING_MAP,cd=new qo(sd,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),ld=new Po(Np.GLOBAL,sd,"cc_spotLightingMap",xr.SAMPLER2D,1);Rp.layouts.cc_spotLightingMap=ld,Rp.bindings[sd]=cd;var ud=function(){};ud.SIZE=4*(ud.COUNT=4+(ud.LIGHTINGMAP_UVPARAM=16+(ud.MAT_WORLD_IT_OFFSET=16+(ud.MAT_WORLD_OFFSET=0)))),ud.NAME="CCLocal",ud.BINDING=Ip.UBO_LOCAL,ud.DESCRIPTOR=new qo(ud.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX|Ur.COMPUTE),ud.LAYOUT=new Ro(Np.LOCAL,ud.BINDING,ud.NAME,[new wo("cc_matWorld",xr.MAT4,1),new wo("cc_matWorldIT",xr.MAT4,1),new wo("cc_lightingMapUVParam",xr.FLOAT4,1)],1),Pp.layouts[ud.NAME]=ud.LAYOUT,Pp.bindings[ud.BINDING]=ud.DESCRIPTOR;var hd="a_matWorld0",_d=function(){};_d.BATCHING_COUNT=10,_d.MAT_WORLDS_OFFSET=0,_d.SIZE=4*(_d.COUNT=16*_d.BATCHING_COUNT),_d.NAME="CCLocalBatched",_d.BINDING=Ip.UBO_LOCAL,_d.DESCRIPTOR=new qo(_d.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX|Ur.COMPUTE),_d.LAYOUT=new Ro(Np.LOCAL,_d.BINDING,_d.NAME,[new wo("cc_matWorlds",xr.MAT4,_d.BATCHING_COUNT)],1),Pp.layouts[_d.NAME]=_d.LAYOUT,Pp.bindings[_d.BINDING]=_d.DESCRIPTOR;var fd=function(){};fd.LIGHTS_PER_PASS=1,fd.SIZE=4*(fd.COUNT=(fd.LIGHT_DIR_OFFSET=(fd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(fd.LIGHT_COLOR_OFFSET=(fd.LIGHT_POS_OFFSET=0)+4*fd.LIGHTS_PER_PASS)+4*fd.LIGHTS_PER_PASS)+4*fd.LIGHTS_PER_PASS)+4*fd.LIGHTS_PER_PASS),fd.NAME="CCForwardLight",fd.BINDING=Ip.UBO_FORWARD_LIGHTS,fd.DESCRIPTOR=new qo(fd.BINDING,Zr.DYNAMIC_UNIFORM_BUFFER,1,Ur.FRAGMENT),fd.LAYOUT=new Ro(Np.LOCAL,fd.BINDING,fd.NAME,[new wo("cc_lightPos",xr.FLOAT4,fd.LIGHTS_PER_PASS),new wo("cc_lightColor",xr.FLOAT4,fd.LIGHTS_PER_PASS),new wo("cc_lightSizeRangeAngle",xr.FLOAT4,fd.LIGHTS_PER_PASS),new wo("cc_lightDir",xr.FLOAT4,fd.LIGHTS_PER_PASS)],1),Pp.layouts[fd.NAME]=fd.LAYOUT,Pp.bindings[fd.BINDING]=fd.DESCRIPTOR;var pd=function(){};pd.LIGHTS_PER_PASS=10;var dd=function(){};dd.SIZE=4*(dd.COUNT=4+(dd.JOINTS_TEXTURE_INFO_OFFSET=0)),dd.NAME="CCSkinningTexture",dd.BINDING=Ip.UBO_SKINNING_TEXTURE,dd.DESCRIPTOR=new qo(dd.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX),dd.LAYOUT=new Ro(Np.LOCAL,dd.BINDING,dd.NAME,[new wo("cc_jointTextureInfo",xr.FLOAT4,1)],1),Pp.layouts[dd.NAME]=dd.LAYOUT,Pp.bindings[dd.BINDING]=dd.DESCRIPTOR;var md=function(){};md.SIZE=4*(md.COUNT=4+(md.JOINTS_ANIM_INFO_OFFSET=0)),md.NAME="CCSkinningAnimation",md.BINDING=Ip.UBO_SKINNING_ANIMATION,md.DESCRIPTOR=new qo(md.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX),md.LAYOUT=new Ro(Np.LOCAL,md.BINDING,md.NAME,[new wo("cc_jointAnimInfo",xr.FLOAT4,1)],1),Pp.layouts[md.NAME]=md.LAYOUT,Pp.bindings[md.BINDING]=md.DESCRIPTOR;var vd=function(){};vd.SIZE=4*(vd.COUNT=360+(vd.JOINTS_OFFSET=0)),vd.NAME="CCSkinning",vd.BINDING=Ip.UBO_SKINNING_TEXTURE,vd.DESCRIPTOR=new qo(vd.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX),vd.LAYOUT=new Ro(Np.LOCAL,vd.BINDING,vd.NAME,[new wo("cc_joints",xr.FLOAT4,90)],1),Pp.layouts[vd.NAME]=vd.LAYOUT,Pp.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd=function(){};gd.MAX_MORPH_TARGET_COUNT=60,gd.OFFSET_OF_WEIGHTS=0,gd.OFFSET_OF_VERTICES_COUNT=4+(gd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(gd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*gd.MAX_MORPH_TARGET_COUNT)),gd.COUNT_BASE_4_BYTES=4*Math.ceil(gd.MAX_MORPH_TARGET_COUNT/4)+4,gd.SIZE=4*gd.COUNT_BASE_4_BYTES,gd.NAME="CCMorph",gd.BINDING=Ip.UBO_MORPH,gd.DESCRIPTOR=new qo(gd.BINDING,Zr.UNIFORM_BUFFER,1,Ur.VERTEX),gd.LAYOUT=new Ro(Np.LOCAL,gd.BINDING,gd.NAME,[new wo("cc_displacementWeights",xr.FLOAT4,gd.MAX_MORPH_TARGET_COUNT/4),new wo("cc_displacementTextureInfo",xr.FLOAT4,1)],1),Pp.layouts[gd.NAME]=gd.LAYOUT,Pp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=Ip.SAMPLER_JOINTS,Sd=new qo(yd,Zr.SAMPLER_TEXTURE,1,Ur.VERTEX),Td=new Po(Np.LOCAL,yd,"cc_jointTexture",xr.SAMPLER2D,1);Pp.layouts.cc_jointTexture=Td,Pp.bindings[yd]=Sd;var Ed=Ip.SAMPLER_MORPH_POSITION,xd=new qo(Ed,Zr.SAMPLER_TEXTURE,1,Ur.VERTEX),Ad=new Po(Np.LOCAL,Ed,"cc_PositionDisplacements",xr.SAMPLER2D,1);Pp.layouts.cc_PositionDisplacements=Ad,Pp.bindings[Ed]=xd;var bd=Ip.SAMPLER_MORPH_NORMAL,Cd=new qo(bd,Zr.SAMPLER_TEXTURE,1,Ur.VERTEX),wd=new Po(Np.LOCAL,bd,"cc_NormalDisplacements",xr.SAMPLER2D,1);Pp.layouts.cc_NormalDisplacements=wd,Pp.bindings[bd]=Cd;var Rd=Ip.SAMPLER_MORPH_TANGENT,Pd=new qo(Rd,Zr.SAMPLER_TEXTURE,1,Ur.VERTEX),Id=new Po(Np.LOCAL,Rd,"cc_TangentDisplacements",xr.SAMPLER2D,1);Pp.layouts.cc_TangentDisplacements=Id,Pp.bindings[Rd]=Pd;var Od=Ip.SAMPLER_LIGHTMAP,Dd=new qo(Od,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Nd=new Po(Np.LOCAL,Od,"cc_lightingMap",xr.SAMPLER2D,1);Pp.layouts.cc_lightingMap=Nd,Pp.bindings[Od]=Dd;var Md=Ip.SAMPLER_SPRITE,Ld=new qo(Md,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Bd=new Po(Np.LOCAL,Md,"cc_spriteTexture",xr.SAMPLER2D,1);Pp.layouts.cc_spriteTexture=Bd,Pp.bindings[Md]=Ld;var Fd=Ip.SAMPLER_REFLECTION,zd=new qo(Fd,Zr.SAMPLER_TEXTURE,1,Ur.FRAGMENT),Ud=new Po(Np.LOCAL,Fd,"cc_reflectionTexture",xr.SAMPLER2D,1);Pp.layouts.cc_reflectionTexture=Ud,Pp.bindings[Fd]=zd;var kd=Ip.STORAGE_REFLECTION,Gd=new qo(kd,Zr.STORAGE_IMAGE,1,Ur.COMPUTE),Hd=new Do(Np.LOCAL,kd,"cc_reflectionStorage",xr.IMAGE2D,1);Pp.layouts.cc_reflectionStorage=Hd,Pp.bindings[kd]=Gd;var Vd,Wd,jd,Xd,qd,Yd=Sp.makeMaskExclude([Sp.BitMask.UI_2D,Sp.BitMask.GIZMOS,Sp.BitMask.EDITOR,Sp.BitMask.SCENE_GIZMO,Sp.BitMask.PROFILER]),Kd=Sp.makeMaskExclude([Sp.BitMask.UI_2D,Sp.BitMask.PROFILER]),Qd=Sp.Enum.ALL;function Zd(e){return e.hasFeature(Sr.COLOR_HALF_FLOAT)&&e.hasFeature(Sr.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===gr.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_GBUFFER:xp,PIPELINE_FLOW_LIGHTING:Ap,PIPELINE_FLOW_FORWARD:bp,PIPELINE_FLOW_SHADOW:Cp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Tp},get RenderPriority(){return Ep},globalDescriptorSetLayout:Rp,localDescriptorSetLayout:Pp,get PipelineGlobalBindings(){return wp},get ModelLocalBindings(){return Ip},get SetIndex(){return Np},bindingMappingInfo:Bp,UBOGlobal:Fp,UBOCamera:zp,UBOShadow:Up,UNIFORM_SHADOWMAP_BINDING:kp,UNIFORM_GBUFFER_ALBEDOMAP_BINDING:Vp,UNIFORM_GBUFFER_POSITIONMAP_BINDING:Xp,UNIFORM_GBUFFER_NORMALMAP_BINDING:Kp,UNIFORM_LIGHTING_RESULTMAP_BINDING:Jp,UNIFORM_GBUFFER_EMISSIVEMAP_BINDING:td,UNIFORM_ENVIRONMENT_BINDING:rd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:sd,UBOLocal:ud,INST_MAT_WORLD:hd,UBOLocalBatched:_d,UBOForwardLight:fd,UBODeferredLight:pd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:dd,UBOSkinningAnimation:md,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:vd,UBOMorph:gd,UNIFORM_JOINT_TEXTURE_BINDING:yd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Ed,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:bd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Rd,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Od,UNIFORM_SPRITE_TEXTURE_BINDING:Md,UNIFORM_REFLECTION_TEXTURE_BINDING:Fd,UNIFORM_REFLECTION_STORAGE_BINDING:kd,CAMERA_DEFAULT_MASK:Yd,CAMERA_EDITOR_MASK:Kd,MODEL_ALWAYS_MASK:Qd,supportsHalfFloatTexture:Zd})),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Vd||(Vd={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Wd||(Wd={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(jd||(jd={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Xd||(Xd={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(qd||(qd={}));var Jd,$d,em,tm,nm,im,rm,om=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],am=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],sm=[100,200,400,800],cm=new Zn,lm=new Zn,um=new _i,hm=eo.STENCIL<<1,_m=[],fm=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Vd.VERTICAL,this._fov=Nn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new vo(.2,.2,.2,1),this._viewport=new bi(0,0,1,1),this._curTransform=yr.IDENTITY,this._isProjDirty=!0,this._matView=new _i,this._matViewInv=null,this._matProj=new _i,this._matProjInv=new _i,this._matViewProj=new _i,this._matViewProjInv=new _i,this._frustum=new kc,this._forward=new Zn,this._position=new Zn,this._priority=0,this._aperture=jd.F16_0,this._apertureValue=void 0,this._shutter=qd.D125,this._shutterValue=0,this._iso=Xd.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=eo.NONE,this._clearDepth=1,this._visibility=Yd,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=om[this._aperture],this._shutterValue=am[this._shutter],this._isoValue=sm[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!_m.length){var t=e.capabilities.clipSpaceSignY;_m[yr.IDENTITY]=new _i(1,0,0,0,0,t),_m[yr.ROTATE_90]=new _i(0,1,0,0,-t,0),_m[yr.ROTATE_180]=new _i(-1,0,0,0,0,-t),_m[yr.ROTATE_270]=new _i(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=eo.NONE,this.clearDepth=1,this.visibility=Yd,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0)},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},t.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(_i.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),t=!0);var n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){var i;this._curTransform=n;var r=this._device.capabilities.clipSpaceSignY;if((null===(i=this.window)||void 0===i?void 0:i.hasOffScreenAttachments)&&(n=yr.IDENTITY),this._proj===Wd.PERSPECTIVE)_i.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Vd.VERTICAL,this._device.capabilities.clipSpaceMinZ,r,n);else{var o=this._orthoHeight*this._aspect,a=this._orthoHeight;_i.ortho(this._matProj,-o,o,-a,a,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,r,n)}_i.invert(this._matProjInv,this._matProj),t=!0,this._isProjDirty=!1}t&&(_i.multiply(this._matViewProj,this._matProj,this._matView),_i.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||i.director.root.mainWindow;t&&(t.attachCamera(this),this.window=t,this.resize(t.width,t.height))},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._viewport.x*i,a=this._viewport.y*r,s=this._viewport.width*i,c=this._viewport.height*r,l=this._proj===Wd.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=hi[this._curTransform];Zn.set(cm,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=cm.x,f=cm.y;return cm.x=_*h[0]+f*h[2]*u,cm.y=_*h[1]+f*h[3]*u,Zn.transformMat4(l?cm:e.o,cm,this._matViewProjInv),l?(this._node.getWorldPosition(lm),ur.fromPoints(e,lm,cm)):Zn.transformQuat(e.d,Zn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._viewport.x*n,o=this._viewport.y*i,a=this._viewport.width*n,s=this._viewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=hi[this._curTransform];if(this._proj===Wd.PERSPECTIVE){Zn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,Zn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(cm),Zn.lerp(e,cm,e,Dn(this._nearClip/this._farClip,1,t.z))}else{Zn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,Zn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this.width,i=this.height,r=this._viewport.x*n,o=this._viewport.y*i,a=this._viewport.width*n,s=this._viewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=hi[this._curTransform];Zn.transformMat4(e,t,this._matViewProj);var u=e.x,h=e.y;return e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,e.x=r+.5*(e.x+1)*a,e.y=o+.5*(e.y+1)*s,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){_i.multiply(e,this._matViewProj,t),_i.multiply(e,_m[this._curTransform],e);var r=n/2,o=i/2;return _i.identity(um),_i.transform(um,um,Zn.set(cm,r,o,0)),_i.scale(um,um,Zn.set(cm,r,o,1)),_i.multiply(e,um,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},k(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,n=e.width,i=e.height,r=this._device.capabilities.screenSpaceSignY<0?1-e.y-i:e.y;switch(this._device.surfaceTransform){case yr.ROTATE_90:this._viewport.x=1-r-i,this._viewport.y=t,this._viewport.width=i,this._viewport.height=n;break;case yr.ROTATE_180:this._viewport.x=1-t-n,this._viewport.y=1-r-i,this._viewport.width=n,this._viewport.height=i;break;case yr.ROTATE_270:this._viewport.x=r,this._viewport.y=1-t-n,this._viewport.width=i,this._viewport.height=n;break;case yr.IDENTITY:this._viewport.x=t,this._viewport.y=r,this._viewport.width=n,this._viewport.height=i}this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView},set:function(e){this._matView=e}},{key:"matViewInv",get:function(){return this._matViewInv||this._node.worldMatrix},set:function(e){this._matViewInv=e}},{key:"matProj",get:function(){return this._matProj},set:function(e){this._matProj=e}},{key:"matProjInv",get:function(){return this._matProjInv},set:function(e){this._matProjInv=e}},{key:"matViewProj",get:function(){return this._matViewProj},set:function(e){this._matViewProj=e}},{key:"matViewProjInv",get:function(){return this._matViewProjInv},set:function(e){this._matViewProjInv=e}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=om[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=am[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=sm[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),pm=1024;function dm(e){return!!(i.sys.capabilities.imageBitmap&&e instanceof ImageBitmap)}!function(e){e[e.RGB565=Tr.R5G6B5]="RGB565",e[e.RGB5A1=Tr.RGB5A1]="RGB5A1",e[e.RGBA4444=Tr.RGBA4]="RGBA4444",e[e.RGB888=Tr.RGB8]="RGB888",e[e.RGB32F=Tr.RGB32F]="RGB32F",e[e.RGBA8888=Tr.RGBA8]="RGBA8888",e[e.RGBA32F=Tr.RGBA32F]="RGBA32F",e[e.A8=Tr.A8]="A8",e[e.I8=Tr.L8]="I8",e[e.AI8=Tr.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Tr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Tr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=pm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Tr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Tr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=pm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Tr.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=pm++]="RGBA_ETC1",e[e.RGB_ETC2=Tr.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Tr.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Tr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Tr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Tr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Tr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Tr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Tr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Tr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Tr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Tr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Tr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Tr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Tr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Tr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Tr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Jd||(Jd={})),function(e){e[e.REPEAT=Nr.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Nr.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Nr.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Nr.BORDER]="CLAMP_TO_BORDER"}($d||($d={})),function(e){e[e.NONE=Dr.NONE]="NONE",e[e.LINEAR=Dr.LINEAR]="LINEAR",e[e.NEAREST=Dr.POINT]="NEAREST"}(em||(em={}));var mm,vm=e("ImageAsset",Zc("cc.ImageAsset")((rm=im=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=Jd.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}H(t,e);var n=t.prototype;return n.reset=function(e){dm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):dm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var r,o=i.director.root?i.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=i.macro.SUPPORT_TEXTURE_FORMATS,h=Q(a);!(r=h()).done;){var _=r.value.split("@"),f=parseInt(_[0],void 0),p=t.extnames[f]||_[0],d=u.indexOf(p);if(-1!==d&&d<s){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||o&&o.hasFeature(Sr.FORMAT_ASTC)))continue;if(!(".pvr"!==p||o&&o.hasFeature(Sr.FORMAT_PVRTC)))continue;if(!(m!==Jd.RGB_ETC1&&m!==Jd.RGBA_ETC1||o&&o.hasFeature(Sr.FORMAT_ETC1)))continue;if(!(m!==Jd.RGB_ETC2&&m!==Jd.RGBA_ETC2||o&&o.hasFeature(Sr.FORMAT_ETC2)))continue;if(".webp"===p&&!i.sys.capabilities.webp)continue;s=d,l=p,c=m}}l?(this._setRawAsset(l),this._format=c):A(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},k(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||dm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||dm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Jd.RGB_ETC1&&this._format<=Jd.RGBA_ASTC_12x12||this._format>=Jd.RGB_A_PVRTC_2BPPV1&&this._format<=Jd.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Cu),im.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],im._sharedPlaceHolderCanvas=null,J((nm=rm).prototype,"_nativeAsset",[Ul],Object.getOwnPropertyDescriptor(nm.prototype,"_nativeAsset"),nm.prototype),tm=nm))||tm);i.ImageAsset=vm,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.mipLODBias=8]="mipLODBias",e[e.total=9]="total"}(mm||(mm={}));var gm=[Dr.LINEAR,Dr.LINEAR,Dr.NONE,Nr.WRAP,Nr.WRAP,Nr.WRAP,0,Mr.NEVER,0],ym=Em(gm),Sm=new vo,Tm=new Co;function Em(e){for(var t=0,n=0,i=0;i<gm.length;i++)switch(t=e[i]||gm[i],i){case mm.minFilter:n|=t;break;case mm.magFilter:n|=t<<2;break;case mm.mipFilter:n|=t<<4;break;case mm.addressU:n|=t<<6;break;case mm.addressV:n|=t<<8;break;case mm.addressW:n|=t<<10;break;case mm.maxAnisotropy:n|=t<<12;break;case mm.cmpFunc:n|=t<<16;break;case mm.mipLODBias:n|=t<<28}return n}var xm,Am,bm,Cm,wm,Rm,Pm,Im,Om,Dm,Nm,Mm,Lm=new(function(){function e(){this._cache={}}return e.prototype.getSampler=function(e,t){return t||(t=ym),this._cache[t]||(Tm.minFilter=3&t,Tm.magFilter=t>>2&3,Tm.mipFilter=t>>4&3,Tm.addressU=t>>6&3,Tm.addressV=t>>8&3,Tm.addressW=t>>10&3,Tm.maxAnisotropy=t>>12&15,Tm.cmpFunc=t>>16&15,Tm.mipLODBias=t>>28&15,Tm.borderColor=Sm,this._cache[t]=e.createSampler(Tm))},e}());i.samplerLib=Lm;var Bm=new ce("Tex"),Fm=Zc("cc.TextureBase")((Mm=Nm=function(e){function t(){var t;return Z(t=e.call(this)||this,"_format",bm,Y(t)),Z(t,"_minFilter",Cm,Y(t)),Z(t,"_magFilter",wm,Y(t)),Z(t,"_mipFilter",Rm,Y(t)),Z(t,"_wrapS",Pm,Y(t)),Z(t,"_wrapT",Im,Y(t)),Z(t,"_wrapR",Om,Y(t)),Z(t,"_anisotropy",Dm,Y(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=[],t._samplerHash=0,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Bm.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=xa(t._id,666),t}H(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){this._wrapS=e,this._samplerInfo[mm.addressU]=e,this._wrapT=t,this._samplerInfo[mm.addressV]=t,void 0!==n&&(this._wrapR=n,this._samplerInfo[mm.addressW]=n),this._samplerHash=Em(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Lm.getSampler(this._gfxDevice,this._samplerHash))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo[mm.minFilter]=e,this._magFilter=t,this._samplerInfo[mm.magFilter]=t,this._samplerHash=Em(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Lm.getSampler(this._gfxDevice,this._samplerHash))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo[mm.mipFilter]=e,this._samplerHash=Em(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Lm.getSampler(this._gfxDevice,this._samplerHash))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo[mm.maxAnisotropy]=e,this._samplerHash=Em(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Lm.getSampler(this._gfxDevice,this._samplerHash))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=i.director.root)||void 0===t?void 0:t.batcher2D)&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerHash=function(){return this._samplerHash},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=Lm.getSampler(this._gfxDevice,this._samplerHash):C(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return i.director.root?i.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?Jd.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===Jd.RGBA_ETC1?e=Jd.RGB_ETC1:e===Jd.RGB_A_PVRTC_4BPPV1?e=Jd.RGB_PVRTC_4BPPV1:e===Jd.RGB_A_PVRTC_2BPPV1&&(e=Jd.RGB_PVRTC_2BPPV1),e},k(t,[{key:"isCompressed",get:function(){return this._format>=Jd.RGB_ETC1&&this._format<=Jd.RGBA_ASTC_12x12||this._format>=Jd.RGB_A_PVRTC_2BPPV1&&this._format<=Jd.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Cu),Nm.PixelFormat=Jd,Nm.WrapMode=$d,Nm.Filter=em,bm=J((Am=Mm).prototype,"_format",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jd.RGBA8888}}),Cm=J(Am.prototype,"_minFilter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return em.LINEAR}}),wm=J(Am.prototype,"_magFilter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return em.LINEAR}}),Rm=J(Am.prototype,"_mipFilter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return em.NONE}}),Pm=J(Am.prototype,"_wrapS",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $d.REPEAT}}),Im=J(Am.prototype,"_wrapT",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $d.REPEAT}}),Om=J(Am.prototype,"_wrapR",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $d.REPEAT}}),Dm=J(Am.prototype,"_anisotropy",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xm=Am))||xm;i.TextureBase=Fm;var zm=new WeakMap,Um=new WeakSet,km=new WeakSet;function Gm(e,t){var n;n=Ku.safeFindClass;var i,r=uh.pool.get();try{i=Eh(e,r,{classFinder:n,customEnv:t})}catch(e){throw d(e),uh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:su(h),owner:a[u],prop:s[u],type:Ke._getClassById(c[u])}}return zm.set(i,l),i._native&&Um.add(i),uh.pool.put(r),i}var Hm,Vm=new(function(){function e(){this._depends=new Wl}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?G({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof Ju){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=Gm(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),Kl.add(e+"@import",o)}catch(t){Yl.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=zm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Um.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=su(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Wm=[new po];function jm(e){return e&&0==(e&e-1)}var Xm,qm,Ym,Km,Qm,Zm,Jm=Zc("cc.SimpleTexture")(Hm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}H(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Wm[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Wm):i.copyTexImagesToTexture([e],this._gfxTexture,Wm)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),nt.CLEANUP_IMAGE_CACHE)){var r=Vm.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(re(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Ir.NONE;this._mipFilter!==em.NONE&&function(e,t,n){return!(e.gfxAPI===gr.WEBGL)||jm(t)&&jm(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Ir.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Pr.SAMPLED|Pr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t|Ir.IMMUTABLE});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},k(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Fm))||Hm;i.SimpleTexture=Jm;var $m,ev,tv,nv,iv,rv,ov,av=e("Texture2D",(Xm=Zc("cc.Texture2D"),qm=Pl([vm]),Xm((Zm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",Qm,Y(t)),t}H(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=Jd.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new vm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,Ke._getClassId(vm))}},n._getGfxTextureCreateInfo=function(e){var t=new Ao(Rr.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new vm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},k(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Jm),Qm=J((Km=Zm).prototype,"_mipmaps",[qm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ym=Km))||Ym));i.Texture2D=av,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(ov||(ov={}));var sv=e("TextureCube",Zc("cc.TextureCube")((rv=iv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",tv,Y(t)),Z(t,"_mipmaps",nv,Y(t)),t}H(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+ov.front].image,back:e[a+ov.back].image,left:e[a+ov.left].image,right:e[a+ov.right].image,top:e[a+ov.top].image,bottom:e[a+ov.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;cv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new vm,back:new vm,left:new vm,right:new vm,top:new vm,bottom:new vm};var o=i.mipmaps[r],a=Ke._getClassId(vm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new Ao(Rr.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new vm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},k(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){cv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Jm),iv.FaceIndex=ov,tv=J((ev=rv).prototype,"isRGBE",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nv=J(ev.prototype,"_mipmaps",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$m=ev))||$m);function cv(e,t){t(e.front,ov.front),t(e.back,ov.back),t(e.left,ov.left),t(e.right,ov.right),t(e.top,ov.top),t(e.bottom,ov.bottom)}i.TextureCube=sv;var lv,uv,hv,_v=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:308883658,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3113634185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3001336778,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2637621064,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:1675533382,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:1867464226,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1559944983,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:3247695832,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:220,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:63},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1783225275,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:63},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3600213289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:67,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3278422876,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:65,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:1017648509,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3555385669,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:56},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:1115292548,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:213,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:56},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:1780456825,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3169038185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3552712539,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:1349506124,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),fv=4026531840,pv=264241152,dv=3145728,mv=1032192;!function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE=1]="TEXTURE"}(hv||(hv={}));var vv=function(e,t,n,i,r){return void 0===r&&(r=0),e<<28&fv|i<<22&pv|t<<20&dv|n<<14&mv|16383&r},gv=function(e){return(e&fv)>>>28},yv=function(e){return(e&pv)>>>22},Sv=function(e){return(e&mv)>>>14},Tv=function(e){return 16383&e},Ev=function(e,t){return e&~pv|t<<22&pv},xv=((lv={})[xr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},lv[xr.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},lv[xr.INT2]=function(e,t,n){return void 0===n&&(n=0),mi.fromArray(t,e,n)},lv[xr.INT3]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},lv[xr.INT4]=function(e,t,n){return void 0===n&&(n=0),Si.fromArray(t,e,n)},lv[xr.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},lv[xr.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),mi.fromArray(t,e,n)},lv[xr.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},lv[xr.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Si.fromArray(t,e,n)},lv[xr.MAT3]=function(e,t,n){return void 0===n&&(n=0),ti.fromArray(t,e,n)},lv[xr.MAT4]=function(e,t,n){return void 0===n&&(n=0),_i.fromArray(t,e,n)},lv),Av=((uv={})[xr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},uv[xr.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},uv[xr.INT2]=function(e,t,n){return void 0===n&&(n=0),mi.toArray(e,t,n)},uv[xr.INT3]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},uv[xr.INT4]=function(e,t,n){return void 0===n&&(n=0),Si.toArray(e,t,n)},uv[xr.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},uv[xr.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),mi.toArray(e,t,n)},uv[xr.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},uv[xr.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Si.toArray(e,t,n)},uv[xr.MAT3]=function(e,t,n){return void 0===n&&(n=0),ti.toArray(e,t,n)},uv[xr.MAT4]=function(e,t,n){return void 0===n&&(n=0),_i.toArray(e,t,n)},uv),bv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Cv(e){switch(e){case xr.BOOL:case xr.INT:case xr.UINT:case xr.FLOAT:return bv[0];case xr.BOOL2:case xr.INT2:case xr.UINT2:case xr.FLOAT2:return bv[1];case xr.BOOL4:case xr.INT4:case xr.UINT4:case xr.FLOAT4:return bv[2];case xr.MAT4:return bv[3];case xr.SAMPLER2D:return"default-texture";case xr.SAMPLER_CUBE:return"default-cube-texture"}return bv[0]}function wv(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Rv=new Yo;function Pv(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Iv(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Ov(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&sa))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.gfxBlocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&ca))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.gfxSamplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function Dv(e){return e.members.reduce((function(e,t){return e+pa(t.type)*t.count}),0)}function Nv(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Mv(e){switch(e.gfxAPI){case gr.GLES2:case gr.WEBGL:return"glsl1";case gr.GLES3:case gr.WEBGL2:return"glsl3";default:return"glsl4"}}var Lv=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=G({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=Pv(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=Pv(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.gfxBlocks=[],s.gfxSamplerTextures=[],s.bindings=[],s.blockSizes=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Dv(l)),s.bindings.push(new qo(l.binding,l.descriptorType||Zr.UNIFORM_BUFFER,1,l.stageFlags)),s.gfxBlocks.push(new Ro(Np.MATERIAL,l.binding,l.name,l.members.map((function(e){return new wo(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new qo(h.binding,h.descriptorType||Zr.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.gfxSamplerTextures.push(new Po(Np.MATERIAL,h.binding,h.name,h.type,h.count))}s.gfxAttributes=[];for(var _=0;_<n.attributes.length;_++){var f=n.attributes[_];s.gfxAttributes.push(new Bo(f.name,f.format,f.isNormalized,0,f.isInstanced,f.location))}Ov(n,s,Pp,"locals"),s.gfxStages=[],s.gfxStages.push(new Lo(Ur.VERTEX,"")),s.gfxStages.push(new Lo(Ur.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=vv(hv.BUFFER,Np.MATERIAL,i.binding,s.type,o),o+=(pa(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=vv(hv.TEXTURE,Np.MATERIAL,l.binding,l.type)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(Rv.bindings=r.bindings,r.setLayouts[Np.MATERIAL]=e.createDescriptorSetLayout(Rv),Rv.bindings=Pp.bindings,r.setLayouts[Np.LOCAL]=e.createDescriptorSetLayout(Rv)),r.setLayouts[n?Np.LOCAL:Np.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];v("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Ov(a,s,Rp,"globals"),s.setLayouts[Np.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Qo(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=Iv(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Mv(e);h?u=a[h]:console.error("Invalid GFX API!"),s.gfxStages[0].source=l+u.vert,s.gfxStages[1].source=l+u.frag;var _=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Nv(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),f=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),p=new Fo(f,s.gfxStages,_,s.gfxBlocks);return p.samplerTextures=s.gfxSamplerTextures,this._cache[r]=e.createShader(p)},e}());i.programLib=Lv;var Bv,Fv,zv,Uv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 miscParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},kv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;var n=this._resources,r=document.createElement("canvas"),o=r.getContext("2d"),a=new vm(r),s=r.width=r.height=2;o.fillStyle="#000",o.fillRect(0,0,s,s);var c=new av;c._uuid="black-texture",c.image=a,n[c._uuid]=c,o.fillStyle="rgba(0,0,0,0)",o.fillRect(0,0,s,s);var l=new av;l._uuid="empty-texture",l.image=a,n[l._uuid]=l;var u=new sv;u._uuid="black-cube-texture",u.setMipFilter(sv.Filter.NEAREST),u.image={front:new vm(r),back:new vm(r),left:new vm(r),right:new vm(r),top:new vm(r),bottom:new vm(r)},n[u._uuid]=u,o.fillStyle="#777",o.fillRect(0,0,s,s);var h=new av;h._uuid="grey-texture",h.image=a,n[h._uuid]=h,o.fillStyle="#fff",o.fillRect(0,0,s,s);var _=new av;_._uuid="white-texture",_.image=a,n[_._uuid]=_;var f=new sv;f._uuid="white-cube-texture",f.setMipFilter(sv.Filter.NEAREST),f.image={front:new vm(r),back:new vm(r),left:new vm(r),right:new vm(r),top:new vm(r),bottom:new vm(r)},n[f._uuid]=f,o.fillStyle="#7f7fff",o.fillRect(0,0,s,s);var p=new av;p._uuid="normal-texture",p.image=a,n[p._uuid]=p,r.width=r.height=16,o.fillStyle="#ddd",o.fillRect(0,0,16,16),o.fillStyle="#555",o.fillRect(0,0,8,8),o.fillStyle="#555",o.fillRect(8,8,8,8);var d=new av;d._uuid="default-texture",d.image=a,n[d._uuid]=d;var m=new sv;if(m.setMipFilter(sv.Filter.NEAREST),m._uuid="default-cube-texture",m.image={front:new vm(r),back:new vm(r),left:new vm(r),right:new vm(r),top:new vm(r),bottom:new vm(r)},n[m._uuid]=m,i.SpriteFrame){var v=new i.SpriteFrame,g=a,y=new av;y.image=g,v.texture=y,v._uuid="default-spriteframe",n[v._uuid]=v}var S=Mv(e);if(!S)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var T=Uv[S];return T?Promise.resolve().then((function(){_v.forEach((function(e,t){var n=Object.assign(new i.EffectAsset,e);n.shaders.forEach((function(e,n){var i=T[t][n];i&&(e[S]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+S+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var r=new i.Material;r._uuid="missing-effect-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ffff00")),e[r._uuid]=r,t.push(r);var o=new i.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",i.color("#ff00ff")),e[o._uuid]=o,t.push(o);var a=new i.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[a._uuid]=a,t.push(a);var s=new i.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new i.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new i.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new i.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new i.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),e[p._uuid]=p,t.push(p);var d=new i.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new i.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new i.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),i.game.on(i.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Gv=e("builtinResMgr",i.builtinResMgr=new kv),Hv=e("getPhaseID",(Bv=new Map,Fv=0,function(e){return"number"==typeof e?e:(Bv.has(e)||(Bv.set(e,1<<Fv),Fv++),Bv.get(e))})),Vv=new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE),Wv=new So(null),jv=new Ko(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(zv||(zv={}));var Xv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Oa,this._dss=new Pa,this._rs=new Ra,this._priority=Ep.DEFAULT,this._stage=Tp.DEFAULT,this._phase=Hv("default"),this._primitive=jr.TRIANGLE_LIST,this._batchingScheme=zv.NONE,this._dynamicStates=Kr.NONE,this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Hv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Lv.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=Q(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),xa(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=xr.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Ev(i,n):t&&(i=Ev(i,yv(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];Av[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];return xv[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=pa(r)>>2,a=this._blocks[i],s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Av[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):C(12006)},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=this._blocks[r],s=this._properties[t],c=s&&s.value||Cv(i);Av[i](a,c,o),this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":Cv(r),l=Gv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?a.samplerHash:l&&l.getSamplerHash(),_=Lm.getSampler(this._device,h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=this._blocks[t.binding],i=0,r=0;r<t.members.length;r++){for(var o=t.members[r],a=this._properties[o.name],s=a&&a.value||Cv(o.type),c=(pa(o.type)>>2)*o.count,l=0;l+s.length<=c;l+=s.length)n.set(s,i+l);i+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Lv.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Lv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Lv.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Ep.DEFAULT),this._setStage(Tp.DEFAULT),this._setPhase(Hv("default")),this._setPrimitive(jr.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?G({},t.defines):t.defines,this._shaderInfo=Lv.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),jv.layout=Lv.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(jv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Lv.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(Vv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(Vv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Wv.buffer=this._rootBuffer,Wv.offset=l[m++],Wv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Wv);this._blocks[v]=new Float32Array(this._rootBlock,Wv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(v,y)}var S=this._propertyHandleMap=s,T={};for(var E in this._properties){var x=this._properties[E];x.handleInfo&&(T[E]=this.getHandle.apply(this,x.handleInfo))}Object.assign(S,T)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(Sr.INSTANCED_ARRAYS)?this._setBatchingScheme(zv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(zv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(zv.VB_MERGING):this._setBatchingScheme(zv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Lv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},k(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Lv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Xv.PropertyType=hv,Xv.getPropertyTypeFromHandle=gv,Xv.getTypeFromHandle=yv,Xv.getBindingFromHandle=Sv,Xv.getOffsetFromHandle=Tv;var qv=new Ko(null),Yv=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Ep.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){if(void 0===n&&(n=null),this._device=i.director.root.device,qv.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(qv),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===zv.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=Ep.DEFAULT,t[0].phase===Hv("reflection")){var r=this._device.width,o=this._device.height,a=512;o<r?(r=a*r/o,o=a):o=a*o/(r=a),this._reflectionTex=this._device.createTexture(new Ao(Rr.TEX2D,Pr.STORAGE|Pr.TRANSFER_SRC|Pr.SAMPLED,Tr.RGBA8,r,o,Ir.IMMUTABLE)),this.descriptorSet.bindTexture(Fd,this._reflectionTex);var s=Em([Dr.LINEAR,Dr.LINEAR,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP]);this._reflectionSampler=Lm.getSampler(this._device,s),this.descriptorSet.bindSampler(Fd,this._reflectionSampler),this.descriptorSet.bindTexture(kd,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyInputAssembler(),this.priority=Ep.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler&&this._reflectionSampler.destroy(),this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},k(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?C(12004,8):(this._passes=e,this._flushPassInfo(),this._descriptorSet&&(this._destroyDescriptorSet(),qv.layout=e[0].localSetLayout,this._createDescriptorSet(qv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._setSubMesh(e),this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===zv.VB_MERGING&&this.subMesh.genFlatBuffers()}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Kv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,n){void 0===n&&(n=0);var i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(Od),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a){if(u.stride!==r)return;if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],S=new Bo(y.name,y.format,y.isNormalized,d.length,!0);m.push(S)}p.set(t.buffer),d.push(f);var T=new zo(m,d,v),E=this._device.createInputAssembler(T);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:E,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}());Kv._buffers=new Map;var Qv,Zv=new _i,Jv=(new $((function(){return new Yv}),32),[{name:"CC_RECEIVE_SHADOW",value:!0}]);!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Qv||(Qv={}));var $v,eg,tg=Em([Dr.LINEAR,Dr.LINEAR,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP]),ng=Em([Dr.LINEAR,Dr.LINEAR,Dr.LINEAR,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP]),ig=function(){function e(){this.type=Qv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(ud.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Si,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Sp.Enum.NONE,this._device=i.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Sp.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){_i.toArray(this._localData,i,ud.MAT_WORLD_OFFSET),_i.inverseTranspose(Zv,i);var a=Math.abs(_i.determinant(Zv)),s=1/Math.sqrt(a);_i.multiplyScalar(Zv,Zv,s),_i.toArray(this._localData,Zv,ud.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Rc.fromPoints(Rc.create(),e,t),this._worldBounds=Rc.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Yv},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Si.toArray(this._localData,t,ud.LIGHTINGMAP_UVPARAM),this._applyLocalData(),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Gv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=Lm.getSampler(this._device,e.mipmaps.length>1?ng:tg),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Od,n),a.bindSampler(Od,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?Jv:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(Sr.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=aa[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Bo;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=aa[c.format],h=new(da(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===zv.INSTANCING&&Kv.get(t).destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(hd)),this._transformUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,ud.SIZE,ud.SIZE)),this._applyLocalBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(ud.BINDING,this._localBuffer)},k(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}($v||($v={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(eg||(eg={})),i.internal.TransformBit=eg;var rg,og,ag,sg,cg,lg,ug,hg,_g,fg,pg,dg,mg,vg,gg,yg,Sg,Tg,Eg=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._createNativeObject(),!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=Q(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=eg.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=Q(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=Q(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},k(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}(),xg=e("EffectAsset",Zc("cc.EffectAsset")((hg=ug=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"techniques",ag,Y(t)),Z(t,"shaders",sg,Y(t)),Z(t,"combinations",cg,Y(t)),Z(t,"hideInEditor",lg,Y(t)),t}H(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Lv.register(this),t.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=i.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=G({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return Lv.getGFXShader(t.device,i.name,e,t.pipeline)}))},r=0;r<this.shaders.length;r++)n(r)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Cu),ug._effects={},ag=J((og=hg).prototype,"techniques",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sg=J(og.prototype,"shaders",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cg=J(og.prototype,"combinations",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lg=J(og.prototype,"hideInEditor",[il,rl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rg=og))||rg);i.EffectAsset=xg;var Ag=e("Material",(_g=Zc("cc.Material"),fg=Pl(xg),_g((Tg=function(e){function t(){var t;return Z(t=e.call(this)||this,"_effectAsset",mg,Y(t)),Z(t,"_techIdx",vg,Y(t)),Z(t,"_defines",gg,Y(t)),Z(t,"_states",yg,Y(t)),Z(t,"_props",Sg,Y(t)),t._passes=[],t._hash=0,t}H(t,e),t.getHash=function(e){for(var t,n=0,i=Q(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?A(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=xg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=Q(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=G({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=G({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=G({},e._states[i]);this._effectAsset=e._effectAsset,this._update()},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],r=0;r<t;++r){var o=e.passes[r],a=o.passIndex=r,s=o.defines=this._defines[a]||(this._defines[a]={}),c=o.stateOverrides=this._states[a]||(this._states[a]={});if(void 0!==o.propertyIndex&&(Object.assign(s,this._defines[o.propertyIndex]),Object.assign(c,this._states[o.propertyIndex])),void 0!==o.embeddedMacros&&Object.assign(s,o.embeddedMacros),!o.switch||s[o.switch]){var l=new Xv(i.director.root);l.initialize(o),n.push(l)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;var r=Xv.getPropertyTypeFromHandle(i);if(r===hv.BUFFER)Array.isArray(n)?e.setUniformArray(i,n):null!==n?e.setUniform(i,n):e.resetUniform(t);else if(r===hv.TEXTURE)if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Xv.getBindingFromHandle(t);if(n instanceof za)e.bindTexture(r,n,i);else if(n instanceof Fm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=Q(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Kn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},k(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Cu),mg=J((dg=Tg).prototype,"_effectAsset",[fg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vg=J(dg.prototype,"_techIdx",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gg=J(dg.prototype,"_defines",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yg=J(dg.prototype,"_states",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sg=J(dg.prototype,"_props",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pg=dg))||pg));i.Material=Ag;var bg=Ze({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Cg=Ze({Planar:0,ShadowMap:1}),wg=Ze({HARD:0,SOFT:1,SOFT_2X:2}),Rg=Cg.ShadowMap+1,Pg=function(){function e(){this.fixedSphere=new to(0,0,0,.01),this.maxReceived=4,this.shadowCameraFar=0,this.matShadowView=new _i,this.matShadowProj=new _i,this.matShadowViewProj=new _i,this._normal=new Zn(0,1,0),this._shadowColor=new Kn(0,0,0,76),this._matLight=new _i,this._material=null,this._instancingMaterial=null,this._size=new mi(512,512),this._enabled=!1,this._distance=0,this._type=Rg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Ag,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Ag,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:Rg},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){if(this.enabled)this.type===Cg.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{var e=i.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()}},t._updatePlanarInfo=function(){this._material||(this._material=new Ag,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Ag,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}));var e=i.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()},t._updatePipeline=function(){var e=i.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=1,e.onGlobalPipelineStateChanged()},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){Zn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();Pg.MAX_FAR=2e3,Pg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=Pg,vn(Eg.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),vn(Eg.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Ig={};vn(Ig,"CameraVisFlags",[{name:"GENERAL"}]),mn(Ig,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Sp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Sp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Sp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Sp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Sp.BitMask,targetName:"UI_2D"}]),i.CameraVisFlags=Ig;var Og,Dg={};function Ng(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}vn(Dg,"VisibilityFlags",[{name:"GENERAL"}]),mn(Dg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Sp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Sp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Sp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Sp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Sp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Sp.Enum,targetName:"UI_2D"}]),i.VisibilityFlags=Dg,mn(Xv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),vn(fm.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),vn(Pg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Og||(Og={}));var Mg=function(e){return 4*Math.PI*Math.PI*e*e},Lg=function(){function e(){this._baked=!1,this._color=new Zn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Zn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Og.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new Zn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},k(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Ng(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=eg.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Bg=new Zn(0,0,-1),Fg=new Zn,zg=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new Zn(1,-1,-1),t._illuminance=Ki.SUN_ILLUM,t._type=Og.DIRECTIONAL,t}H(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Ki.SUN_ILLUM,this.direction=new Zn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Zn.transformQuat(Fg,Bg,this._node.worldRotation))},k(t,[{key:"direction",get:function(){return this._dir},set:function(e){Zn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e}}]),t}(Lg),Ug=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(Y(i)),i}H(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Xv.fillPipelineInfo(this,e),Xv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!wv(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(zv.NONE)},n._onStateChange=function(){this._setHash(Xv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},k(t,[{key:"parent",get:function(){return this._parent}}]),t}(Xv),kg=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}H(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=Q(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Ag.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new Ug(t[n],this));return e},k(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Ag),Gg=null,Hg=null,Vg=function(){function e(){this._envmap=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._isRGBE=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setIsRGBE=function(e){this._isRGBE=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setIsRGBE(e.isRGBE),this._envmap=e.envmap},t.activate=function(){var e=i.director.root.pipeline,t=e.pipelineSceneData.ambient;if(this._globalDSManager=e.globalDSManager,this._default=Gv.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),this._envmap||(this._envmap=this._default),t.albedoArray[3]=this._envmap.mipmapLevel,Hg)Hg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var n=new Ag;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),Hg=new kg({parent:n})}this.enabled&&(Gg||(Gg=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Gg.renderingSubMeshes[0],Hg)),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=i.director.root,n=t.pipeline;n.macros.CC_USE_IBL!==e&&(n.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=Lm.getSampler(i.director._device,this.envmap.getSamplerHash());this._globalDSManager.bindSampler(rd,t),this._globalDSManager.bindTexture(rd,e),this._globalDSManager.update()},t._destroy=function(){},t.destroy=function(){this._destroy()},k(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){e&&(Hg&&Hg.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,Hg)),this._setIsRGBE(e),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(i.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"native",get:function(){return this._nativeObj}}]),e}();i.Skybox=Vg;var Wg,jg,Xg=function(e){H(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminance=0,t._pos=void 0,t._aabb=void 0,t._aabb=Rc.create(),t._pos=new Zn,t._type=Og.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Mg(.15)},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Rc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},k(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Lg),qg=new Zn(0,0,-1),Yg=new ri,Kg=new _i,Qg=new _i,Zg=new _i,Jg=new _i,$g=function(e){H(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new Zn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminance=0,t._aspect=0,t._aabb=Rc.create(),t._frustum=kc.create(),t._pos=new Zn,t._type=Og.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Mg(.15),this.range=Math.cos(Math.PI/6),this._setDirection(new Zn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Zn.transformQuat(this._dir,qg,this._node.getWorldRotation(Yg)),Zn.normalize(this._dir,this._dir),Rc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Kg),_i.invert(Kg,Kg),_i.perspective(Qg,this._angle,1,.001,this._range),_i.multiply(Zg,Qg,Kg),this._frustum.update(Zg,Jg),this._needUpdate=!1)},k(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(Lg),ey=Object.freeze({__proto__:null,Ambient:Ki,get CameraFOVAxis(){return Vd},get CameraProjection(){return Wd},get CameraAperture(){return jd},get CameraISO(){return Xd},get CameraShutter(){return qd},SKYBOX_FLAG:hm,Camera:fm,CameraVisFlags:Ig,VisibilityFlags:Dg,DirectionalLight:zg,ColorTemperatureToRGB:Ng,get LightType(){return Og},nt2lm:Mg,Light:Lg,get ModelType(){return Qv},Model:ig,ShadowSize:bg,ShadowType:Cg,PCFType:wg,Shadows:Pg,RenderScene:Eg,Skybox:Vg,SphereLight:Xg,SpotLight:$g,SubModel:Yv,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function ty(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function ny(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Wg||(Wg={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(jg||(jg={}));var iy,ry,oy,ay,sy,cy,ly,uy,hy,_y,fy=function(){function e(e){this._device=void 0,this._format=Tr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new po,this._region1=new po,this._region2=new po,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=aa[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=da(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=ny(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,ty(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;v("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED|Pr.TRANSFER_DST,this._format,e,e,Ir.IMMUTABLE)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=ny(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,ty(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),py=function(e){if(void 0===Yi[e]){var t=1<<qi;Yi[e]=t,qi+=1}},dy=Object.freeze({__proto__:null,addStage:py,scene:ey,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new Bo(ro.ATTR_POSITION,Tr.RGB32F)),t.normals&&o.push(new Bo(ro.ATTR_NORMAL,Tr.RGB32F)),t.uvs&&o.push(new Bo(ro.ATTR_TEX_COORD,Tr.RG32F)),t.colors&&o.push(new Bo(ro.ATTR_COLOR,Tr.RGB32F));var a=e.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new zo(o,[a],s))},get RenderQueue(){return Wg},get PassStage(){return jg},get PropertyType(){return hv},genHandle:vv,getPropertyTypeFromHandle:gv,getTypeFromHandle:yv,getSetIndexFromHandle:function(e){return(e&dv)>>>20},getBindingFromHandle:Sv,getOffsetFromHandle:Tv,customizeType:Ev,type2reader:xv,type2writer:Av,getDefaultFromType:Cv,overrideMacros:wv,get BatchingSchemes(){return zv},Pass:Xv,getDeviceShaderVersion:Mv,programLib:Lv,get SamplerInfoIndex(){return mm},defaultSamplerHash:ym,genSamplerHash:Em,samplerLib:Lm,nearestPOT:ty,TextureBufferPool:fy,MaterialInstance:kg,PassInstance:Ug,get PoolType(){return cc},NULL_HANDLE:0,get NodeView(){return lc},NodePool:pc,get PassView(){return hc},PassPool:gc,get AABBView(){return dc},AABBPool:Tc});e("renderer",dy);var my,vy,gy,yy,Sy,Ty,Ey,xy,Ay,by,Cy,wy,Ry,Py=e("RenderStage",(iy=Zc("RenderStage"),ry=El(),oy=El(),ay=El(),iy((_y=function(){function e(){Z(this,"_name",ly,this),Z(this,"_priority",uy,this),Z(this,"_tag",hy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},k(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),ly=J((cy=_y).prototype,"_name",[ry,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uy=J(cy.prototype,"_priority",[oy,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hy=J(cy.prototype,"_tag",[ay,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sy=cy))||sy));i.RenderStage=Py;var Iy=e("RenderFlow",(my=Zc("RenderFlow"),vy=El(),gy=El(),yy=El(),Sy=El(),Ty=Pl([Py]),my((Ry=function(){function e(){Z(this,"_name",Ay,this),Z(this,"_priority",by,this),Z(this,"_tag",Cy,this),Z(this,"_stages",wy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},k(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Ay=J((xy=Ry).prototype,"_name",[vy,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),by=J(xy.prototype,"_priority",[gy,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cy=J(xy.prototype,"_tag",[yy,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wy=J(xy.prototype,"_stages",[Sy,Ty,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ey=xy))||Ey));i.RenderFlow=Iy;var Oy=new Zn,Dy=(new Zn,new Zn,new Zn),Ny=new _i,My=new Rc,Ly=(new Rc,[]),By=to.create(0,0,0,1),Fy=new to,zy=new kc;zy.accurate=!0;var Uy=new kc;Uy.accurate=!0;var ky=new kc,Gy=new _i,Hy=new _i,Vy=new _i,Wy=new _i,jy=new _i,Xy=new _i,qy=new _i,Yy=new Zn,Ky=new mi,Qy=new Zn,Zy=new Zn,Jy=new Zn(0,0,0),$y=new $((function(){return{model:null,depth:0}}),128),eS=new $((function(){return{model:null,depth:0}}),128);function tS(e,t){var n=0;e.node&&(Zn.subtract(Oy,e.node.worldPosition,t.position),n=Zn.dot(Oy,t.forward));var i=$y.alloc();return i.model=e,i.depth=n,i}function nS(e,t){var n=0;e.node&&(Zn.subtract(Oy,e.node.worldPosition,t.position),n=Zn.dot(Oy,t.forward));var i=eS.alloc();return i.model=e,i.depth=n,i}function iS(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/Zn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,_i.toArray(n,f,Up.MAT_LIGHT_PLANE_PROJ_OFFSET)}function rS(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;$y.freeArray(s),s.length=0;var c=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(Up.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Cg.ShadowMap))if(c=e.pipelineSceneData.shadowObjects,eS.freeArray(c),c.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device,a=r.invisibleOcclusionRange,s=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();_i.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(Ny,i),kc.split(zy,i,Ny,.1,r.shadowDistance),Uy=kc.clone(zy),_i.fromRT(Gy,n.node.rotation,Jy),_i.invert(Hy,Gy),_i.invert(Vy,Hy);var c=Hy.clone();Uy.transform(Hy),Rc.fromPoints(My,new Zn(1e7,1e7,1e7),new Zn(-1e7,-1e7,-1e7)),My.mergeFrustum(Uy);var l=2*My.halfExtents.z;Dy.set(My.center.x,My.center.y,My.center.z+My.halfExtents.z+a),Zn.transformMat4(Dy,Dy,Vy),_i.fromRT(Gy,n.node.rotation,Dy),_i.invert(Hy,Gy),_i.invert(Vy,Hy);var u=Zn.distance(zy.vertices[0],zy.vertices[6]);Fy.center.set(0,0,0),Fy.radius=-1,Fy.mergePoints(zy.vertices);var h=.8*u+.4*Fy.radius;r.shadowCameraFar=l+a;var _=.5*h;if(_i.ortho(Wy,-_,_,-_,_,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),s>0){_i.multiply(Xy,Wy,c),Zn.transformMat4(Yy,Dy,Xy);var f=2/s;Ky.set(f,f);var p=Yy.x%Ky.x,d=Yy.y%Ky.y;Qy.set(Yy.x-p,Yy.y-d,Yy.z),_i.invert(qy,Xy),Zn.transformMat4(Zy,Qy,qy),_i.fromRT(Gy,n.node.rotation,Zy),_i.invert(Hy,Gy),_i.invert(Vy,Hy),kc.createOrtho(e,h,h,.1,r.shadowCameraFar,Vy)}else{for(var m=0;m<8;m++)e.vertices[m].set(0,0,0);e.updatePlanes()}_i.multiply(jy,Wy,Hy),r.matShadowView=Hy,r.matShadowProj=Wy,r.matShadowViewProj=jy}(ky,e,i,t,o);else{for(var l=0;l<8;l++)ky.vertices[l].set(0,0,0);ky.updatePlanes()}i&&o.type===Cg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/Zn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(Up.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&hm&&s.push(tS(a.model,t));for(var u=n.models,h=t.visibility,_=0;_<u.length;_++){var f=u[_];if(f.enabled&&(f.node&&(h&f.node.layer)===f.node.layer||h&f.visFlags)){if(null!=c&&f.castShadow&&f.worldBounds&&!Ys.aabbFrustum(f.worldBounds,ky)&&c.push(nS(f,t)),f.worldBounds&&!Ys.aabbFrustum(f.worldBounds,t.frustum))continue;s.push(tS(f,t))}}}var oS=new _i,aS=new _i,sS=new _i,cS=new Si,lS=function(){function e(){this._globalUBO=new Float32Array(Fp.COUNT),this._cameraUBO=new Float32Array(zp.COUNT),this._shadowUBO=new Float32Array(Up.COUNT)}e.updateGlobalUBOView=function(e,t){var n=e.device,r=i.director.root,o=t,a=Math.floor(n.width),s=Math.floor(n.height);o[Fp.TIME_OFFSET]=r.cumulativeTime,o[Fp.TIME_OFFSET+1]=r.frameTime,o[Fp.TIME_OFFSET+2]=i.director.getTotalFrames(),o[Fp.SCREEN_SIZE_OFFSET]=n.width,o[Fp.SCREEN_SIZE_OFFSET+1]=n.height,o[Fp.SCREEN_SIZE_OFFSET+2]=1/n.width,o[Fp.SCREEN_SIZE_OFFSET+3]=1/n.height,o[Fp.NATIVE_SIZE_OFFSET]=a,o[Fp.NATIVE_SIZE_OFFSET+1]=s,o[Fp.NATIVE_SIZE_OFFSET+2]=1/o[Fp.NATIVE_SIZE_OFFSET],o[Fp.NATIVE_SIZE_OFFSET+3]=1/o[Fp.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var r=e.device,o=(n.scene?n.scene:i.director.getScene().renderScene).mainLight,a=e.pipelineSceneData,s=a.ambient,c=a.fog,l=Math.floor(r.width),u=Math.floor(r.height),h=t,_=n.exposure,f=a.isHDR,p=a.shadingScale,d=a.fpScale;if(h[zp.SCREEN_SCALE_OFFSET]=n.width/l*p,h[zp.SCREEN_SCALE_OFFSET+1]=n.height/u*p,h[zp.SCREEN_SCALE_OFFSET+2]=1/h[zp.SCREEN_SCALE_OFFSET],h[zp.SCREEN_SCALE_OFFSET+3]=1/h[zp.SCREEN_SCALE_OFFSET+1],h[zp.EXPOSURE_OFFSET]=_,h[zp.EXPOSURE_OFFSET+1]=1/_,h[zp.EXPOSURE_OFFSET+2]=f?1:0,h[zp.EXPOSURE_OFFSET+3]=d/_,o){if(Zn.toArray(h,o.direction,zp.MAIN_LIT_DIR_OFFSET),Zn.toArray(h,o.color,zp.MAIN_LIT_COLOR_OFFSET),o.useColorTemperature){var m=o.colorTemperatureRGB;h[zp.MAIN_LIT_COLOR_OFFSET]*=m.x,h[zp.MAIN_LIT_COLOR_OFFSET+1]*=m.y,h[zp.MAIN_LIT_COLOR_OFFSET+2]*=m.z}h[zp.MAIN_LIT_COLOR_OFFSET+3]=f?o.illuminance*d:o.illuminance*_}else Zn.toArray(h,Zn.UNIT_Z,zp.MAIN_LIT_DIR_OFFSET),Si.toArray(h,Si.ZERO,zp.MAIN_LIT_COLOR_OFFSET);var v=s.colorArray;v[3]=f?s.skyIllum*d:s.skyIllum*_,h.set(v,zp.AMBIENT_SKY_OFFSET),h.set(s.albedoArray,zp.AMBIENT_GROUND_OFFSET),_i.toArray(h,n.matView,zp.MAT_VIEW_OFFSET),_i.toArray(h,n.node.worldMatrix,zp.MAT_VIEW_INV_OFFSET),Zn.toArray(h,n.position,zp.CAMERA_POS_OFFSET),_i.toArray(h,n.matProj,zp.MAT_PROJ_OFFSET),_i.toArray(h,n.matProjInv,zp.MAT_PROJ_INV_OFFSET),_i.toArray(h,n.matViewProj,zp.MAT_VIEW_PROJ_OFFSET),_i.toArray(h,n.matViewProjInv,zp.MAT_VIEW_PROJ_INV_OFFSET),h[zp.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),h.set(c.colorArray,zp.GLOBAL_FOG_COLOR_OFFSET),h[zp.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,h[zp.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,h[zp.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,h[zp.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,h[zp.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,h[zp.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&o.type===Cg.ShadowMap){var s,c,l,u=.1,h=0;if(o.fixedArea){_i.invert(oS,r.node.getWorldMatrix()),s=oS;var _=o.orthoSize,f=o.orthoSize;u=o.near,h=o.far,_i.ortho(aS,-_,_,-f,f,u,h,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY),c=aS,_i.multiply(sS,aS,oS),l=sS}else u=.1,h=o.shadowCameraFar,s=o.matShadowView,c=o.matShadowProj,l=o.matShadowViewProj;_i.toArray(t,s,Up.MAT_LIGHT_VIEW_OFFSET),a[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=c.m10,a[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=c.m14,a[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=c.m11,a[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=c.m15,a[Up.SHADOW_PROJ_INFO_OFFSET+0]=c.m00,a[Up.SHADOW_PROJ_INFO_OFFSET+1]=c.m05,a[Up.SHADOW_PROJ_INFO_OFFSET+2]=1/c.m00,a[Up.SHADOW_PROJ_INFO_OFFSET+3]=1/c.m05,_i.toArray(t,l,Up.MAT_LIGHT_VIEW_PROJ_OFFSET);var p=Zd(i)?0:1;a[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=u,a[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h,a[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=p,a[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Cg.Planar&&iS(o,r,a);Kn.toArray(a,o.shadowColor,Up.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i,r,o,a=e.device,s=e.pipelineSceneData.shadows,c=t,l=Zd(a)?0:1,u=.1,h=0;switch(n.type){case Og.DIRECTIONAL:if(s.fixedArea){_i.invert(oS,n.node.getWorldMatrix()),i=oS;var _=s.orthoSize,f=s.orthoSize;u=s.near,h=s.far,_i.ortho(aS,-_,_,-f,f,u,h,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),r=aS,_i.multiply(sS,aS,oS),o=sS}else u=.1,h=s.shadowCameraFar,i=s.matShadowView,r=s.matShadowProj,o=s.matShadowViewProj;_i.toArray(t,i,Up.MAT_LIGHT_VIEW_OFFSET),c[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=r.m10,c[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=r.m14,c[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=r.m11,c[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=r.m15,c[Up.SHADOW_PROJ_INFO_OFFSET+0]=r.m00,c[Up.SHADOW_PROJ_INFO_OFFSET+1]=r.m05,c[Up.SHADOW_PROJ_INFO_OFFSET+2]=1/r.m00,c[Up.SHADOW_PROJ_INFO_OFFSET+3]=1/r.m05,_i.toArray(t,o,Up.MAT_LIGHT_VIEW_PROJ_OFFSET),cS.set(u,h,0,1-s.saturation),Si.toArray(c,cS,Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),cS.set(0,l,s.normalBias,0),Si.toArray(c,cS,Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Og.SPOT:_i.invert(oS,n.node.getWorldMatrix()),_i.toArray(c,oS,Up.MAT_LIGHT_VIEW_OFFSET),_i.perspective(aS,n.angle,n.aspect,.001,n.range),_i.multiply(sS,aS,oS),_i.toArray(c,sS,Up.MAT_LIGHT_VIEW_PROJ_OFFSET),cS.set(.01,n.range,0,1-s.saturation),Si.toArray(c,cS,Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),cS.set(1,l,s.normalBias,0),Si.toArray(c,cS,Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}cS.set(s.size.x,s.size.y,s.pcf,s.bias),Si.toArray(c,cS,Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Kn.toArray(c,s.shadowColor,Up.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,Fp.SIZE,Fp.SIZE));n.bindBuffer(Fp.BINDING,i);var r=e.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,zp.SIZE,zp.SIZE));n.bindBuffer(zp.BINDING,r);var o=e.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,Up.SIZE,Up.SIZE));n.bindBuffer(Up.BINDING,o)},t.updateGlobalUBO=function(){var t=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,i=this._pipeline.commandBuffers;n.update(),e.updateGlobalUBOView(this._pipeline,this._globalUBO),i[0].updateBuffer(n.getBuffer(Fp.BINDING),this._globalUBO),t.bindBuffer(Fp.BINDING,n.getBuffer(Fp.BINDING)),t.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(zp.BINDING),this._cameraUBO),n.bindBuffer(zp.BINDING,i.getBuffer(zp.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;i.update(),a&&o.has(a)&&i.bindTexture(kp,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),r[0].updateBuffer(i.getBuffer(Up.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){var i=this._pipeline.descriptorSet;e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,t,n),i.getBuffer(Up.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof _i?_i.toArray(this._shadowUBO,t,e):t instanceof Kn&&Kn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();lS._combineSignY=0;var uS,hS,_S,fS,pS,dS,mS,vS,gS,yS,SS,TS=[Dr.LINEAR,Dr.LINEAR,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP],ES=[Dr.POINT,Dr.POINT,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP],xS=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device;var t=Em(TS);this._linearSampler=Lm.getSampler(this._device,t);var n=Em(ES);this._pointSampler=Lm.getSampler(this._device,n);var i=new Yo(Rp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(i),this._globalDescriptorSet=this._device.createDescriptorSet(new Ko(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Ko(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=wp.UBO_GLOBAL;r<wp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,Up.SIZE,Up.SIZE));i.bindBuffer(Up.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy(),this._linearSampler.destroy(),this._pointSampler.destroy()},k(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),AS=e("RenderPipeline",(uS=Zc("cc.RenderPipeline"),hS=El(),_S=El(),fS=Pl([Iy]),uS((gS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_tag",mS,Y(t)),Z(t,"_flows",vS,Y(t)),t._commandBuffers=[],t._pipelineUBO=new lS,t._macros={},t._constantMacros="",t}H(t,e);var n=t.prototype;return n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.generateRenderArea=function(e){var t=new co,n=e.viewport,i=this.pipelineSceneData,r=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.height:e.width,o=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.width:e.height;return t.x=n.x*r,t.y=n.y*o,t.width=n.width*r*i.shadingScale,t.height=n.height*o*i.shadingScale,t},n.activate=function(){this._device=i.director.root.device,this._globalDSManager=new xS(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),!0},n.render=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.scene)for(var i=0;i<this._flows.length;i++)this._flows[i].render(n)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n.resize=function(){},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(Sr.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",this._constantMacros=e},k(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}}]),t}(Cu),mS=J((dS=gS).prototype,"_tag",[hS,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vS=J(dS.prototype,"_flows",[_S,fS,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pS=dS))||pS));i.RenderPipeline=AS,function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(yS||(yS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(SS||(SS={}));var bS,CS,wS,RS,PS,IS,OS,DS,NS,MS,LS=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.id,a=this._PSOHashMap.get(o);if(!a){t.pipelineLayout;var s=new Zo(r.attributes),c=new Da(n,t.pipelineLayout,i,s,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(c),this._PSOHashMap.set(o,a)}return a},e}());LS._PSOHashMap=new Map;var BS=new Uo;BS.endAccesses=[Hr.FRAGMENT_SHADER_READ_TEXTURE];var FS,zS,US,kS,GS,HS,VS,WS,jS,XS,qS,YS,KS,QS,ZS,JS,$S,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,pT,dT,mT,vT,gT,yT,ST,TT,ET,xT,AT,bT,CT,wT,RT,PT,IT,OT,DT,NT,MT,LT,BT,FT,zT,UT,kT,GT,HT,VT,WT,jT,XT,qT,YT,KT,QT,ZT,JT,$T,eE,tE,nE,iE,rE,oE,aE,sE,cE=new ko,lE=new Vo([BS],cE),uE={width:1,height:1,renderPassInfo:lE},hE=e("RenderTexture",(bS=Zc("cc.RenderTexture"),CS=gl(),wS=yl(),RS=gl(),PS=yl(),bS((MS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_width",DS,Y(t)),Z(t,"_height",NS,Y(t)),t._window=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=i.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.getGFXSampler=function(){var e=i.director.root;return Lm.getSampler(e.device,ym)},n.getSamplerHash=function(){return ym},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=i.director.root;uE.title=this._name,uE.width=this._width,uE.height=this._height,uE.renderPassInfo=e&&e.passInfo?e.passInfo:lE,this._window?(this._window.destroy(),this._window.initialize(t.device,uE)):this._window=t.createWindow(uE)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},k(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}},{key:"_serialize",get:function(){return null}},{key:"_deserialize",get:function(){return null}}]),t}(Fm),DS=J((OS=MS).prototype,"_width",[il,CS,wS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NS=J(OS.prototype,"_height",[il,RS,PS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IS=OS))||IS));i.RenderTexture=hE,et(Rr),et(Pr),et(Gr),et(kr),et(Hr),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(sE||(sE={})),et(sE),FS=Zc("RenderTextureDesc"),zS=Pl(Rr),US=Pl(Pr),kS=Pl(Tr),FS((HS=J((GS=function(){Z(this,"name",HS,this),Z(this,"type",VS,this),Z(this,"usage",WS,this),Z(this,"format",jS,this),Z(this,"width",XS,this),Z(this,"height",qS,this)}).prototype,"name",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VS=J(GS.prototype,"type",[zS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rr.TEX2D}}),WS=J(GS.prototype,"usage",[US],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.COLOR_ATTACHMENT}}),jS=J(GS.prototype,"format",[kS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),XS=J(GS.prototype,"width",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),qS=J(GS.prototype,"height",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),GS));var _E,fE=(YS=Zc("RenderTextureConfig"),KS=Pl(hE),YS((JS=J((ZS=function(){Z(this,"name",JS,this),Z(this,"texture",$S,this)}).prototype,"name",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$S=J(ZS.prototype,"texture",[KS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QS=ZS))||QS),pE=(eT=Zc("MaterialConfig"),tT=Pl(Ag),eT((iT=J((nT=function(){Z(this,"name",iT,this),Z(this,"material",rT,this)}).prototype,"name",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rT=J(nT.prototype,"material",[tT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nT)),oT=Zc("FrameBufferDesc"),aT=Pl([wt]),sT=Pl(hE),oT((lT=J((cT=function(){Z(this,"name",lT,this),Z(this,"renderPass",uT,this),Z(this,"colorTextures",hT,this),Z(this,"depthStencilTexture",_T,this),Z(this,"texture",fT,this)}).prototype,"name",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uT=J(cT.prototype,"renderPass",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hT=J(cT.prototype,"colorTextures",[aT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_T=J(cT.prototype,"depthStencilTexture",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fT=J(cT.prototype,"texture",[sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cT)),pT=Zc("ColorDesc"),dT=Pl(Tr),mT=Pl(kr),vT=Pl(Gr),gT=Pl([Hr]),yT=Pl([Hr]),pT((ET=J((TT=function(){Z(this,"format",ET,this),Z(this,"loadOp",xT,this),Z(this,"storeOp",AT,this),Z(this,"sampleCount",bT,this),Z(this,"beginAccesses",CT,this),Z(this,"endAccesses",wT,this)}).prototype,"format",[dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),xT=J(TT.prototype,"loadOp",[mT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),AT=J(TT.prototype,"storeOp",[vT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gr.STORE}}),bT=J(TT.prototype,"sampleCount",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CT=J(TT.prototype,"beginAccesses",[gT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wT=J(TT.prototype,"endAccesses",[yT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Hr.PRESENT]}}),ST=TT))||ST),dE=(RT=Zc("DepthStencilDesc"),PT=Pl(Tr),IT=Pl(kr),OT=Pl(Gr),DT=Pl(kr),NT=Pl(Gr),MT=Pl([Hr]),LT=Pl([Hr]),RT((zT=J((FT=function(){Z(this,"format",zT,this),Z(this,"depthLoadOp",UT,this),Z(this,"depthStoreOp",kT,this),Z(this,"stencilLoadOp",GT,this),Z(this,"stencilStoreOp",HT,this),Z(this,"sampleCount",VT,this),Z(this,"beginAccesses",WT,this),Z(this,"endAccesses",jT,this)}).prototype,"format",[PT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),UT=J(FT.prototype,"depthLoadOp",[IT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),kT=J(FT.prototype,"depthStoreOp",[OT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gr.STORE}}),GT=J(FT.prototype,"stencilLoadOp",[DT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.CLEAR}}),HT=J(FT.prototype,"stencilStoreOp",[NT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gr.STORE}}),VT=J(FT.prototype,"sampleCount",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WT=J(FT.prototype,"beginAccesses",[MT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jT=J(FT.prototype,"endAccesses",[LT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),BT=FT))||BT);XT=Zc("RenderPassDesc"),qT=Pl([pE]),YT=Pl(dE),XT((QT=J((KT=function(){Z(this,"index",QT,this),Z(this,"colorAttachments",ZT,this),Z(this,"depthStencilAttachment",JT,this)}).prototype,"index",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ZT=J(KT.prototype,"colorAttachments",[qT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JT=J(KT.prototype,"depthStencilAttachment",[YT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dE}}),KT)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(_E||(_E={})),et(_E);var mE=($T=Zc("RenderQueueDesc"),eE=Pl(_E),tE=Pl([wt]),$T((rE=J((iE=function(){Z(this,"isTransparent",rE,this),Z(this,"sortMode",oE,this),Z(this,"stages",aE,this)}).prototype,"isTransparent",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oE=J(iE.prototype,"sortMode",[eE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _E.FRONT_TO_BACK}}),aE=J(iE.prototype,"stages",[tE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nE=iE))||nE);function vE(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function gE(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var yE=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new ee((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new te(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.id,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=LS.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Np.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Np.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function SE(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Hv(e.stages[n]);var i=vE;switch(e.sortMode){case _E.BACK_TO_FRONT:i=gE;break;case _E.FRONT_TO_BACK:i=vE}return new yE({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function TE(e){e.clear()}function EE(e){e.sort()}function xE(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var AE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=LS.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Np.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Np.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),bE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Np.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=LS.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(Np.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),CE=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,n){void 0===n&&(n=0);var i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<_d.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=i[p],m=_.vbs[p],v=_.vbDatas[p];(r=(a+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,S=y+a,T=_.mergeCount;if(g[y]!==T||g[S-1]!==T)for(var E=y;E<S;E++)g[E]=T+.1;return _i.toArray(_.uboData,n.transform.worldMatrix,_d.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(_d.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var x=[],A=[],b=[],C=0;C<i.length;++C){var w=i[C],R=this._device.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),x.push(R),A.push(new Uint8Array(R.size)),b.push(R)}var P=this._device.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,4*a,4)),I=new Float32Array(a);I.fill(0),P.update(I),b.push(P);for(var O=e.inputAssembler.attributes,D=new Array(O.length+1),N=0;N<O.length;++N)D[N]=O[N];D[O.length]=new Bo("a_dyn_batch_id",Tr.R32F,!1,i.length);var M=new zo(D,b),L=this._device.createInputAssembler(M),B=this._device.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,_d.SIZE,_d.SIZE));l.bindBuffer(_d.BINDING,B),l.update();var F=new Float32Array(_d.COUNT);_i.toArray(F,n.transform.worldMatrix,_d.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:x,vbDatas:A,vbIdx:P,vbIdxData:I,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();CE._buffers=new Map;var wE=new $((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),RE=new Float32Array(4),PE=to.create(0,0,0,1),IE=[],OE=[],DE=new _i,NE=new _i;function ME(e,t){return!(!t.worldBounds||Ys.aabbWithAABB(t.worldBounds,e.aabb))}function LE(e,t){return!(!t.worldBounds||Ys.aabbWithAABB(t.worldBounds,e.aabb)&&Ys.aabbFrustum(t.worldBounds,e.frustum))}var BE=Hv("forward-add"),FE=[];function zE(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===BE){o=a,n=!0;break}t.push(o)}return n}var UE,kE,GE,HE,VE,WE,jE,XE,qE,YE,KE,QE=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._shadowUBO=new Float32Array(Up.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new bE,this._batchedQueue=new AE;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(fd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new So(this._lightBuffer,0,fd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}wE.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Up.BINDING).destroy(),r.getSampler(kp).destroy(),r.getSampler(sd).destroy(),r.getTexture(kp).destroy(),r.getTexture(sd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){var n=this._validLights;if(this.clear(),this._gatherValidLights(e,n),n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(zE(a,FE)&&(OE.length=0,this._lightCulling(o,n),OE.length))for(var s=0;s<a.length;s++){var c=FE[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.descriptorSet.bindBuffer(fd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c,n)}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=LS.getOrCreatePipelineState(e,u,h,t,_),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(Np.MATERIAL,p),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);IE[0]=c[m],n.bindDescriptorSet(Np.GLOBAL,g),n.bindDescriptorSet(Np.LOCAL,d,IE),n.draw(_)}}},t._gatherValidLights=function(e,t){for(var n=e.scene.sphereLights,i=0;i<n.length;i++){var r=n[i];r.baked||(to.set(PE,r.position.x,r.position.y,r.position.z,r.range),Ys.sphereFrustum(PE,e.frustum)&&t.push(r))}for(var o=e.scene.spotLights,a=0;a<o.length;a++){var s=o[a];s.baked||(to.set(PE,s.position.x,s.position.y,s.position.z,s.range),Ys.sphereFrustum(PE,e.frustum)&&t.push(s))}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case Og.SPHERE:r=ME(i,e);break;case Og.SPOT:r=LE(i,e)}r||OE.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===zv.INSTANCING)for(var o=0;o<OE.length;o++){var a=OE[o],s=Kv.get(e,a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===zv.VB_MERGING)for(var c=0;c<OE.length;c++){var l=OE[c],u=CE.get(e,l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=wE.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<OE.length;_++){var f=OE[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=Zd(n)?0:1,c=this._pipeline.globalDSManager,l=0;l<this._validLights.length;l++){var u=this._validLights[l],h=c.getOrCreateDescriptorSet(l);if(h){var _=void 0,f=void 0;switch(u.type){case Og.SPHERE:a&&iS(r,a,this._shadowUBO),this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Kn.toArray(this._shadowUBO,r.shadowColor,Up.SHADOW_COLOR_OFFSET);break;case Og.SPOT:if(a&&iS(r,a,this._shadowUBO),_i.invert(DE,u.node.getWorldMatrix()),_i.perspective(NE,u.angle,u.aspect,.001,u.range),_=NE.clone(),f=NE.clone().invert(),_i.multiply(NE,NE,DE),_i.toArray(this._shadowUBO,DE,Up.MAT_LIGHT_VIEW_OFFSET),_i.toArray(this._shadowUBO,NE,Up.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=u.range,this._shadowUBO[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Up.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Up.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Up.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[Up.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[Up.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Up.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Up.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Up.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Up.SHADOW_PROJ_INFO_OFFSET+0]=_.m00,this._shadowUBO[Up.SHADOW_PROJ_INFO_OFFSET+1]=_.m05,this._shadowUBO[Up.SHADOW_PROJ_INFO_OFFSET+2]=1/_.m00,this._shadowUBO[Up.SHADOW_PROJ_INFO_OFFSET+3]=1/_.m05,Kn.toArray(this._shadowUBO,r.shadowColor,Up.SHADOW_COLOR_OFFSET),o.has(u)){var p,d=null===(p=o.get(u))||void 0===p?void 0:p.colorTextures[0];d&&h.bindTexture(sd,d)}}h.update(),t.updateBuffer(h.getBuffer(Up.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.fpScale;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Gn(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new So(this._lightBuffer,0,fd.SIZE)));for(var a=0,s=0;a<this._validLights.length;a++,s+=this._lightBufferElementCount){var c=this._validLights[a];switch(c.type){case Og.SPHERE:if(Zn.toArray(RE,c.position),RE[3]=0,this._lightBufferData.set(RE,s+fd.LIGHT_POS_OFFSET),RE[0]=c.size,RE[1]=c.range,RE[2]=0,this._lightBufferData.set(RE,s+fd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Zn.toArray(RE,c.color),c.useColorTemperature){var l=c.colorTemperatureRGB;RE[0]*=l.x,RE[1]*=l.y,RE[2]*=l.z}RE[3]=r?c.luminance*o*this._lightMeterScale:c.luminance*n*this._lightMeterScale,this._lightBufferData.set(RE,s+fd.LIGHT_COLOR_OFFSET);break;case Og.SPOT:if(Zn.toArray(RE,c.position),RE[3]=1,this._lightBufferData.set(RE,s+fd.LIGHT_POS_OFFSET),RE[0]=c.size,RE[1]=c.range,RE[2]=c.spotAngle,this._lightBufferData.set(RE,s+fd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Zn.toArray(RE,c.direction),this._lightBufferData.set(RE,s+fd.LIGHT_DIR_OFFSET),Zn.toArray(RE,c.color),c.useColorTemperature){var u=c.colorTemperatureRGB;RE[0]*=u.x,RE[1]*=u.y,RE[2]*=u.z}RE[3]=r?c.luminance*o*this._lightMeterScale:c.luminance*n*this._lightMeterScale,this._lightBufferData.set(RE,s+fd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),ZE=new Rc,JE=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new bE,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=this._pipeline.pipelineUBO,r=n.shadows;if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,r.enabled&&r.type===Cg.Planar){i.updateShadowUBO(e);var o=e.scene,a=e.frustum,s=0!=(e.visibility&Sp.BitMask.DEFAULT);if(o.mainLight&&s){for(var c=o.models,l=0;l<c.length;l++){var u=c[l];u.enabled&&u.node&&u.castShadow&&this._castModels.push(u)}var h=Kv.get(r.instancingMaterial.passes[0]);this._instancedQueue.queue.add(h);for(var _=0;_<this._castModels.length;_++){var f=this._castModels[_];if(!f.worldBounds||(Rc.transform(ZE,f.worldBounds,r.matLight),Ys.aabbFrustum(ZE,a)))if(f.isInstancingEnabled)for(var p=f.subModels,d=0;d<p.length;d++){var m=p[d];h.merge(m,f.instancedAttributes,0,m.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Cg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Np.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=LS.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(Np.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),$E=function(){function e(){this._phaseID=Hv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=s.descriptorSet,d=LS.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(Np.MATERIAL,h.descriptorSet),r.bindDescriptorSet(Np.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},e}(),ex=[new vo(0,0,0,1)],tx=e("ForwardStage",(UE=Zc("ForwardStage"),kE=Pl([mE]),GE=El(),UE((XE=jE=function(e){function t(){var t;return Z(t=e.call(this)||this,"renderQueues",WE,Y(t)),t._renderQueues=[],t._renderArea=new co,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Hv("default"),t._clearFlag=4294967295,t._batchedQueue=new AE,t._instancedQueue=new bE,t._uiPhase=new $E,t}H(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=SE(this.renderQueues[i]);this._additiveLightQueue=new QE(this._pipeline),this._planarQueue=new JE(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(TE);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===zv.INSTANCING){var p=Kv.get(_);p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===zv.VB_MERGING){var d=CE.get(_);d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(EE);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m);var v=t.pipelineSceneData;if(this._renderArea=t.generateRenderArea(e),e.clearFlag&eo.COLOR)if(v.isHDR){xE(ex[0],e.clearColor);var g=v.fpScale/e.exposure;ex[0].x*=g,ex[0].y*=g,ex[0].z*=g}else ex[0].x=e.clearColor.x,ex[0].y=e.clearColor.y,ex[0].z=e.clearColor.z;ex[0].w=e.clearColor.w;var y=e.window.framebuffer,S=y.colorTextures[0]?y.renderPass:t.getRenderPass(e.clearFlag&this._clearFlag);m.beginRenderPass(S,y,this._renderArea,ex,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Np.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,S,m),this._instancedQueue.recordCommandBuffer(n,S,m),this._batchedQueue.recordCommandBuffer(n,S,m),this._additiveLightQueue.recordCommandBuffer(n,S,m),this._planarQueue.recordCommandBuffer(n,S,m),this._renderQueues[1].recordCommandBuffer(n,S,m),this._uiPhase.render(e,S),m.endRenderPass()},t}(Py),jE.initInfo={name:"ForwardStage",priority:yS.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:_E.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:_E.BACK_TO_FRONT,stages:["default","planarShadow"]}]},WE=J((VE=XE).prototype,"renderQueues",[kE,il,GE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HE=VE))||HE)),nx=e("ForwardFlow",Zc("ForwardFlow")((KE=YE=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new tx;n.initialize(tx.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Iy),YE.initInfo={name:bp,priority:SS.FORWARD,stages:[]},qE=KE))||qE),ix=Hv("shadow-caster"),rx=[];function ox(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===ix){o=a,n=!0;break}t.push(o)}return n}var ax,sx,cx,lx,ux,hx,_x=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new bE,this._batchedQueue=new AE}var t=e.prototype;return t.gatherLightPasses=function(e,t,n){this.clear();var i=this._pipeline.pipelineSceneData.shadows,r=this._pipeline.pipelineSceneData.shadowObjects,o=this._pipeline.pipelineSceneData.renderObjects;if(e&&i.enabled&&i.type===Cg.ShadowMap)switch(this._pipeline.pipelineUBO.updateShadowUBOLight(e,t),e.type){case Og.DIRECTIONAL:for(var a=0;a<r.length;a++){var s=r[a].model;ox(s.subModels,rx)&&this.add(s,n,rx)}break;case Og.SPOT:for(var c=0;c<o.length;c++){var l=o[c].model;ox(l.subModels,rx)&&l.castShadow&&(!l.worldBounds||Ys.aabbWithAABB(l.worldBounds,e.aabb)&&Ys.aabbFrustum(l.worldBounds,e.frustum))&&this.add(l,n,rx)}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,n){for(var i=e.subModels,r=0;r<i.length;r++){var o=i[r],a=n[r],s=o.passes[a];if(s.batchingScheme===zv.INSTANCING){var c=Kv.get(s);c.merge(o,e.instancedAttributes,a),this._instancedQueue.queue.add(c)}else if(s.batchingScheme===zv.VB_MERGING){var l=CE.get(s);l.merge(o,a,e),this._batchedQueue.queue.add(l)}else{var u=o.shaders[a];this._subModelsArray.push(o),u&&this._shaderArray.push(u),this._passArray.push(s)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=LS.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Np.MATERIAL,l),n.bindDescriptorSet(Np.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),fx=[new vo(1,1,1,1)],px=e("ShadowStage",Zc("ShadowStage")((cx=sx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new co,t._light=null,t}H(t,e);var n=t.prototype;return n.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},n.destroy=function(){var e;null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){fx[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,fx,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,e,o);var a=e.viewport,s=i.size;this._renderArea.x=a.x*s.x,this._renderArea.y=a.y*s.y,this._renderArea.width=a.width*s.x*r,this._renderArea.height=a.height*s.y*r;var c=t.device,l=this._shadowFrameBuffer.renderPass;o.beginRenderPass(l,this._shadowFrameBuffer,this._renderArea,fx,e.clearDepth,e.clearStencil),o.bindDescriptorSet(Np.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(c,l,o),o.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new _x(t)},t}(Py),sx.initInfo={name:"ShadowStage",priority:yS.FORWARD,tag:0},ax=cx))||ax),dx=e("ShadowFlow",Zc("ShadowFlow")((hx=ux=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new px;n.initialize(px.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.shadowObjects,o=t.pipelineSceneData.renderObjects;if(n.enabled&&n.type===Cg.ShadowMap){var a=function(e,t){Ly.length=0;var n=e.scene;Ly.push(n.mainLight);for(var i=n.spotLights,r=0;r<i.length;r++){var o=i[r];to.set(By,o.position.x,o.position.y,o.position.z,o.range),Ys.sphereFrustum(By,e.frustum)&&t>Ly.length&&Ly.push(o)}return Ly}(e,n.maxReceived);if(0!==r.length||0!==o.length){n.shadowMapDirty&&this.resizeShadowMap();for(var s=0;s<a.length;s++){var c=a[s];i.has(c)||this._initShadowFrameBuffer(t,c);for(var l=i.get(c),u=0;u<this._stages.length;u++){var h=this._stages[u];h.setUsage(c,l),h.render(e)}}t.pipelineUBO.updateShadowUBO(e)}else this.clearShadowMap(a,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=Zd(n)?Tr.R32F:Tr.RGBA8;if(!this._shadowRenderPass){var a=new Uo;a.format=o,a.loadOp=kr.CLEAR,a.storeOp=Gr.STORE,a.sampleCount=1;var s=new ko;s.format=n.depthStencilFormat,s.depthLoadOp=kr.CLEAR,s.depthStoreOp=Gr.DISCARD,s.stencilLoadOp=kr.CLEAR,s.stencilStoreOp=Gr.DISCARD,s.sampleCount=1;var c=new Vo([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new Ao(Rr.TEX2D,Pr.DEPTH_STENCIL_ATTACHMENT,n.depthStencilFormat,i.x,i.y)),h=n.createFramebuffer(new Xo(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){for(var n=this._pipeline.pipelineSceneData,i=0;i<e.length;i++){var r=e[i],o=n.shadowFrameBufferMap.get(r);if(n.shadowFrameBufferMap.has(r))for(var a=0;a<this._stages.length;a++){var s=this._stages[a];s.setUsage(r,o),s.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Zd(i)?Tr.R32F:Tr.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Xo(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(Iy),ux.initInfo={name:Cp,priority:SS.SHADOW,tag:sE.SCENE,stages:[]},lx=hx))||lx),mx=Ze({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),vx=mx.LAYERED+1,gx=function(){function e(){this._fogColor=new Kn("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._enabled=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:vx},t._setEnable=function(e){this._enabled=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=i.director.root,t=this.enabled?this.type:vx,n=e.pipeline;n.macros.CC_USE_FOG!==t&&(n.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e||(this._type=vx),e?this.activate():this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),Kn.toArray(this._colorArray,this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();i.Fog=gx;var yx,Sx,Tx,Ex,xx,Ax,bx,Cx,wx,Rx,Px,Ix,Ox,Dx,Nx,Mx,Lx,Bx=function(){var e=t.prototype;function t(){this.fog=new gx,this.ambient=new Ki,this.skybox=new Vg,this.shadows=new Pg,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._isHDR=!1,this._shadingScale=1,this._fpScale=1/1024,this._init(),this.shadingScale=1,this.fpScale=1/1024}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,!0},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy()},k(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"fpScale",get:function(){return this._fpScale},set:function(e){this._fpScale=e}}]),t}(),Fx=[Dr.POINT,Dr.POINT,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP],zx=e("ForwardPipeline",(yx=Zc("ForwardPipeline"),Sx=Pl([fE]),Tx=El(),yx((bx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",Ax,Y(t)),t._renderPasses=new Map,t}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new dx;n.initialize(dx.initInfo),this._flows.push(n);var i=new nx;i.initialize(nx.initInfo),this._flows.push(i)}return!0},n.activate=function(){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new Bx,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(C(2402),1))},n.render=function(e){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){rS(this,n),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n)}}this._commandBuffers[0].end(),this._device.flushCommands(this._commandBuffers),this._device.queue.submit(this._commandBuffers)},n.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new Uo,r=new ko;i.format=n.colorFormat,r.format=n.depthStencilFormat,r.stencilStoreOp=Gr.DISCARD,r.depthStoreOp=Gr.DISCARD,e&eo.COLOR||(e&hm?i.loadOp=kr.DISCARD:(i.loadOp=kr.LOAD,i.beginAccesses=[Hr.PRESENT])),(e&eo.DEPTH_STENCIL)!==eo.DEPTH_STENCIL&&(e&eo.DEPTH||(r.depthLoadOp=kr.LOAD),e&eo.STENCIL||(r.stencilLoadOp=kr.LOAD),r.beginAccesses=[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE]);var o=new Vo([i],r);return t=n.createRenderPass(o),this._renderPasses.set(e,t),t},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=Em(Fx),n=Lm.getSampler(e,t);return this._descriptorSet.bindSampler(kp,n),this._descriptorSet.bindTexture(kp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(sd,n),this._descriptorSet.bindTexture(sd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Fp.BINDING).destroy(),this._descriptorSet.getBuffer(Up.BINDING).destroy(),this._descriptorSet.getBuffer(zp.BINDING).destroy(),this._descriptorSet.getSampler(kp).destroy(),this._descriptorSet.getSampler(sd).destroy(),this._descriptorSet.getTexture(kp).destroy(),this._descriptorSet.getTexture(sd).destroy())},n.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},t}(AS),Ax=J((xx=bx).prototype,"renderTextures",[Sx,il,Tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ex=xx))||Ex));!function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT",e[e.POSTPROCESS=19]="POSTPROCESS",e[e.UI=20]="UI"}(Cx||(Cx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.GBUFFER=1]="GBUFFER",e[e.LIGHTING=5]="LIGHTING",e[e.UI=10]="UI"}(wx||(wx={}));var Ux,kx,Gx,Hx,Vx,Wx,jx,Xx,qx,Yx,Kx,Qx,Zx,Jx,$x,eA,tA,nA=[new vo(0,0,0,0),new vo(0,0,0,0),new vo(0,0,0,0),new vo(0,0,0,0)],iA=e("GbufferStage",(Rx=Zc("GbufferStage"),Px=Pl([mE]),Ix=El(),Rx((Lx=Mx=function(e){function t(){var t;return Z(t=e.call(this)||this,"renderQueues",Nx,Y(t)),t._renderQueues=[],t._renderArea=new co,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Hv("deferred"),t._batchedQueue=new AE,t._instancedQueue=new bE,t}H(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=SE(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(TE);var i=t.pipelineSceneData.renderObjects;if(0!==i.length){for(var r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===zv.INSTANCING){var p=Kv.get(_);p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===zv.VB_MERGING){var d=CE.get(_);d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(EE);var m=t.commandBuffers[0];if(this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._renderArea=t.generateRenderArea(e),t.updateQuadVertexData(this._renderArea),e.clearFlag&eo.COLOR)if(t.pipelineSceneData.isHDR){xE(nA[0],e.clearColor);var v=t.pipelineSceneData.fpScale/e.exposure;nA[0].x*=v,nA[0].y*=v,nA[0].z*=v}else nA[0].x=e.clearColor.x,nA[0].y=e.clearColor.y,nA[0].z=e.clearColor.z;nA[0].w=e.clearColor.w;var g=t.getDeferredRenderData(e).gbufferFrameBuffer,y=g.renderPass;m.beginRenderPass(y,g,this._renderArea,nA,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Np.GLOBAL,t.descriptorSet);for(var S=0;S<this.renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,y,m);this._instancedQueue.recordCommandBuffer(n,y,m),this._batchedQueue.recordCommandBuffer(n,y,m),m.endRenderPass()}},t}(Py),Mx.initInfo={name:"GbufferStage",priority:Cx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:_E.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:_E.BACK_TO_FRONT,stages:["default"]}]},Nx=J((Dx=Lx).prototype,"renderQueues",[Px,il,Ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ox=Dx))||Ox)),rA=e("GbufferFlow",Zc("GbufferFlow")((Gx=kx=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new iA;n.initialize(iA.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Iy),kx.initInfo={name:xp,priority:wx.GBUFFER,stages:[]},Ux=Gx))||Ux),oA=[new vo(0,0,0,1)],aA=e("LightingStage",(Hx=Zc("LightingStage"),Vx=Pl(Ag),Wx=El(),jx=Pl([mE]),Xx=El(),Hx((Jx=Zx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._deferredLitsBufs=null,t._maxDeferredLights=pd.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new co,Z(t,"_deferredMaterial",Kx,Y(t)),Z(t,"renderQueues",Qx,Y(t)),t._phaseID=Hv("default"),t._defPhaseID=Hv("deferred"),t._renderQueues=[],t}H(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=to.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Si.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(to.set(o,_.position.x,_.position.y,_.position.z,_.range),Ys.sphereFrustum(o,e.frustum)){if(Zn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),Zn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*t.pipelineSceneData.fpScale*this._lightMeterScale:a[3]=_.luminance*s*this._lightMeterScale,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(to.set(o,d.position.x,d.position.y,d.position.z,d.range),Ys.sphereFrustum(o,e.frustum)){if(Zn.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Zn.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=d.luminance*t.pipelineSceneData.fpScale*this._lightMeterScale:a[3]=d.luminance*s*this._lightMeterScale,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),Zn.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=SE(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new So(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new Yo(Pp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Ko(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(fd.BINDING,a),this._planarQueue=new JE(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;if(0!==o.length){if(this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(Np.LOCAL,this._descriptorSet,[0]),this._renderArea=t.generateRenderArea(e),e.clearFlag&eo.COLOR)if(r.isHDR){xE(oA[0],e.clearColor);var a=r.fpScale/e.exposure;oA[0].x*=a,oA[0].y*=a,oA[0].z*=a}else oA[0].x=e.clearColor.x,oA[0].y=e.clearColor.y,oA[0].z=e.clearColor.z;oA[0].w=0;var s=t.getDeferredRenderData(e).lightingFrameBuffer,c=s.renderPass;i.beginRenderPass(c,s,this._renderArea,oA,e.clearDepth,e.clearStencil),i.bindDescriptorSet(Np.GLOBAL,t.descriptorSet);var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant();i.bindDescriptorSet(Np.MATERIAL,l.descriptorSet);var h=t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=LS.getOrCreatePipelineState(n,l,u,c,h)),null!=_&&(i.bindPipelineState(_),i.bindInputAssembler(h),i.draw(h)),this._renderQueues.forEach(TE);for(var f=0,p=0,d=0,m=0;m<o.length;++m){var v=o[m],g=v.model.subModels;for(f=0;f<g.length;++f){var y=g[f].passes;for(p=0;p<y.length;++p){var S=y[p];if(S.phase===this._phaseID||S.phase===this._defPhaseID)for(d=0;d<this._renderQueues.length;d++)this._renderQueues[d].insertRenderPass(v,f,p)}}}this._renderQueues.forEach(EE);for(var T=0;T<this._renderQueues.length;T++)this._renderQueues[T].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i),i.endRenderPass()}},t}(Py),Zx.initInfo={name:"LightingStage",priority:Cx.LIGHTING,tag:0},Kx=J((Yx=Jx).prototype,"_deferredMaterial",[Vx,il,Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qx=J(Yx.prototype,"renderQueues",[jx,il,Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qx=Yx))||qx)),sA=e("LightingFlow",Zc("LightingFlow")((tA=eA=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new aA;n.initialize(aA.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Iy),eA.initInfo={name:Ap,priority:wx.LIGHTING,stages:[]},$x=tA))||$x);function cA(e,t){for(var n,i=Q(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?cA(e,r):e.push(r)}}function lA(e){var t=[];return cA(t,e),t.join("")}var uA=Zt.Flags.Destroyed,hA=Zt.Flags.PersistentMask,_A=Wt.IDENTIFIER_RE,fA="var ",pA="o",dA={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},mA=Wt.escapeForJS,vA=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return fA+this.varName+"="+this.expression+";"},e}();function gA(e,t){return t instanceof vA?new vA(t.varName,e+t.expression):e+t}function yA(e,t,n){Array.isArray(n)?(n[0]=gA(t,n[0]),e.push(n)):e.push(gA(t,n)+";")}var SA=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];yA(e,t+TA(i[0])+"=",i[1])}},e}();function TA(e){return _A.test(e)?"."+e:"["+mA(e)+"]"}SA.pool=void 0,SA.pool=new qe((function(e){e._exps.length=0,e._targetExp=null}),1),SA.pool.get=function(e){var t=this._get()||new SA;return t._targetExp=e,t};var EA=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Se(),Oe(this.funcModuleCache,dA),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=fA+this.globalVariables.join(",")+";");var i=lA(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Te(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=SA.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),SA.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var r=n.__values__,o=Tt(n),a=0;a<r.length;a++){var s=r[a],c=t[s],l=o[s+"$_$default"];if(!xA(l,c))if("object"==typeof c&&c instanceof i.ValueType&&(l=Wt.getDefault(l))&&l.constructor===c.constructor){var u=pA+TA(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new vA(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)yA(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new vA(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&yA(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=gA(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?mA(n):("_objFlags"===t&&e instanceof Zt&&(n&=hA),n)},t.setObjProp=function(e,t,n,i){yA(e,pA+TA(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=t[r];"object"==typeof o&&o&&o===t._iN$t||this.setObjProp(e,t,r,o)}},t.instantiateObj=function(e){if(e instanceof i.ValueType)return Wt.getNewValueTypeCode(e);if(e instanceof i.Asset)return this.getObjRef(e);if(e._objFlags&uA)return null;var t,n=e.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return this.getObjRef(e)}else if(this.parent instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof i.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new vA(pA,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new vA(pA,"{}");else{if(n)return this.getObjRef(e);t=new vA(pA,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function xA(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof i.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return pe(e)&&pe(t)}return!1}var AA,bA=function(){function e(e){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this.uiTransformDirty=!0,this._node=e}return k(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?A(12002):this._uiComp=e}}]),e}();!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(AA||(AA=e("SystemEventType",{}))),et(AA),i.SystemEventType=AA;var CA=function(){function e(e,t,n){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=n,this._type=e||0,this._listenerID=t||""}e.create=function(e){P(e&&e.event,1900);var t=e.event;delete e.event;var n=null;if(t===i.EventListener.TOUCH_ONE_BY_ONE?n=new PA:t===i.EventListener.TOUCH_ALL_AT_ONCE?n=new IA:t===i.EventListener.MOUSE?n=new RA:t===i.EventListener.KEYBOARD?n=new DA:t===i.EventListener.ACCELERATION&&(n=new OA(e.callback),delete e.callback),n)for(var r=0,o=Object.keys(e);r<o.length;r++){var a=o[r];n[a]=e[a]}return n};var t=e.prototype;return t._setPaused=function(e){this._paused=e},t._isPaused=function(){return this._paused},t._setRegistered=function(e){this._registered=e},t._isRegistered=function(){return this._registered},t._getType=function(){return this._type},t._getListenerID=function(){return this._listenerID},t._setFixedPriority=function(e){this._fixedPriority=e},t._getFixedPriority=function(){return this._fixedPriority},t._setSceneGraphPriority=function(e){this._target=e,this._node=e},t._getSceneGraphPriority=function(){return this._node},t.checkAvailable=function(){return null!==this._onEvent},t.clone=function(){return null},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},k(e,[{key:"onEvent",get:function(){return this._onEvent}}]),e}();CA.UNKNOWN=0,CA.TOUCH_ONE_BY_ONE=1,CA.TOUCH_ALL_AT_ONCE=2,CA.KEYBOARD=3,CA.MOUSE=4,CA.ACCELERATION=6,CA.CUSTOM=8,CA.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var wA=CA.ListenerID,RA=function(e){function t(){var t;return(t=e.call(this,CA.MOUSE,wA.MOUSE,null)||this).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}H(t,e);var n=t.prototype;return n._callback=function(e){switch(e.type){case AA.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(e);break;case AA.MOUSE_UP:this.onMouseUp&&this.onMouseUp(e);break;case AA.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(e);break;case AA.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(e)}},n.clone=function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e},n.checkAvailable=function(){return!0},t}(CA),PA=function(e){function t(){var t;return(t=e.call(this,CA.TOUCH_ONE_BY_ONE,wA.TOUCH_ONE_BY_ONE,null)||this).swallowTouches=!1,t.onTouchBegan=null,t.onTouchMoved=null,t.onTouchEnded=null,t.onTouchCancelled=null,t._claimedTouches=[],t}H(t,e);var n=t.prototype;return n.setSwallowTouches=function(e){this.swallowTouches=e},n.isSwallowTouches=function(){return this.swallowTouches},n.clone=function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e},n.checkAvailable=function(){return!!this.onTouchBegan||(E(1801),!1)},t}(CA),IA=function(e){function t(){var t;return(t=e.call(this,CA.TOUCH_ALL_AT_ONCE,wA.TOUCH_ALL_AT_ONCE,null)||this).onTouchesBegan=null,t.onTouchesMoved=null,t.onTouchesEnded=null,t.onTouchesCancelled=null,t}H(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e},n.checkAvailable=function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(E(1802),!1)},t}(CA),OA=function(e){function t(t){var n;return(n=e.call(this,CA.ACCELERATION,wA.ACCELERATION,null)||this)._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=t,n}H(t,e);var n=t.prototype;return n._callback=function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)},n.checkAvailable=function(){return P(this._onAccelerationEvent,1803),!0},n.clone=function(){return new t(this._onAccelerationEvent)},t}(CA),DA=function(e){function t(){var t;return(t=e.call(this,CA.KEYBOARD,wA.KEYBOARD,null)||this).onKeyDown=void 0,t.onKeyPressed=void 0,t.onKeyReleased=void 0,t._onEvent=function(e){return t._callback(e)},t}H(t,e);var n=t.prototype;return n._callback=function(e){var t,n;switch(e.type){case AA.KEY_DOWN:null===(t=this.onKeyPressed)||void 0===t||t.call(this,e.keyCode,e);break;case AA.KEY_UP:null===(n=this.onKeyReleased)||void 0===n||n.call(this,e.keyCode,e)}},n.clone=function(){var e=new t;return e.onKeyDown=this.onKeyDown,e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e},n.checkAvailable=function(){return null!==this.onKeyDown||null!==this.onKeyPressed||null!==this.onKeyReleased||(E(1800),!1)},t}(CA);i.EventListener=CA;var NA,MA,LA,BA,FA,zA,UA,kA,GA,HA,VA=CA.ListenerID,WA=[AA.TOUCH_START,AA.TOUCH_MOVE,AA.TOUCH_END,AA.TOUCH_CANCEL],jA=[AA.MOUSE_DOWN,AA.MOUSE_MOVE,AA.MOUSE_UP,AA.MOUSE_WHEEL],XA=[AA.KEY_DOWN,AA.KEY_UP],qA=function(){function e(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}var t=e.prototype;return t.size=function(){return this._fixedListeners.length+this._sceneGraphListeners.length},t.empty=function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length},t.push=function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)},t.clearSceneGraphListeners=function(){this._sceneGraphListeners.length=0},t.clearFixedListeners=function(){this._fixedListeners.length=0},t.clear=function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0},t.getFixedPriorityListeners=function(){return this._fixedListeners},t.getSceneGraphPriorityListeners=function(){return this._sceneGraphListeners},e}(),YA=new(function(){function e(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}var t=e.prototype;return t.pauseTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof i._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0,o=n.length;r<o;r++){var a=n[r];a._setPaused(!0),a instanceof PA&&a._claimedTouches.includes(this._currentTouch)&&this._clearCurTouch()}if(!0===t){var s=e.children;if(s)for(var c=0;c<s.length;++c){var l=s[c];this.pauseTarget(l,!0)}}}else A(3506)},t.resumeTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof i._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r)n[r]._setPaused(!1);if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var o=e.children;if(o)for(var a=0;a<o.length;++a){var s=o[a];this.resumeTarget(s,!0)}}}else A(3506)},t.frameUpdateListeners=function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var n in e)e[n].empty()&&(delete t[n],delete e[n]);var i=this._toAddedListeners;if(0!==i.length){for(var r=0,o=i.length;r<o;r++)this._forceAddEventListener(i[r]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()},t.hasEventListener=function(e){return!!this._getListeners(e)},t.addListener=function(e,t){if(P(e&&t,3503),!(i.js.isNumber(t)||t instanceof i._BaseNode))return A(3506),null;if(e instanceof i.EventListener){if(e._isRegistered())return E(3505),null}else P(!i.js.isNumber(t),3504),e=i.EventListener.create(e);if(!e.checkAvailable())return null;if(i.js.isNumber(t)){if(0===t)return E(3500),null;e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(n=t)||!n.getComponent("cc.UITransform"))return E(3512),null;e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var n;return e},t.addCustomListener=function(e,t){var n=CA.create({event:i.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(n,1),n},t.removeListener=function(e){if(null!=e){var t=!1,n=this._listenersMap;for(var r in e===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null),n){var o=n[r],a=o.getFixedPriorityListeners(),s=o.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),o.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete n[r]),t)break}if(!t)for(var c=this._toAddedListeners,l=c.length-1;l>=0;l--){var u=c[l];if(u===e){i.js.array.removeAt(c,l),u._setRegistered(!1);break}}}},t.removeListeners=function(e,t){if(void 0===t&&(t=!1),i.js.isNumber(e)||e instanceof i._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var r=i.js.array.copy(n),o=0;o<r.length;++o){var a=r[o];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var s=this._toAddedListeners,c=0;c<s.length;){var l=s[c];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),s.splice(c,1)):++c}if(!0===t)for(var u=e.getChildren(),h=0;h<u.length;++h){var _=u[h];this.removeListeners(_,!0)}}else e===i.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(VA.TOUCH_ONE_BY_ONE):e===i.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(VA.TOUCH_ALL_AT_ONCE):e===i.EventListener.MOUSE?this._removeListenersForListenerID(VA.MOUSE):e===i.EventListener.ACCELERATION?this._removeListenersForListenerID(VA.ACCELERATION):e===i.EventListener.KEYBOARD?this._removeListenersForListenerID(VA.KEYBOARD):E(3501);else A(3506)},t.removeCustomListeners=function(e){this._removeListenersForListenerID(e)},t.removeAllListeners=function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var n in e)-1===t.indexOf(n)&&this._removeListenersForListenerID(n)},t.setPriority=function(e,t){if(null!=e){var n=this._listenersMap;for(var i in n){var r=n[i].getFixedPriorityListeners();if(r&&-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&E(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},t.dispatchEvent=function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(WA.includes(e.getType()))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=e.type;return t===AA.DEVICEMOTION?VA.ACCELERATION:XA.includes(t)?VA.KEYBOARD:jA.includes(t)?VA.MOUSE:(WA.includes(t)&&E(2e3),"")}(e);this._sortEventListeners(t);var n=this._listenersMap[t];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,e),this._onUpdateListeners(n)),this._inDispatch--}else C(3511)},t._onListenerCallback=function(e,t){t.currentTarget=e._target;var n=e.onEvent;return n&&n(t),t.isStopped()},t.dispatchCustomEvent=function(e,t){var n=new i.Event.EventCustom(e);n.setUserData(t),this.dispatchEvent(n)},t._setDirtyForNode=function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var n=0,i=t.length;n<i;n++){var r=t[n]._getListenerID();this._dirtyListeners[r]||(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var o=e.children,a=0,s=o?o.length:0;a<s;a++)this._setDirtyForNode(o[a])},t._addListener=function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)},t._forceAddEventListener=function(e){var t=e._getListenerID(),n=this._listenersMap[t];if(n||(n=new qA,this._listenersMap[t]=n),n.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var i=e._getSceneGraphPriority();null===i&&E(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)},t._getListeners=function(e){return this._listenersMap[e]},t._updateDirtyFlagForSceneGraph=function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2),e[t]=!1},t._removeAllListenersInVector=function(e){if(e)for(var t,n=e.length-1;n>=0;n--)(t=e[n])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&i.js.array.removeAt(e,n)},t._removeListenersForListenerID=function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners(),r=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(r),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var o=this._toAddedListeners,a=o.length-1;a>=0;a--){var s=o[a];s&&s._getListenerID()===e&&i.js.array.removeAt(o,a)}},t._sortEventListeners=function(e){var t=0,n=this._priorityDirtyFlagMap;n[e]&&(t=n[e]),0!==t&&(n[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&i.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))},t._sortListenersOfSceneGraphPriority=function(e){var t=this._getListeners(e);if(t){var n=t.getSceneGraphPriorityListeners();if(n&&0!==n.length){var i=t.getSceneGraphPriorityListeners();i.forEach((function(e){var t=e._getSceneGraphPriority()._uiProps.uiTransformComp;e._cameraPriority=t.cameraPriority})),i.sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},t._sortEventListenersOfSceneGraphPriorityDes=function(e,t){var n=e._getSceneGraphPriority(),i=t._getSceneGraphPriority();if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;var r=n,o=i,a=!1;if(e._cameraPriority!==t._cameraPriority)return t._cameraPriority-e._cameraPriority;for(;r.parent._id!==o.parent._id;)r=null===r.parent.parent?(a=!0)&&i:r.parent,o=null===o.parent.parent?(a=!0)&&n:o.parent;if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var s=r.getSiblingIndex(),c=o.getSiblingIndex();return a?s-c:c-s},t._sortListenersOfFixedPriority=function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners();if(n&&0!==n.length){n.sort(this._sortListenersOfFixedPriorityAsc);for(var i=0,r=n.length;i<r&&!(n[i]._getFixedPriority()>=0);)++i;t.gt0Index=i}}},t._sortListenersOfFixedPriorityAsc=function(e,t){return e._getFixedPriority()-t._getFixedPriority()},t._onUpdateListeners=function(e){var t=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners(),r=this._toRemovedListeners;if(n)for(var o=n.length-1;o>=0;o--){var a=n[o];if(!a._isRegistered()){i.js.array.removeAt(n,o);var s=r.indexOf(a);-1!==s&&r.splice(s,1)}}if(t)for(var c=t.length-1;c>=0;c--){var l=t[c];if(!l._isRegistered()){i.js.array.removeAt(t,c);var u=r.indexOf(l);-1!==u&&r.splice(u,1)}}n&&0===n.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()},t._updateTouchListeners=function(){var e=this._inDispatch;if(P(e>0,3508),!(e>1)){var t;(t=this._listenersMap[VA.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(t),(t=this._listenersMap[VA.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(t),P(1===e,3509);var n=this._toAddedListeners;if(0!==n.length){for(var i=0,r=n.length;i<r;i++)this._forceAddEventListener(n[i]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},t._cleanToRemovedListeners=function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var n=e[t],i=this._listenersMap[n._getListenerID()];if(i){var r=i.getFixedPriorityListeners(),o=i.getSceneGraphPriorityListeners();if(o){var a=o.indexOf(n);-1!==a&&o.splice(a,1)}if(r){var s=r.indexOf(n);-1!==s&&r.splice(s,1)}}}e.length=0},t._onTouchEventCallback=function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=n.touch;n.currentTarget=e._getSceneGraphPriority();var r=!1,o=-1,a=n.type;if(a===AA.TOUCH_START){if(!nt.ENABLE_MULTI_TOUCH&&YA._currentTouch){var s=YA._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(i,n))&&e._isRegistered()&&!e._isPaused()&&(e._claimedTouches.push(i),!nt.ENABLE_MULTI_TOUCH&&YA._currentTouch||(YA._currentTouch=i),YA._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(o=e._claimedTouches.indexOf(i))){if(r=!0,!nt.ENABLE_MULTI_TOUCH&&YA._currentTouch&&YA._currentTouch!==i)return!1;a===AA.TOUCH_MOVE&&e.onTouchMoved?e.onTouchMoved(i,n):a===AA.TOUCH_END?(e.onTouchEnded&&e.onTouchEnded(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),(nt.ENABLE_MULTI_TOUCH||YA._currentTouch===i)&&(YA._currentTouch=null),YA._currentTouchListener=null):a===AA.TOUCH_CANCEL&&(e.onTouchCancelled&&e.onTouchCancelled(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),(nt.ENABLE_MULTI_TOUCH||YA._currentTouch===i)&&(YA._currentTouch=null),YA._currentTouchListener=null)}return n.isStopped()?(YA._updateTouchListeners(n),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(i,1),!0)},t._dispatchTouchEvent=function(e){this._sortEventListeners(VA.TOUCH_ONE_BY_ONE),this._sortEventListeners(VA.TOUCH_ALL_AT_ONCE);var t=this._getListeners(VA.TOUCH_ONE_BY_ONE),n=this._getListeners(VA.TOUCH_ALL_AT_ONCE);if(null!==t||null!==n){var r=e.getTouches(),o=i.js.array.copy(r),a={event:e,needsMutableSet:t&&n,touches:o,selTouch:null};if(t)for(var s=0;s<r.length;++s){var c=r[s];e.touch=c,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}n&&o.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:e,touches:o}),e.isStopped())||this._updateTouchListeners(e)}},t._onTouchesEventCallback=function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=t.touches,r=n.type;return n.currentTarget=e._getSceneGraphPriority(),r===AA.TOUCH_START&&e.onTouchesBegan?e.onTouchesBegan(i,n):r===AA.TOUCH_MOVE&&e.onTouchesMoved?e.onTouchesMoved(i,n):r===AA.TOUCH_END&&e.onTouchesEnded?e.onTouchesEnded(i,n):r===AA.TOUCH_CANCEL&&e.onTouchesCancelled&&e.onTouchesCancelled(i,n),!!n.isStopped()&&(YA._updateTouchListeners(n),!0)},t._associateNodeAndEventListener=function(e,t){var n=this._nodeListenersMap[e.uuid];n||(n=[],this._nodeListenersMap[e.uuid]=n),n.push(t)},t._dissociateNodeAndEventListener=function(e,t){var n=this._nodeListenersMap[e.uuid];n&&(i.js.array.remove(n,t),0===n.length&&delete this._nodeListenersMap[e.uuid])},t._dispatchEventToListeners=function(e,t,n){var i=!1,r=e.getFixedPriorityListeners(),o=e.getSceneGraphPriorityListeners(),a=0;if(r&&0!==r.length)for(;a<e.gt0Index;++a){var s=r[a];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,n)){i=!0;break}}if(o&&!i)for(var c=0;c<o.length;++c){var l=o[c];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,n)){i=!0;break}}if(r&&!i)for(;a<r.length;++a){var u=r[a];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,n)){i=!0;break}}},t._setDirty=function(e,t){var n=this._priorityDirtyFlagMap;null==n[e]?n[e]=t:n[e]|=t},t._sortNumberAsc=function(e,t){return e-t},t._clearCurTouch=function(){this._currentTouchListener=null,this._currentTouch=null},t._removeListenerInCallback=function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var r=e[n];if(r._onCustomEvent===t||r.onEvent===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(e,n):this._toRemovedListeners.push(r),!0}return!1},t._removeListenerInVector=function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var r=e[n];if(r===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(e,n):this._toRemovedListeners.push(r),!0}return!1},e}());Zt.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(NA||(NA={}));var KA=Zt.Flags.Destroying,QA=Zt.Flags.DontDestroy,ZA=Zt.Flags.Deactivating,JA=new ce("Node");function $A(e){return e?"string"==typeof e?je(e):e:(C(3804),null)}var eb,tb,nb,ib,rb,ob,ab,sb,cb,lb,ub,hb=e("BaseNode",Zc("cc.BaseNode")((HA=GA=function(e){H(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return Z(n=e.call(this,t)||this,"_parent",BA,Y(n)),Z(n,"_children",FA,Y(n)),Z(n,"_active",zA,Y(n)),Z(n,"_components",UA,Y(n)),Z(n,"_prefab",kA,Y(n)),n._scene=null,n._activeInHierarchy=!1,n._id=JA.getNewId(),n._name=void 0,n._eventProcessor=new i.NodeEventProcessor(Y(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Oe(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(NA.PARENT_CHANGED,n),n&&!(n._objFlags&KA)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(NA.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(NA.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return f("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return f("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&ZA)C(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=$A(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=$A(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=$A(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=$A(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=je(e)))throw i._RF.peek()&&C(3808,e),TypeError(I(3807,e))}else{if(!e)throw TypeError(I(3804));t=e}if("function"!=typeof t)throw TypeError(I(3809));if(!Me(t,i.Component))throw TypeError(I(3810));var n=t._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);var r=new t;return r.node=this,this._components.push(r),this._activeInHierarchy&&i.director._nodeActivator.activateComp(r),r},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof qu?e:this.getComponent(e))&&t.destroy()}else C(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case NA.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case NA.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(NA.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&KA)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&C(3815)}}else C(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(NA.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=i.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof i.Scene||i.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&i.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=KA;var e=this._parent,t=!!e&&0!=(e._objFlags&KA);if(this._persistNode&&i.game.removePersistRootNode(this),!t&&e){this.emit(NA.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(NA.CHILD_REMOVED,this)}this.emit(NA.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,o=0;o<r.length;++o)r[o]._destroyImmediate();for(var a=this._components,s=0;s<a.length;++s)a[s]._destroyImmediate();return t},k(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&QA)>0},set:function(e){e?this._objFlags|=QA:this._objFlags&=~QA}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&i.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Zt),GA.idGenerator=JA,GA._stacks=[[]],GA._stackId=0,J((LA=HA).prototype,"_persistNode",[tl],Object.getOwnPropertyDescriptor(LA.prototype,"_persistNode"),LA.prototype),J(LA.prototype,"name",[fl],Object.getOwnPropertyDescriptor(LA.prototype,"name"),LA.prototype),J(LA.prototype,"children",[fl],Object.getOwnPropertyDescriptor(LA.prototype,"children"),LA.prototype),J(LA.prototype,"active",[fl],Object.getOwnPropertyDescriptor(LA.prototype,"active"),LA.prototype),J(LA.prototype,"activeInHierarchy",[fl],Object.getOwnPropertyDescriptor(LA.prototype,"activeInHierarchy"),LA.prototype),J(LA.prototype,"parent",[fl],Object.getOwnPropertyDescriptor(LA.prototype,"parent"),LA.prototype),BA=J(LA.prototype,"_parent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FA=J(LA.prototype,"_children",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zA=J(LA.prototype,"_active",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UA=J(LA.prototype,"_components",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kA=J(LA.prototype,"_prefab",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MA=LA))||MA);function _b(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return C(3701,e.name),void(t.instance=void 0);var n=e._objFlags,r=e._parent,o=e._id,a=e._prefab;e[Yt],i.game._isCloning=!0,t.asset._doInstantiate(e),i.game._isCloning=!1,e._objFlags=n,e._parent=r,e._id=o,e._prefab&&(e._prefab.instance=null==a?void 0:a.instance)}}function fb(e,t,n){var i;if(t){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)fb(e.children[u],r,!1)}}function pb(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function db(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=pb(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,fb(u,a,!1),u._siblingIndex=o._children.length-1,u._onBatchCreated(!1))}}}}function mb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=pb(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function vb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=pb(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function gb(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=pb(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof tt?a[c].set(o.value):a[c]=o.value}}}}function yb(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=pb(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(_=pb(f.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}i._BaseNode=hb;var Sb=new Zn,Tb=new ri,Eb=new ri,xb=new ri,Ab=new ti,bb=new ti,Cb=new _i,wb=[],Rb=[],Pb=[],Ib=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return Pb[0]=this._chunks[e],Pb[1]=this._freelists[e].pop(),Pb},e}();Ib.CAPACITY_PER_CHUNK=256;var Ob,Db,Nb,Mb,Lb,Bb,Fb,zb,Ub,kb,Gb,Hb,Vb,Wb,jb,Xb,qb,Yb,Kb,Qb,Zb,Jb,$b,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,_C,fC,pC,dC,mC,vC,gC,yC,SC,TC,EC,xC,AC,bC,CC,wC,RC,PC,IC,OC,DC,NC,MC,LC,BC,FC,zC,UC,kC,GC,HC,VC,WC,jC=new Ib,XC=Symbol("ReserveContentsForAllSyncablePrefab"),qC=e("Node",(eb=Zc("cc.Node"),tb=Pl(Zn),eb((ub=lb=function(e){H(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new bA(Y(n)),n._static=!1,Z(n,"_lpos",rb,Y(n)),Z(n,"_lrot",ob,Y(n)),Z(n,"_lscale",ab,Y(n)),Z(n,"_layer",sb,Y(n)),Z(n,"_euler",cb,Y(n)),n._dirtyFlagsPri=eg.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=jC.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Zn,this._rot=new ri,this._scale=new Zn(1,1,1),this._mat=new _i},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof i.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return jC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[Qu]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),_i.multiply(Cb,_i.invert(Cb,i._mat),this._mat),_i.toRTS(Cb,this._lrot,this._lpos,this._lscale)):(Zn.copy(this._lpos,this._pos),ri.copy(this._lrot,this._rot),Zn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(eg.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){var t,n=null===(t=this._prefab)||void 0===t?void 0:t.instance;!e&&n&&_b(this),this.hasChangedFlags=eg.TRS,this._dirtyFlags|=eg.TRS,this._uiProps.uiTransformDirty=!0;for(var i=this._children.length,r=0;r<i;++r)this._children[r]._siblingIndex=r,this._children[r]._onBatchCreated(e);if(!e&&n){var o={};n.targetMap=o,fb(this,o,!0),db(0,n.mountedChildren,o),vb(0,n.removedComponents,o),mb(0,n.mountedComponents,o),gb(0,n.propertyOverrides,o)}yb(this)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(YA.resumeTarget(this),this.invalidateChildren(eg.TRS)):YA.pauseTarget(this)},t.translate=function(e,t){var n=t||$v.LOCAL;if(n===$v.LOCAL)Zn.transformQuat(Sb,e,this._lrot),this._lpos.x+=Sb.x,this._lpos.y+=Sb.y,this._lpos.z+=Sb.z;else if(n===$v.WORLD)if(this._parent){ri.invert(Tb,this._parent.worldRotation),Zn.transformQuat(Sb,e,Tb);var i=this.worldScale;this._lpos.x+=Sb.x/i.x,this._lpos.y+=Sb.y/i.y,this._lpos.z+=Sb.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.POSITION)},t.rotate=function(e,t){var n=t||$v.LOCAL;if(ri.normalize(Tb,e),n===$v.LOCAL)ri.multiply(this._lrot,this._lrot,Tb);else if(n===$v.WORLD){var i=this.worldRotation;ri.multiply(Eb,Tb,i),ri.invert(Tb,i),ri.multiply(Eb,Tb,Eb),ri.multiply(this._lrot,this._lrot,Eb)}this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(Sb),Zn.subtract(Sb,Sb,e),Zn.normalize(Sb,Sb),ri.fromViewUp(Tb,Sb,t),this.setWorldRotation(Tb)},t._setDirtyNode=function(e,t){wb[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|eg.POSITION;for(wb[0]=this;r>=0;){if(c=(t=wb[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._uiProps.uiTransformDirty=!0,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],wb[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=wb[--n])._dirtyFlags,t?(i&eg.POSITION&&(Zn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&eg.RS&&(_i.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),_i.multiply(e._mat,t._mat,e._mat),i&eg.ROTATION&&ri.multiply(e._rot,t._rot,e._lrot),ti.fromQuat(Ab,ri.conjugate(xb,e._rot)),ti.multiplyMat4(Ab,Ab,e._mat),e._scale.x=Ab.m00,e._scale.y=Ab.m04,e._scale.z=Ab.m08)):(i&eg.POSITION&&(Zn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&eg.RS&&(i&eg.ROTATION&&ri.copy(e._rot,e._lrot),i&eg.SCALE&&(Zn.copy(e._scale,e._lscale),_i.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=eg.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?Zn.copy(this._lpos,e):void 0===n?Zn.set(this._lpos,e,t,this._lpos.z):Zn.set(this._lpos,e,t,n),this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.POSITION)},t.getPosition=function(e){return e?Zn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Zn.copy(new Zn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?ri.copy(this._lrot,e):ri.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(Zn.copy(this._euler,e),ri.fromEuler(this._lrot,e.x,e.y,e.z)):(Zn.set(this._euler,e,t,i),ri.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)},t.getRotation=function(e){return e?ri.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):ri.copy(new ri,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?Zn.copy(this._lscale,e):void 0===n?Zn.set(this._lscale,e,t,this._lscale.z):Zn.set(this._lscale,e,t,n),this.invalidateChildren(eg.SCALE),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.SCALE)},t.getScale=function(e){return e?Zn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Zn.copy(new Zn,this._lscale)},t.inverseTransformPoint=function(e,t){Zn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Zn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=wb[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?Zn.copy(this._pos,e):Zn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Zn.transformMat4(r,this._pos,_i.invert(Cb,i._mat))):Zn.copy(r,this._pos),this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?Zn.copy(e,this._pos):Zn.copy(new Zn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?ri.copy(this._rot,e):ri.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),ri.multiply(this._lrot,ri.conjugate(this._lrot,this._parent._rot),this._rot)):ri.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){ri.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),ri.multiply(this._lrot,ri.conjugate(this._lrot,this._parent._rot),this._rot)):ri.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?ri.copy(e,this._rot):ri.copy(new ri,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?Zn.copy(this._scale,e):Zn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),ti.fromQuat(Ab,ri.conjugate(xb,i._rot)),ti.multiplyMat4(Ab,Ab,i._mat),bb.m00=this._scale.x,bb.m04=this._scale.y,bb.m08=this._scale.z,ti.multiply(Ab,bb,ti.invert(Ab,Ab)),this._lscale.x=Zn.set(Sb,Ab.m00,Ab.m01,Ab.m02).length(),this._lscale.y=Zn.set(Sb,Ab.m03,Ab.m04,Ab.m05).length(),this._lscale.z=Zn.set(Sb,Ab.m06,Ab.m07,Ab.m08).length()):Zn.copy(this._lscale,this._scale),this.invalidateChildren(eg.SCALE),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?Zn.copy(e,this._scale):Zn.copy(new Zn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new _i;return _i.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new _i;return _i.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new _i;return _i.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=eg.ROTATION,void 0!==e.w?(ri.copy(this._lrot,e),this._eulerDirty=!0):(Zn.copy(this._euler,e),ri.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(Zn.copy(this._lpos,t),i|=eg.POSITION),n&&(Zn.copy(this._lscale,n),i|=eg.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){YA.pauseTarget(this,e)},t.resumeSystemEvents=function(e){YA.resumeTarget(this,e)},n.resetHasChangedFlags=function(){jC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,wb.length=0,Rb.length=0)},k(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(ri.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){Zn.set(this._euler,0,0,e),ri.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){_i.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(eg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(NA.TRANSFORM_CHANGED,eg.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Zn.transformQuat(new Zn,Zn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();Zn.multiplyScalar(Sb,e,-1/t),ri.fromViewUp(Tb,Sb),this.setWorldRotation(Tb)}},{key:"up",get:function(){return Zn.transformQuat(new Zn,Zn.UP,this.worldRotation)}},{key:"right",get:function(){return Zn.transformQuat(new Zn,Zn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this.emit(NA.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(hb),lb.EventType=NA,lb.NodeSpace=$v,lb.TransformDirtyBit=eg,lb.TransformBit=eg,lb.reserveContentsForAllSyncablePrefabTag=XC,lb.ClearFrame=0,lb.ClearRound=1e3,rb=J((ib=ub).prototype,"_lpos",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn}}),ob=J(ib.prototype,"_lrot",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),ab=J(ib.prototype,"_lscale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(1,1,1)}}),sb=J(ib.prototype,"_layer",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sp.Enum.DEFAULT}}),cb=J(ib.prototype,"_euler",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn}}),J(ib.prototype,"eulerAngles",[tb],Object.getOwnPropertyDescriptor(ib.prototype,"eulerAngles"),ib.prototype),J(ib.prototype,"angle",[fl],Object.getOwnPropertyDescriptor(ib.prototype,"angle"),ib.prototype),J(ib.prototype,"layer",[fl],Object.getOwnPropertyDescriptor(ib.prototype,"layer"),ib.prototype),nb=ib))||nb));i.Node=qC;var YC=Zc("cc.TargetInfo")((Nb=J((Db=function(){Z(this,"localID",Nb,this)}).prototype,"localID",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ob=Db))||Ob,KC=(Mb=Zc("cc.TargetOverrideInfo"),Lb=Pl(Zt),Bb=Pl(YC),Fb=Pl(qC),zb=Pl(YC),Mb((Gb=J((kb=function(){Z(this,"source",Gb,this),Z(this,"sourceInfo",Hb,this),Z(this,"propertyPath",Vb,this),Z(this,"target",Wb,this),Z(this,"targetInfo",jb,this)}).prototype,"source",[il,Lb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hb=J(kb.prototype,"sourceInfo",[il,Bb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vb=J(kb.prototype,"propertyPath",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wb=J(kb.prototype,"target",[il,Fb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jb=J(kb.prototype,"targetInfo",[il,zb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ub=kb))||Ub),QC=Zc("cc.CompPrefabInfo")((Yb=J((qb=function(){Z(this,"fileId",Yb,this)}).prototype,"fileId",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xb=qb))||Xb,ZC=(Kb=Zc("CCPropertyOverrideInfo"),Qb=Pl(YC),Kb((nC=function(){function e(){Z(this,"targetInfo",$b,this),Z(this,"propertyPath",eC,this),Z(this,"value",tC,this)}return e.prototype.isTarget=function(){},e}(),$b=J((Jb=nC).prototype,"targetInfo",[il,Qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eC=J(Jb.prototype,"propertyPath",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tC=J(Jb.prototype,"value",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zb=Jb))||Zb),JC=(iC=Zc("cc.MountedChildrenInfo"),rC=Pl(YC),oC=Pl([qC]),iC((uC=function(){function e(){Z(this,"targetInfo",cC,this),Z(this,"nodes",lC,this)}return e.prototype.isTarget=function(){},e}(),cC=J((sC=uC).prototype,"targetInfo",[il,rC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lC=J(sC.prototype,"nodes",[il,oC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aC=sC))||aC),$C=(hC=Zc("cc.MountedComponentsInfo"),_C=Pl(YC),fC=Pl([qu]),hC((gC=function(){function e(){Z(this,"targetInfo",mC,this),Z(this,"components",vC,this)}return e.prototype.isTarget=function(){},e}(),mC=J((dC=gC).prototype,"targetInfo",[il,_C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vC=J(dC.prototype,"components",[il,fC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pC=dC))||pC),ew=(yC=Zc("cc.PrefabInstance"),SC=Pl(qC),TC=Pl([JC]),EC=Pl([$C]),xC=Pl([ZC]),AC=Pl([YC]),yC((NC=function(){function e(){Z(this,"fileId",wC,this),Z(this,"prefabRootNode",RC,this),Z(this,"mountedChildren",PC,this),Z(this,"mountedComponents",IC,this),Z(this,"propertyOverrides",OC,this),Z(this,"removedComponents",DC,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),wC=J((CC=NC).prototype,"fileId",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RC=J(CC.prototype,"prefabRootNode",[il,SC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PC=J(CC.prototype,"mountedChildren",[il,TC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IC=J(CC.prototype,"mountedComponents",[il,EC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OC=J(CC.prototype,"propertyOverrides",[il,xC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DC=J(CC.prototype,"removedComponents",[il,AC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bC=CC))||bC),tw=(MC=Zc("cc.PrefabInfo"),LC=Pl(qC),BC=Pl(ew),FC=Pl([KC]),MC((kC=J((UC=function(){Z(this,"root",kC,this),Z(this,"asset",GC,this),Z(this,"fileId",HC,this),Z(this,"instance",VC,this),Z(this,"targetOverrides",WC,this)}).prototype,"root",[il,LC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GC=J(UC.prototype,"asset",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),HC=J(UC.prototype,"fileId",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VC=J(UC.prototype,"instance",[il,BC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),WC=J(UC.prototype,"targetOverrides",[il,FC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zC=UC))||zC);i._PrefabInfo=tw;var nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,pw,dw=Object.freeze({__proto__:null,TargetInfo:YC,TargetOverrideInfo:KC,CompPrefabInfo:QC,PropertyOverrideInfo:ZC,MountedChildrenInfo:JC,MountedComponentsInfo:$C,PrefabInstance:ew,PrefabInfo:tw,createNodeWithPrefab:_b,generateTargetMap:fb,getTarget:pb,applyMountedChildren:db,applyMountedComponents:mb,applyRemovedComponents:vb,applyPropertyOverrides:gb,applyTargetOverrides:yb}),mw=Ze({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),vw=e("Prefab",Zc("cc.Prefab")((sw=aw=function(e){function t(){var t;return Z(t=e.call(this)||this,"data",rw,Y(t)),Z(t,"optimizationPolicy",ow,Y(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}H(t,e);var n=t.prototype;return n.createNode=function(e){var t=i.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof i._BaseNode&&e,new EA(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||A(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==mw.SINGLE_INSTANCE&&(this.optimizationPolicy===mw.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new qC,this.data.name="(Missing Node)";var n=new i._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},t}(Cu),aw.OptimizationPolicy=mw,aw.OptimizationPolicyThreshold=3,rw=J((iw=sw).prototype,"data",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ow=J(iw.prototype,"optimizationPolicy",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mw.AUTO}}),nw=iw))||nw);Ke.value(vw,"_utils",dw),i.Prefab=vw,Ee(i,"cc._Prefab","Prefab"),e("PrefabLink",(cw=Zc("cc.PrefabLink"),lw=Pl(vw),uw=pl(),cw((pw=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"prefab",fw,Y(t)),t}return H(t,e),t}(qu),fw=J((_w=pw).prototype,"prefab",[lw,il,uw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hw=_w))||hw));var gw=new Zn;function yw(e,t,n,i){i||(i=new Zn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function Sw(e,t,n){return n||(n=new Zn),e.worldToScreen(t,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}var Tw,Ew,xw=e("convertUtils",{WorldNode3DToLocalNodeUI:yw,WorldNode3DToWorldNodeUI:Sw});i.pipelineUtils=xw,mn(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||gw;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),vn(Fm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),mn(hE.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Aw,bw=e("BufferAsset",Zc("cc.BufferAsset")((J((Ew=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}H(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},k(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Cu)).prototype,"_nativeAsset",[Ul],Object.getOwnPropertyDescriptor(Ew.prototype,"_nativeAsset"),Ew.prototype),Tw=Ew))||Tw);i.BufferAsset=bw;var Cw=((Aw={})[Er.UNORM]="Uint",Aw[Er.SNORM]="Int",Aw[Er.UINT]="Uint",Aw[Er.INT]="Int",Aw[Er.UFLOAT]="Float",Aw[Er.FLOAT]="Float",Aw.default="Uint",Aw);function ww(e){return""+(Cw[e.type]||Cw.default)+e.size/e.count*8}function Rw(e,t,n,i,r){void 0===n&&(n=Tr.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=aa[n];r||(r=o.size);for(var a="set"+ww(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=Ni.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;e[a](f,t[o.count*u+_],l)}}function Pw(e,t,n,i,r,o,a){void 0===n&&(n=Tr.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=aa[n];o||(o=s.size);for(var c="set"+ww(s),l="get"+ww(s),u=s.size/s.count,h=Math.floor(r/o),_=Ni.isLittleEndian,f=0;f<h;++f)for(var p=i+o*f,d=0;d<s.count;++d){var m=p+u*d,v=e[l](m,_);a[c](m,t(v,d,e),_)}return a}var Iw=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new zo(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Bo("a_vertexId",Tr.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},k(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Zn.ZERO,max:Zn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Zn.ZERO,max:Zn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,ro.ATTR_POSITION),i=e.readIndices(t),r=new Zn,o=new Zn,a=this.attributes.find((function(e){return e.name===ro.ATTR_POSITION}));if(a){var s=aa[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,o,a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=i.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=a.vertexBundles[s.vertexBundelIndices[l]];o=0,r=Tr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===ro.ATTR_JOINTS){r=_.format;break}o+=aa[_.format].size}r?function(){var i=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(i.slice().buffer),_=a.jointMaps[s.jointMapIndex];Pw(h,(function(e){return _.indexOf(e)}),r,o,u.view.length,u.view.stride,h);var f=c.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}()),Ow=new Array(16),Dw=null,Nw=new mi,Mw=[NA.TOUCH_START,NA.TOUCH_MOVE,NA.TOUCH_END,NA.TOUCH_CANCEL],Lw=[NA.MOUSE_DOWN,NA.MOUSE_ENTER,NA.MOUSE_MOVE,NA.MOUSE_LEAVE,NA.MOUSE_UP,NA.MOUSE_WHEEL];function Bw(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(e.getUILocation(Nw),!n._uiProps.uiTransformComp.isHit(Nw,this)||(t.type=NA.TOUCH_START,t.touch=e,t.bubbles=!0,n.dispatchEvent(t),0)))}function Fw(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(t.type=NA.TOUCH_MOVE,t.touch=e,t.bubbles=!0,n.dispatchEvent(t),0))}function zw(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(e.getUILocation(Nw),n._uiProps.uiTransformComp.isHit(Nw,this)?t.type=NA.TOUCH_END:t.type=NA.TOUCH_CANCEL,t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function Uw(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(t.type=NA.TOUCH_CANCEL,t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function kw(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nw=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nw,this)&&(e.type=NA.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e)))}function Gw(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(Nw=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nw,this))this._previousIn||(Dw&&Dw.eventProcessor.mouseListener&&(e.type=NA.MOUSE_LEAVE,Dw.dispatchEvent(e),Dw.eventProcessor.mouseListener&&(Dw.eventProcessor.mouseListener._previousIn=!1)),Dw=t,e.type=NA.MOUSE_ENTER,t.dispatchEvent(e),this._previousIn=!0),e.type=NA.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=NA.MOUSE_LEAVE,t.dispatchEvent(e),this._previousIn=!1,Dw=null}e.propagationStopped=!0}}function Hw(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nw=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nw,this)&&(e.type=NA.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Vw(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nw=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nw,this)&&(e.type=NA.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Ww(e,t){if(t){for(var n=0,i=[],r=e;r&&qC.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null}function jw(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.bubblingTargets.hasEventListener(t[n]))return!0;if(e.eventProcessor.capturingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}var Xw,qw,Yw,Kw,Qw,Zw,Jw,$w,eR,tR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,pR,dR,mR,vR,gR,yR,SR,TR,ER,xR,AR,bR,CR,wR,RR,PR,IR,OR,DR,NR,MR,LR,BR,FR,zR,UR,kR,GR,HR,VR,WR,jR,XR,qR,YR,KR,QR,ZR,JR,$R,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,SP,TP,EP,xP,AP,bP,CP,wP,RP,PP,IP,OP,DP,NP,MP,LP,BP,FP,zP,UP,kP,GP,HP,VP,WP,jP,XP,qP,YP,KP,QP,ZP,JP,$P,eI,tI,nI,iI,rI,oI,aI,sI=function(){function e(e){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}var t=e.prototype;return t.reattach=function(){var t;this.node.walk((function(n){t||(t=Ww(n,e._comp)),n.eventProcessor.touchListener&&(n.eventProcessor.touchListener.mask=t),n.eventProcessor.mouseListener&&(n.eventProcessor.mouseListener.mask=t)}))},t.destroy=function(){Dw===this._node&&(Dw=null),(this.touchListener||this.mouseListener)&&(YA.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()},t.on=function(e,t,n,i){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,n,i):(this.bubblingTargets||(this.bubblingTargets=new sn),this.bubblingTargets.on(e,t,n))},t.once=function(e,t,n,i){var r,o=this;(r=this._checknSetupSysEvent(e)&&i?this.capturingTargets=this.capturingTargets||new sn:this.bubblingTargets=this.bubblingTargets||new sn).on(e,t,n,!0),r.on(e,(function(){o.off(e,t,n)}),void 0,!0)},t.off=function(e,t,n,i){var r=-1!==Mw.indexOf(e),o=!r&&-1!==Lw.indexOf(e);r||o?(this._offDispatch(e,t,n,i),r?this.touchListener&&!jw(this._node,Mw)&&(YA.removeListener(this.touchListener),this.touchListener=null):o&&this.mouseListener&&!jw(this._node,Lw)&&(YA.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,n)},t.emit=function(e,t,n,i,r,o){this.bubblingTargets&&this.bubblingTargets.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){!function(e,t){var n,i=0;for(t.target=e,Ow.length=0,e.eventProcessor.getCapturingTargets(t.type,Ow),t.eventPhase=1,i=Ow.length-1;i>=0;--i)if((n=Ow[i]).eventProcessor.capturingTargets&&(t.currentTarget=n,n.eventProcessor.capturingTargets.emit(t.type,t,Ow),t.propagationStopped))return void(Ow.length=0);if(Ow.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,Ow),t.eventPhase=3,i=0;i<Ow.length;++i)if((n=Ow[i]).eventProcessor.bubblingTargets&&(t.currentTarget=n,n.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(Ow.length=0);Ow.length=0}(this._node,e),Ow.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(e,t,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(e,t,n)),i},t.targetOff=function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!jw(this.node,Mw)&&(YA.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!jw(this.node,Lw)&&(YA.removeListener(this.mouseListener),this.mouseListener=null)},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(n),n=n.parent},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(n),n=n.parent},t._checknSetupSysEvent=function(t){var n=this,r=!1,o=!1;return-1!==Mw.indexOf(t)?(this.touchListener||(this.touchListener=i.EventListener.create({event:i.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:Ww(this._node,e._comp),onTouchBegan:Bw,onTouchMoved:Fw,onTouchEnded:zw,onTouchCancelled:Uw}),YA.addListener(this.touchListener,this._node),r=!0),o=!0):-1!==Lw.indexOf(t)&&(this.mouseListener||(this.mouseListener=i.EventListener.create({event:i.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:Ww(this._node,e._comp),onMouseDown:kw,onMouseMove:Gw,onMouseUp:Hw,onMouseScroll:Vw}),YA.addListener(this.mouseListener,this._node),r=!0),o=!0),r&&!this._node.activeInHierarchy&&i.director.getScheduler().schedule((function(){n._node.activeInHierarchy||YA.pauseTarget(n._node)}),this._node,0,0,0,!1),o},t._onDispatch=function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=null;return(r=i?this.capturingTargets=this.capturingTargets||new sn:this.bubblingTargets=this.bubblingTargets||new sn).hasEventListener(e,t,n)||r.on(e,t,n),t}C(6800)},t._offDispatch=function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=i?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,n)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)},k(e,[{key:"node",get:function(){return this._node}}]),e}();sI._comp=null,i.NodeEventProcessor=sI;var cI=new Zn(0,1,0),lI=new Zn,uI=new ri,hI=(Xw=Zc("cc.AmbientInfo"),qw=Pl(bt),Xw(($w=function(){function e(){Z(this,"_skyColor",Qw,this),Z(this,"_skyIllum",Zw,this),Z(this,"_groundAlbedo",Jw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},k(e,[{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)}},{key:"skyIllum",get:function(){return this._skyIllum},set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}}]),e}(),Qw=J((Kw=$w).prototype,"_skyColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(51,128,204,1)}}),Zw=J(Kw.prototype,"_skyIllum",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ki.SKY_ILLUM}}),Jw=J(Kw.prototype,"_groundAlbedo",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(51,51,51,255)}}),J(Kw.prototype,"skyColor",[fl],Object.getOwnPropertyDescriptor(Kw.prototype,"skyColor"),Kw.prototype),J(Kw.prototype,"skyIllum",[fl,qw],Object.getOwnPropertyDescriptor(Kw.prototype,"skyIllum"),Kw.prototype),J(Kw.prototype,"groundAlbedo",[fl],Object.getOwnPropertyDescriptor(Kw.prototype,"groundAlbedo"),Kw.prototype),Yw=Kw))||Yw);i.AmbientInfo=hI;var _I=(eR=Zc("cc.SkyboxInfo"),tR=Pl(sv),nR=Pl(sv),eR((lR=function(){function e(){Z(this,"_envmap",oR,this),Z(this,"_isRGBE",aR,this),Z(this,"_enabled",sR,this),Z(this,"_useIBL",cR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)}}]),e}(),oR=J((rR=lR).prototype,"_envmap",[tR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aR=J(rR.prototype,"_isRGBE",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sR=J(rR.prototype,"_enabled",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cR=J(rR.prototype,"_useIBL",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),J(rR.prototype,"enabled",[fl],Object.getOwnPropertyDescriptor(rR.prototype,"enabled"),rR.prototype),J(rR.prototype,"useIBL",[fl],Object.getOwnPropertyDescriptor(rR.prototype,"useIBL"),rR.prototype),J(rR.prototype,"envmap",[fl,nR],Object.getOwnPropertyDescriptor(rR.prototype,"envmap"),rR.prototype),J(rR.prototype,"isRGBE",[fl],Object.getOwnPropertyDescriptor(rR.prototype,"isRGBE"),rR.prototype),iR=rR))||iR);i.SkyboxInfo=_I;var fI=(uR=Zc("cc.FogInfo"),hR=Pl(mx),_R=pl(),fR=Pl(bt),pR=vl(),dR=Sl(),mR=El(),vR=pl(),gR=Pl(bt),yR=Sl(),SR=El(),TR=pl(),ER=Pl(bt),xR=Sl(),AR=El(),bR=pl(),CR=Pl(bt),wR=gl(),RR=Sl(),PR=El(),IR=pl(),OR=Pl(bt),DR=Sl(),NR=El(),MR=pl(),LR=Pl(bt),BR=Sl(),FR=El(),uR((QR=KR=function(){function e(){Z(this,"_type",kR,this),Z(this,"_fogColor",GR,this),Z(this,"_enabled",HR,this),Z(this,"_fogDensity",VR,this),Z(this,"_fogStart",WR,this),Z(this,"_fogEnd",jR,this),Z(this,"_fogAtten",XR,this),Z(this,"_fogTop",qR,this),Z(this,"_fogRange",YR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),KR.FogType=mx,kR=J((UR=QR).prototype,"_type",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mx.LINEAR}}),GR=J(UR.prototype,"_fogColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn("#C8C8C8")}}),HR=J(UR.prototype,"_enabled",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VR=J(UR.prototype,"_fogDensity",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),WR=J(UR.prototype,"_fogStart",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),jR=J(UR.prototype,"_fogEnd",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),XR=J(UR.prototype,"_fogAtten",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),qR=J(UR.prototype,"_fogTop",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),YR=J(UR.prototype,"_fogRange",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),J(UR.prototype,"enabled",[fl],Object.getOwnPropertyDescriptor(UR.prototype,"enabled"),UR.prototype),J(UR.prototype,"fogColor",[fl],Object.getOwnPropertyDescriptor(UR.prototype,"fogColor"),UR.prototype),J(UR.prototype,"type",[fl,hR],Object.getOwnPropertyDescriptor(UR.prototype,"type"),UR.prototype),J(UR.prototype,"fogDensity",[_R,fR,pR,dR,Tl,mR],Object.getOwnPropertyDescriptor(UR.prototype,"fogDensity"),UR.prototype),J(UR.prototype,"fogStart",[vR,gR,yR,SR],Object.getOwnPropertyDescriptor(UR.prototype,"fogStart"),UR.prototype),J(UR.prototype,"fogEnd",[TR,ER,xR,AR],Object.getOwnPropertyDescriptor(UR.prototype,"fogEnd"),UR.prototype),J(UR.prototype,"fogAtten",[bR,CR,wR,RR,PR],Object.getOwnPropertyDescriptor(UR.prototype,"fogAtten"),UR.prototype),J(UR.prototype,"fogTop",[IR,OR,DR,NR],Object.getOwnPropertyDescriptor(UR.prototype,"fogTop"),UR.prototype),J(UR.prototype,"fogRange",[MR,LR,BR,FR],Object.getOwnPropertyDescriptor(UR.prototype,"fogRange"),UR.prototype),zR=UR))||zR),pI=(ZR=Zc("cc.ShadowsInfo"),JR=Pl(Cg),$R=pl(),eP=pl(),tP=Pl(bt),nP=pl(),iP=vl(),rP=Pl(bt),oP=pl(),aP=Pl(wg),sP=pl(),cP=Pl(At),lP=pl(),uP=Pl(bt),hP=pl(),_P=Pl(bt),fP=pl(),pP=Pl(bg),dP=pl(),mP=Pl(Ct),vP=pl(),gP=Pl(bt),yP=pl(),SP=Pl(bt),TP=pl(),EP=ml(),xP=vl(),AP=Pl(bt),bP=pl(),CP=ml(),wP=vl(),RP=Pl(bt),PP=pl(),IP=Pl(bt),OP=pl(),ZR((ZP=function(){function e(){Z(this,"_type",MP,this),Z(this,"_enabled",LP,this),Z(this,"_normal",BP,this),Z(this,"_distance",FP,this),Z(this,"_shadowColor",zP,this),Z(this,"_fixedArea",UP,this),Z(this,"_pcf",kP,this),Z(this,"_bias",GP,this),Z(this,"_normalBias",HP,this),Z(this,"_near",VP,this),Z(this,"_far",WP,this),Z(this,"_shadowDistance",jP,this),Z(this,"_invisibleOcclusionRange",XP,this),Z(this,"_orthoSize",qP,this),Z(this,"_maxReceived",YP,this),Z(this,"_size",KP,this),Z(this,"_saturation",QP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(uI),this.normal=Zn.transformQuat(lI,cI,uI),e.getWorldPosition(lI),this.distance=Zn.dot(this._normal,lI)},t.activate=function(e){this._resource=e,this.pcf=Math.min(this._pcf,wg.SOFT_2X),this._resource.initialize(this),this._resource.activate()},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){Zn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,2e3),this._resource&&(this._resource.far=Math.min(e,2e3))}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,2e3),this._resource&&(this._resource.invisibleOcclusionRange=Math.min(e,2e3))}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,2e3),this._resource&&(this._resource.shadowDistance=Math.min(e,2e3))}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),MP=J((NP=ZP).prototype,"_type",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cg.Planar}}),LP=J(NP.prototype,"_enabled",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BP=J(NP.prototype,"_normal",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(0,1,0)}}),FP=J(NP.prototype,"_distance",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zP=J(NP.prototype,"_shadowColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0,0,76)}}),UP=J(NP.prototype,"_fixedArea",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kP=J(NP.prototype,"_pcf",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wg.HARD}}),GP=J(NP.prototype,"_bias",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),HP=J(NP.prototype,"_normalBias",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VP=J(NP.prototype,"_near",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),WP=J(NP.prototype,"_far",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),jP=J(NP.prototype,"_shadowDistance",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),XP=J(NP.prototype,"_invisibleOcclusionRange",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),qP=J(NP.prototype,"_orthoSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),YP=J(NP.prototype,"_maxReceived",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),KP=J(NP.prototype,"_size",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(512,512)}}),QP=J(NP.prototype,"_saturation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),J(NP.prototype,"enabled",[fl],Object.getOwnPropertyDescriptor(NP.prototype,"enabled"),NP.prototype),J(NP.prototype,"type",[fl,JR],Object.getOwnPropertyDescriptor(NP.prototype,"type"),NP.prototype),J(NP.prototype,"shadowColor",[$R],Object.getOwnPropertyDescriptor(NP.prototype,"shadowColor"),NP.prototype),J(NP.prototype,"normal",[eP],Object.getOwnPropertyDescriptor(NP.prototype,"normal"),NP.prototype),J(NP.prototype,"distance",[tP,nP],Object.getOwnPropertyDescriptor(NP.prototype,"distance"),NP.prototype),J(NP.prototype,"saturation",[fl,iP,Tl,rP,oP],Object.getOwnPropertyDescriptor(NP.prototype,"saturation"),NP.prototype),J(NP.prototype,"pcf",[aP,sP],Object.getOwnPropertyDescriptor(NP.prototype,"pcf"),NP.prototype),J(NP.prototype,"maxReceived",[cP,lP],Object.getOwnPropertyDescriptor(NP.prototype,"maxReceived"),NP.prototype),J(NP.prototype,"bias",[uP,hP],Object.getOwnPropertyDescriptor(NP.prototype,"bias"),NP.prototype),J(NP.prototype,"normalBias",[_P,fP],Object.getOwnPropertyDescriptor(NP.prototype,"normalBias"),NP.prototype),J(NP.prototype,"shadowMapSize",[pP,dP],Object.getOwnPropertyDescriptor(NP.prototype,"shadowMapSize"),NP.prototype),J(NP.prototype,"fixedArea",[mP,vP],Object.getOwnPropertyDescriptor(NP.prototype,"fixedArea"),NP.prototype),J(NP.prototype,"near",[gP,yP],Object.getOwnPropertyDescriptor(NP.prototype,"near"),NP.prototype),J(NP.prototype,"far",[SP,TP],Object.getOwnPropertyDescriptor(NP.prototype,"far"),NP.prototype),J(NP.prototype,"invisibleOcclusionRange",[fl,EP,xP,Tl,AP,bP],Object.getOwnPropertyDescriptor(NP.prototype,"invisibleOcclusionRange"),NP.prototype),J(NP.prototype,"shadowDistance",[fl,CP,wP,Tl,RP,PP],Object.getOwnPropertyDescriptor(NP.prototype,"shadowDistance"),NP.prototype),J(NP.prototype,"orthoSize",[IP,OP],Object.getOwnPropertyDescriptor(NP.prototype,"orthoSize"),NP.prototype),DP=NP))||DP);i.ShadowsInfo=pI;var dI,mI=(JP=Zc("cc.SceneGlobals"),$P=Pl(_I),JP((aI=function(){function e(){Z(this,"ambient",nI,this),Z(this,"shadows",iI,this),Z(this,"_skybox",rI,this),Z(this,"fog",oI,this)}return e.prototype.activate=function(){var e=i.director.root.pipeline.pipelineSceneData;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)},k(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),nI=J((tI=aI).prototype,"ambient",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hI}}),iI=J(tI.prototype,"shadows",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pI}}),rI=J(tI.prototype,"_skybox",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _I}}),oI=J(tI.prototype,"fog",[fl,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fI}}),J(tI.prototype,"skybox",[fl,$P],Object.getOwnPropertyDescriptor(tI.prototype,"skybox"),tI.prototype),eI=tI))||eI);i.SceneGlobals=mI,mn(hb.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),mn(qC.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new mi),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new xi),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),vn(mI.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),vn(qC.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),vn(Sp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),mn(Sp,"Layers",[{name:"Default",newName:"DEFAULT",target:Sp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Sp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Sp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Sp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Sp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Sp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Sp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Sp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Sp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Sp,targetName:"Layers"}]),vn(Sp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),vn(Sp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var vI,gI,yI,SI,TI=Zt.Flags.HideInHierarchy,EI=Zt.Flags.DontSave,xI=e("PrivateNode",Zc("cc.PrivateNode")(dI=function(e){function t(t){var n;return A(12003,(n=e.call(this,t)||this).name),n.hideFlags|=EI|TI,n}return H(t,e),t}(qC))||dI);i.PrivateNode=xI;var AI=e("Scene",Zc("cc.Scene")((J((gI=function(e){H(n,e);var t=n.prototype;function n(t){var n;return Z(n=e.call(this,t)||this,"autoReleaseAssets",yI,Y(n)),Z(n,"_globals",SI,Y(n)),n._renderScene=null,n.dependAssets=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Zn.ZERO,n._rot=ri.IDENTITY,n._scale=Zn.ONE,n._mat=_i.IDENTITY,n._dirtyFlags=0,n._lpos=Zn.ZERO,n._lrot=ri.IDENTITY,n._lscale=Zn.ONE,n._activeInHierarchy=!1,i.director&&i.director.root&&(n._renderScene=i.director.root.createScene({})),n._inited=!i.game||!i.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=Zt.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(I(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t);yb(this)},t.getPosition=function(e){return Zn.copy(e||new Zn,Zn.ZERO)},t.getRotation=function(e){return ri.copy(e||new ri,ri.IDENTITY)},t.getScale=function(e){return Zn.copy(e||new Zn,Zn.ONE)},t.getWorldPosition=function(e){return Zn.copy(e||new Zn,Zn.ZERO)},t.getWorldRotation=function(e){return ri.copy(e||new ri,ri.IDENTITY)},t.getWorldScale=function(e){return Zn.copy(e||new Zn,Zn.ONE)},t.getWorldMatrix=function(e){return _i.copy(e||new _i,_i.IDENTITY)},t.getWorldRS=function(e){return _i.copy(e||new _i,_i.IDENTITY)},t.getWorldRT=function(e){return _i.copy(e||new _i,_i.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(hb._setScene)},t._activate=function(e){e=!1!==e,i.director._nodeActivator.activateNode(this,e),this._globals.activate()},k(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Zn.ZERO}},{key:"worldPosition",get:function(){return Zn.ZERO}},{key:"rotation",get:function(){return ri.IDENTITY}},{key:"worldRotation",get:function(){return ri.IDENTITY}},{key:"scale",get:function(){return Zn.ONE}},{key:"worldScale",get:function(){return Zn.ONE}},{key:"eulerAngles",get:function(){return Zn.ZERO}},{key:"worldMatrix",get:function(){return _i.IDENTITY}}]),n}(hb)).prototype,"globals",[fl],Object.getOwnPropertyDescriptor(gI.prototype,"globals"),gI.prototype),yI=J(gI.prototype,"autoReleaseAssets",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SI=J(gI.prototype,"_globals",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mI}}),vI=gI))||vI);function bI(e,t){if(!t){var n=i.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}i.Scene=AI,i.find=bI;var CI=Ye.fastRemoveAt,wI=Zt.Flags.IsStartCalled,RI=Zt.Flags.IsOnEnableCalled;function PI(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function II(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Zt.Flags.IsEditorOnEnableCalled;var OI=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ne;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function DI(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}OI.stableRemoveInactive=II;var NI=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){II(this._zero,e),II(this._neg,e),II(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(DI),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(DI),this._invoke(t),t.array.length=0)},t}(OI),MI=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=PI(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=PI(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(OI);function LI(e,t,n){var r="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",o=t?Function("it","dt",r):Function("it",r);return function(e,t,n){return function(r,o){try{t(r,o)}catch(t){i._throw(t);var a=r.array;for(n&&(a[r.i]._objFlags|=n),++r.i;r.i<a.length;++r.i)try{e(a[r.i],o)}catch(e){i._throw(e),n&&(a[r.i]._objFlags|=n)}}}}(Function("c","dt",e),o,n)}var BI=LI("c.start();c._objFlags|="+wI,!1,wI),FI=LI("c.update(dt)",!0),zI=LI("c.lateUpdate(dt)",!0),UI=function(e){var t=i.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var r=n[e.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||t._onEnabled(r))}},kI=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new NI(BI),this.updateInvoker=new MI(FI),this.lateUpdateInvoker=new MI(zI),this._updating=!1},t._onEnabled=function(e){i.director.getScheduler().resumeTarget(e),e._objFlags|=RI,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){i.director.getScheduler().pauseTarget(e),e._objFlags&=~RI;var t=this._deferredComps.indexOf(e);t>=0?CI(this._deferredComps,t):(!e.start||e._objFlags&wI||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&RI)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&RI&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&wI||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),GI=Zt.Flags.IsPreloadStarted,HI=Zt.Flags.IsOnLoadStarted,VI=Zt.Flags.IsOnLoadCalled,WI=Zt.Flags.Deactivating,jI=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){OI.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(OI),XI=LI("c.__preload();"),qI=LI("c.onLoad();c._objFlags|="+VI,!1,VI),YI=new qe(4);function KI(e,t,n){t?e._removeComponent(t):Ye.removeAt(e._components,n)}YI.get=function(){var e=this._get()||{preload:new jI(XI),onLoad:new NI(qI),onEnable:new NI(UI)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var QI,ZI,JI,$I,eO,tO,nO,iO,rO=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=YI.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),YI.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=Q(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(GI),o.onLoad.cancelInactive(HI),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)},t.activateComp=function(e,t,n,r){if($t(e,!0)&&(e._objFlags&GI||(e._objFlags|=GI,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&HI||(e._objFlags|=HI,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=VI):e._objFlags|=VI),e._enabled)){if(!e.node._activeInHierarchy)return;i.director._compScheduler.enableComp(e,r)}},t.destroyComp=function(e){i.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&VI&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,r){if(e._objFlags&WI)C(3816,e.name);else{e._activeInHierarchy=!0;for(var o=e._components.length,a=0;a<o;++a){var s=e._components[a];s instanceof i.Component?this.activateComp(s,t,n,r):(KI(e,s,a),--a,--o)}e._childArrivalOrder=e._children.length;for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,r)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=WI,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var r=e._components[n];if(r._enabled&&(i.director._compScheduler.disableComp(r),e._activeInHierarchy))return void(e._objFlags&=~WI)}for(var o=0,a=e._children.length;o<a;++o){var s=e._children[o];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~WI)}e._onPostActivated(!1),e._objFlags&=~WI},e}()),oO=e("SceneAsset",Zc("cc.SceneAsset")(($I=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"scene",JI,Y(t)),t}H(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new AI("New Scene")},n.validate=function(){return!!this.scene},t}(Cu),JI=J((ZI=$I).prototype,"scene",[fl,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QI=ZI))||QI);i.SceneAsset=oO;var aO,sO,cO,lO,uO=e("TextAsset",Zc("cc.TextAsset")((iO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"text",nO,Y(t)),t}return H(t,e),t.prototype.toString=function(){return this.text},t}(Cu),nO=J((tO=iO).prototype,"text",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eO=tO))||eO);i.TextAsset=uO;var hO=e("JsonAsset",Zc("cc.JsonAsset")((lO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"json",cO,Y(t)),t}return H(t,e),t}(Cu),cO=J((sO=lO).prototype,"json",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aO=sO))||aO);i.JsonAsset=hO;var _O,fO,pO,dO,mO,vO,gO,yO,SO,TO,EO,xO,AO,bO,CO,wO,RO,PO,IO=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updateDeferredPassInfo()},n.initPipelinePassInfo=function(){var e=new Ag;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Ag;n._uuid="builtin-post-process-material",n.initialize({effectName:"post-process"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._deferredPostMaterial=n,this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass(),this.updateDeferredPostPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.updateDeferredPostPass=function(){if(this.deferredPostMaterial){var e=this.deferredPostMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},k(t,[{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updateDeferredPassInfo())}},{key:"deferredPostMaterial",get:function(){return this._deferredPostMaterial},set:function(e){this._deferredPostMaterial!==e&&e&&(this._deferredPostMaterial=e,this.updateDeferredPassInfo())}}]),t}(Bx),OO=Em([Dr.POINT,Dr.POINT,Dr.NONE,Nr.CLAMP,Nr.CLAMP,Nr.CLAMP]),DO=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},NO=function(){this.gbufferFrameBuffer=null,this.gbufferRenderTargets=[],this.lightingFrameBuffer=null,this.lightingRenderTargets=[],this.depthTex=null},MO=e("DeferredPipeline",(_O=Zc("DeferredPipeline"),fO=Pl([fE]),pO=El(),_O((gO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._deferredRenderData=null,t._gbufferRenderPass=null,t._lightingRenderPass=null,t._width=0,t._height=0,t._lastUsedRenderArea=new co,Z(t,"renderTextures",vO,Y(t)),t._renderPasses=new Map,t}H(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new dx;n.initialize(dx.initInfo),this._flows.push(n);var i=new rA;i.initialize(rA.initInfo),this._flows.push(i);var r=new sA;r.initialize(sA.initInfo),this._flows.push(r)}return!0},n.activate=function(){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new IO,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(C(2402),1))},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){rS(this,n),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n)}}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new Uo,r=new ko;i.format=n.colorFormat,r.format=n.depthStencilFormat,r.stencilStoreOp=Gr.DISCARD,r.depthStoreOp=Gr.DISCARD,e&eo.COLOR||(e&hm?i.loadOp=kr.DISCARD:(i.loadOp=kr.LOAD,i.beginAccesses=[Hr.PRESENT])),(e&eo.DEPTH_STENCIL)!==eo.DEPTH_STENCIL&&(e&eo.DEPTH||(r.depthLoadOp=kr.LOAD),e&eo.STENCIL||(r.stencilLoadOp=kr.LOAD),r.beginAccesses=[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE]);var o=new Vo([i],r);return t=n.createRenderPass(o),this._renderPasses.set(e,t),t},n.getDeferredRenderData=function(){return this._deferredRenderData||this._generateDeferredRenderData(),this._deferredRenderData},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=Lm.getSampler(e,OO);this._descriptorSet.bindSampler(kp,t),this._descriptorSet.bindTexture(kp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(sd,t),this._descriptorSet.bindTexture(sd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var n=new DO;if(!(n=this.createQuadInputAssembler(yr.IDENTITY)).quadIB||!n.quadVB||!n.quadIA)return!1;this._quadIB=n.quadIB,this._quadVBOffscreen=n.quadVB,this._quadIAOffscreen=n.quadIA;var i=this.createQuadInputAssembler(e.surfaceTransform);if(!i.quadIB||!i.quadVB||!i.quadIA)return!1;if(this._quadVBOnscreen=i.quadVB,this._quadIAOnscreen=i.quadIA,!this._gbufferRenderPass){var r=new Uo;r.format=Tr.RGBA16F,r.loadOp=kr.CLEAR,r.storeOp=Gr.STORE;var o=new Uo;o.format=Tr.RGBA16F,o.loadOp=kr.CLEAR,o.storeOp=Gr.STORE;var a=new Uo;a.format=Tr.RGBA16F,a.loadOp=kr.CLEAR,a.storeOp=Gr.STORE;var s=new Uo;s.format=Tr.RGBA16F,s.loadOp=kr.CLEAR,s.storeOp=Gr.STORE;var c=new ko;c.format=e.depthStencilFormat,c.depthLoadOp=kr.CLEAR,c.depthStoreOp=Gr.STORE,c.stencilLoadOp=kr.CLEAR,c.stencilStoreOp=Gr.STORE;var l=new Vo([r,o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Uo;u.format=Tr.RGBA8,u.loadOp=kr.CLEAR,u.storeOp=Gr.STORE,u.endAccesses=[Hr.COLOR_ATTACHMENT_WRITE];var h=new ko;h.format=e.depthStencilFormat,h.depthLoadOp=kr.LOAD,h.depthStoreOp=Gr.DISCARD,h.stencilLoadOp=kr.LOAD,h.stencilStoreOp=Gr.DISCARD,h.beginAccesses=[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Hr.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Vo([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Fp.BINDING).destroy(),this._descriptorSet.getBuffer(Up.BINDING).destroy(),this._descriptorSet.getBuffer(zp.BINDING).destroy(),this._descriptorSet.getSampler(kp).destroy(),this._descriptorSet.getSampler(sd).destroy(),this._descriptorSet.getTexture(kp).destroy(),this._descriptorSet.getTexture(sd).destroy())},n.destroyDeferredData=function(){var e=this._deferredRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.lightingFrameBuffer&&e.lightingFrameBuffer.destroy(),e.depthTex&&e.depthTex.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.lightingRenderTargets.length;n++)e.lightingRenderTargets[n].destroy();e.lightingRenderTargets.length=0}this._deferredRenderData=null},n.destroy=function(){this.destroyUBOs(),this.destroyQuadInputAssembler(),this.destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.resize=function(e,t){this._width===e&&this._height===t||(this._width=e,this._height=t,this.destroyDeferredData(),this._generateDeferredRenderData())},n.createQuadInputAssembler=function(){var e=new DO,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Bo("a_position",Tr.RG32F),c[1]=new Bo("a_texCoord",Tr.RG32F);var l=this._device.createInputAssembler(new zo(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e){if(this._lastUsedRenderArea!==e){this._lastUsedRenderArea=e;var t=this.genQuadVertexData(yr.IDENTITY,e);this._quadVBOffscreen.update(t);var n=this.genQuadVertexData(this.device.surfaceTransform,e);this._quadVBOnscreen.update(n)}},n.genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this.device.width,r=(t.x+t.width)/this.device.width,o=t.y/this.device.height,a=(t.y+t.height)/this.device.height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case yr.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case yr.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case yr.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case yr.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n.destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._generateDeferredRenderData=function(){var e=this.device,t=this._deferredRenderData=new NO;t.gbufferRenderTargets.push(e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,Tr.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,Tr.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,Tr.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,Tr.RGBA16F,this._width,this._height))),t.depthTex=e.createTexture(new Ao(Rr.TEX2D,Pr.DEPTH_STENCIL_ATTACHMENT,e.depthStencilFormat,this._width,this._height)),t.gbufferFrameBuffer=e.createFramebuffer(new Xo(this._gbufferRenderPass,t.gbufferRenderTargets,t.depthTex)),t.lightingRenderTargets.push(e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,Tr.RGBA8,this._width,this._height))),t.lightingFrameBuffer=e.createFramebuffer(new Xo(this._lightingRenderPass,t.lightingRenderTargets,t.depthTex)),this._descriptorSet.bindTexture(Vp,t.gbufferFrameBuffer.colorTextures[0]),this._descriptorSet.bindTexture(Xp,t.gbufferFrameBuffer.colorTextures[1]),this._descriptorSet.bindTexture(Kp,t.gbufferFrameBuffer.colorTextures[2]),this._descriptorSet.bindTexture(td,t.gbufferFrameBuffer.colorTextures[3]),this._descriptorSet.bindTexture(Jp,t.lightingFrameBuffer.colorTextures[0]);var n=Lm.getSampler(e,OO);this._descriptorSet.bindSampler(Vp,n),this._descriptorSet.bindSampler(Xp,n),this._descriptorSet.bindSampler(Kp,n),this._descriptorSet.bindSampler(td,n),this._descriptorSet.bindSampler(Jp,n)},k(t,[{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}}]),t}(AS),vO=J((mO=gO).prototype,"renderTextures",[fO,il,pO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dO=mO))||dO)),LO=[new vo(0,0,0,1)];function BO(){var e=new zx;return e.initialize({flows:[]}),e}e("PostprocessStage",(yO=Zc("PostprocessStage"),SO=Pl(Ag),TO=El(),EO=Pl([mE]),xO=El(),yO((PO=RO=function(e){function t(){var t;return Z(t=e.call(this)||this,"_postProcessMaterial",CO,Y(t)),Z(t,"renderQueues",wO,Y(t)),t._renderArea=new co,t._uiPhase=void 0,t._uiPhase=new $E,t}H(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t),this._postProcessMaterial&&(t.pipelineSceneData.deferredPostMaterial=this._postProcessMaterial)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.width,this._renderArea.y=o.y*e.height,this._renderArea.width=o.width*e.width*i.shadingScale,this._renderArea.height=o.height*e.height*i.shadingScale;var a=e.window.framebuffer,s=a.colorTextures[0]?a.renderPass:t.getRenderPass(e.clearFlag);e.clearFlag&eo.COLOR&&(LO[0].x=e.clearColor.x,LO[0].y=e.clearColor.y,LO[0].z=e.clearColor.z),LO[0].w=e.clearColor.w,r.beginRenderPass(s,a,this._renderArea,LO,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Np.GLOBAL,t.descriptorSet);var c=i.deferredPostMaterial.passes[0],l=c.getShaderVariant();r.bindDescriptorSet(Np.MATERIAL,c.descriptorSet);var u=e.window.hasOffScreenAttachments?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=LS.getOrCreatePipelineState(n,c,l,s,u));var _=t.pipelineSceneData.renderObjects;null!=h&&_.length>0&&(r.bindPipelineState(h),r.bindInputAssembler(u),r.draw(u)),this._uiPhase.render(e,s),r.endRenderPass()},t}(Py),RO.initInfo={name:"PostprocessStage",priority:Cx.POSTPROCESS,tag:0},CO=J((bO=PO).prototype,"_postProcessMaterial",[SO,il,TO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wO=J(bO.prototype,"renderQueues",[EO,il,xO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AO=bO))||AO)),mn(AA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var FO,zO=function(){function e(){this.support=void 0,this._intervalInMileseconds=200,this._accelTimer=0,this._eventTarget=new ln,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this.support=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,un.browserType===N.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileseconds)){this._accelTimer=t;var n=0,r=0,o=0;if(this._globalEventClass===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;n=.1*((null==a?void 0:a.x)||0),r=.1*((null==a?void 0:a.y)||0),o=.1*((null==a?void 0:a.z)||0)}else{var s=e;n=(s.gamma||0)/90*.981,r=-(s.beta||0)/90*.981,o=(s.alpha||0)/90*.981}if(i.view._isRotated){var c=n;n=-r,r=c}var l=n;90===window.orientation?(n=-r,r=l):-90===window.orientation?(n=r,r=-l):180===window.orientation&&(n=-n,r=-r),un.os===B.ANDROID&&un.browserType!==N.MOBILE_QQ&&(n=-n,r=-r);var u={type:AA.DEVICEMOTION,x:n,y:r,z:o,timestamp:performance.now()};this._eventTarget.emit(AA.DEVICEMOTION,u)}},t.start=function(){this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileseconds=e},t.onChange=function(e){this._eventTarget.on(AA.DEVICEMOTION,e)},e}(),UO=function(){function e(){this.support=void 0,this.support=!0}var t=e.prototype;return t.show=function(){throw new Error("Method not implemented.")},t.hide=function(){throw new Error("Method not implemented.")},t.onChange=function(){throw new Error("Method not implemented.")},t.onComplete=function(){throw new Error("Method not implemented.")},t.offChange=function(){throw new Error("Method not implemented.")},t.offComplete=function(){throw new Error("Method not implemented.")},e}();!function(e){e[e.NONE=0]="NONE",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(FO||(FO=e("KeyCode",{})));var kO={Backspace:FO.BACKSPACE,Tab:FO.TAB,Enter:FO.ENTER,ShiftLeft:FO.SHIFT_LEFT,ControlLeft:FO.CTRL_LEFT,AltLeft:FO.ALT_LEFT,ShiftRight:FO.SHIFT_RIGHT,ControlRight:FO.CTRL_RIGHT,AltRight:FO.ALT_RIGHT,Pause:FO.PAUSE,CapsLock:FO.CAPS_LOCK,Escape:FO.ESCAPE,Space:FO.SPACE,PageUp:FO.PAGE_UP,PageDown:FO.PAGE_DOWN,End:FO.END,Home:FO.HOME,ArrowLeft:FO.ARROW_LEFT,ArrowUp:FO.ARROW_UP,ArrowRight:FO.ARROW_RIGHT,ArrowDown:FO.ARROW_DOWN,Insert:FO.INSERT,Delete:FO.DELETE,Digit0:FO.DIGIT_0,Digit1:FO.DIGIT_1,Digit2:FO.DIGIT_2,Digit3:FO.DIGIT_3,Digit4:FO.DIGIT_4,Digit5:FO.DIGIT_5,Digit6:FO.DIGIT_6,Digit7:FO.DIGIT_7,Digit8:FO.DIGIT_8,Digit9:FO.DIGIT_9,KeyA:FO.KEY_A,KeyB:FO.KEY_B,KeyC:FO.KEY_C,KeyD:FO.KEY_D,KeyE:FO.KEY_E,KeyF:FO.KEY_F,KeyG:FO.KEY_G,KeyH:FO.KEY_H,KeyI:FO.KEY_I,KeyJ:FO.KEY_J,KeyK:FO.KEY_K,KeyL:FO.KEY_L,KeyM:FO.KEY_M,KeyN:FO.KEY_N,KeyO:FO.KEY_O,KeyP:FO.KEY_P,KeyQ:FO.KEY_Q,KeyR:FO.KEY_R,KeyS:FO.KEY_S,KeyT:FO.KEY_T,KeyU:FO.KEY_U,KeyV:FO.KEY_V,KeyW:FO.KEY_W,KeyX:FO.KEY_X,KeyY:FO.KEY_Y,KeyZ:FO.KEY_Z,Numpad0:FO.NUM_0,Numpad1:FO.NUM_1,Numpad2:FO.NUM_2,Numpad3:FO.NUM_3,Numpad4:FO.NUM_4,Numpad5:FO.NUM_5,Numpad6:FO.NUM_6,Numpad7:FO.NUM_7,Numpad8:FO.NUM_8,Numpad9:FO.NUM_9,NumpadMultiply:FO.NUM_MULTIPLY,NumpadAdd:FO.NUM_PLUS,NumpadSubtract:FO.NUM_SUBTRACT,NumpadDecimal:FO.NUM_DECIMAL,NumpadDivide:FO.NUM_DIVIDE,NumpadEnter:FO.NUM_ENTER,F1:FO.F1,F2:FO.F2,F3:FO.F3,F4:FO.F4,F5:FO.F5,F6:FO.F6,F7:FO.F7,F8:FO.F8,F9:FO.F9,F10:FO.F10,F11:FO.F11,F12:FO.F12,NumLock:FO.NUM_LOCK,ScrollLock:FO.SCROLL_LOCK,Semicolon:FO.SEMICOLON,Equal:FO.EQUAL,Comma:FO.COMMA,Minus:FO.DASH,Period:FO.PERIOD,Slash:FO.SLASH,Backquote:FO.BACK_QUOTE,BracketLeft:FO.BRACKET_LEFT,Backslash:FO.BACKSLASH,BracketRight:FO.BRACKET_RIGHT,Quote:FO.QUOTE},GO=function(){function e(){this.support=void 0,this._eventTarget=new ln,this.support=void 0!==document.documentElement.onkeyup,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){t.stopPropagation(),t.preventDefault();var n=e._getInputEvent(t,AA.KEY_DOWN);e._eventTarget.emit(AA.KEY_DOWN,n)})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,AA.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(AA.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n;return{type:t,code:(n=e.code,kO[n]||FO.NONE),timestamp:performance.now()}},t.onDown=function(e){this._eventTarget.on("keypress",e)},t.onPressing=function(e){this._eventTarget.on(AA.KEY_DOWN,e)},t.onUp=function(e){this._eventTarget.on(AA.KEY_UP,e)},e}(),HO=function(){function e(){this.support=void 0,this._canvas=void 0,this._eventTarget=new ln,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new mi,this.support=void 0!==document.documentElement.onmouseup,this.support&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new bi(t.x,t.y,t.width,t.height):new bi(0,0,0,0)},t._getLocation=function(e){return new mi(e.clientX,e.clientY)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(AA.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(AA.MOUSE_MOVE)),window.addEventListener("mouseup",this._createCallback(AA.MOUSE_UP)),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",this._createCallback(AA.MOUSE_UP)),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",(function(e){var t=r._getCanvasRect(),n=r._getLocation(e),i={type:AA.MOUSE_WHEEL,x:n.x-t.x,y:t.y+t.height-n.y,button:e.button,deltaX:5*e.deltaX,deltaY:5*-e.deltaY,timestamp:performance.now(),movementX:e.movementX,movementY:e.movementY};e.stopPropagation(),e.preventDefault(),r._eventTarget.emit(AA.MOUSE_WHEEL,i)})),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getCanvasRect(),o=t._getLocation(n),a=n.button;switch(n.type){case"mousedown":null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case"mouseup":t._isPressed=!1;break;case"mousemove":t._isPressed||(a=-1)}var s={type:e,x:t._pointLocked?t._preMousePos.x+n.movementX:o.x-r.x,y:t._pointLocked?t._preMousePos.y-n.movementY:r.y+r.height-o.y,button:a,timestamp:performance.now(),movementX:n.movementX,movementY:n.movementY};t._preMousePos.set(s.x,s.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,s)}},t.onDown=function(e){this._eventTarget.on(AA.MOUSE_DOWN,e)},t.onMove=function(e){this._eventTarget.on(AA.MOUSE_MOVE,e)},t.onUp=function(e){this._eventTarget.on(AA.MOUSE_UP,e)},t.onWheel=function(e){this._eventTarget.on(AA.MOUSE_WHEEL,e)},e}(),VO=function(){function e(){this.support=void 0,this._canvas=void 0,this._eventTarget=new ln,this.support=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart||navigator.msPointerEnabled,this.support&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(AA.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(AA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(AA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(AA.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=t._getLocation(c),u=l.x-r.x,h=r.y+r.height-l.y;if(i.view._isRotated){var _=u;u=r.height-h,h=_}var f={identifier:c.identifier,x:u,y:h,force:c.force};o.push(f)}var p,d={type:e,changedTouches:o,timestamp:performance.now()};n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),"touchstart"===n.type&&(null===(p=t._canvas)||void 0===p||p.focus()),t._eventTarget.emit(e,d)}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new bi(t.x,t.y,t.width,t.height):new bi(0,0,0,0)},t._getLocation=function(e){return new mi(e.clientX,e.clientY)},t.onStart=function(e){this._eventTarget.on(AA.TOUCH_START,e)},t.onMove=function(e){this._eventTarget.on(AA.TOUCH_MOVE,e)},t.onEnd=function(e){this._eventTarget.on(AA.TOUCH_END,e)},t.onCancel=function(e){this._eventTarget.on(AA.TOUCH_CANCEL,e)},e}(),WO=new(function(){function e(){this._touch=new VO,this._mouse=new HO,this._keyboard=new GO,this._accelerometer=new zO,this._inputBox=new UO,this._touchEvents=[],this._mouseEvents=[],this._keyboardEvents=[],this._accelerometerEvents=[],this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){if(this._touch.support){var e=this._touchEvents;this._touch.onStart((function(t){e.push(t)})),this._touch.onMove((function(t){e.push(t)})),this._touch.onEnd((function(t){e.push(t)})),this._touch.onCancel((function(t){e.push(t)}))}if(this._mouse.support){var t=this._mouseEvents;this._mouse.onDown((function(e){t.push(e)})),this._mouse.onMove((function(e){t.push(e)})),this._mouse.onUp((function(e){t.push(e)})),this._mouse.onWheel((function(e){t.push(e)}))}if(this._keyboard.support){var n=this._keyboardEvents;this._keyboard.onPressing((function(e){n.push(e)})),this._keyboard.onUp((function(e){n.push(e)}))}if(this._accelerometer.support){var i=this._accelerometerEvents;this._accelerometer.onChange((function(e){i.push(e)}))}},t.startAccelerometer=function(){this._accelerometer.start()},t.stopAccelerometer=function(){this._accelerometer.stop()},t.setAccelerometerInterval=function(e){this._accelerometer.setInterval(e)},t.pollTouchEvents=function(){var e=Ke.array.copy(this._touchEvents);return this._touchEvents.length=0,e},t.pollMouseEvents=function(){var e=Ke.array.copy(this._mouseEvents);return this._mouseEvents.length=0,e},t.pollKeyboardEvents=function(){var e=Ke.array.copy(this._keyboardEvents);return this._keyboardEvents.length=0,e},t.pollAccelerometerEvents=function(){var e=Ke.array.copy(this._accelerometerEvents);return this._accelerometerEvents.length=0,e},e}()),jO=new mi,XO=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}H(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new mi),mi.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new mi),mi.set(e,this._x,i.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new mi),mi.set(e,this._x,this._y),i.view._convertPointWithScale(e),e},n.getPreviousLocation=function(e){return e||(e=new mi),mi.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new mi),mi.set(e,this._prevX,this._prevY),i.view._convertPointWithScale(e),e},n.getDelta=function(e){return e||(e=new mi),mi.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new mi),mi.set(e,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/i.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/i.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=i.view.getViewportRect();return(this._x-e.x)/i.view.getScaleX()},n.getUILocationY=function(){var e=i.view.getViewportRect();return(this._y-e.y)/i.view.getScaleY()},k(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(du));XO.BUTTON_MISSING=-1,XO.BUTTON_LEFT=0,XO.BUTTON_RIGHT=2,XO.BUTTON_MIDDLE=1,XO.BUTTON_4=3,XO.BUTTON_5=4,XO.BUTTON_6=5,XO.BUTTON_7=6,XO.BUTTON_8=7;var qO=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}H(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new mi},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new mi},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new mi},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new mi},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new mi},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new mi},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new mi},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new mi},n.getDeltaX=function(){return this.touch?this.touch.getDelta(jO).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(jO).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(du));qO.MAX_TOUCHES=5;var YO=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,AA.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return H(t,e),t}(du)),KO=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?AA.KEY_DOWN:AA.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==AA.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return H(t,e),k(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(du));du.EventMouse=XO,du.EventTouch=qO,du.EventAcceleration=YO,du.EventKeyboard=KO;var QO=new mi,ZO=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new mi,this._prevPoint=new mi,this._lastModified=0,this._id=0,this._startPoint=new mi,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new mi),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new mi),e.set(this._point.x,this._point.y),i.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=i.view.getViewportRect();return(this._point.x-e.x)/i.view.getScaleX()},t.getUILocationY=function(){var e=i.view.getViewportRect();return(this._point.y-e.y)/i.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new mi),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new mi),e.set(this._prevPoint.x,this._prevPoint.y),i.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new mi),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new mi),e.set(this._startPoint.x,this._startPoint.y),i.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new mi),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new mi),QO.set(this._point),QO.subtract(this._prevPoint),e.set(i.view.getScaleX(),i.view.getScaleY()),mi.divide(e,QO,e),e},t.getLocationInView=function(e){return e||(e=new mi),e.set(this._point.x,i.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new mi),e.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new mi),e.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new mi(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new mi(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=i.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new mi(e.x,e.y):new mi(e||0,t||0),this._lastModified=i.game.frameStartTime},k(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());i.Touch=ZO;var JO=function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i},$O=nt.TOUCH_TIMEOUT,eD=new mi,tD=new mi,nD=new(function(){function e(){this._preTouchPoint=new mi,this._prevMousePoint=new mi,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}var t=e.prototype;return t.clearEvents=function(){WO.pollMouseEvents(),WO.pollTouchEvents(),WO.pollKeyboardEvents(),WO.pollAccelerometerEvents()},t.frameDispatchEvents=function(){for(var e=WO.pollMouseEvents(),t=0,n=e.length;t<n;++t){var i=e[t];this._dispatchMouseEvent(i)}for(var r=WO.pollTouchEvents(),o=0,a=r.length;o<a;++o){var s=r[o];this._dispatchTouchEvent(s)}for(var c=WO.pollKeyboardEvents(),l=0,u=c.length;l<u;++l){var h=c[l];this._dispatchKeyboardEvent(h)}for(var _=WO.pollAccelerometerEvents(),f=0,p=_.length;f<p;++f){var d=_[f];this._dispatchAccelerometerEvent(d)}},t._dispatchMouseEvent=function(e){var t,n;switch(e.type){case AA.MOUSE_DOWN:t=this._getMouseEvent(e),n=this._getTouch(e),this._handleTouchesStart([n]),YA.dispatchEvent(t);break;case AA.MOUSE_MOVE:t=this._getMouseEvent(e),n=this._getTouch(e),this._handleTouchesMove([n]),YA.dispatchEvent(t);break;case AA.MOUSE_UP:t=this._getMouseEvent(e),n=this._getTouch(e),this._handleTouchesEnd([n]),YA.dispatchEvent(t);break;case AA.MOUSE_WHEEL:(t=this._getMouseEvent(e)).setScrollData(e.deltaX,e.deltaY),YA.dispatchEvent(t)}},t._dispatchTouchEvent=function(e){var t=this._getTouchList(e);switch(e.type){case AA.TOUCH_START:this._handleTouchesStart(t);break;case AA.TOUCH_MOVE:this._handleTouchesMove(t);break;case AA.TOUCH_END:this._handleTouchesEnd(t);break;case AA.TOUCH_CANCEL:this._handleTouchesCancel(t)}},t._handleTouchesStart=function(e){for(var t=[],n=this._touchesIntegerDict,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o&&void 0===n[o]){var a=this._getUnUsedIndex();if(-1===a){E(2300,a);continue}r.getLocation(eD);var s=new ZO(eD.x,eD.y,o);this._touches[a]=s,r.getPreviousLocation(eD),s.setPrevPoint(eD),n[o]=a,t.push(s)}}if(t.length>0){var c=new qO(t,!1,AA.TOUCH_START,nt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);YA.dispatchEvent(c)}},t._handleTouchesMove=function(e){for(var t=[],n=this._touches,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o){var a=this._touchesIntegerDict[o];void 0!==a&&n[a]&&(r.getLocation(eD),n[a].setPoint(eD),r.getPreviousLocation(eD),n[a].setPrevPoint(eD),t.push(n[a]))}}if(t.length>0){var s=new qO(t,!1,AA.TOUCH_MOVE,nt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);YA.dispatchEvent(s)}},t._handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new qO(t,!1,AA.TOUCH_END,nt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);YA.dispatchEvent(n)}this._preTouchPool.length=0},t._handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new qO(t,!1,AA.TOUCH_CANCEL,nt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);YA.dispatchEvent(n)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],n=this._touches,i=this._touchesIntegerDict,r=0;r<e.length;++r){var o=e[r],a=o.getID();if(null!==a){var s=i[a];void 0!==s&&n[s]&&(o.getLocation(eD),n[s].setPoint(eD),o.getPreviousLocation(eD),n[s].setPrevPoint(eD),t.push(n[s]),this._removeUsedIndexBit(s),delete i[a])}}return t},t._getPreTouch=function(e){for(var t=null,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){t=n[r];break}return t||(t=e),t},t._setPreTouch=function(e){for(var t=!1,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){n[r]=e,t=!0;break}t||(n.length<=50?n.push(e):(n[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t._getViewPixelRatio=function(){return this._glView||(this._glView=i.view),this._glView?this._glView._devicePixelRatio:1},t._getTouch=function(e){var t=this._preTouchPoint,n=this._getViewPixelRatio(),i=e.x*n,r=e.y*n,o=new ZO(i,r,0);return o.setPrevPoint(t.x,t.y),t.x=i,t.y=r,o},t._getMouseEvent=function(e){var t=this._prevMousePoint,n=new XO(e.type,!1,t),r=this._getViewPixelRatio();return t.x=e.x*r,t.y=e.y*r,i.GAME_VIEW&&(t.x/=i.gameView.canvas.width/i.game.canvas.width,t.y/=i.gameView.canvas.height/i.game.canvas.height),n.setLocation(t.x,t.y),n.setButton(e.button),e.movementX&&(n.movementX=e.movementX),e.movementY&&(n.movementY=e.movementY),n},t._getTouchList=function(e){for(var t=[],n=this._preTouchPoint,i=e.changedTouches.length,r=this._getViewPixelRatio(),o=0;o<i;o++){var a=e.changedTouches[o],s=a.x*r,c=a.y*r,l=new ZO(s,c,a.identifier);if(this._getPreTouch(l).getLocation(tD),l.setPrevPoint(tD.x,tD.y),this._setPreTouch(l),n.x=s,n.y=c,t.push(l),!nt.ENABLE_MULTI_TOUCH)break}return t},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=i.game.frameStartTime,n=0;n<this._maxTouches;n++){if(!(1&e))return this._indexBitsUsed|=1<<n,n;var r=this._touches[n];if(t-r.lastModified>$O){this._removeUsedIndexBit(n);var o=r.getID();return null!==o&&delete this._touchesIntegerDict[o],n}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var n in t){var i=t[parseInt(n)];if(null!=i){var r=this._touches[i];e.push(r)}}return e},t._dispatchKeyboardEvent=function(e){switch(e.type){case AA.KEY_DOWN:YA.dispatchEvent(new KO(e.code,AA.KEY_DOWN));break;case AA.KEY_UP:YA.dispatchEvent(new KO(e.code,AA.KEY_UP))}},t._dispatchAccelerometerEvent=function(e){if(e.type===AA.DEVICEMOTION){var t=e.x,n=e.y,i=e.z,r=e.timestamp;YA.dispatchEvent(new YO(new JO(t,n,i,r)))}},t.setAccelerometerEnabled=function(e){e?WO.startAccelerometer():WO.stopAccelerometer()},t.setAccelerometerInterval=function(e){WO.setAccelerometerInterval(e)},e}());i.internal.inputManager=nD;var iD=null,rD=null,oD=null,aD=null,sD=e("SystemEvent",function(e){function t(){return e.call(this)||this}H(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){E(3520,e),nD.setAccelerometerEnabled("granted"===e)})).catch((function(e){A(3521,e.message),nD.setAccelerometerEnabled(!1)})):nD.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){nD.setAccelerometerInterval(e)},n.on=function(t,n,r,o){return e.prototype.on.call(this,t,n,r,o),t!==AA.KEY_DOWN&&t!==AA.KEY_UP||iD||(iD=CA.create({event:CA.KEYBOARD,onKeyDown:function(e,t){cD.emit(t.type,t)},onKeyPressed:function(e,t){cD.emit(t.type,t)},onKeyReleased:function(e,t){cD.emit(t.type,t)}}),YA.addListener(iD,256)),t===AA.DEVICEMOTION&&(rD||(rD=CA.create({event:CA.ACCELERATION,callback:function(e,t){i.systemEvent.emit(t.type,t)}}),YA.addListener(rD,256))),t!==AA.TOUCH_START&&t!==AA.TOUCH_MOVE&&t!==AA.TOUCH_END&&t!==AA.TOUCH_CANCEL||oD||(oD=CA.create({event:CA.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return i.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){i.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){i.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){i.systemEvent.emit(t.type,e,t)}}),YA.addListener(oD,256)),t!==AA.MOUSE_DOWN&&t!==AA.MOUSE_MOVE&&t!==AA.MOUSE_UP&&t!==AA.MOUSE_WHEEL||aD||(aD=CA.create({event:CA.MOUSE,onMouseDown:function(e){i.systemEvent.emit(e.type,e)},onMouseMove:function(e){i.systemEvent.emit(e.type,e)},onMouseUp:function(e){i.systemEvent.emit(e.type,e)},onMouseScroll:function(e){i.systemEvent.emit(e.type,e)}}),YA.addListener(aD,256)),n},n.off=function(t,n,i){if(e.prototype.off.call(this,t,n,i),iD&&(t===AA.KEY_DOWN||t===AA.KEY_UP)){var r=this.hasEventListener(AA.KEY_DOWN),o=this.hasEventListener(AA.KEY_UP);r||o||(YA.removeListener(iD),iD=null)}if(rD&&t===AA.DEVICEMOTION&&(YA.removeListener(rD),rD=null),oD&&(t===AA.TOUCH_START||t===AA.TOUCH_MOVE||t===AA.TOUCH_END||t===AA.TOUCH_CANCEL)){var a=this.hasEventListener(AA.TOUCH_START),s=this.hasEventListener(AA.TOUCH_MOVE),c=this.hasEventListener(AA.TOUCH_END),l=this.hasEventListener(AA.TOUCH_CANCEL);a||s||c||l||(YA.removeListener(oD),oD=null)}if(aD&&(t===AA.MOUSE_DOWN||t===AA.MOUSE_MOVE||t===AA.MOUSE_UP||t===AA.MOUSE_WHEEL)){var u=this.hasEventListener(AA.MOUSE_DOWN),h=this.hasEventListener(AA.MOUSE_MOVE),_=this.hasEventListener(AA.MOUSE_UP),f=this.hasEventListener(AA.MOUSE_WHEEL);u||h||_||f||(YA.removeListener(aD),aD=null)}},t}(ln));sD.EventType=AA,i.SystemEvent=sD;var cD=e("systemEvent",new sD);i.systemEvent=cD;var lD=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t}H(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){i.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(nD.clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return i.director.once(i.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){un.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,r=0;r<n.length;r++){var o=n[r],a=hn(o.value);Sp.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),i.director.root&&i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Au.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()}))},n.addPersistRootNode=function(e){if(i.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=i.director._scene;if(i.isValid(n))if(e.parent){if(!(e.parent instanceof i.Scene))return void A(3801);if(e.parent!==n)return void A(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(e)}}else A(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(i.director._init()).then((function(){f("Cocos Creator v"+r),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,i.internal.dynamicAtlasManager&&(i.internal.dynamicAtlasManager.enabled=!nt.CLEANUP_IMAGE_CACHE)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=i.director;if(30===this._frameRate){var r=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(r=!r)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=i.director;D(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=w.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,g(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(0===n?Ni.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):Ni.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):1===n&&Ni.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):2===n&&Ni.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(I(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=[],r=nt.ENABLE_WEBGL_ANTIALIAS,o=new oa(this.canvas,r,!1,window.devicePixelRatio,Ni.windowPixelResolution.width,Ni.windowPixelResolution.height,Bp),a=!!window.WebGL2RenderingContext,s=window.navigator.userAgent.toLowerCase();(-1!==s.indexOf("safari")&&-1===s.indexOf("chrome")||Ni.browserType===N.UC)&&(a=!1),a&&i.WebGL2Device&&n.push(i.WebGL2Device),i.WebGLDevice&&n.push(i.WebGLDevice);for(var c=0;c<n.length&&(this._gfxDevice=new n[c],!this._gfxDevice.initialize(o));c++);}if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){un.on("show",this._onShow,this),un.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){i.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof AS?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){p(n),p("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(i.internal.SplashScreen){var e=i.internal.SplashScreen.instance;return e.main(i.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){i.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},k(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(ln));lD.EVENT_HIDE="game_on_hide",lD.EVENT_SHOW="game_on_show",lD.EVENT_LOW_MEMORY="game_on_low_memory",lD.EVENT_GAME_INITED="game_inited",lD.EVENT_ENGINE_INITED="engine_inited",lD.EVENT_RENDERER_INITED="renderer_inited",lD.EVENT_RESTART="game_on_restart",lD.RENDER_TYPE_CANVAS=0,lD.RENDER_TYPE_WEBGL=1,lD.RENDER_TYPE_OPENGL=2,lD.DEBUG_DT_THRESHOLD=1,i.Game=lD;var uD=e("game",i.game=new lD),hD={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};i.visibleRect=hD;var _D=function(){function e(){}var t=e.prototype;return t.fullScreen=function(){return Ii.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&A(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Ii.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return Ii.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},k(e,[{key:"supportsFullScreen",get:function(){return Ii.supportFullScreen}}]),e}(),fD=e("screen",new _D);i.screen=fD;var pD=new xi,dD=e("View",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=mD,r=vD;return t._frameSize=new xi(0,0),t._designResolutionSize=new xi(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new bi(0,0,0,0),t._visibleRect=new bi(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=i.macro.ORIENTATION_AUTO,t._rpExactFit=new gD(n.EQUAL_TO_FRAME,r.EXACT_FIT),t._rpShowAll=new gD(n.EQUAL_TO_FRAME,r.SHOW_ALL),t._rpNoBorder=new gD(n.EQUAL_TO_FRAME,r.NO_BORDER),t._rpFixedHeight=new gD(n.EQUAL_TO_FRAME,r.FIXED_HEIGHT),t._rpFixedWidth=new gD(n.EQUAL_TO_FRAME,r.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,i.game.once(i.Game.EVENT_ENGINE_INITED,t.init,Y(t)),t}H(t,e);var n=t.prototype;return n.init=function(){this._initFrameSize();var e=i.game.canvas.width,t=i.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,pD.width=this._visibleRect.width,pD.height=this._visibleRect.height,hD&&hD.init(this._visibleRect)},n.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,Ii.on("window-resize",this._resizeEvent,this),Ii.on("orientation-change",this._orientationChange,this)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,Ii.off("window-resize",this._resizeEvent,this),Ii.off("orientation-change",this._orientationChange,this))},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){(e&=i.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&fD.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){var n=i.game.canvas,r=i.game.container;this._devicePixelRatio=window.devicePixelRatio,n.width=Ni.windowPixelResolution.width,n.height=Ni.windowPixelResolution.height,n.style.width=e+"px",n.style.height=t+"px",r.style.width=e+"px",r.style.height=t+"px",this._resizeEvent()},n.getCanvasSize=function(){return new xi(i.game.canvas.width,i.game.canvas.height)},n.getFrameSize=function(){return new xi(this._frameSize.width,this._frameSize.height)},n.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,i.game.frame.style.width=e+"px",i.game.frame.style.height=t+"px",this._resizeEvent()},n.getVisibleSize=function(){return new xi(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new xi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new mi(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new mi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n.setResolutionPolicy=function(e){if(e instanceof gD)this._resolutionPolicy=e;else{var t=gD;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this.setResolutionPolicy(n);var i=this._resolutionPolicy;if(i&&i.preApply(this),this._orientationChanging=!0,this._resizing||this._initFrameSize(),i){this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),pD.width=this._visibleRect.width,pD.height=this._visibleRect.height,hD&&hD.init(this._visibleRect),this.emit("design-resolution-changed")}else E(2201)}else C(2200)},n.getDesignResolutionSize=function(){return new xi(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return this._devicePixelRatio},n.convertToLocationInView=function(e,t,n,r){var o=r||new mi,a=this._devicePixelRatio*(e-n.left),s=this._devicePixelRatio*(n.top+n.height-t);return this._isRotated?(o.x=i.game.canvas.width-s,o.y=a):(o.x=a,o.y=s),i.GAME_VIEW&&(o.x/=i.gameView.canvas.width/i.game.canvas.width,o.y/=i.gameView.canvas.height/i.game.canvas.height),o},n._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._resizeEvent=function(){var e,t=this._frameSize.width,n=this._frameSize.height,r=this._isRotated;if(i.sys.isMobile){var o=i.game.container.style,a=o.margin;o.margin="0",o.display="none",this._initFrameSize(),o.margin=a,o.display="block"}else this._initFrameSize();if(this._orientationChanging||this._isRotated!==r||this._frameSize.width!==t||this._frameSize.height!==n){var s=this._designResolutionSize.width,c=this._designResolutionSize.height;this._resizing=!0,s>0&&this.setDesignResolutionSize(s,c,this._resolutionPolicy),this._resizing=!1,this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)}},n._orientationChange=function(){this._orientationChanging=!0,this._resizeEvent()},n._initFrameSize=function(){var e=this._frameSize,t=Ii.windowSize,n=t.width,r=t.height,o=n>=r;!i.sys.isMobile||o&&this._orientation&i.macro.ORIENTATION_LANDSCAPE||!o&&this._orientation&i.macro.ORIENTATION_PORTRAIT?(e.width=n,e.height=r,i.game.container.style["-webkit-transform"]="rotate(0deg)",i.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=r,e.height=n,i.game.container.style["-webkit-transform"]="rotate(90deg)",i.game.container.style.transform="rotate(90deg)",i.game.container.style["-webkit-transform-origin"]="0px 0px 0px",i.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,i.game.canvas.style["-webkit-transform"]="translateZ(0px)",i.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){i.view._orientationChanging=!1}),1e3)},t}(ln));dD.instance=void 0;var mD=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,n){var r=i.game.canvas,o=i.game.container;Ni.os!==B.ANDROID&&Ni.os!==B.OHOS||(document.body.style.width=(e._isRotated?n:t)+"px",document.body.style.height=(e._isRotated?t:n)+"px"),o.style.width=r.style.width=t+"px",o.style.height=r.style.height=n+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),r.width=t*e._devicePixelRatio,r.height=n*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(i.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=i.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();mD.EQUAL_TO_FRAME=void 0,mD.PROPORTION_TO_FRAME=void 0;var vD=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new bi(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();vD.EXACT_FIT=void 0,vD.SHOW_ALL=void 0,vD.NO_BORDER=void 0,vD.FIXED_HEIGHT=void 0,vD.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return H(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,n=i.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?n.margin="0 0 0 "+t+"px":n.margin="0px",n.padding="0px"},t}(mD),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return H(t,e),t.prototype.apply=function(e,t){var n,r,o=e._frameSize.width,a=e._frameSize.height,s=i.game.container.style,c=t.width,l=t.height,u=o/c,h=a/l;u<h?(n=o,r=l*u):(n=c*h,r=a);var _=Math.round((o-n)/2),f=Math.round((a-r)/2);n=o-2*_,r=a-2*f,this._setupContainer(e,n,r),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=_+"px",s.paddingRight=_+"px",s.paddingTop=f+"px",s.paddingBottom=f+"px"},t}(mD),n=("undefined"==typeof window?global:window).__globalAdapter;n&&(n.adaptContainerStrategy&&n.adaptContainerStrategy(mD.prototype),n.adaptView&&n.adaptView(dD.prototype)),mD.EQUAL_TO_FRAME=new e,mD.PROPORTION_TO_FRAME=new t;var r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return H(t,e),t.prototype.apply=function(e,t){var n=i.game.canvas.width,r=i.game.canvas.height,o=n/t.width,a=r/t.height;return this._buildResult(n,r,n,r,o,a)},t}(vD),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return H(t,e),t.prototype.apply=function(e,t){var n,r,o=i.game.canvas.width,a=i.game.canvas.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,r=c*(h=l)):(n=s*(h=u),r=a),this._buildResult(o,a,n,r,h,h)},t}(vD),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return H(t,e),t.prototype.apply=function(e,t){var n,r,o,a=i.game.canvas.width,s=i.game.canvas.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(r=c*(n=h),o=s):(r=a,o=l*(n=u)),this._buildResult(a,s,r,o,n,n)},t}(vD),s=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return H(t,e),t.prototype.apply=function(e,t){var n=i.game.canvas.width,r=i.game.canvas.height,o=r/t.height,a=n,s=r;return this._buildResult(n,r,a,s,o,o)},t}(vD),c=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return H(t,e),t.prototype.apply=function(e,t){var n=i.game.canvas.width,r=i.game.canvas.height,o=n/t.width,a=n,s=r;return this._buildResult(n,r,a,s,o,o)},t}(vD);vD.EXACT_FIT=new r,vD.SHOW_ALL=new o,vD.NO_BORDER=new a,vD.FIXED_HEIGHT=new s,vD.FIXED_WIDTH=new c}();var gD=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof mD&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof vD&&(this._contentStrategy=e)},k(e,[{key:"canvasSize",get:function(){return new mi(i.game.canvas.width,i.game.canvas.height)}}]),e}());gD.EXACT_FIT=0,gD.NO_BORDER=1,gD.SHOW_ALL=2,gD.FIXED_HEIGHT=3,gD.FIXED_WIDTH=4,gD.UNKNOWN=5,gD.ContainerStrategy=mD,gD.ContentStrategy=vD,i.ResolutionPolicy=gD;var yD=e("view",dD.instance=i.view=new dD);i.winSize=pD,vn(dD.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),gn(dD.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"}]),gn(i,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),mn(du,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:sD.EventType,targetName:"SystemEvent.EventType"}]),gn(du,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),mn(XO,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:sD.EventType,targetName:"SystemEvent.EventType"}}))),mn(XO,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:sD.EventType,targetName:"SystemEvent.EventType"}]),gn(XO.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),mn(qO,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:sD.EventType,targetName:"SystemEvent.EventType"}]),mn(qO,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:sD.EventType,targetName:"SystemEvent.EventType"}]),mn(qO,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:sD.EventType,targetName:"SystemEvent.EventType"}]),mn(qO,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:sD.EventType,targetName:"SystemEvent.EventType"}]),gn(qO.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),mn(Ni,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:Ni.Language,targetName:"sys.Language"}}))),mn(Ni,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:Ni.OS,targetName:"sys.OS"}}))),mn(Ni,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:Ni.BrowserType,targetName:"sys.BrowserType"}}))),mn(Ni,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Ni.BrowserType,targetName:"sys.BrowserType"}]),mn(Ni,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:Ni.Platform,targetName:"sys.Platform"}}))),mn(Ni,"sys",[{name:"IPHONE",newName:"IOS",target:Ni.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Ni.Platform,targetName:"sys.Platform"}]),vn(Ni,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),mn(AA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:qC.EventType,targetName:"Node.EventType"}}))),mn(qC.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:sD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:sD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:sD.EventType,targetName:"SystemEvent.EventType"}]),gn(nt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),gn(nt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),gn(nt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),gn(nt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),gn(nt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),gn(fD,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var SD=new mi,TD=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new vo(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new vo(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.enableRetina(!0),i.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?i.view.setDesignResolutionSize(n.width,n.height,n.policy):i.view.setDesignResolutionSize(960,640,4),this.root=e,this.device=e.device,i.game.once(i.Game.EVENT_GAME_INITED,(function(){i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new vo(e.x,e.y,e.z,e.w)];var t=this.device;this.renderArea=new co(0,0,t.width,t.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=t.commandBuffer;var n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),i=4*Float32Array.BYTES_PER_ELEMENT,r=4*i;this.vertexBuffers=t.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,r,i)),this.vertexBuffers.update(n);var o=new Uint16Array([0,1,2,1,3,2]),a=Uint16Array.BYTES_PER_ELEMENT,s=6*a;this.indicesBuffers=t.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,s,a)),this.indicesBuffers.update(o);var c=[new Bo("a_position",Tr.RG32F),new Bo("a_texCoord",Tr.RG32F)],l=new zo(c,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(l),this.projection=new _i,_i.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,t.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),i.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device;_i.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,r.surfaceTransform);var o=r.width,a=r.height,s=o<a?o:a;e.startTime<0&&(e.startTime=n);var c=n-e.startTime,l=$h(On(c/i.totalTime));"NONE"===i.effect&&(l=1);var u=e.logoTexture.width,h=e.logoTexture.height,_=s*i.displayRatio,f=_*u/h,p=_;if(r.surfaceTransform!==yr.ROTATE_90&&r.surfaceTransform!==yr.ROTATE_270||(f=_*o/a,p=_*h/u*a/o),e.logoMat.setProperty("resolution",SD.set(o,a),0),e.logoMat.setProperty("scale",SD.set(f,p),0),e.logoMat.setProperty("translate",SD.set(.5*o,.5*a),0),e.logoMat.setProperty("precent",l),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var d=.5*s,m=e.watermarkTexture.width,v=d,g=d*e.watermarkTexture.height/m;r.surfaceTransform!==yr.ROTATE_90&&r.surfaceTransform!==yr.ROTATE_270||(v=.5*d,g=d*o/a*.5),e.watermarkMat.setProperty("resolution",SD.set(o,a),0),e.watermarkMat.setProperty("scale",SD.set(v,g),0),e.watermarkMat.setProperty("translate",SD.set(.5*o,.1*a),0),e.watermarkMat.setProperty("precent",l),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.frame(),c>i.totalTime&&(e.splashFinish=!0),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Ag,this.logoMat.initialize({effectName:"splash-screen"});var t=new Co;t.addressU=Nr.CLAMP,t.addressV=Nr.CLAMP,t.addressW=Nr.CLAMP,this.sampler=e.createSampler(t),this.logoTexture=e.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED|Pr.TRANSFER_DST,Tr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new po;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new po;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED|Pr.TRANSFER_DST,Tr.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Ag,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device;e.acquire();var t=this.cmdBuff,n=this.framebuffer,i=this.renderArea;i.width=e.width,i.height=e.height,t.begin(),t.beginRenderPass(n.renderPass,n,i,this.clearColors,1,0);var r=this.logoMat.passes[0],o=LS.getOrCreatePipelineState(e,r,this.shader,n.renderPass,this.quadAssmebler);if(t.bindPipelineState(o),t.bindDescriptorSet(Np.MATERIAL,r.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var a=this.watermarkMat.passes[0],s=LS.getOrCreatePipelineState(e,a,this.shader,n.renderPass,this.quadAssmebler);t.bindPipelineState(s),t.bindDescriptorSet(Np.MATERIAL,a.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler)}t.endRenderPass(),t.end(),e.flushCommands([t]),e.queue.submit([t]),e.present()},e.destroy=function(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},k(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();TD._ins=void 0,i.internal.SplashScreen=TD;var ED=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},k(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());ED.Priority=Ze({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var xD=new ce("Scheduler"),AD=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};AD.get=function(e,t,n,i){var r=AD._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new AD(e,t,n,i),r},AD.put=function(e){AD._listEntries.length<20&&(e.target=null,AD._listEntries.push(e))},AD._listEntries=[];var bD=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};bD.get=function(e,t,n,i){var r=bD._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new bD(e,t,n,i),r},bD.put=function(e){bD._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,bD._hashUpdateEntries.push(e))},bD._hashUpdateEntries=[];var CD=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};CD.get=function(e,t,n,i,r,o){var a=CD._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new CD(e,t,n,i,r,o),a},CD.put=function(e){CD._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,CD._hashTimerEntries.push(e))},CD._hashTimerEntries=[];var wD=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,r,o,a){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=r,this._delay=a,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();wD._timers=[],wD.get=function(){return wD._timers.pop()||new wD},wD.put=function(e){wD._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,wD._timers.push(e))};var RD=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=Se(!0),t._hashForTimers=Se(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}H(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?A(1513):e.id=xD.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,r,o,a){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!r,r=i.macro.REPEAT_FOREVER,o=0),P(t,1502);var c=t.uuid||t.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==a&&A(1511):(h=CD.get(null,t,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return E(1507,l.getInterval(),n),void(l._interval=n);(l=wD.get()).initWithCallback(this,e,t,n,r,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else C(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return E(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=AD.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=bD.get(o,a,e,null)}else C(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),wD.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else C(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else C(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)wD.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else C(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(ED.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){P(e,1508),P(t,1509);var n=t.uuid||t.id;if(!n)return C(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(ED.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){P(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else C(1510)},n.resumeTarget=function(e){P(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else C(1510)},n.isTargetPaused=function(e){P(e,1505);var t=e.uuid||e.id;if(!t)return C(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}CD.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],AD.put(r),bD.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(ED));RD.ID="scheduler",i.Scheduler=RD;var PD=function(){function e(){this._title="",this._width=1,this._height=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t._setHasOffScreenAttachments=function(e){this._hasOffScreenAttachments=e},t._setHasOnScreenAttachments=function(e){this._hasOnScreenAttachments=e},t._createFrameBuffer=function(e,t){this._framebuffer=e.createFramebuffer(new Xo(t,this._colorTextures,this._depthStencilTexture))},t._init=function(){},t.initialize=function(e,t){this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height;for(var n=t.renderPassInfo,i=n.colorAttachments,r=n.depthStencilAttachment,o=0;o<i.length;o++)i[o].format===Tr.UNKNOWN&&(i[o].format=e.colorFormat);r&&r.format===Tr.UNKNOWN&&(r.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(var a=0;a<i.length;a++){var s=null;this._swapchainBufferIndices&1<<a?this._setHasOnScreenAttachments(!0):(s=e.createTexture(new Ao(Rr.TEX2D,Pr.COLOR_ATTACHMENT|Pr.SAMPLED,i[a].format,this._width,this._height)),this._setHasOffScreenAttachments(!0)),this._colorTextures.push(s)}return r?this._swapchainBufferIndices>=0&&(this._depthStencilTexture=e.createTexture(new Ao(Rr.TEX2D,Pr.DEPTH_STENCIL_ATTACHMENT|Pr.SAMPLED,r.format,this._width,this._height)),this._setHasOffScreenAttachments(!0)):this._setHasOnScreenAttachments(!0),this._createFrameBuffer(e,this._renderPass),!0},t._destroy=function(){this.framebuffer.destroy()},t.destroy=function(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){this._width=e,this._height=t;var n=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),n=!0);for(var i=0;i<this._colorTextures.length;i++){var r=this._colorTextures[i];r&&(r.resize(e,t),n=!0)}var o=this.framebuffer;n&&o&&(o.destroy(),o.initialize(new Xo(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var a,s=Q(this._cameras);!(a=s()).done;){var c=a.value;c.isWindowSize&&c.resize(e,t)}},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},k(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"shouldSyncSizeWithSwapchain",get:function(){return this._shouldSyncSizeWithSwapchain}},{key:"hasOnScreenAttachments",get:function(){return this._hasOnScreenAttachments}},{key:"hasOffScreenAttachments",get:function(){return this._hasOffScreenAttachments}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ID=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(e),Eg.registerCreateFunc(this),PD.registerCreateFunc(this),this._cameraPool=new $((function(){return new fm(t._device)}),4)}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){var e=this;this._init();var t=new Uo,n=new ko;n.depthStoreOp=Gr.DISCARD,n.stencilStoreOp=Gr.DISCARD;var r=new Vo([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:r,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(Gv.initBuiltinRes(this._device)).then((function(){i.view.on("design-resolution-changed",(function(){var t=i.game.canvas.width,n=i.game.canvas.height;e.resize(t,n)}),e)}))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(var n,i=Q(this._windows);!(n=i()).done;){var r=n.value;r.shouldSyncSizeWithSwapchain&&r.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t)},e.setRenderPipeline=function(e){if(e instanceof MO&&(this._useDeferredPipeline=!0),e||(e=BO()),this._pipeline=e,!this._pipeline.activate())return!1;var t=i.director.getScene();return t&&t.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();for(var n=this._windows,r=[],o=0;o<n.length;o++)n[o].extractRenderCameras(r);if(this._pipeline&&r.length>0){this._device.acquire();var a=this._scenes,s=i.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(var c=0;c<a.length;c++)a[c].update(s);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),r.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(r),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=Q(this._windows);!(e=t()).done;)e.value.destroy();this._windows=[]},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=Q(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes=[]},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new $((function(){return new e}),10)),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):A(1300,e.constructor.name)},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new $((function(){return new e}),4)),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case Og.SPHERE:e.scene.removeSphereLight(e);break;case Og.SPOT:e.scene.removeSpotLight(e)}},k(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();i.Root=ID;var OD=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new RD,t._compScheduler=new kI,t._nodeActivator=new rO,t._systems=[],uD.once(lD.EVENT_RENDERER_INITED,t._initOnRendererInitialized,Y(t)),t}H(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.convertToGL=function(e){var t=uD.container,n=i.view,r=t.getBoundingClientRect(),o=r.left+window.pageXOffset-t.clientLeft,a=r.top+window.pageYOffset-t.clientTop,s=n._devicePixelRatio*(e.x-o),c=n._devicePixelRatio*(a+r.height-e.y);return n._isRotated?yi(n._viewportRect.width-c,s):yi(s,c)},n.convertToUI=function(e){var t=uD.container,n=i.view,r=t.getBoundingClientRect(),o=r.left+window.pageXOffset-t.clientLeft,a=r.top+window.pageYOffset-t.clientTop,s=yi(0,0);return n._isRotated?(s.x=o+e.y/n._devicePixelRatio,s.y=a+r.height-(n._viewportRect.width-e.x)/n._devicePixelRatio):(s.x=o+e.x*n._devicePixelRatio,s.y=a+r.height-e.y*n._devicePixelRatio),s},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),YA&&YA.setEnabled(!1),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),YA&&YA.setEnabled(!0),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof oO&&(e=e.scene),P(e instanceof AI,1216),e._load();for(var r=Object.keys(uD._persistRootNodes).map((function(e){return uD._persistRootNodes[e]})),o=0;o<r.length;o++){var a=r[o];a.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(a,c)}else a.parent=e}var l=this._scene;i.isValid(l)&&l.destroy(),i.assetManager._releaseManager._autoRelease(l,e,uD._persistRootNodes),this._scene=null,Zt._deferredDestroy(),t&&t(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var r=this;e instanceof oO&&(e=e.scene),P(e,1205),P(e instanceof AI,1216),e._load(),this.once(i.Director.EVENT_END_FRAME,(function(){r.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var r=this;if(this._loadingScene)return A(1208,e,this._loadingScene),!1;var o=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return o?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),o.loadScene(e,(function(i,o){console.timeEnd("LoadScene "+e),r._loadingScene="",i?(d(i),t&&t(i)):r.runSceneImmediate(o,n,t)})),!0):(C(1209,e),!1)},n.preloadScene=function(e,t,n){var r=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(r)r.preloadScene(e,null,t,n);else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(o)),d("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return uD.deltaTime},n.getTotalTime=function(){return uD.totalTime},n.getCurrentTime=function(){return uD.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(RD.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(ED.sortByPriority)},n.unregisterSystem=function(e){Ye.fastRemove(this._systems,e),this._systems.sort(ED.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(i.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=uD._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),nD.frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Zt._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),YA.frameUpdateListeners(),qC.resetHasChangedFlags(),qC.clearNodeArray(),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,YA&&YA.setEnabled(!0),this.registerSystem(RD.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new ID(uD._gfxDevice),this._root.initialize({}).catch((function(e){return C(1217),Promise.reject(e)}))},k(t,[{key:"root",get:function(){return this._root}}]),t}(ln));OD.EVENT_INIT="director_init",OD.EVENT_RESET="director_reset",OD.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",OD.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",OD.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",OD.EVENT_BEFORE_UPDATE="director_before_update",OD.EVENT_AFTER_UPDATE="director_after_update",OD.EVENT_BEFORE_DRAW="director_before_draw",OD.EVENT_AFTER_DRAW="director_after_draw",OD.EVENT_BEFORE_COMMIT="director_before_commit",OD.EVENT_BEFORE_PHYSICS="director_before_physics",OD.EVENT_AFTER_PHYSICS="director_after_physics",OD.EVENT_BEGIN_FRAME="director_begin_frame",OD.EVENT_END_FRAME="director_end_frame",OD.instance=void 0,i.Director=OD;var DD=e("director",OD.instance=i.director=new OD),ND={};mn(ND,"vmath",[{name:"vec2",newName:"Vec2",target:Pi,targetName:"math"},{name:"vec3",newName:"Vec3",target:Pi,targetName:"math"},{name:"vec4",newName:"Vec4",target:Pi,targetName:"math"},{name:"quat",newName:"Quat",target:Pi,targetName:"math"},{name:"mat3",newName:"Mat3",target:Pi,targetName:"math"},{name:"mat4",newName:"Mat4",target:Pi,targetName:"math"},{name:"color4",newName:"Color",target:Pi,targetName:"math"},{name:"rect",newName:"Rect",target:Pi,targetName:"math"},{name:"approx",newName:"approx",target:Pi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Pi,targetName:"math"},{name:"equals",newName:"equals",target:Pi,targetName:"math"},{name:"clamp",newName:"clamp",target:Pi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Pi,targetName:"math"},{name:"lerp",newName:"lerp",target:Pi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Pi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Pi,targetName:"math"},{name:"random",newName:"random",target:Pi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Pi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Pi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Pi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Pi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Pi,targetName:"math"},{name:"repeat",newName:"repeat",target:Pi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Pi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Pi,targetName:"math"}]),i.vmath=ND,mn(RD.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:RD,targetName:"Scheduler"}]),mn(RD,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return ED.Priority.SCHEDULER}}]),vn(RD,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),mn(qO.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:qO,targetName:"EventTouch"}]),mn(Yv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),vn(Yv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),mn(ID.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),gn(uD,"game",[{name:"collisionMatrix"},{name:"groupList"}]),gn(OD.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),vn(OD.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"}]);var MD=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Wl,this.scenes=new Wl,this.paths=new Wl}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=su(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var p=t[_];t[_]=h[p]=su(p)}t=h}for(var d in n){var m=n[d];o[t[d]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var S=e.packs;for(var T in S)for(var E=S[T],x=0;x<E.length;++x)E[x]=t[E[x]];var A=e.versions;if(A)for(var b in A)for(var C=A[b],w=0;w<C.length;w+=2){var R=C[w];C[w]=t[R]||R}var P=e.redirect;if(P)for(var I=0;I<P.length;I+=2)P[I]=t[P[I]],P[I+1]=r[P[I+1]];if(e.extensionMap){var O=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var D in e.extensionMap)O(D)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=_u(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(Ke.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=_u(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!Ke.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=Ke._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function LD(e,t){e._uuid&&t.push(e._uuid)}function BD(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Cu&&LD(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof Cu&&LD(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Cu&&LD(u,t)}}}}function FD(e,t){for(var n=0;n<e._components.length;n++)BD(e._components[n],t);for(var i=0;i<e._children.length;i++)FD(e._children[i],t)}function zD(e,t,n,i){n.push(e._uuid);for(var r=Vm.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=ql.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||zD(s,t,n,i)}}}var UD=[],kD=new(function(){function e(){this._persistNodeDeps=new Wl,this._toDelete=new Wl,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];FD(e,t);for(var n=0,i=t.length;n<i;n++){var r=ql.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=ql.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Vm.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=ql.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Vm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=ql.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Vm.remove(e.uuid)}var _=Vm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var p,d,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=Q(v);!(d=g()).done;){var y=d.value,S=ql.get(y);S&&S.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Cu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,_t(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),$t(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,zD(e,t,UD,-1),UD.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&zD(ql.get(n),t,UD,1);return UD.length=0,t[e._uuid]}(e)>0)){ql.remove(n);for(var i=Vm.getDeps(n),r=0,o=i.length;r<o;r++){var a=ql.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Vm.remove(n)}},e}()),GD=null;function HD(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Cu&&r.content.decRef(!1),r.recycle()}e.input=null}function VD(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function WD(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){WD(e,t,n,i,r)}),n)}))}function jD(e,t,n,i,r){try{for(var o=Vm.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(G({},o.nativeDep)))}catch(e){d(e.message,e.stack)}}function XD(e,t,n){t&&(n=void 0!==n?n:i.assetManager.cacheAsset,hu(t)||!n||t.isDefault||ql.add(e,t))}function qD(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function YD(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function KD(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=Ke.isChildClassOf(e,Cu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||GD,onComplete:o}}function QD(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=Vm.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||QD(e,c,n,i)){r=!0;break}}return r}function ZD(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Cu&&i.push(e.addRef())})):n instanceof Cu&&i.push(n.addRef()),_t((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var JD=function(){function e(){this._config=new MD}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),Ql.add(e.name,this)},t.load=function(e,t,n,r){var o=KD(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete,l={__requestType__:Xl.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(e)};i.assetManager.loadAny(e,l,s,c)},t.preload=function(e,t,n,r){var o=KD(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(e,{__requestType__:Xl.PATH,type:a,bundle:this.name},s,c)},t.loadDir=function(e,t,n,r){var o=KD(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.loadAny(e,{__requestType__:Xl.DIR,type:a,bundle:this.name,__outputAsArray__:!0},s,c)},t.preloadDir=function(e,t,n,r){var o=KD(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(e,{__requestType__:Xl.DIR,type:a,bundle:this.name},s,c)},t.loadScene=function(e,t,n,r){var o=YD(t,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,i.assetManager.loadAny({scene:e},a,s,(function(e,t){if(e)d(e.message,e.stack);else if(t instanceof oO&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");c&&c(e,t)}))},t.preloadScene=function(e,t,n,r){var o=YD(t,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.bundle=this.name,i.assetManager.preloadAny({scene:e},a,s,(function(t){t&&C(1210,e,t.message),c&&c(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&ql.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&kD.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;ql.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&kD.tryRelease(t)}))},t.releaseAll=function(){var e=this;ql.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&kD.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},k(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),$D=e("resources",new JD);function eN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(I(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function tN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}i.resources=$D;var nN={};function iN(e,t,n){if(nN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),nN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(I(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var rN=/^(?:\w+:\/\/|\.+\/).+/,oN=function(e,t,n){(Ni.capabilities.imageBitmap&&i.assetManager.allowImageBitmap?aN:eN)(e,t,n)},aN=function(e,t,n){t.xhrResponseType="blob",tN(e,t,t.onFileProgress,n)},sN=function(e,t,n){t.xhrResponseType="json",tN(e,t,t.onFileProgress,n)},cN=function(e,t,n){t.xhrResponseType="arraybuffer",tN(e,t,t.onFileProgress,n)},lN=function(e,t,n){sN(e,t,(function(t,i){if(t)n(t);else{var r=$u(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){cN(""+Ui(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new Ju(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},uN=function(e,t,n){cN(e,t,(function(e,t){if(e)n(e);else try{var i=eh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},hN=function(e,t,n){t.xhrResponseType="text",tN(e,t,t.onFileProgress,n)},_N=function(e,t,n){var i=ki(e),r=e;rN.test(r)||(r=-1!==fN.remoteBundles.indexOf(i)?fN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||fN.bundleVers[i],a=0,s=null,c=null;sN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),iN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},fN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=eN,this.downloadDomAudio=null,this.downloadFile=tN,this.downloadScript=iN,this._downloaders={".png":oN,".jpg":oN,".bmp":oN,".jpeg":oN,".gif":oN,".ico":oN,".tiff":oN,".webp":oN,".image":oN,".pvr":cN,".pkm":cN,".astc":cN,".txt":hN,".xml":hN,".vsh":hN,".fsh":hN,".atlas":hN,".tmx":hN,".tsx":hN,".json":sN,".ExportJson":sN,".plist":hN,".ccon":lN,".cconb":uN,".fnt":hN,".binary":cN,".bin":cN,".dbbin":cN,".skel":cN,".js":iN,bundle:_N,default:hN},this._downloading=new Wl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?Oe(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=Yl.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;WD((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(VD(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(VD(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||Yl.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){i.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=i.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(VD(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(_t(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},k(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function pN(e,t,n,i){var r=null,o=null;try{(r=new vm)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function dN(e,t,n,i){var r=new hO;r.json=t,i(null,r)}function mN(e,t,n,i){var r=new uO;r.text=t,i(null,r)}function vN(e,t,n,i){var r=new bw;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function gN(e,t,n,i){var r=new Cu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function yN(e,n,i,r){var o=Ql.get(n.name);o||(o=n.name===eu.RESOURCES?$D:new JD,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var SN=new(function(){function e(){this._creating=new Wl,this._producers={".png":pN,".jpg":pN,".bmp":pN,".jpeg":pN,".gif":pN,".ico":pN,".tiff":pN,".webp":pN,".image":pN,".pvr":pN,".pkm":pN,".txt":mN,".xml":mN,".vsh":mN,".fsh":mN,".atlas":mN,".tmx":mN,".tsx":mN,".fnt":mN,".json":dN,".ExportJson":dN,".binary":vN,".bin":vN,".dbbin":vN,".skel":vN,bundle:yN,default:gN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?Ke.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=ql.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof Cu&&(n._uuid=e,XD(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),TN=new(function(){function e(){this._loading=new Wl,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=Ke.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(I(5304,e[0]));Sh(e,!0,void 0,Eh.reportMissingClass),Th(e);for(var t=new xh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&C(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=Ke._getClassId(av),c=Ke._getClassId(vm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&C(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Ah(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&C(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?Ke.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(Yl.has(e.id))n(null,Yl.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=fu(o.uuid,{ext:o.ext,bundle:e.config.name});fN.download(o.uuid,a,o.ext,e.options,(function(t,n){Yl.remove(o.uuid),t&&d(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)Yl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else fN.download(e.id,e.url,e.ext,e.options,n)},e}());function EN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,o=e.progress,a=[],s=o.total,c=r.__exclude__=r.__exclude__||Object.create(null);e.output=[],qD(e.input,(function(r,l){if(!r.isNative&&ql.has(r.uuid)){var u=ql.get(r.uuid);return r.content=u.addRef(),e.output.push(r),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r),void l()}TN.load(r,e.options,(function(u,h){u?e.isFinish||(!i.assetManager.force||n?(d(u.message,u.stack),o.canInvoke=!1,t(u)):(e.output.push(r),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r))):e.isFinish||(r.file=h,e.output.push(r),r.isNative||(c[r.uuid]=!0,jD(r.uuid,h,c,a,r.config),o.total=s+a.length),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r)),l()}))}),(function(){if(e.isFinish)return HD(e,!0),void e.dispatch("error");if(a.length>0){var i=nu.create({input:a,progress:o,options:r,onProgress:e.onProgress,onError:nu.prototype.recycle,onComplete:function(r){var o;r||((o=e.output).push.apply(o,i.output),i.recycle()),n&&xN(e),t(r)}});Jl.async(i)}else n&&xN(e),t()}))}function xN(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var AN=new(function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return A(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function bN(e,t){return e[t]<<8|e[t+1]}var CN=new(function(){function e(){this._parsing=new Wl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=bN(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=bN(a,12),l=bN(a,14);bN(a,8),bN(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?Jd.RGBA_ASTC_4x4:5===e?4===t?Jd.RGBA_ASTC_5x4:Jd.RGBA_ASTC_5x5:6===e?5===t?Jd.RGBA_ASTC_6x5:Jd.RGBA_ASTC_6x6:8===e?5===t?Jd.RGBA_ASTC_8x5:6===t?Jd.RGBA_ASTC_8x6:Jd.RGBA_ASTC_8x8:10===e?5===t?Jd.RGBA_ASTC_10x5:6===t?Jd.RGBA_ASTC_10x6:8===t?Jd.RGBA_ASTC_10x8:Jd.RGBA_ASTC_10x10:10===t?Jd.RGBA_ASTC_12x10:Jd.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=AN.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Gm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?Oe(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=Kl.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?Yl.remove(e):hu(n)||Kl.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function wN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,o=e.progress;r.__exclude__=r.__exclude__||Object.create(null),e.output=[],qD(e.input,(function(a,s){var c=nu.create({input:a,onProgress:e.onProgress,options:r,progress:o,onComplete:function(r,l){r&&!e.isFinish&&(!i.assetManager.force||n?(d(r.message,r.stack),o.canInvoke=!1,t(r)):o.canInvoke&&e.dispatch("progress",++o.finish,o.total,a)),e.output.push(l),c.recycle(),s(null)}});RN.async(c)}),(function(){if(r.__exclude__=null,e.isFinish)return HD(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),HD(e,!0),t()}))}var RN=new jl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&ql.has(o)?t():TN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)CN.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),Yl.remove(o),Kl.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||QD(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&ql.has(c)){var p=ql.get(c);n.content=p.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,CN.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),jD(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=nu.create({input:h,options:e.options,onProgress:e.onProgress,onError:nu.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=Q(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Cu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=zm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(d("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Cu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}zm.delete(t)}Um.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Um.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||km.has(t)||Um.has(t)||(t.onLoaded(),km.add(t))}catch(e){d("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}Yl.remove(s),Kl.remove(s),XD(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var m=l[h];t.addRef&&t.addRef(),m.item.content=t,m.done(e)}l.length=0}});Zl.async(f)}(e,i,t)}))}}]);function PN(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case Xl.PATH:case Xl.UUID:case Xl.DIR:case Xl.SCENE:case Xl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=nu.create({input:e.input,options:i}),s=null;try{e.output=e.source=$l.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var IN=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},k(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();IN.MAX_DEAD_NUM=500,IN._deadPool=[];var ON=[];function DN(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=IN.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||Xl.UUID]=n[i]),"object"==typeof o)for(var l in Ie(o,t),o.preset&&Ie(o,tu[o.preset]),o){switch(l){case Xl.UUID:if("break"===function(){var e,t=a.uuid=su(o.uuid);if(!o.bundle){var n=Ql.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(Ql.has(o.bundle)){if(s=Ql.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!Ql.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Ql.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Xl.DIR:if(Ql.has(o.bundle)){Ql.get(o.bundle).config.getDirWithPath(o.dir,o.type,ON);for(var u,h=Q(ON);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}ON.length=0}a.recycle(),a=null;break;case Xl.PATH:if(Ql.has(o.bundle)){if(s=Ql.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Ql.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Ql.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case Xl.SCENE:if(!o.bundle){var f=Ql.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Ql.has(o.bundle)){if(s=Ql.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Ql.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Ql.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case Xl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||zi(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function NN(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var r=t[n];if(!r.url){var o,a,s=r.config;a=r.isNative?s&&s.nativeBase?s.base+s.nativeBase:i.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:i.assetManager.generalImportBase;var c=r.uuid,l="";r.info&&(l=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),o=".ttf"===r.ext?a+"/"+c.slice(0,2)+"/"+c+l+"/"+r.options.__nativeName__:a+"/"+c.slice(0,2)+"/"+c+l+r.ext,r.url=o}}return null}var MN=e("AssetManager",function(){function e(){this.pipeline=Zl.append(PN).append(wN),this.fetchPipeline=Jl.append(PN).append(EN),this.transformPipeline=$l.append(DN).append(NN),this.bundles=Ql,this.assets=ql,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Vm,this.force=!1,this.allowImageBitmap=!Ni.isMobile,this.utils=pu,this.downloader=fN,this.parser=CN,this.packManager=TN,this.cacheAsset=!0,this.cacheManager=null,this.presets=tu,this.factory=SN,this.preprocessPipe=PN,this.fetchPipe=EN,this.loadPipe=wN,this.references=null,this._releaseManager=kD,this._files=Yl,this._parsed=Kl,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return Ql.get(e)||null},t.removeBundle=function(e){e._destroy(),Ql.remove(e.name)},t.loadAny=function(e,t,n,i){var r=YD(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=nu.create({input:e,onProgress:a,onComplete:ZD(s),options:o});Zl.async(c)},t.preloadAny=function(e,t,n,i){var r=YD(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=nu.create({input:e,onProgress:a,onComplete:ZD(s),options:o});Jl.async(c)},t.loadRemote=function(e,t,n){var i=YD(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),o&&o(t,n)):SN.create(e,n,r.ext||zi(e),r,(function(e,t){o&&o(e,t)}))}))):ZD(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=YD(t,void 0,n),r=i.options,o=i.onComplete,a=ki(e);this.bundles.has(a)?ZD(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),o&&o(t,n)):SN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){kD.tryRelease(e,!0)},t.releaseUnusedAssets=function(){ql.forEach((function(e){kD.tryRelease(e)}))},t.releaseAll=function(){ql.forEach((function(e){kD.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},k(e,[{key:"main",get:function(){return Ql.get(eu.MAIN)||null}},{key:"resources",get:function(){return Ql.get(eu.RESOURCES)||null}}]),e}());MN.Pipeline=jl,MN.Task=nu,MN.Cache=Wl,MN.RequestItem=IN,MN.Bundle=JD,MN.BuiltinBundleName=eu;var LN=e("assetManager",i.assetManager=new MN);i.AssetManager=MN;var BN=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],FN=[".mp3",".ogg",".wav",".m4a"];function zN(){return!0}var UN={transformURL:function(e){var t=lu(e);if(!t)return e;var n=Ql.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===zi(e)&&(o=!0),o){var a=Gi(e),s=ki(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/,(function(e){return e+"."+i}));return e}},kN=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=KD}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];LN.loadAny(i,null,(function(e,n,i){i.content&&(BN.includes(i.ext)?a.push(i.content):FN.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof Cu)){var r=n,o=i[e].url;a.includes(r)?SN.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&SN.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),ql.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:zN,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return LN.assets.has(e)?{content:LN.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=zi(e);c&&!$D.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),$D.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=zi(t);i&&!$D.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),$D.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;$D.loadDir(e,o,a,(function(t,n){var i=[];t||(i=$D.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return ql.has(e)?ql.get(e):$D.get(e,t)},t.getResCount=function(){return ql.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Vm.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);fN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);CN.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=ql.get(n)),LN.releaseAsset(n)}else e&&("string"==typeof e&&(e=ql.get(e)),LN.releaseAsset(e))},t.releaseAsset=function(e){LN.releaseAsset(e)},t.releaseRes=function(e,t){$D.release(e,t)},t.releaseAll=function(){LN.releaseAll(),ql.clear()},t.removeItem=function(e){return!!ql.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=Vm.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},k(e,[{key:"onProgress",set:function(e){GD=e}},{key:"_cache",get:function(){return ql._map}},{key:"md5Pipe",get:function(){return UN}},{key:"downloader",get:function(){return fN}},{key:"loader",get:function(){return LN.parser}}]),e}()),GN=e("loader",new kN),HN=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,LN.init(e),e.rawAssets&&$D.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:eu.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){LN.loadAny(e,t)}}),VN=e("url",{});mn(VN,"url",[{name:"normalize",target:LN.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?fu({path:Hi(e.substr(10)),bundle:eu.RESOURCES,__isNative__:!0,ext:zi(e)}):""}}]),vn(HN,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),vn(GN,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),mn(i,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return GN}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return HN}},{name:"Pipeline",target:MN,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return VN}}]),vn(i,"cc",[{name:"LoadingItems",suggest:I(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),mn(nt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:fN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),mn(DD,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return LN.main?null===(t=LN.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),mn(uD,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return LN.main&&LN.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var WN,jN,XN,qN,YN,KN,QN,ZN,JN,$N,eM,tM,nM,iM,rM=kD._autoRelease;kD._autoRelease=function(e,t,n){rM.call(kD,e,t,n);for(var i=GN._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=ql.get(a);s&&kD.tryRelease(s)}}};var oM,aM,sM,cM,lM,uM,hM,_M,fM,pM,dM,mM,vM,gM,yM,SM,TM,EM,xM,AM,bM,CM,wM,RM,PM,IM,OM,DM,NM,MM,LM,BM,FM,zM,UM,kM,GM,HM,VM,WM,jM,XM,qM,YM,KM,QM,ZM,JM,$M,eL,tL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,pL,dL,mL,vL,gL=e("EventHandler",(WN=Zc("cc.ClickEvent"),jN=Pl(i.Node),XN=ml(),qN=ml(),YN=ml(),KN=ml(),WN((iM=function(){function e(){Z(this,"target",JN,this),Z(this,"component",$N,this),Z(this,"_componentId",eM,this),Z(this,"handler",tM,this),Z(this,"customEventData",nM,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(i.isValid(t)){this._genCompIdIfNeeded();var n=i.js._getClassById(this._componentId),r=t.getComponent(n);if(i.isValid(r)){var o=r[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),o.apply(r,e))}}},t._compName2Id=function(e){var t=i.js.getClassByName(e);return i.js._getClassId(t)},t._compId2Name=function(e){var t=i.js._getClassById(e);return i.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},k(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),JN=J((ZN=iM).prototype,"target",[il,jN,XN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$N=J(ZN.prototype,"component",[il,fl,qN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eM=J(ZN.prototype,"_componentId",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tM=J(ZN.prototype,"handler",[il,fl,YN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nM=J(ZN.prototype,"customEventData",[il,fl,KN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QN=ZN))||QN));i.Component.EventHandler=gL;var yL,SL,TL,EL,xL,AL,bL,CL,wL,RL,PL,IL=new Zn,OL=Ze(Wd),DL=Ze(Vd),NL=Ze(jd),ML=Ze(qd),LL=Ze(Xd),BL=Ze({SKYBOX:hm|eo.DEPTH_STENCIL,SOLID_COLOR:eo.ALL,DEPTH_ONLY:eo.DEPTH_STENCIL,DONT_CLEAR:eo.NONE}),FL=(oM=Zc("cc.Camera"),aM=_l(),sM=cl(),cM=El(),lM=ml(),uM=Pl(Sp.BitMask),hM=El(),_M=ml(),fM=Pl(BL),pM=El(),dM=ml(),mM=El(),vM=ml(),gM=El(),yM=ml(),SM=El(),TM=ml(),EM=Pl(OL),xM=El(),AM=ml(),bM=Pl(DL),CM=El(),wM=ml(),RM=El(),PM=ml(),IM=El(),OM=ml(),DM=El(),NM=ml(),MM=El(),LM=ml(),BM=Pl(NL),FM=El(),zM=ml(),UM=Pl(ML),kM=El(),GM=ml(),HM=Pl(LL),VM=El(),WM=ml(),jM=El(),XM=ml(),qM=Pl(hE),YM=El(),KM=ml(),yL=oM(QM=aM(QM=sM(QM=sl((vL=mL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_projection",JM,Y(t)),Z(t,"_priority",$M,Y(t)),Z(t,"_fov",eL,Y(t)),Z(t,"_fovAxis",tL,Y(t)),Z(t,"_orthoHeight",nL,Y(t)),Z(t,"_near",iL,Y(t)),Z(t,"_far",rL,Y(t)),Z(t,"_color",oL,Y(t)),Z(t,"_depth",aL,Y(t)),Z(t,"_stencil",sL,Y(t)),Z(t,"_clearFlags",cL,Y(t)),Z(t,"_rect",lL,Y(t)),Z(t,"_aperture",uL,Y(t)),Z(t,"_shutter",hL,Y(t)),Z(t,"_iso",_L,Y(t)),Z(t,"_screenScale",fL,Y(t)),Z(t,"_visibility",pL,Y(t)),Z(t,"_targetTexture",dL,Y(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}H(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=eg.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=ur.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new Zn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new Zn),!this._camera)return n;this.worldToScreen(e,IL);var r=t.getComponent("cc.UITransform"),o=yD.getVisibleSize(),a=IL.x-.5*this._camera.width,s=IL.y-.5*this._camera.height;return IL.x=a/i.view.getScaleX()+.5*o.width,IL.y=s/i.view.getScaleY()+.5*o.height,r&&r.convertToNodeSpaceAR(IL,n),n},n._createCamera=function(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=Nn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},k(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Vd.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=Nn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}}]),t}(qu),mL.ProjectionType=OL,mL.FOVAxis=DL,mL.ClearFlag=BL,mL.Aperture=NL,mL.Shutter=ML,mL.ISO=LL,mL.TARGET_TEXTURE_CHANGE="tex-change",JM=J((ZM=vL).prototype,"_projection",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OL.PERSPECTIVE}}),$M=J(ZM.prototype,"_priority",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eL=J(ZM.prototype,"_fov",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),tL=J(ZM.prototype,"_fovAxis",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DL.VERTICAL}}),nL=J(ZM.prototype,"_orthoHeight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),iL=J(ZM.prototype,"_near",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rL=J(ZM.prototype,"_far",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),oL=J(ZM.prototype,"_color",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn("#333333")}}),aL=J(ZM.prototype,"_depth",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sL=J(ZM.prototype,"_stencil",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cL=J(ZM.prototype,"_clearFlags",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BL.SOLID_COLOR}}),lL=J(ZM.prototype,"_rect",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bi(0,0,1,1)}}),uL=J(ZM.prototype,"_aperture",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NL.F16_0}}),hL=J(ZM.prototype,"_shutter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ML.D125}}),_L=J(ZM.prototype,"_iso",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LL.ISO100}}),fL=J(ZM.prototype,"_screenScale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pL=J(ZM.prototype,"_visibility",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd}}),dL=J(ZM.prototype,"_targetTexture",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J(ZM.prototype,"priority",[cM,lM],Object.getOwnPropertyDescriptor(ZM.prototype,"priority"),ZM.prototype),J(ZM.prototype,"visibility",[uM,hM,_M],Object.getOwnPropertyDescriptor(ZM.prototype,"visibility"),ZM.prototype),J(ZM.prototype,"clearFlags",[fM,pM,dM],Object.getOwnPropertyDescriptor(ZM.prototype,"clearFlags"),ZM.prototype),J(ZM.prototype,"clearColor",[mM,vM],Object.getOwnPropertyDescriptor(ZM.prototype,"clearColor"),ZM.prototype),J(ZM.prototype,"clearDepth",[gM,yM],Object.getOwnPropertyDescriptor(ZM.prototype,"clearDepth"),ZM.prototype),J(ZM.prototype,"clearStencil",[SM,TM],Object.getOwnPropertyDescriptor(ZM.prototype,"clearStencil"),ZM.prototype),J(ZM.prototype,"projection",[EM,xM,AM],Object.getOwnPropertyDescriptor(ZM.prototype,"projection"),ZM.prototype),J(ZM.prototype,"fovAxis",[bM,CM,wM],Object.getOwnPropertyDescriptor(ZM.prototype,"fovAxis"),ZM.prototype),J(ZM.prototype,"fov",[RM,PM],Object.getOwnPropertyDescriptor(ZM.prototype,"fov"),ZM.prototype),J(ZM.prototype,"orthoHeight",[IM,OM],Object.getOwnPropertyDescriptor(ZM.prototype,"orthoHeight"),ZM.prototype),J(ZM.prototype,"near",[DM,NM],Object.getOwnPropertyDescriptor(ZM.prototype,"near"),ZM.prototype),J(ZM.prototype,"far",[MM,LM],Object.getOwnPropertyDescriptor(ZM.prototype,"far"),ZM.prototype),J(ZM.prototype,"aperture",[BM,FM,zM],Object.getOwnPropertyDescriptor(ZM.prototype,"aperture"),ZM.prototype),J(ZM.prototype,"shutter",[UM,kM,GM],Object.getOwnPropertyDescriptor(ZM.prototype,"shutter"),ZM.prototype),J(ZM.prototype,"iso",[HM,VM,WM],Object.getOwnPropertyDescriptor(ZM.prototype,"iso"),ZM.prototype),J(ZM.prototype,"rect",[jM,XM],Object.getOwnPropertyDescriptor(ZM.prototype,"rect"),ZM.prototype),J(ZM.prototype,"targetTexture",[qM,YM,KM],Object.getOwnPropertyDescriptor(ZM.prototype,"targetTexture"),ZM.prototype),QM=ZM))||QM)||QM)||QM)||QM,e({Camera:yL,CameraComponent:yL}),yL);i.Camera=FL;var zL,UL,kL,GL,HL,VL,WL,jL,XL={parent:null,owner:null,subModelIdx:0},qL=e("RenderableComponent",(SL=Zc("cc.RenderableComponent"),TL=Pl([Ag]),EL=Pl(Ag),xL=El(),AL=dl(),SL((PL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_materials",wL,Y(t)),Z(t,"_visFlags",RL,Y(t)),t._materialInstances=[],t._models=[],t}H(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof kg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){XL.parent=this._materials[e],XL.owner=this,XL.subModelIdx=e;var t=new kg(XL);XL.parent=null,XL.owner=null,XL.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){A(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},k(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(qu),wL=J((CL=PL).prototype,"_materials",[TL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RL=J(CL.prototype,"_visFlags",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sp.Enum.NONE}}),J(CL.prototype,"sharedMaterials",[EL,xL,AL],Object.getOwnPropertyDescriptor(CL.prototype,"sharedMaterials"),CL.prototype),bL=CL))||bL));function YL(e){return"string"==typeof e||"number"==typeof e}i.RenderableComponent=qL,mn(FL,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),mn(FL.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),i.CameraComponent=FL,Ke.setClassAlias(FL,"cc.CameraComponent");var KL,QL,ZL,JL,$L,eB,tB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,_B,fB,pB,dB,mB,vB=Zc("cc.animation.HierarchyPath")((GL=function(){function e(e){Z(this,"path",kL,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getChildByPath(this.path)||(A(3926,e.name,this.path),null):(A(3925),null)},e}(),kL=J((UL=GL).prototype,"path",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zL=UL))||zL,gB=Zc("cc.animation.ComponentPath")((jL=function(){function e(e){Z(this,"component",WL,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getComponent(this.component)||(A(3928,e.name,this.component),null):(A(3927),null)},e}(),WL=J((VL=jL).prototype,"component",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HL=VL))||HL,yB=Zc("cc.animation.UniformProxyFactory")((eB=function(){function e(e,t){Z(this,"passIndex",ZL,this),Z(this,"uniformName",JL,this),Z(this,"channelIndex",$L,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');var r=Xv.getPropertyTypeFromHandle(n);if(r===hv.BUFFER){var o=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,xr.FLOAT);if(!o)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=Q(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=Q(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(o,e)}}:{set:function(e){t.setUniform(o,e)}}}if(r===hv.TEXTURE){var a=Xv.getBindingFromHandle(n),s=t.properties[this.uniformName],c=s&&s.value?s.value+"-texture":Cv(s.type),l=Gv.get(c);return l||(p("Illegal texture default value: "+c+"."),l=Gv.get("default-texture")),{set:function(e){e||(e=l);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(a,n),e instanceof Fm&&t.bindSampler(a,Lm.getSampler(i.game._gfxDevice,e.getSamplerHash())))}}}throw new Error("Animations are not available for uniforms with property type "+r+".")},e}(),ZL=J((QL=eB).prototype,"passIndex",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JL=J(QL.prototype,"uniformName",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$L=J(QL.prototype,"channelIndex",[Cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),KL=QL))||KL,SB=Zc("cc.animation.MorphWeightValueProxy")((oB=function(){function e(){Z(this,"subMeshIndex",iB,this),Z(this,"shapeIndex",rB,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),iB=J((nB=oB).prototype,"subMeshIndex",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rB=J(nB.prototype,"shapeIndex",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tB=nB))||tB,TB=Zc("cc.animation.MorphWeightsValueProxy")((lB=function(){function e(){Z(this,"subMeshIndex",cB,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),cB=J((sB=lB).prototype,"subMeshIndex",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aB=sB))||aB,EB=Zc("cc.animation.MorphWeightsAllValueProxy")(uB=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||uB;function xB(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=Zc(e)((l=function(){function e(e,n,i){Z(this,"dataPoint",a,this),Z(this,"inTangent",s,this),Z(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},e}(),a=J((o=l).prototype,"dataPoint",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=J(o.prototype,"inTangent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=J(o.prototype,"outTangent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===ri){var p=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=p.call(this,e,t,n);return ri.normalize(i,i),i}}return f}var AB=e("CubicSplineVec2Value",xB("cc.CubicSplineVec2Value",mi,mi.multiplyScalar,mi.scaleAndAdd));i.CubicSplineVec2Value=AB;var bB=e("CubicSplineVec3Value",xB("cc.CubicSplineVec3Value",Zn,Zn.multiplyScalar,Zn.scaleAndAdd));i.CubicSplineVec3Value=bB;var CB=e("CubicSplineVec4Value",xB("cc.CubicSplineVec4Value",Si,Si.multiplyScalar,Si.scaleAndAdd));i.CubicSplineVec4Value=CB;var wB=e("CubicSplineQuatValue",xB("cc.CubicSplineQuatValue",ri,ri.multiplyScalar,ri.scaleAndAdd));i.CubicSplineQuatValue=wB;var RB=e("CubicSplineNumberValue",Zc("cc.CubicSplineNumberValue")((mB=function(){function e(e,t,n){Z(this,"dataPoint",fB,this),Z(this,"inTangent",pB,this),Z(this,"outTangent",dB,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),fB=J((_B=mB).prototype,"dataPoint",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pB=J(_B.prototype,"inTangent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dB=J(_B.prototype,"outTangent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hB=_B))||hB);i.CubicSplineNumberValue=RB;var PB,IB,OB,DB,NB,MB,LB,BB,FB,zB,UB,kB,GB,HB,VB,WB,jB,XB,qB,YB,KB,QB,ZB,JB,$B,eF,tF,nF=Symbol("CreateEval"),iF=Symbol("NormalizedFollow"),rF=Symbol("ConvertAsTrsPath"),oF=Symbol("TrackBinding"),aF=Zc("cc.animation.TrackPath")((DB=function(){function e(){Z(this,"_paths",OB,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new vB(e)),this},t.toComponent=function(e){var t=new gB("string"==typeof e?e:Ke.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof vB},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof gB},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[iF](e,t,n)},t[rF]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof vB))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[iF]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(YL(a)){if(!(a in r))return A(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},k(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),OB=J((IB=DB).prototype,"_paths",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PB=IB))||PB,sF=Zc("cc.animation.TrackBinding")(NB=al((FB=function(){function e(){Z(this,"path",LB,this),Z(this,"proxy",BB,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[rF]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[iF](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return C(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[iF](e,0,o-1);return null===f?null:t&&f instanceof qC&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}},e}(),LB=J((MB=FB).prototype,"path",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new aF}}),BB=J(MB.prototype,"proxy",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NB=MB))||NB)||NB,cF=Zc("cc.animation.Track")((GB=function(){function e(){Z(this,"_binding",kB,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=Q(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},t[nF]=function(){throw new Error("No Impl")},k(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:oF,get:function(){return this._binding}}]),e}(),kB=J((UB=GB).prototype,"_binding",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sF}}),zB=UB))||zB,lF=Zc("cc.animation.Channel")((jB=function(){function e(e){this.name="",Z(this,"_curve",WB,this),this._curve=e}return k(e,[{key:"curve",get:function(){return this._curve}}]),e}(),WB=J((VB=jB).prototype,"_curve",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),HB=VB))||HB,uF=Zc("cc.animation.SingleChannelTrack")((KB=function(e){function t(){var t;return Z(t=e.call(this)||this,"_channel",YB,Y(t)),t._channel=new lF(t.createCurve()),t}H(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[nF]=function(){var e=this._channel.curve;return new hF(e)},k(t,[{key:"channel",get:function(){return this._channel}}]),t}(cF),YB=J((qB=KB).prototype,"_channel",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XB=qB))||XB,hF=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),_F=Zc("cc.animation.RealTrack")(QB=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t.prototype.createCurve=function(){return new ef},t}(uF))||QB;function fF(e){return 0===e.keyFramesCount?void 0:e}var pF,dF,mF,vF,gF,yF,SF,TF,EF,xF,AF=["X","Y","Z","W"],bF=Zc("cc.animation.VectorTrack")((tF=function(e){function t(){var t;Z(t=e.call(this)||this,"_channels",$B,Y(t)),Z(t,"_nComponents",eF,Y(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new lF(new ef);i.name=AF[n],t._channels[n]=i}return t}H(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[nF]=function(){switch(this._nComponents){default:case 2:return new CF(fF(this._channels[0].curve),fF(this._channels[1].curve));case 3:return new wF(fF(this._channels[0].curve),fF(this._channels[1].curve),fF(this._channels[2].curve));case 4:return new RF(fF(this._channels[0].curve),fF(this._channels[1].curve),fF(this._channels[2].curve),fF(this._channels[3].curve))}},k(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(cF),$B=J((JB=tF).prototype,"_channels",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eF=J(JB.prototype,"_nComponents",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),ZB=JB))||ZB,CF=function(){function e(e,t){this._result=new mi,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||mi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),wF=function(){function e(e,t,n){this._result=new Zn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||Zn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),RF=function(){function e(e,t,n,i){this._result=new Si,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Si.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),PF=Zc("cc.animation.QuatTrack")(pF=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.createCurve=function(){return new Gf},n[nF]=function(){return new IF(this.channels()[0].curve)},t}(uF))||pF,IF=function(){function e(e){this._result=new ri,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),OF=["Red","Green","Blue","Alpha"],DF=Zc("cc.animation.ColorTrack")((gF=function(e){function t(){var t;Z(t=e.call(this)||this,"_channels",vF,Y(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new lF(new ef);i.name=OF[n],t._channels[n]=i}return t}H(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[nF]=function(){return new NF(fF(this._channels[0].curve),fF(this._channels[1].curve),fF(this._channels[2].curve),fF(this._channels[3].curve))},t}(cF),vF=J((mF=gF).prototype,"_channels",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dF=mF))||dF,NF=function(){function e(e,t,n,i){this._result=new Kn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Kn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),MF=["Width","Height"],LF=Zc("cc.animation.SizeTrack")((EF=function(e){function t(){var t;Z(t=e.call(this)||this,"_channels",TF,Y(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new lF(new ef);i.name=MF[n],t._channels[n]=i}return t}H(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[nF]=function(){return new BF(fF(this._channels[0].curve),fF(this._channels[1].curve))},t}(cF),TF=J((SF=EF).prototype,"_channels",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yF=SF))||yF,BF=function(){function e(e,t){this._result=new xi,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),FF=Zc("cc.animation.ObjectTrack")(xF=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t.prototype.createCurve=function(){return new np},t}(uF))||xF;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:yB,MorphWeightValueProxy:SB,MorphWeightsValueProxy:TB,MorphWeightsAllValueProxy:EB,Track:cF,TrackPath:aF,RealTrack:_F,VectorTrack:bF,QuatTrack:PF,ColorTrack:DF,SizeTrack:LF,ObjectTrack:FF,isPropertyPath:YL,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:vB,ComponentPath:gB,CubicSplineVec2Value:AB,CubicSplineVec3Value:bB,CubicSplineVec4Value:CB,CubicSplineQuatValue:wB,CubicSplineNumberValue:RB}));var zF=Symbol("BakeNodeCurves"),UF=function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&i.director.root.dataPoolManager.releaseAnimationClip(t);var r=Math.ceil(t.sample*t.duration)+1,o=t.sample;n=t[zF](0,o,r),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}();UF.pool=new Map;var kF=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?WF:Hc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());i.RatioSampler=kF;var GF=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=$F(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=VF(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function HF(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function VF(e,t){if("string"==typeof t){var n=k_[t];n?e=n(e):C(3906,t)}else Array.isArray(t)&&(e=Ff(t,e));return e}function WF(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}GF.Linear=null,i.AnimCurve=GF,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),i.sampleAnimationCurve=HF;var jF,XF,qF,YF,KF,QF,ZF,JF,$F=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return Dn;if("object"==typeof t&&t.constructor){if(t instanceof ri)return n=new ri,function(e,t,i){return ri.slerp(n,e,t,i)};if(t instanceof tt)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return Dn;if("function"==typeof t.lerp)return e}var n}}}(),ez=Zc("cc.animation.UntypedTrackChannel")((YF=function(e){function t(){var t;return Z(t=e.call(this,new ef)||this,"property",qF,Y(t)),t}return H(t,e),t}(lF),qF=J((XF=YF).prototype,"property",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jF=XF))||jF,tz=Zc("cc.animation.UntypedTrack")((JF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_channels",ZF,Y(t)),t}H(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[nF]=function(e){var t=this;if(!e.getValue)throw new Error(I(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(I(3931));case i instanceof mi:return new CF(n("x"),n("y"));case i instanceof Zn:return new wF(n("x"),n("y"),n("z"));case i instanceof Si:return new RF(n("x"),n("y"),n("z"),n("w"));case i instanceof Kn:return new NF(n("r"),n("g"),n("b"),n("a"));case i instanceof xi:return new BF(n("width"),n("height"))}},n.addChannel=function(e){var t=new ez;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new bF;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new DF,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return n("r",_),n("g",f),n("b",p),n("a",d),n("x",_),n("y",f),n("z",p),n("w",d),u;case"size":}return null},t}(cF),ZF=J((QF=JF).prototype,"_channels",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KF=QF))||KF,nz=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new aF,o=Q(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof vB?r.toHierarchy(a.path):a instanceof gB?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new tz;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new rz(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return A(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return A(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void A(3934);var e;if(p)e=p;else{var n=new _F;f(n),t.push(n),e=n.channel.curve}var i=h?Bl.LINEAR:Bl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case iz(c,mi):case iz(c,Zn):case iz(c,Si):var r=u instanceof mi?2:u instanceof Zn?3:4,o=new bF;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Bl.LINEAR:Bl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),d.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(d)}return void t.push(o);case iz(c,ri):var S=new PF;f(S);var T=h?If.SLERP:If.CONSTANT;return S.channel.curve.assignSorted(l,c.map((function(e){return{value:ri.clone(e),interpolationMode:T}}))),_.convertQuatCurve(S.channel.curve),void t.push(S);case iz(c,Kn):var E=new DF;f(E);var x=E.channels(),b=x[0].curve,C=x[1].curve,w=x[2].curve,R=x[3].curve,P=h?Bl.LINEAR:Bl.CONSTANT,I=function(e){return{value:e,interpolationMode:P}};return b.assignSorted(l,c.map((function(e){return I(e.r)}))),_.convert(b),C.assignSorted(l,c.map((function(e){return I(e.g)}))),_.convert(C),w.assignSorted(l,c.map((function(e){return I(e.b)}))),_.convert(w),R.assignSorted(l,c.map((function(e){return I(e.a)}))),_.convert(R),void t.push(E);case iz(c,xi):var O=new LF;f(O);var D=O.channels(),N=D[0].curve,M=D[1].curve,L=h?Bl.LINEAR:Bl.CONSTANT,B=function(e){return{value:e,interpolationMode:L}};return N.assignSorted(l,c.map((function(e){return B(e.width)}))),_.convert(N),M.assignSorted(l,c.map((function(e){return B(e.height)}))),_.convert(M),void t.push(O);case iz(c,RB):var F=new _F;f(F);var z=h?Bl.CUBIC:Bl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case iz(c,AB):case iz(c,bB):case iz(c,CB):var U=u instanceof AB?2:u instanceof bB?3:4,k=new bF;f(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],W=G[2],j=G[3],X=h?Bl.LINEAR:Bl.CONSTANT,q=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:X}};switch(U){case 4:j.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:W.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(k);case c.every((function(e){return e instanceof wB})):A(3935)}var Y=new FF;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=Q(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new kF(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new GF(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},k(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function iz(e,t){return e.every((function(e){return e instanceof t}))}var rz=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,S,T,E,x=this._easingMethods;if(x){var A=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(x)&&x.length;for(var b=A-1,C=0;C<b;++C){var w=x[C];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(C),i=e.getKeyframeValue(C),r=e.getKeyframeTime(C+1),o=e.getKeyframeValue(C+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,S=void 0,T=void 0,E=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),S=Math.sqrt(p*p+d*d)*g,T=v/m,E=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Bl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===zl.NONE?zl.RIGHT:a===zl.LEFT?zl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=S,o.tangentWeightMode=function(e){return e===zl.NONE?zl.LEFT:e===zl.RIGHT?zl.BOTH:e}(o.tangentWeightMode),o.leftTangent=T,o.leftTangentWeight=E):oz(w,e,C))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():az(o,e,r))}}}},k(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function oz(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=Bz[e];r===U_.CONSTANT?i.interpolationMode=Bl.CONSTANT:(i.interpolationMode=Bl.LINEAR,i.easingMethod=r)}function az(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=Bz[e];i.easingMethod=r}var sz,cz,lz,uz,hz,_z,fz,pz,dz,mz,vz,gz,yz,Sz,Tz,Ez,xz,Az,bz,Cz,wz,Rz,Pz,Iz,Oz,Dz,Nz,Mz,Lz,Bz={constant:U_.CONSTANT,linear:U_.LINEAR,quadIn:U_.QUAD_IN,quadOut:U_.QUAD_OUT,quadInOut:U_.QUAD_IN_OUT,quadOutIn:U_.QUAD_OUT_IN,cubicIn:U_.CUBIC_IN,cubicOut:U_.CUBIC_OUT,cubicInOut:U_.CUBIC_IN_OUT,cubicOutIn:U_.CUBIC_OUT_IN,quartIn:U_.QUART_IN,quartOut:U_.QUART_OUT,quartInOut:U_.QUART_IN_OUT,quartOutIn:U_.QUART_OUT_IN,quintIn:U_.QUINT_IN,quintOut:U_.QUINT_OUT,quintInOut:U_.QUINT_IN_OUT,quintOutIn:U_.QUINT_OUT_IN,sineIn:U_.SINE_IN,sineOut:U_.SINE_OUT,sineInOut:U_.SINE_IN_OUT,sineOutIn:U_.SINE_OUT_IN,expoIn:U_.EXPO_IN,expoOut:U_.EXPO_OUT,expoInOut:U_.EXPO_IN_OUT,expoOutIn:U_.EXPO_OUT_IN,circIn:U_.CIRC_IN,circOut:U_.CIRC_OUT,circInOut:U_.CIRC_IN_OUT,circOutIn:U_.CIRC_OUT_IN,elasticIn:U_.ELASTIC_IN,elasticOut:U_.ELASTIC_OUT,elasticInOut:U_.ELASTIC_IN_OUT,elasticOutIn:U_.ELASTIC_OUT_IN,backIn:U_.BACK_IN,backOut:U_.BACK_OUT,backInOut:U_.BACK_IN_OUT,backOutIn:U_.BACK_OUT_IN,bounceIn:U_.BOUNCE_IN,bounceOut:U_.BOUNCE_OUT,bounceInOut:U_.BOUNCE_IN_OUT,bounceOutIn:U_.BOUNCE_OUT_IN,smooth:U_.SMOOTH,fade:U_.FADE};function Fz(){throw new Error("split() only valid in Editor.")}Zc("cc.animation.ExoticAnimation")((lz=function(){function e(){Z(this,"_nodeAnimations",cz,this)}var t=e.prototype;return t.createEvaluator=function(e){return new qz(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new zz(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return Fz()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),cz=J((sz=lz).prototype,"_nodeAnimations",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sz));var zz=Zc("cc.animation.ExoticNodeAnimation")((mz=function(){function e(e){Z(this,"_path",_z,this),Z(this,"_position",fz,this),Z(this,"_rotation",pz,this),Z(this,"_scale",dz,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new Wz(e,new Hz(t))},t.createRotation=function(e,t){this._rotation=new Wz(e,new Vz(t))},t.createScale=function(e,t){this._scale=new Wz(e,new Hz(t))},t.createEvaluator=function(e){return new Yz(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return Fz()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},k(e,[{key:"path",get:function(){return this._path}}]),e}(),_z=J((hz=mz).prototype,"_path",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fz=J(hz.prototype,"_position",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pz=J(hz.prototype,"_rotation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dz=J(hz.prototype,"_scale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uz=hz))||uz;function Uz(e){return e.toPrecision(2)}function kz(e){return e.map(Uz).join(" ")}var Gz=Zc("cc.animation.ExoticVectorLikeTrackValues")((Tz=function(){function e(e){Z(this,"_values",yz,this),Z(this,"_isQuantized",Sz,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=Qz[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new hU(Zz(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():kz(t))},k(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:Zz(this._values)}}]),e}(),yz=J((gz=Tz).prototype,"_values",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Sz=J(gz.prototype,"_isQuantized",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vz=gz))||vz,Hz=Zc("cc.animation.ExoticVec3TrackValues")(Ez=function(e){function t(){return e.apply(this,arguments)||this}H(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?pU(n,e,t):Zn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(pU(a,e,i),pU(a,t,r)):(Zn.fromArray(i,a,3*e),Zn.fromArray(r,a,3*t)),Zn.lerp(o,i,r,n)},t}(Gz))||Ez,Vz=Zc("cc.animation.ExoticQuatTrackValues")(xz=function(e){function t(){return e.apply(this,arguments)||this}H(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?dU(n,e,t):ri.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(dU(a,e,i),dU(a,t,r)):(ri.fromArray(i,a,4*e),ri.fromArray(r,a,4*t)),ri.slerp(o,i,r,n)},t}(Gz))||xz,Wz=Zc("cc.animation.ExoticTrack")((Rz=function(){function e(e,t){Z(this,"times",Cz,this),Z(this,"values",wz,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+kz(e)+"; values: "+t.toHashString()},e}(),Cz=J((bz=Rz).prototype,"times",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wz=J(bz.prototype,"values",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Az=bz))||Az;function jz(e,t){e.length,e.length;var n=0,i=0,r=Hc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=In(t,r,o),s=In(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=jz(e,t),o=r.index,a=r.ratio,s=jz(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},k(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var Xz,qz=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),Yz=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=fU(t.times,t.values,Zn,e,"position",r)),n&&(this._rotation=fU(n.times,n.values,ri,e,"rotation",r)),i&&(this._scale=fU(i.times,i.values,Zn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),Kz=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=Hc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),Qz={uint8:Uint8Array,uint16:Uint16Array};function Zz(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return Xz.FLOAT_32;case 8:return Xz.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(Xz||(Xz={}));var Jz,$z,eU,tU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU=Zc("cc.animation.QuantizedFloatArray")((Lz=function(){function e(e,t,n,i){void 0===i&&(i=0),Z(this,"originalPrecision",Oz,this),Z(this,"min",Dz,this),Z(this,"extent",Nz,this),Z(this,"values",Mz,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+Uz(t)+" "+Uz(n)+" "+i.join(" ")},k(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),Oz=J((Iz=Lz).prototype,"originalPrecision",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Dz=J(Iz.prototype,"min",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nz=J(Iz.prototype,"extent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mz=J(Iz.prototype,"values",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pz=Iz))||Pz;function _U(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function fU(e,t,n,i,r,o){var a=new sF;a.path=(new aF).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new Kz(e,t,n)}:null}function pU(e,t,n){Zn.set(n,_U(e,3*t+0),_U(e,3*t+1),_U(e,3*t+2))}function dU(e,t,n){ri.set(n,_U(e,4*t+0),_U(e,4*t+1),_U(e,4*t+2),_U(e,4*t+3))}var mU=Symbol("SearchForRootBonePath"),vU=Symbol("ExoticAnimation"),gU=e("AnimationClip",Zc("cc.AnimationClip")((uU=lU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"sample",eU,Y(t)),Z(t,"speed",tU,Y(t)),Z(t,"wrapMode",nU,Y(t)),Z(t,"enableTrsBlending",iU,Y(t)),Z(t,"_duration",rU,Y(t)),Z(t,"_hash",oU,Y(t)),t.frameRate=0,Z(t,"_tracks",aU,Y(t)),Z(t,"_exoticAnimation",sU,Y(t)),t._legacyData=void 0,t._legacyDataDirty=!1,Z(t,"_events",cU,Y(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}H(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new FF;return o.path=(new aF).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new CU(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=i.director.root)||void 0===t?void 0:t.dataPoolManager)&&i.director.root.dataPoolManager.releaseAnimationClip(this),UF.destroy(this),e.prototype.destroy.call(this)},n[zF]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new _i}))};var c=r.reduce((function(e,t){return e[t]=new TU,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return bU(n,t.property)}}),void 0),d=0;d<n;++d){var m=e+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];_i.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var S=r[y];c[S].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof tz){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)Ye.remove(i,n[l]);i.push.apply(i,t)},n[mU]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)){var h=t(u[oF]);if(h){var _=u[nF](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new yU(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof qC){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new SU,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[oF].parseTrsPath();if(h&&h.node===i){n.push(u);var _=bU(o,h.property);if(_){var f=u[nF](_);a.push({binding:_,trackEval:f})}}}return new xU(r,this._duration,o,a)}A(3924)}else A(3923)}else C(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[oF].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new nz(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][oF].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},k(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=xa(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:vU,get:function(){return this._exoticAnimation}},{key:vU,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Cu),lU.WrapMode=Bc,eU=J(($z=uU).prototype,"sample",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),tU=J($z.prototype,"speed",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nU=J($z.prototype,"wrapMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bc.Normal}}),iU=J($z.prototype,"enableTrsBlending",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rU=J($z.prototype,"_duration",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oU=J($z.prototype,"_hash",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aU=J($z.prototype,"_tracks",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sU=J($z.prototype,"_exoticAnimation",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cU=J($z.prototype,"_events",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jz=$z))||Jz);i.AnimationClip=gU;var yU=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),SU=function(){function e(){this.position=new Zn,this.scale=new Zn(1,1,1),this.rotation=new ri,this.eulerAngles=new Zn}return e.prototype.getTransform=function(e){_i.fromRTS(e,this.rotation,this.position,this.scale)},e}(),TU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new _i,t}return H(t,e),t.prototype.invalidate=function(){this._dirty=!0},k(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,_i.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&_i.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(SU),EU=new _i,xU=function(){function e(e,t,n,i){this._initialTransformCache=new _i,this._clipEndTransformCache=new _i,this._startTransformCache=new _i,this._endTransformCache=new _i,this._motionTransformCache=new _i,this._translationMotionCache=new Zn,this._rotationMotionCache=new ri,this._scaleMotionCache=new Zn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;_i.toRTS(n,r,i,o),Zn.add(i,i,a.position),a.setPosition(i),ri.multiply(r,r,a.rotation),a.setRotation(r),Zn.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);AU(n,o,a)}else{_i.identity(n);var s=function(e,t){AU(EU,e,t),_i.multiply(n,n,EU)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),AU(EU,h,_);for(var p=0;p<l;++p)_i.multiply(n,n,EU);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function AU(e,t,n){_i.invert(e,t),_i.multiply(e,n,e)}function bU(e,t){switch(t){default:return;case"position":return{setValue:function(t){Zn.copy(e.position,t)}};case"rotation":return{setValue:function(t){ri.copy(e.rotation,t)}};case"scale":return{setValue:function(t){Zn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){Zn.copy(e.eulerAngles,t)}}}}var CU=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=RU(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=RU(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=wU(n),s=wU(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&Lc.PingPong)===Lc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&Lc.PingPong)===Lc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?i.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function wU(e){return e-(0|e)==0&&(e-=1),0|e}function RU(e,t){return Hc(t,e)}var PU,IU=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(I(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},k(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),OU=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(PU||(PU={})),et(PU);var DU=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Bc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Gc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||v("Clip "+t.name+" has zero duration."),i}H(t,e);var n=t.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var t=this._clip;if(this.duration=t.duration,this._invDuration=1/this.duration,this.speed=t.speed,this.wrapMode=t.wrapMode,this.frameRate=t.sample,this._playbackRange.min=0,this._playbackRange.max=t.duration,this._playbackDuration=t.duration,(this.wrapMode&Lc.Loop)===Lc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var n,r,o,a=null!==(n=null===(r=i.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==n?n:null;a&&(this._poseOutput=new OU(a)),this._clipEval=t.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=t.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(PU.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(PU.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(PU.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(PU.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Gc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(PU.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(PU.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(PU.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&Lc.PingPong)===Lc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&Lc.Reverse)===Lc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new Gc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&Lc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){i.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){i.director.getAnimationManager().removeAnimation(this)},k(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&Lc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Lc.ShouldWrap,n=(this.wrapMode&Lc.Reverse)===Lc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(IU));i.AnimationState=DU;var NU,MU,LU,BU,FU,zU,UU,kU,GU,HU,VU,WU,jU,XU,qU,YU,KU,QU=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:i.director.getAnimationManager(),n}H(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:On(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),oe(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(IU),ZU=function(t){return e({AnimationComponent:t,Animation:t}),t}((NU=Zc("cc.Animation"),MU=_l(),LU=$c(99),BU=cl(),FU=Pl([gU]),zU=ml(),UU=Pl(gU),kU=ml(),GU=ml(),HU=Pl([gU]),NU(VU=MU(VU=LU(VU=sl(VU=BU((KU=YU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",jU,Y(t)),t._crossFade=new QU,t._nameToState=Se(!0),Z(t,"_clips",XU,Y(t)),Z(t,"_defaultClip",qU,Y(t)),t._hasBeenPlayed=!1,t}H(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Se(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,t))},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return ae(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void A(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void A(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===PU.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===PU.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===PU.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new DU(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(PU.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n._getStateByNameOrDefaultClip=function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}return this._nameToState[e]||null},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];JU(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(PU.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(PU.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},k(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=Q(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=Q(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return JU(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return JU(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(cn(qu)),YU.EventType=PU,J((WU=KU).prototype,"clips",[FU,zU],Object.getOwnPropertyDescriptor(WU.prototype,"clips"),WU.prototype),J(WU.prototype,"defaultClip",[UU,kU],Object.getOwnPropertyDescriptor(WU.prototype,"defaultClip"),WU.prototype),jU=J(WU.prototype,"playOnLoad",[il,GU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XU=J(WU.prototype,"_clips",[HU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qU=J(WU.prototype,"_defaultClip",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VU=WU))||VU)||VU)||VU)||VU)||VU));function JU(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}mn(ZU.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return ZU.prototype.removeState.call(this,e.name)}}]),i.AnimationComponent=ZU,Ke.setClassAlias(ZU,"cc.AnimationComponent");var $U,ek,tk,nk=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new ik(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new sk,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),ik=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},k(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),rk=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},ok=function(e){function t(){return e.call(this,new Zn)||this}H(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?Zn.copy(n,e):Zn.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,Zn.zero(this.blendedValue)},t}(rk),ak=function(e){function t(){return e.call(this,new ri)||this}H(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)ri.copy(n,e);else{var r=t/(i+t);ri.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,ri.identity(this.blendedValue)},t}(rk),sk=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new ok;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new ak}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},k(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),ck=[],lk=new Map;function uk(e,t){for(var n=0,i=_i.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,ck[n++]=e,e=e.parent}for(;n>0;){e=ck[--n],ck[n]=null;var r=e.node;_i.fromRTS(e.local,r.rotation,r.position,r.scale),i=_i.multiply(e.world,i,e.local)}return i}function hk(e){for(var t=lk.get(e.uuid)||null;t;)lk.delete(t.node.uuid),t=t.parent}var _k=e("AnimationManager",Zc((tk=ek=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new ne([]),t._crossFades=new ne([]),t._delayEvents=[],t._blendStateBuffer=new nk,t._sockets=[],t}H(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):C(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,r=this._sockets,o=n.array;for(n.i=0;n.i<o.length;++n.i)o[n.i].update(e);var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var c=s[a.i];c.isMotionless||c.update(e)}this._blendStateBuffer.apply();for(var l=i.director.getTotalFrames(),u=0,h=r.length;u<h;u++){var _=r[u],f=_.target,p=_.transform;f.matrix=uk(p,l)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):C(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&function(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(lk.has(o)){i=lk.get(o);break}i={node:e,local:new _i,world:new _i,stamp:-1,parent:null},lk.set(o,i),ck[r++]=i,e=e.parent,i=null}for(;r>0;)n=ck[--r],ck[r]=null,n.parent=i,i=n;return i}(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){hk(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},k(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(ED),ek.ID="animation",$U=tk))||$U);DD.on(OD.EVENT_INIT,(function(){var e=new _k;DD.registerSystem(_k.ID,e,ED.Priority.HIGH)})),i.AnimationManager=_k;var fk,pk,dk,mk,vk=new _i;i.easing=k_;var gk=e("HierachyModifier",Zc("cc.HierachyModifier")(fk=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(vB))||fk);i.HierachyModifier=gk;var yk=e("ComponentModifier",Zc("cc.ComponentModifier")(pk=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(gB))||pk);i.ComponentModifier=yk;var Sk=e("CurveValueAdapter",Zc("cc.CurveValueAdapter")(dk=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||dk);i.CurveValueAdapter=Sk;var Tk=e("UniformCurveValueAdapter",Zc("cc.UniformCurveValueAdapter")(mk=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(yB))||mk);function Ek(e){return"string"==typeof e}function xk(e){return"number"==typeof e}function Ak(e,t){return e instanceof t}i.UniformCurveValueAdapter=Tk,i.isPropertyModifier=Ek,i.isElementModifier=xk,i.isCustomTargetModifier=Ak,i.math=Pi,i.geometry=gp;var bk=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());i.NodePool=bk,i.renderer=dy;var Ck,wk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&sa){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ca&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},k(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(ba);function Rk(e,t){switch(e){case Tr.R8:return t.UNSIGNED_BYTE;case Tr.R8SN:return t.BYTE;case Tr.R8UI:return t.UNSIGNED_BYTE;case Tr.R8I:return t.BYTE;case Tr.R16F:return Ck.HALF_FLOAT_OES;case Tr.R16UI:return t.UNSIGNED_SHORT;case Tr.R16I:return t.SHORT;case Tr.R32F:return t.FLOAT;case Tr.R32UI:return t.UNSIGNED_INT;case Tr.R32I:return t.INT;case Tr.RG8:return t.UNSIGNED_BYTE;case Tr.RG8SN:return t.BYTE;case Tr.RG8UI:return t.UNSIGNED_BYTE;case Tr.RG8I:return t.BYTE;case Tr.RG16F:return Ck.HALF_FLOAT_OES;case Tr.RG16UI:return t.UNSIGNED_SHORT;case Tr.RG16I:return t.SHORT;case Tr.RG32F:return t.FLOAT;case Tr.RG32UI:return t.UNSIGNED_INT;case Tr.RG32I:return t.INT;case Tr.RGB8:case Tr.SRGB8:return t.UNSIGNED_BYTE;case Tr.RGB8SN:return t.BYTE;case Tr.RGB8UI:return t.UNSIGNED_BYTE;case Tr.RGB8I:return t.BYTE;case Tr.RGB16F:return Ck.HALF_FLOAT_OES;case Tr.RGB16UI:return t.UNSIGNED_SHORT;case Tr.RGB16I:return t.SHORT;case Tr.RGB32F:return t.FLOAT;case Tr.RGB32UI:return t.UNSIGNED_INT;case Tr.RGB32I:return t.INT;case Tr.BGRA8:case Tr.RGBA8:case Tr.SRGB8_A8:return t.UNSIGNED_BYTE;case Tr.RGBA8SN:return t.BYTE;case Tr.RGBA8UI:return t.UNSIGNED_BYTE;case Tr.RGBA8I:return t.BYTE;case Tr.RGBA16F:return Ck.HALF_FLOAT_OES;case Tr.RGBA16UI:return t.UNSIGNED_SHORT;case Tr.RGBA16I:return t.SHORT;case Tr.RGBA32F:return t.FLOAT;case Tr.RGBA32UI:return t.UNSIGNED_INT;case Tr.RGBA32I:return t.INT;case Tr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Tr.R11G11B10F:return t.FLOAT;case Tr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Tr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Tr.RGB10A2:return t.UNSIGNED_BYTE;case Tr.RGB10A2UI:return t.UNSIGNED_INT;case Tr.RGB9E5:return t.UNSIGNED_BYTE;case Tr.D16:return t.UNSIGNED_SHORT;case Tr.D16S8:return Ck.UNSIGNED_INT_24_8_WEBGL;case Tr.D24:return t.UNSIGNED_INT;case Tr.D24S8:return Ck.UNSIGNED_INT_24_8_WEBGL;case Tr.D32F:return t.UNSIGNED_INT;case Tr.D32F_S8:return Ck.UNSIGNED_INT_24_8_WEBGL;case Tr.BC1:case Tr.BC1_SRGB:case Tr.BC2:case Tr.BC2_SRGB:case Tr.BC3:case Tr.BC3_SRGB:case Tr.BC4:return t.UNSIGNED_BYTE;case Tr.BC4_SNORM:return t.BYTE;case Tr.BC5:return t.UNSIGNED_BYTE;case Tr.BC5_SNORM:return t.BYTE;case Tr.BC6H_SF16:case Tr.BC6H_UF16:return t.FLOAT;case Tr.BC7:case Tr.BC7_SRGB:case Tr.ETC_RGB8:case Tr.ETC2_RGB8:case Tr.ETC2_SRGB8:case Tr.ETC2_RGB8_A1:case Tr.ETC2_SRGB8_A1:case Tr.EAC_R11:return t.UNSIGNED_BYTE;case Tr.EAC_R11SN:return t.BYTE;case Tr.EAC_RG11:return t.UNSIGNED_BYTE;case Tr.EAC_RG11SN:return t.BYTE;case Tr.PVRTC_RGB2:case Tr.PVRTC_RGBA2:case Tr.PVRTC_RGB4:case Tr.PVRTC_RGBA4:case Tr.PVRTC2_2BPP:case Tr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Tr.ASTC_RGBA_4X4:case Tr.ASTC_RGBA_5X4:case Tr.ASTC_RGBA_5X5:case Tr.ASTC_RGBA_6X5:case Tr.ASTC_RGBA_6X6:case Tr.ASTC_RGBA_8X5:case Tr.ASTC_RGBA_8X6:case Tr.ASTC_RGBA_8X8:case Tr.ASTC_RGBA_10X5:case Tr.ASTC_RGBA_10X6:case Tr.ASTC_RGBA_10X8:case Tr.ASTC_RGBA_10X10:case Tr.ASTC_RGBA_12X10:case Tr.ASTC_RGBA_12X12:case Tr.ASTC_SRGBA_4X4:case Tr.ASTC_SRGBA_5X4:case Tr.ASTC_SRGBA_5X5:case Tr.ASTC_SRGBA_6X5:case Tr.ASTC_SRGBA_6X6:case Tr.ASTC_SRGBA_8X5:case Tr.ASTC_SRGBA_8X6:case Tr.ASTC_SRGBA_8X8:case Tr.ASTC_SRGBA_10X5:case Tr.ASTC_SRGBA_10X6:case Tr.ASTC_SRGBA_10X8:case Tr.ASTC_SRGBA_10X10:case Tr.ASTC_SRGBA_12X10:case Tr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Pk(e,t){switch(e){case Tr.A8:return t.ALPHA;case Tr.L8:return t.LUMINANCE;case Tr.LA8:return t.LUMINANCE_ALPHA;case Tr.RGB8:case Tr.RGB16F:case Tr.RGB32F:return t.RGB;case Tr.BGRA8:case Tr.RGBA8:case Tr.SRGB8_A8:case Tr.RGBA16F:case Tr.RGBA32F:return t.RGBA;case Tr.R5G6B5:return t.RGB;case Tr.RGB5A1:case Tr.RGBA4:return t.RGBA;case Tr.D16:return t.DEPTH_COMPONENT;case Tr.D16S8:return t.DEPTH_STENCIL;case Tr.D24:return t.DEPTH_COMPONENT;case Tr.D24S8:return t.DEPTH_STENCIL;case Tr.D32F:return t.DEPTH_COMPONENT;case Tr.D32F_S8:return t.DEPTH_STENCIL;case Tr.BC1:return Ck.COMPRESSED_RGB_S3TC_DXT1_EXT;case Tr.BC1_ALPHA:return Ck.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Tr.BC1_SRGB:return Ck.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Tr.BC1_SRGB_ALPHA:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Tr.BC2:return Ck.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Tr.BC2_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Tr.BC3:return Ck.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Tr.BC3_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Tr.ETC_RGB8:return Ck.COMPRESSED_RGB_ETC1_WEBGL;case Tr.ETC2_RGB8:return Ck.COMPRESSED_RGB8_ETC2;case Tr.ETC2_SRGB8:return Ck.COMPRESSED_SRGB8_ETC2;case Tr.ETC2_RGB8_A1:return Ck.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_SRGB8_A1:return Ck.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_RGBA8:return Ck.COMPRESSED_RGBA8_ETC2_EAC;case Tr.ETC2_SRGB8_A8:return Ck.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Tr.EAC_R11:return Ck.COMPRESSED_R11_EAC;case Tr.EAC_R11SN:return Ck.COMPRESSED_SIGNED_R11_EAC;case Tr.EAC_RG11:return Ck.COMPRESSED_RG11_EAC;case Tr.EAC_RG11SN:return Ck.COMPRESSED_SIGNED_RG11_EAC;case Tr.PVRTC_RGB2:return Ck.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGBA2:return Ck.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGB4:return Ck.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Tr.PVRTC_RGBA4:return Ck.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Tr.ASTC_RGBA_4X4:return Ck.COMPRESSED_RGBA_ASTC_4x4_KHR;case Tr.ASTC_RGBA_5X4:return Ck.COMPRESSED_RGBA_ASTC_5x4_KHR;case Tr.ASTC_RGBA_5X5:return Ck.COMPRESSED_RGBA_ASTC_5x5_KHR;case Tr.ASTC_RGBA_6X5:return Ck.COMPRESSED_RGBA_ASTC_6x5_KHR;case Tr.ASTC_RGBA_6X6:return Ck.COMPRESSED_RGBA_ASTC_6x6_KHR;case Tr.ASTC_RGBA_8X5:return Ck.COMPRESSED_RGBA_ASTC_8x5_KHR;case Tr.ASTC_RGBA_8X6:return Ck.COMPRESSED_RGBA_ASTC_8x6_KHR;case Tr.ASTC_RGBA_8X8:return Ck.COMPRESSED_RGBA_ASTC_8x8_KHR;case Tr.ASTC_RGBA_10X5:return Ck.COMPRESSED_RGBA_ASTC_10x5_KHR;case Tr.ASTC_RGBA_10X6:return Ck.COMPRESSED_RGBA_ASTC_10x6_KHR;case Tr.ASTC_RGBA_10X8:return Ck.COMPRESSED_RGBA_ASTC_10x8_KHR;case Tr.ASTC_RGBA_10X10:return Ck.COMPRESSED_RGBA_ASTC_10x10_KHR;case Tr.ASTC_RGBA_12X10:return Ck.COMPRESSED_RGBA_ASTC_12x10_KHR;case Tr.ASTC_RGBA_12X12:return Ck.COMPRESSED_RGBA_ASTC_12x12_KHR;case Tr.ASTC_SRGBA_4X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Tr.ASTC_SRGBA_5X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Tr.ASTC_SRGBA_5X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Tr.ASTC_SRGBA_6X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Tr.ASTC_SRGBA_6X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Tr.ASTC_SRGBA_8X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Tr.ASTC_SRGBA_8X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Tr.ASTC_SRGBA_8X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Tr.ASTC_SRGBA_10X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Tr.ASTC_SRGBA_10X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Tr.ASTC_SRGBA_10X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Tr.ASTC_SRGBA_10X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Tr.ASTC_SRGBA_12X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Tr.ASTC_SRGBA_12X12:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function Ik(e,t){switch(e){case xr.BOOL:return t.BOOL;case xr.BOOL2:return t.BOOL_VEC2;case xr.BOOL3:return t.BOOL_VEC3;case xr.BOOL4:return t.BOOL_VEC4;case xr.INT:return t.INT;case xr.INT2:return t.INT_VEC2;case xr.INT3:return t.INT_VEC3;case xr.INT4:return t.INT_VEC4;case xr.UINT:return t.UNSIGNED_INT;case xr.FLOAT:return t.FLOAT;case xr.FLOAT2:return t.FLOAT_VEC2;case xr.FLOAT3:return t.FLOAT_VEC3;case xr.FLOAT4:return t.FLOAT_VEC4;case xr.MAT2:return t.FLOAT_MAT2;case xr.MAT3:return t.FLOAT_MAT3;case xr.MAT4:return t.FLOAT_MAT4;case xr.SAMPLER2D:return t.SAMPLER_2D;case xr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),xr.UNKNOWN}}function Ok(e){switch(e){case xr.BOOL:case xr.BOOL2:case xr.BOOL3:case xr.BOOL4:case xr.INT:case xr.INT2:case xr.INT3:case xr.INT4:case xr.UINT:return Int32Array;case xr.FLOAT:case xr.FLOAT2:case xr.FLOAT3:case xr.FLOAT4:case xr.MAT2:case xr.MAT3:case xr.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function Dk(e,t){switch(e){case t.BOOL:return xr.BOOL;case t.BOOL_VEC2:return xr.BOOL2;case t.BOOL_VEC3:return xr.BOOL3;case t.BOOL_VEC4:return xr.BOOL4;case t.INT:return xr.INT;case t.INT_VEC2:return xr.INT2;case t.INT_VEC3:return xr.INT3;case t.INT_VEC4:return xr.INT4;case t.UNSIGNED_INT:return xr.UINT;case t.FLOAT:return xr.FLOAT;case t.FLOAT_VEC2:return xr.FLOAT2;case t.FLOAT_VEC3:return xr.FLOAT3;case t.FLOAT_VEC4:return xr.FLOAT4;case t.FLOAT_MAT2:return xr.MAT2;case t.FLOAT_MAT3:return xr.MAT3;case t.FLOAT_MAT4:return xr.MAT4;case t.SAMPLER_2D:return xr.SAMPLER2D;case t.SAMPLER_CUBE:return xr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),xr.UNKNOWN}}function Nk(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Mk(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Ck||(Ck={}));var Lk,Bk=[512,513,514,515,516,517,518,519],Fk=[0,7680,7681,7682,7683,5386,34055,34056],zk=[32774,32778,32779,32775,32776],Uk=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Lk||(Lk={}));var kk=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Gk=function(e){function t(){var t;return(t=e.call(this,Lk.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new co,t.clearFlag=eo.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return H(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(kk),Hk=function(e){function t(){var t;return(t=e.call(this,Lk.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ia,t}return H(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(kk),Vk=function(e){function t(){var t;return(t=e.call(this,Lk.DRAW)||this).drawInfo=new To,t}return H(t,e),t.prototype.clear=function(){},t}(kk),Wk=function(e){function t(){var t;return(t=e.call(this,Lk.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return H(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(kk),jk=function(e){function t(){var t;return(t=e.call(this,Lk.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return H(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(kk),Xk=function(){function e(){this.cmds=new te(1),this.beginRenderPassCmds=new te(1),this.bindStatesCmds=new te(1),this.drawCmds=new te(1),this.updateBufferCmds=new te(1),this.copyBufferToTextureCmds=new te(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function qk(e,t,n,i,r){if(t.usage&Ar.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Ar.INDIRECT)t.indirects.length=i,Array.prototype.push.apply(t.indirects,n.drawInfos);else{var o=n,a=e.gl,s=e.stateCache;switch(t.glTarget){case a.ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case a.ELEMENT_ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===o.byteLength?a.bufferSubData(t.glTarget,i,o):a.bufferSubData(t.glTarget,i,o.slice(0,r))}}var Yk={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function Kk(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==Tr.UNKNOWN)switch(_.loadOp){case kr.LOAD:break;case kr.CLEAR:c.bs.targets[0].blendColorMask!==zr.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case kr.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Tr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case kr.DISCARD:}if(aa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case kr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==zr.ALL){var d=(p&zr.R)!==zr.NONE,m=(p&zr.G)!==zr.NONE,v=(p&zr.B)!==zr.NONE,g=(p&zr.A)!==zr.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function Qk(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&Yk.gpuPipelineState!==t){if(Yk.gpuPipelineState=t,Yk.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=t.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case Yr.NONE:l.disable(l.CULL_FACE);break;case Yr.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Yr.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var m=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==m&&(l.frontFace(m?l.CCW:l.CW),u.rs.isFrontFaceCCW=m),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var v=t.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(Bk[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,Bk[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,Fk[v.stencilFailOpFront],Fk[v.stencilZFailOpFront],Fk[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,Bk[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,Fk[v.stencilFailOpBack],Fk[v.stencilZFailOpBack],Fk[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=t.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],S=u.bs.targets[0];S.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),S.blend=y.blend),S.blendEq===y.blendEq&&S.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(zk[y.blendEq],zk[y.blendAlphaEq]),S.blendEq=y.blendEq,S.blendAlphaEq=y.blendAlphaEq),S.blendSrc===y.blendSrc&&S.blendDst===y.blendDst&&S.blendSrcAlpha===y.blendSrcAlpha&&S.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(Uk[y.blendSrc],Uk[y.blendDst],Uk[y.blendSrcAlpha],Uk[y.blendDstAlpha]),S.blendSrc=y.blendSrc,S.blendDst=y.blendDst,S.blendSrcAlpha=y.blendSrcAlpha,S.blendDstAlpha=y.blendDstAlpha),S.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&zr.R)!==zr.NONE,(y.blendColorMask&zr.G)!==zr.NONE,(y.blendColorMask&zr.B)!==zr.NONE,(y.blendColorMask&zr.A)!==zr.NONE),S.blendColorMask=y.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var T=h.glBlocks.length,E=t.gpuPipelineLayout.dynamicOffsetIndices,x=0;x<T;x++){var A=h.glBlocks[x],b=i[A.set],C=b&&b.descriptorIndices[A.binding],w=C>=0&&b.gpuDescriptors[C],R=null,P=0;if(w&&w.gpuBuffer){var I=w.gpuBuffer,O=E[A.set],D=O&&O[A.binding];D>=0&&(P=r[D]),"vf32"in I?R=I.vf32:(P+=I.offset,R=I.gpuBuffer.vf32),P>>=2}if(R)for(var N=A.glActiveUniforms.length,M=0;M<N;M++){var L=A.glActiveUniforms[M];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+P+B;if(R[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=R[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+P+k;if(R[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=R[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<L.array.length;++W){var j=L.offset+P+W;if(R[j]!==L.array[W]){for(var X=W,q=j;X<L.array.length;++X,++q)L.array[X]=R[q];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+P+Y;if(R[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=R[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+P+J;if(R[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=R[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+P+ne;if(R[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=R[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+P+ae;if(R[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=R[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+P+ue;if(R[he]!==L.array[ue]){for(var _e=ue,fe=he;_e<L.array.length;++_e,++fe)L.array[_e]=R[fe];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var pe=0;pe<L.array.length;++pe){var de=L.offset+P+pe;if(R[de]!==L.array[pe]){for(var me=pe,ve=de;me<L.array.length;++me,++ve)L.array[me]=R[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+P+ge;if(R[ye]!==L.array[ge]){for(var Se=ge,Te=ye;Se<L.array.length;++Se,++Te)L.array[Se]=R[Te];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Ee=0;Ee<L.array.length;++Ee){var xe=L.offset+P+Ee;if(R[xe]!==L.array[Ee]){for(var Ae=Ee,be=xe;Ae<L.array.length;++Ae,++be)L.array[Ae]=R[be];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else d("Buffer binding '"+A.name+"' at set "+A.set+" binding "+A.binding+" is not bounded")}for(var Ce=h.glSamplerTextures.length,we=0;we<Ce;we++)for(var Re=h.glSamplerTextures[we],Pe=i[Re.set],Ie=Pe&&Pe.descriptorIndices[Re.binding],Oe=Ie>=0&&Pe.gpuDescriptors[Ie],De=Re.units.length,Ne=0;Ne<De;Ne++){var Me=Re.units[Ne];if(Oe&&Oe.gpuSampler){if(Oe.gpuTexture&&Oe.gpuTexture.size>0){var Le=Oe.gpuTexture,Be=u.glTexUnits[Me];Be.glTexture!==Le.glTexture&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=Oe.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}Oe=Pe.gpuDescriptors[++Ie]}else d("Sampler binding '"+Re.name+"' at set "+Re.set+" binding "+Re.binding+" index "+Ne+" is not bounded")}}if(n&&h&&(_||Yk.gpuInputAssembler!==n)){Yk.gpuInputAssembler=n;var ze=e.ANGLE_instanced_arrays;if(e.useVAO){var Ue=e.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var We=h.glInputs[Ve];Ge=null;for(var je=n.glAttribs.length,Xe=0;Xe<je;Xe++){var qe=n.glAttribs[Xe];if(qe.name===We.name){Ge=qe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Kr.VIEWPORT:var ft=o.viewport;u.viewport.left===ft.left&&u.viewport.top===ft.top&&u.viewport.width===ft.width&&u.viewport.height===ft.height||(l.viewport(ft.left,ft.top,ft.width,ft.height),u.viewport.left=ft.left,u.viewport.top=ft.top,u.viewport.width=ft.width,u.viewport.height=ft.height);break;case Kr.SCISSOR:var pt=o.scissor;u.scissorRect.x===pt.x&&u.scissorRect.y===pt.y&&u.scissorRect.width===pt.width&&u.scissorRect.height===pt.height||(l.scissor(pt.x,pt.y,pt.width,pt.height),u.scissorRect.x=pt.x,u.scissorRect.y=pt.y,u.scissorRect.width=pt.width,u.scissorRect.height=pt.height);break;case Kr.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Kr.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Kr.BLEND_CONSTANTS:var dt=o.blendConstant;u.bs.blendColor.x===dt.x&&u.bs.blendColor.y===dt.y&&u.bs.blendColor.z===dt.z&&u.bs.blendColor.w===dt.w||(l.blendColor(dt.x,dt.y,dt.z,dt.w),u.bs.blendColor.copy(dt));break;case Kr.STENCIL_WRITE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==mt.writeMask&&(l.stencilMaskSeparate(l.FRONT,mt.writeMask),u.dss.stencilWriteMaskFront=mt.writeMask),u.dss.stencilWriteMaskBack!==vt.writeMask&&(l.stencilMaskSeparate(l.BACK,vt.writeMask),u.dss.stencilWriteMaskBack=vt.writeMask);break;case Kr.STENCIL_COMPARE_MASK:var gt=o.stencilStatesFront,yt=o.stencilStatesBack;u.dss.stencilRefFront===gt.reference&&u.dss.stencilReadMaskFront===gt.compareMask||(l.stencilFuncSeparate(l.FRONT,Bk[u.dss.stencilFuncFront],gt.reference,gt.compareMask),u.dss.stencilRefFront=gt.reference,u.dss.stencilReadMaskFront=gt.compareMask),u.dss.stencilRefBack===yt.reference&&u.dss.stencilReadMaskBack===yt.compareMask||(l.stencilFuncSeparate(l.BACK,Bk[u.dss.stencilFuncBack],yt.reference,yt.compareMask),u.dss.stencilRefBack=yt.reference,u.dss.stencilReadMaskBack=yt.compareMask)}}function Zk(e,t){var n=e.gl,i=e.ANGLE_instanced_arrays,r=Yk.gpuInputAssembler,o=Yk.glPrimitive;if(r)if(r.gpuIndirectBuffer)for(var a=r.gpuIndirectBuffer.indirects.length,s=0;s<a;s++){var c=r.gpuIndirectBuffer.indirects[s],l=r.gpuIndexBuffer;if(c.instanceCount&&i)if(l){if(c.indexCount>0){var u=c.firstIndex*l.stride;i.drawElementsInstancedANGLE(o,c.indexCount,r.glIndexType,u,c.instanceCount)}}else c.vertexCount>0&&i.drawArraysInstancedANGLE(o,c.firstVertex,c.vertexCount,c.instanceCount);else if(l){if(c.indexCount>0){var h=c.firstIndex*l.stride;n.drawElements(o,c.indexCount,r.glIndexType,h)}}else c.vertexCount>0&&n.drawArrays(o,c.firstVertex,c.vertexCount)}else{var _=r.gpuIndexBuffer;if(t.instanceCount&&i)if(_){if(t.indexCount>0){var f=t.firstIndex*_.stride;i.drawElementsInstancedANGLE(o,t.indexCount,r.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(_){if(t.indexCount>0){var p=t.firstIndex*_.stride;n.drawElements(o,t.indexCount,r.glIndexType,p)}}else t.vertexCount>0&&n.drawArrays(o,t.firstVertex,t.vertexCount)}}var Jk=new Array(Lk.COUNT);function $k(e,t){Jk.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=Jk[i]++;switch(i){case Lk.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];Kk(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case Lk.BIND_STATES:var a=t.bindStatesCmds.array[r];Qk(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case Lk.DRAW:Zk(e,t.drawCmds.array[r].drawInfo);break;case Lk.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];qk(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case Lk.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];eG(e,c.buffers,c.gpuTexture,c.regions)}}}function eG(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=aa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===Ck.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt===Ck.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ir.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var tG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Ar.INDIRECT&&(this._indirectBuffer=new xo),this._usage&Ar.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&Ar.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Ar.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&wr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Ar.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&i.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Ar.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&i.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Ar.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0},n.destroy=function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&wr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Ar.VERTEX?(e.useVAO&&i.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Ar.INDEX?(e.useVAO&&i.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=Yk.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Ar.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Ar.INDIRECT?0:e.byteLength,qk(this._device,this._gpuBuffer,e,0,n))},k(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(va),nG=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new te(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),iG=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new nG(Gk,1),this.bindStatesCmdPool=new nG(Hk,1),this.drawCmdPool=new nG(Vk,1),this.updateBufferCmdPool=new nG(Wk,1),this.copyBufferToTextureCmdPool=new nG(jk,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),rG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new Xk,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ia,t._isStateInvalied=!1,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null);return!0},n.destroy=function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)},n.begin=function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._webGLAllocator.beginRenderPassCmdPool.alloc(Gk);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(Lk.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Qr.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Qr.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Qr.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Qr.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===$r.PRIMARY&&this._isInRenderPass||this._type===$r.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(Vk);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(Lk.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===$r.PRIMARY&&!this._isInRenderPass||this._type===$r.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._webGLAllocator.updateBufferCmdPool.alloc(Wk),a=0;e.usage&Ar.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(Lk.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===$r.PRIMARY&&!this._isInRenderPass||this._type===$r.SECONDARY){var i=t.gpuTexture;if(i){var r=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(jk);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(Lk.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Hk);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Lk.BIND_STATES),this._isStateInvalied=!1)},k(t,[{key:"webGLDevice",get:function(){return this._device}}]),t}(ga),oG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;return e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var n=e.gl,i=[],r=n.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var a=t.gpuColorTextures[o];a&&(a.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+o,a.glTarget,a.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+o,n.RENDERBUFFER,a.glRenderbuffer),i.push(n.COLOR_ATTACHMENT0+o))}var s=t.gpuDepthStencilTexture;if(s){var c=aa[s.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;s.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,c,s.glTarget,s.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,c,n.RENDERBUFFER,s.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(i);var l=n.checkFramebufferStatus(n.FRAMEBUFFER);if(l!==n.FRAMEBUFFER_COMPLETE)switch(l){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},k(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Sa),aG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=Rk(o.format,n),l=aa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:aa[o.format].count,stride:s.stride,componentCount:Mk(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(this._device,this._gpuInputAssembler),!0},n.destroy=function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.OES_vertex_array_object.deleteVertexArrayOES(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},k(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Aa),sG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&la)for(var _=0;_<h.count;_++)l.push(h.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t},!0},n.destroy=function(){this._bindings.length=0},k(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ca),cG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}return this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r},!0},n.destroy=function(){this._setLayouts.length=0},k(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(wa),lG=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],uG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);return this._gpuPipelineState={glPrimitive:lG[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r},!0},n.destroy=function(){this._gpuPipelineState=null},k(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Na),hG=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){Kk(this._device,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),Zk(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Ar.INDIRECT?0:t.byteLength,qk(this._device,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&eG(this._device,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];$k(this._device,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){Qk(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(rG),_G=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return this._type=e.type,!0},n.destroy=function(){},n.submit=function(e){if(!this._isAsync)for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Ma),fG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0},n.destroy=function(){this._gpuRenderPass=null},k(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(La),pG=[10497,33648,33071,33071],dG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuSampler=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias;var t,n,i=this._minFilter,r=this._magFilter,o=this._mipFilter;t=i===Dr.LINEAR||i===Dr.ANISOTROPIC?o===Dr.LINEAR||o===Dr.ANISOTROPIC?9987:o===Dr.POINT?9985:9729:o===Dr.LINEAR||o===Dr.ANISOTROPIC?9986:o===Dr.POINT?9984:9728,n=r===Dr.LINEAR||r===Dr.ANISOTROPIC?9729:9728;var a=pG[this._addressU],s=pG[this._addressV],c=pG[this._addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:n,glWrapS:a,glWrapT:s,glWrapR:c},!0},n.destroy=function(){this._gpuSampler=null},k(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Ba),mG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}return function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Ur.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ur.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(t.glProgram,p),g=Dk(f.type,n),y=Nk(f.type,n);t.glInputs[_]={binding:m,name:p,type:g,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var T=t.blocks[S],E={set:T.set,binding:T.binding,name:T.name,size:0,glUniforms:new Array(T.members.length),glActiveUniforms:[]};t.glBlocks[S]=E;for(var x=0;x<T.members.length;++x){var A=T.members[x],b=Ik(A.type,n),C=Nk(b,n),w=C*A.count;E.glUniforms[x]={binding:-1,name:A.name,type:A.type,stride:C,count:A.count,size:w,offset:0,glType:b,glLoc:-1,array:null}}}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var R=0;R<t.samplerTextures.length;++R){var P=t.samplerTextures[R];t.glSamplerTextures[R]={set:P.set,binding:P.binding,name:P.name,type:P.type,count:P.count,units:[],glUnits:null,glType:Ik(P.type,n),glLoc:null}}}for(var I=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),O=0;O<I;++O){var D=n.getActiveUniform(t.glProgram,O);if(D&&D.type!==n.SAMPLER_2D&&D.type!==n.SAMPLER_CUBE){var N=n.getUniformLocation(t.glProgram,D.name);if(null!==N&&("number"==typeof N||-1!==N.id)){var M,L=D.name.indexOf("[");M=-1!==L?D.name.substr(0,L):D.name;for(var B=0;B<t.glBlocks.length;B++)for(var F=t.glBlocks[B],z=0;z<F.glUniforms.length;z++){var U=F.glUniforms[z];if(U.name===M){U.glLoc=N,U.count=D.size,U.size=U.stride*U.count,U.array=new(Ok(U.type))(U.size/4),F.glActiveUniforms.push(U);break}}}}}for(var k=0;k<t.glBlocks.length;k++)for(var G=t.glBlocks[k],H=0;H<G.glUniforms.length;H++){var V=G.glUniforms[H];V.offset=G.size/4,G.size+=V.size}for(var W=[],j=[],X=e.bindingMappingInfo,q=e.stateCache.texUnitCacheMap,Y=0,K=0;K<t.blocks.length;++K)t.blocks[K].set===X.flexibleSet&&Y++;for(var Q=0,Z=0;Z<t.samplerTextures.length;++Z){var J=t.samplerTextures[Z],$=n.getUniformLocation(t.glProgram,J.name);if(null===$||"number"!=typeof $&&-1===$.id||(W.push(t.glSamplerTextures[Z]),j.push($)),void 0===q[J.name]){var ee=J.binding+X.samplerOffsets[J.set]+Q;J.set===X.flexibleSet&&(ee-=Y),q[J.name]=ee%e.capabilities.maxTextureUnits,Q+=J.count-1}}if(W.length){for(var te=[],ne=0;ne<W.length;++ne){var ie=W[ne],re=q[ie.name];if(void 0!==re){ie.glLoc=j[ne];for(var oe=0;oe<ie.count;++oe){for(;te[re];)re=(re+1)%e.capabilities.maxTextureUnits;ie.units.push(re),te[re]=!0}}}for(var ae=0,se=0;se<W.length;++se){var ce=W[se];if(!ce.glLoc){ce.glLoc=j[se];for(var le=0;le<ce.count;++le){for(;te[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;void 0===q[ce.name]&&(q[ce.name]=ae),ce.units.push(ae),te[ae]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var ue=0;ue<W.length;ue++){var he=W[ue];he.glUnits=new Int32Array(he.units),n.uniform1iv(he.glLoc,he.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var _e=0;_e<t.glBlocks.length;)t.glBlocks[_e].glActiveUniforms.length?_e++:(t.glBlocks[_e]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=W}}(this._device,this._gpuShader),!0},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)},k(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Fa),vG=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new mo,this.scissorRect=new co(0,0,0,0),this.rs=new Ra,this.dss=new Pa,this.bs=new Oa,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),gG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ua(this._width)&&ua(this._height),this._size=_a(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=Pk(t.format,n),t.glType=Rk(t.format,n);var i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),!e.WEBGL_depth_texture&&aa[t.format].hasDepth){t.glInternalFmt=function(e,t){switch(e){case Tr.R5G6B5:return t.RGB565;case Tr.RGB5A1:return t.RGB5_A1;case Tr.RGBA4:return t.RGBA4;case Tr.RGBA16F:return Ck.RGBA16F_EXT;case Tr.RGBA32F:return Ck.RGBA32F_EXT;case Tr.SRGB8_A8:return Ck.SRGB8_ALPHA8_EXT;case Tr.D16:return t.DEPTH_COMPONENT16;case Tr.D16S8:return t.DEPTH_STENCIL;case Tr.D24:return t.DEPTH_COMPONENT16;case Tr.D24S8:return t.DEPTH_STENCIL;case Tr.D32F:return t.DEPTH_COMPONENT16;case Tr.D32F_S8:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n);var a=n.createRenderbuffer();a&&t.size>0&&(t.glRenderbuffer=a,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r))}else{var s=n.createTexture();if(s&&t.size>0){t.glTexture=s;var c=e.stateCache.glTexUnits[e.stateCache.texUnit];if(c.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),c.glTexture=t.glTexture),aa[t.format].isCompressed)if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=ha(t.format,i,r,1),h=new Uint8Array(u);n.compressedTexImage2D(n.TEXTURE_2D,l,t.glInternalFmt,i,r,0,h),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else{var _=ha(t.format,2,2,1),f=new Uint8Array(_);n.compressedTexImage2D(n.TEXTURE_2D,0,t.glInternalFmt,2,2,0,f)}else for(var p=0;p<t.mipLevel;++p)n.texImage2D(n.TEXTURE_2D,p,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}else n.deleteTexture(s)}break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var d=Math.max(i,r);d>e.capabilities.maxCubeMapTextureSize&&C(9100,d,e.capabilities.maxTextureSize);var m=n.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),aa[t.format].isCompressed)if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){i=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var S=ha(t.format,i,r,1),T=new Uint8Array(S);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternalFmt,i,r,0,T),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var E=0;E<6;++E){var x=ha(t.format,2,2,1),A=new Uint8Array(x);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+E,0,t.glInternalFmt,2,2,0,A)}else for(var b=0;b<6;++b){i=t.width,r=t.height;for(var w=0;w<t.mipLevel;++w)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+b,w,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)},n.destroy=function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=_a(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),aa[t.format].isCompressed){if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var c=ha(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&C(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),aa[t.format].isCompressed){if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ha(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=n,this._device.memoryStatus.textureSize+=this._size)},k(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(za),yG="webglcontextlost",SG=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new vG,t.cmdAllocator=new iG,t.nullTex2D=null,t.nullTexCube=null,t._webGLRC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!1,t._destroyShadersImmediately=!0,t._noCompressedTexSubImage2D=!1,t._bindingMappingInfo=new go,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._EXT_blend_minmax=null,t._EXT_frag_depth=null,t._EXT_shader_texture_lod=null,t._EXT_sRGB=null,t._OES_vertex_array_object=null,t._EXT_color_buffer_half_float=null,t._WEBGL_color_buffer_float=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_shaders=null,t._WEBGL_draw_buffers=null,t._WEBGL_lose_context=null,t._WEBGL_depth_texture=null,t._WEBGL_debug_renderer_info=null,t._OES_texture_half_float=null,t._OES_texture_half_float_linear=null,t._OES_texture_float=null,t._OES_texture_float_linear=null,t._OES_standard_derivatives=null,t._OES_element_index_uint=null,t._ANGLE_instanced_arrays=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:nt.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(yG,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=gr.WEBGL,this._deviceName="WebGL";var n=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=n.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=n.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=n.getParameter(n.RENDERER),this._vendor=n.getParameter(n.VENDOR)),this._version=n.getParameter(n.VERSION),this._caps.maxVertexAttributes=n.getParameter(n.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=n.getParameter(n.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=n.getParameter(n.DEPTH_BITS),this._caps.stencilBits=n.getParameter(n.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=e.width,this._height=e.height,this._colorFmt=Tr.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Tr.D24S8:this._depthStencilFmt=Tr.D24:8===this._caps.stencilBits?this._depthStencilFmt=Tr.D16S8:this._depthStencilFmt=Tr.D16,this._extensions=n.getSupportedExtensions();var i="";if(this._extensions){for(var r,o=Q(this._extensions);!(r=o()).done;)i+=r.value+" ";v("EXTENSIONS: "+i)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Ni.os===B.IOS&&14===Ni.osMainVersion&&Ni.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),Ni.browserType===N.UC&&(this._ANGLE_instanced_arrays=null),Ni.os===B.IOS&&Ni.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_sRGB&&(this._features[Sr.FORMAT_SRGB]=!0),this._EXT_blend_minmax&&(this._features[Sr.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[Sr.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Sr.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Sr.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Sr.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Sr.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Sr.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Sr.FORMAT_RGB8]=!0,this._OES_element_index_uint&&(this._features[Sr.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Sr.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[Sr.MULTIPLE_RENDER_TARGETS]=!0);var a="";this._WEBGL_compressed_texture_etc1&&(this._features[Sr.FORMAT_ETC1]=!0,a+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Sr.FORMAT_ETC2]=!0,a+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Sr.FORMAT_DXT]=!0,a+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Sr.FORMAT_PVRTC]=!0,a+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Sr.FORMAT_ASTC]=!0,a+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+this._version),v("DPR: "+this._devicePixelRatio),v("SCREEN_SIZE: "+this._width+" x "+this._height),v("MAX_VERTEX_UNIFORM_VECTORS: "+this._caps.maxVertexUniformVectors),v("DEPTH_BITS: "+this._caps.depthBits),v("STENCIL_BITS: "+this._caps.stencilBits),this._EXT_texture_filter_anisotropic&&v("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),v("USE_VAO: "+this._useVAO),v("COMPRESSED_FORMAT: "+a),this.initStates(n),this._queue=this.createQueue(new $o(Jr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Jo(this._queue)),this.nullTex2D=this.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED,Tr.RGBA8,2,2,Ir.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new Ao(Rr.CUBE,Pr.SAMPLED,Tr.RGBA8,2,2,Ir.GEN_MIPMAP,6));var s=new po;s.texExtent.width=2,s.texExtent.height=2;var c=new Uint8Array(this.nullTex2D.size);return c.fill(0),this.copyBuffersToTexture([c],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([c,c,c,c,c,c],this.nullTexCube,[s]),!0},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(yG,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null},n.resize=function(e,t){this._width===e&&this._height===t||(v("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)},n.flushCommands=function(){},n.acquire=function(){this.cmdAllocator.releaseCmds()},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===$r.PRIMARY?hG:rG)(this);return t.initialize(e)?t:null},n.createBuffer=function(e){var t=new tG(this);return t.initialize(e)?t:null},n.createTexture=function(e){var t=new gG(this);return t.initialize(e)?t:null},n.createSampler=function(e){var t=new dG(this);return t.initialize(e)?t:null},n.createDescriptorSet=function(e){var t=new wk(this);return t.initialize(e)?t:null},n.createShader=function(e){var t=new mG(this);return t.initialize(e)?t:null},n.createInputAssembler=function(e){var t=new aG(this);return t.initialize(e)?t:null},n.createRenderPass=function(e){var t=new fG(this);return t.initialize(e)?t:null},n.createFramebuffer=function(e){var t=new oG(this);return t.initialize(e)?t:null},n.createDescriptorSetLayout=function(e){var t=new sG(this);return t.initialize(e)?t:null},n.createPipelineLayout=function(e){var t=new cG(this);return t.initialize(e)?t:null},n.createPipelineState=function(e){var t=new uG(this);return t.initialize(e)?t:null},n.createQueue=function(e){var t=new _G(this);return t.initialize(e)?t:null},n.createGlobalBarrier=function(e){var t=new Ua(this);return t.initialize(e)?t:null},n.createTextureBarrier=function(e){var t=new ka(this);return t.initialize(e)?t:null},n.copyBuffersToTexture=function(e,t,n){eG(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ir.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},n.copyFramebufferToBuffer=function(e,t,n){var i=this._webGLRC,r=e.gpuFramebuffer,o=r.gpuColorTextures[0].format,a=Pk(o,i),s=Rk(o,i),c=da(aa[o]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);for(var u,h=new c(t),_=Q(n);!(u=_()).done;){var f=u.value,p=f.texExtent.width,d=f.texExtent.height;i.readPixels(f.texOffset.x,f.texOffset.y,p,d,a,s,h)}this.stateCache.glFramebuffer!==l&&(i.bindFramebuffer(i.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)},n.blitFramebuffer=function(){},n.getExtension=function(e){for(var t=["","WEBKIT_","MOZ_"],n=0;n<t.length;++n){var i=this.gl.getExtension(t[n]+e);if(i)return i}return null},n.initStates=function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)},n._onWebGLContextLost=function(e){A(11e3),p(e)},k(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"destroyShadersImmediately",get:function(){return this._destroyShadersImmediately}},{key:"noCompressedTexSubImage2D",get:function(){return this._noCompressedTexSubImage2D}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_blend_minmax",get:function(){return this._EXT_blend_minmax}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),t}(ya));i.WebGLDevice=SG;var TG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&sa?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&ca&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},k(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(ba),EG=[10497,33648,33071,33071],xG=new Float32Array(4);function AG(e,t){switch(e){case Tr.R8:return t.UNSIGNED_BYTE;case Tr.R8SN:return t.BYTE;case Tr.R8UI:return t.UNSIGNED_BYTE;case Tr.R8I:return t.BYTE;case Tr.R16F:return t.HALF_FLOAT;case Tr.R16UI:return t.UNSIGNED_SHORT;case Tr.R16I:return t.SHORT;case Tr.R32F:return t.FLOAT;case Tr.R32UI:return t.UNSIGNED_INT;case Tr.R32I:return t.INT;case Tr.RG8:return t.UNSIGNED_BYTE;case Tr.RG8SN:return t.BYTE;case Tr.RG8UI:return t.UNSIGNED_BYTE;case Tr.RG8I:return t.BYTE;case Tr.RG16F:return t.HALF_FLOAT;case Tr.RG16UI:return t.UNSIGNED_SHORT;case Tr.RG16I:return t.SHORT;case Tr.RG32F:return t.FLOAT;case Tr.RG32UI:return t.UNSIGNED_INT;case Tr.RG32I:return t.INT;case Tr.RGB8:case Tr.SRGB8:return t.UNSIGNED_BYTE;case Tr.RGB8SN:return t.BYTE;case Tr.RGB8UI:return t.UNSIGNED_BYTE;case Tr.RGB8I:return t.BYTE;case Tr.RGB16F:return t.HALF_FLOAT;case Tr.RGB16UI:return t.UNSIGNED_SHORT;case Tr.RGB16I:return t.SHORT;case Tr.RGB32F:return t.FLOAT;case Tr.RGB32UI:return t.UNSIGNED_INT;case Tr.RGB32I:return t.INT;case Tr.BGRA8:case Tr.RGBA8:case Tr.SRGB8_A8:return t.UNSIGNED_BYTE;case Tr.RGBA8SN:return t.BYTE;case Tr.RGBA8UI:return t.UNSIGNED_BYTE;case Tr.RGBA8I:return t.BYTE;case Tr.RGBA16F:return t.HALF_FLOAT;case Tr.RGBA16UI:return t.UNSIGNED_SHORT;case Tr.RGBA16I:return t.SHORT;case Tr.RGBA32F:return t.FLOAT;case Tr.RGBA32UI:return t.UNSIGNED_INT;case Tr.RGBA32I:return t.INT;case Tr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Tr.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Tr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Tr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Tr.RGB10A2:case Tr.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Tr.RGB9E5:return t.FLOAT;case Tr.D16:return t.UNSIGNED_SHORT;case Tr.D16S8:return t.UNSIGNED_INT_24_8;case Tr.D24:return t.UNSIGNED_INT;case Tr.D24S8:return t.UNSIGNED_INT_24_8;case Tr.D32F:return t.FLOAT;case Tr.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case Tr.BC1:case Tr.BC1_SRGB:case Tr.BC2:case Tr.BC2_SRGB:case Tr.BC3:case Tr.BC3_SRGB:case Tr.BC4:return t.UNSIGNED_BYTE;case Tr.BC4_SNORM:return t.BYTE;case Tr.BC5:return t.UNSIGNED_BYTE;case Tr.BC5_SNORM:return t.BYTE;case Tr.BC6H_SF16:case Tr.BC6H_UF16:return t.FLOAT;case Tr.BC7:case Tr.BC7_SRGB:case Tr.ETC_RGB8:case Tr.ETC2_RGB8:case Tr.ETC2_SRGB8:case Tr.ETC2_RGB8_A1:case Tr.ETC2_SRGB8_A1:case Tr.EAC_R11:return t.UNSIGNED_BYTE;case Tr.EAC_R11SN:return t.BYTE;case Tr.EAC_RG11:return t.UNSIGNED_BYTE;case Tr.EAC_RG11SN:return t.BYTE;case Tr.PVRTC_RGB2:case Tr.PVRTC_RGBA2:case Tr.PVRTC_RGB4:case Tr.PVRTC_RGBA4:case Tr.PVRTC2_2BPP:case Tr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Tr.ASTC_RGBA_4X4:case Tr.ASTC_RGBA_5X4:case Tr.ASTC_RGBA_5X5:case Tr.ASTC_RGBA_6X5:case Tr.ASTC_RGBA_6X6:case Tr.ASTC_RGBA_8X5:case Tr.ASTC_RGBA_8X6:case Tr.ASTC_RGBA_8X8:case Tr.ASTC_RGBA_10X5:case Tr.ASTC_RGBA_10X6:case Tr.ASTC_RGBA_10X8:case Tr.ASTC_RGBA_10X10:case Tr.ASTC_RGBA_12X10:case Tr.ASTC_RGBA_12X12:case Tr.ASTC_SRGBA_4X4:case Tr.ASTC_SRGBA_5X4:case Tr.ASTC_SRGBA_5X5:case Tr.ASTC_SRGBA_6X5:case Tr.ASTC_SRGBA_6X6:case Tr.ASTC_SRGBA_8X5:case Tr.ASTC_SRGBA_8X6:case Tr.ASTC_SRGBA_8X8:case Tr.ASTC_SRGBA_10X5:case Tr.ASTC_SRGBA_10X6:case Tr.ASTC_SRGBA_10X8:case Tr.ASTC_SRGBA_10X10:case Tr.ASTC_SRGBA_12X10:case Tr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function bG(e,t){switch(e){case Tr.A8:return t.ALPHA;case Tr.L8:return t.LUMINANCE;case Tr.LA8:return t.LUMINANCE_ALPHA;case Tr.R8:case Tr.R8SN:return t.RED;case Tr.R8UI:case Tr.R8I:return t.RED;case Tr.RG8:case Tr.RG8SN:case Tr.RG8UI:case Tr.RG8I:return t.RG;case Tr.RGB8:case Tr.RGB8SN:case Tr.RGB8UI:case Tr.RGB8I:return t.RGB;case Tr.BGRA8:case Tr.RGBA8:case Tr.RGBA8SN:case Tr.RGBA8UI:case Tr.RGBA8I:return t.RGBA;case Tr.R16UI:case Tr.R16I:case Tr.R16F:return t.RED;case Tr.RG16UI:case Tr.RG16I:case Tr.RG16F:return t.RG;case Tr.RGB16UI:case Tr.RGB16I:case Tr.RGB16F:return t.RGB;case Tr.RGBA16UI:case Tr.RGBA16I:case Tr.RGBA16F:return t.RGBA;case Tr.R32UI:case Tr.R32I:case Tr.R32F:return t.RED;case Tr.RG32UI:case Tr.RG32I:case Tr.RG32F:return t.RG;case Tr.RGB32UI:case Tr.RGB32I:case Tr.RGB32F:return t.RGB;case Tr.RGBA32UI:case Tr.RGBA32I:case Tr.RGBA32F:case Tr.RGB10A2:return t.RGBA;case Tr.R11G11B10F:case Tr.R5G6B5:return t.RGB;case Tr.RGB5A1:case Tr.RGBA4:return t.RGBA;case Tr.SRGB8:return t.RGB;case Tr.SRGB8_A8:return t.RGBA;case Tr.D16:return t.DEPTH_COMPONENT;case Tr.D16S8:return t.DEPTH_STENCIL;case Tr.D24:return t.DEPTH_COMPONENT;case Tr.D24S8:return t.DEPTH_STENCIL;case Tr.D32F:return t.DEPTH_COMPONENT;case Tr.D32F_S8:return t.DEPTH_STENCIL;case Tr.BC1:return Ck.COMPRESSED_RGB_S3TC_DXT1_EXT;case Tr.BC1_ALPHA:return Ck.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Tr.BC1_SRGB:return Ck.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Tr.BC1_SRGB_ALPHA:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Tr.BC2:return Ck.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Tr.BC2_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Tr.BC3:return Ck.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Tr.BC3_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Tr.ETC_RGB8:return Ck.COMPRESSED_RGB_ETC1_WEBGL;case Tr.ETC2_RGB8:return Ck.COMPRESSED_RGB8_ETC2;case Tr.ETC2_SRGB8:return Ck.COMPRESSED_SRGB8_ETC2;case Tr.ETC2_RGB8_A1:return Ck.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_SRGB8_A1:return Ck.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_RGBA8:return Ck.COMPRESSED_RGBA8_ETC2_EAC;case Tr.ETC2_SRGB8_A8:return Ck.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Tr.EAC_R11:return Ck.COMPRESSED_R11_EAC;case Tr.EAC_R11SN:return Ck.COMPRESSED_SIGNED_R11_EAC;case Tr.EAC_RG11:return Ck.COMPRESSED_RG11_EAC;case Tr.EAC_RG11SN:return Ck.COMPRESSED_SIGNED_RG11_EAC;case Tr.PVRTC_RGB2:return Ck.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGBA2:return Ck.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGB4:return Ck.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Tr.PVRTC_RGBA4:return Ck.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Tr.ASTC_RGBA_4X4:return Ck.COMPRESSED_RGBA_ASTC_4x4_KHR;case Tr.ASTC_RGBA_5X4:return Ck.COMPRESSED_RGBA_ASTC_5x4_KHR;case Tr.ASTC_RGBA_5X5:return Ck.COMPRESSED_RGBA_ASTC_5x5_KHR;case Tr.ASTC_RGBA_6X5:return Ck.COMPRESSED_RGBA_ASTC_6x5_KHR;case Tr.ASTC_RGBA_6X6:return Ck.COMPRESSED_RGBA_ASTC_6x6_KHR;case Tr.ASTC_RGBA_8X5:return Ck.COMPRESSED_RGBA_ASTC_8x5_KHR;case Tr.ASTC_RGBA_8X6:return Ck.COMPRESSED_RGBA_ASTC_8x6_KHR;case Tr.ASTC_RGBA_8X8:return Ck.COMPRESSED_RGBA_ASTC_8x8_KHR;case Tr.ASTC_RGBA_10X5:return Ck.COMPRESSED_RGBA_ASTC_10x5_KHR;case Tr.ASTC_RGBA_10X6:return Ck.COMPRESSED_RGBA_ASTC_10x6_KHR;case Tr.ASTC_RGBA_10X8:return Ck.COMPRESSED_RGBA_ASTC_10x8_KHR;case Tr.ASTC_RGBA_10X10:return Ck.COMPRESSED_RGBA_ASTC_10x10_KHR;case Tr.ASTC_RGBA_12X10:return Ck.COMPRESSED_RGBA_ASTC_12x10_KHR;case Tr.ASTC_RGBA_12X12:return Ck.COMPRESSED_RGBA_ASTC_12x12_KHR;case Tr.ASTC_SRGBA_4X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Tr.ASTC_SRGBA_5X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Tr.ASTC_SRGBA_5X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Tr.ASTC_SRGBA_6X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Tr.ASTC_SRGBA_6X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Tr.ASTC_SRGBA_8X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Tr.ASTC_SRGBA_8X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Tr.ASTC_SRGBA_8X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Tr.ASTC_SRGBA_10X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Tr.ASTC_SRGBA_10X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Tr.ASTC_SRGBA_10X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Tr.ASTC_SRGBA_10X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Tr.ASTC_SRGBA_12X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Tr.ASTC_SRGBA_12X12:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function CG(e,t){switch(e){case xr.BOOL:return t.BOOL;case xr.BOOL2:return t.BOOL_VEC2;case xr.BOOL3:return t.BOOL_VEC3;case xr.BOOL4:return t.BOOL_VEC4;case xr.INT:return t.INT;case xr.INT2:return t.INT_VEC2;case xr.INT3:return t.INT_VEC3;case xr.INT4:return t.INT_VEC4;case xr.UINT:return t.UNSIGNED_INT;case xr.FLOAT:return t.FLOAT;case xr.FLOAT2:return t.FLOAT_VEC2;case xr.FLOAT3:return t.FLOAT_VEC3;case xr.FLOAT4:return t.FLOAT_VEC4;case xr.MAT2:return t.FLOAT_MAT2;case xr.MAT2X3:return t.FLOAT_MAT2x3;case xr.MAT2X4:return t.FLOAT_MAT2x4;case xr.MAT3X2:return t.FLOAT_MAT3x2;case xr.MAT3:return t.FLOAT_MAT3;case xr.MAT3X4:return t.FLOAT_MAT3x4;case xr.MAT4X2:return t.FLOAT_MAT4x2;case xr.MAT4X3:return t.FLOAT_MAT4x3;case xr.MAT4:return t.FLOAT_MAT4;case xr.SAMPLER2D:return t.SAMPLER_2D;case xr.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case xr.SAMPLER3D:return t.SAMPLER_3D;case xr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),xr.UNKNOWN}}function wG(e,t){switch(e){case t.BOOL:return xr.BOOL;case t.BOOL_VEC2:return xr.BOOL2;case t.BOOL_VEC3:return xr.BOOL3;case t.BOOL_VEC4:return xr.BOOL4;case t.INT:return xr.INT;case t.INT_VEC2:return xr.INT2;case t.INT_VEC3:return xr.INT3;case t.INT_VEC4:return xr.INT4;case t.UNSIGNED_INT:return xr.UINT;case t.UNSIGNED_INT_VEC2:return xr.UINT2;case t.UNSIGNED_INT_VEC3:return xr.UINT3;case t.UNSIGNED_INT_VEC4:return xr.UINT4;case t.FLOAT:return xr.FLOAT;case t.FLOAT_VEC2:return xr.FLOAT2;case t.FLOAT_VEC3:return xr.FLOAT3;case t.FLOAT_VEC4:return xr.FLOAT4;case t.FLOAT_MAT2:return xr.MAT2;case t.FLOAT_MAT2x3:return xr.MAT2X3;case t.FLOAT_MAT2x4:return xr.MAT2X4;case t.FLOAT_MAT3x2:return xr.MAT3X2;case t.FLOAT_MAT3:return xr.MAT3;case t.FLOAT_MAT3x4:return xr.MAT3X4;case t.FLOAT_MAT4x2:return xr.MAT4X2;case t.FLOAT_MAT4x3:return xr.MAT4X3;case t.FLOAT_MAT4:return xr.MAT4;case t.SAMPLER_2D:return xr.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return xr.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return xr.SAMPLER3D;case t.SAMPLER_CUBE:return xr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),xr.UNKNOWN}}function RG(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function PG(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var IG,OG=[512,513,514,515,516,517,518,519],DG=[0,7680,7681,7682,7683,5386,34055,34056],NG=[32774,32778,32779,32775,32776],MG=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(IG||(IG={}));var LG=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},BG=function(e){function t(){var t;return(t=e.call(this,IG.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new co,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return H(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(LG),FG=function(e){function t(){var t;return(t=e.call(this,IG.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ia,t}return H(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(LG),zG=function(e){function t(){var t;return(t=e.call(this,IG.DRAW)||this).drawInfo=new To,t}return H(t,e),t.prototype.clear=function(){},t}(LG),UG=function(e){function t(){var t;return(t=e.call(this,IG.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return H(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(LG),kG=function(e){function t(){var t;return(t=e.call(this,IG.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return H(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(LG),GG=function(){function e(){this.cmds=new te(1),this.beginRenderPassCmds=new te(1),this.bindStatesCmds=new te(1),this.drawCmds=new te(1),this.updateBufferCmds=new te(1),this.copyBufferToTextureCmds=new te(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function HG(e,t,n,i,r){if(t.usage&Ar.INDIRECT)t.indirects.length=i,Array.prototype.push.apply(t.indirects,n.drawInfos);else{var o=n,a=e.gl,s=e.stateCache;switch(t.glTarget){case a.ARRAY_BUFFER:s.glVAO&&(a.bindVertexArray(null),s.glVAO=VG.gpuInputAssembler=null),s.glArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,t.glBuffer),s.glArrayBuffer=t.glBuffer),r===o.byteLength?a.bufferSubData(t.glTarget,i,o):a.bufferSubData(t.glTarget,i,o.slice(0,r));break;case a.ELEMENT_ARRAY_BUFFER:s.glVAO&&(a.bindVertexArray(null),s.glVAO=VG.gpuInputAssembler=null),s.glElementArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t.glBuffer),s.glElementArrayBuffer=t.glBuffer),r===o.byteLength?a.bufferSubData(t.glTarget,i,o):a.bufferSubData(t.glTarget,i,o.slice(0,r));break;case a.UNIFORM_BUFFER:s.glUniformBuffer!==t.glBuffer&&(a.bindBuffer(a.UNIFORM_BUFFER,t.glBuffer),s.glUniformBuffer=t.glBuffer),r===o.byteLength?a.bufferSubData(t.glTarget,i,o):a.bufferSubData(t.glTarget,i,new Float32Array(o,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}var VG={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function WG(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),VG.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==Tr.UNKNOWN)switch(h.loadOp){case kr.LOAD:break;case kr.CLEAR:if(c.bs.targets[0].blendColorMask!==zr.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)xG[0]=r[u].x,xG[1]=r[u].y,xG[2]=r[u].z,xG[3]=r[u].w,s.clearBufferfv(s.COLOR,u,xG);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case kr.DISCARD:VG.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Tr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case kr.DISCARD:VG.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(aa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case kr.LOAD:break;case kr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case kr.DISCARD:VG.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&VG.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,VG.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==zr.ALL){var p=(f&zr.R)!==zr.NONE,d=(f&zr.G)!==zr.NONE,m=(f&zr.B)!==zr.NONE,v=(f&zr.A)!==zr.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function jG(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&VG.gpuPipelineState!==t){if(VG.gpuPipelineState=t,VG.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Yr.NONE:a.disable(a.CULL_FACE);break;case Yr.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Yr.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(OG[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,OG[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,DG[f.stencilFailOpFront],DG[f.stencilZFailOpFront],DG[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,OG[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,DG[f.stencilFailOpBack],DG[f.stencilZFailOpBack],DG[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var p=t.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var m=p.targets[0],v=s.bs.targets[0];v.blend!==m.blend&&(m.blend?a.enable(a.BLEND):a.disable(a.BLEND),v.blend=m.blend),v.blendEq===m.blendEq&&v.blendAlphaEq===m.blendAlphaEq||(a.blendEquationSeparate(NG[m.blendEq],NG[m.blendAlphaEq]),v.blendEq=m.blendEq,v.blendAlphaEq=m.blendAlphaEq),v.blendSrc===m.blendSrc&&v.blendDst===m.blendDst&&v.blendSrcAlpha===m.blendSrcAlpha&&v.blendDstAlpha===m.blendDstAlpha||(a.blendFuncSeparate(MG[m.blendSrc],MG[m.blendDst],MG[m.blendSrcAlpha],MG[m.blendDstAlpha]),v.blendSrc=m.blendSrc,v.blendDst=m.blendDst,v.blendSrcAlpha=m.blendSrcAlpha,v.blendDstAlpha=m.blendDstAlpha),v.blendColorMask!==m.blendColorMask&&(a.colorMask((m.blendColorMask&zr.R)!==zr.NONE,(m.blendColorMask&zr.G)!==zr.NONE,(m.blendColorMask&zr.B)!==zr.NONE,(m.blendColorMask&zr.A)!==zr.NONE),v.blendColorMask=m.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var g=c.glBlocks.length,y=t.gpuPipelineLayout.dynamicOffsetIndices,S=0;S<g;S++){var T=c.glBlocks[S],E=i[T.set],x=E&&E.descriptorIndices[T.binding],A=x>=0&&E.gpuDescriptors[x];if(A&&A.gpuBuffer){var b=y[T.set],C=b&&b[T.binding],w=A.gpuBuffer.glOffset;C>=0&&(w+=r[C]),s.glBindUBOs[T.glBinding]===A.gpuBuffer.glBuffer&&s.glBindUBOOffsets[T.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,T.glBinding,A.gpuBuffer.glBuffer,w,A.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,T.glBinding,A.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[T.glBinding]=A.gpuBuffer.glBuffer,s.glBindUBOOffsets[T.glBinding]=w)}else d("Buffer binding '"+T.name+"' at set "+T.set+" binding "+T.binding+" is not bounded")}for(var R=c.glSamplerTextures.length,P=0;P<R;P++)for(var I=c.glSamplerTextures[P],O=i[I.set],D=O&&O.descriptorIndices[I.binding],N=D>=0&&O.gpuDescriptors[D],M=0;M<I.units.length;M++){var L=I.units[M],B=s.glTexUnits[L];if(N&&N.gpuTexture&&N.gpuSampler){if(N.gpuTexture&&N.gpuTexture.size>0){var F=N.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=N.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}N=O.gpuDescriptors[++D]}else d("Sampler binding '"+I.name+"' at set "+I.set+" binding "+I.binding+" index "+M+" is not bounded")}}if(n&&c&&(l||VG.gpuInputAssembler!==n))if(VG.gpuInputAssembler=n,e.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var k;U=a.createVertexArray(),n.glVAOs.set(c.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];k=null;for(var V=0;V<n.glAttribs.length;V++){var W=n.glAttribs[V];if(W.name===H.name){k=W;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var j=0;j<k.componentCount;++j){var X=H.glLoc+j,q=k.offset+k.size*j;a.enableVertexAttribArray(X),s.glCurrentAttribLocs[X]=!0,a.vertexAttribPointer(X,k.count,k.glType,k.isNormalized,k.stride,q),a.vertexAttribDivisor(X,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(a.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(a.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,a.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),a.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var oe=0;oe<e.capabilities.maxVertexAttributes;++oe)s.glEnabledAttribLocs[oe]!==s.glCurrentAttribLocs[oe]&&(a.disableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!1)}if(t&&t.dynamicStates.length)for(var ae=t.dynamicStates.length,se=0;se<ae;se++)switch(t.dynamicStates[se]){case Kr.VIEWPORT:var ce=o.viewport;s.viewport.left===ce.left&&s.viewport.top===ce.top&&s.viewport.width===ce.width&&s.viewport.height===ce.height||(a.viewport(ce.left,ce.top,ce.width,ce.height),s.viewport.left=ce.left,s.viewport.top=ce.top,s.viewport.width=ce.width,s.viewport.height=ce.height);break;case Kr.SCISSOR:var le=o.scissor;s.scissorRect.x===le.x&&s.scissorRect.y===le.y&&s.scissorRect.width===le.width&&s.scissorRect.height===le.height||(a.scissor(le.x,le.y,le.width,le.height),s.scissorRect.x=le.x,s.scissorRect.y=le.y,s.scissorRect.width=le.width,s.scissorRect.height=le.height);break;case Kr.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Kr.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Kr.BLEND_CONSTANTS:var ue=o.blendConstant;s.bs.blendColor.x===ue.x&&s.bs.blendColor.y===ue.y&&s.bs.blendColor.z===ue.z&&s.bs.blendColor.w===ue.w||(a.blendColor(ue.x,ue.y,ue.z,ue.w),s.bs.blendColor.copy(ue));break;case Kr.STENCIL_WRITE_MASK:var he=o.stencilStatesFront,_e=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==he.writeMask&&(a.stencilMaskSeparate(a.FRONT,he.writeMask),s.dss.stencilWriteMaskFront=he.writeMask),s.dss.stencilWriteMaskBack!==_e.writeMask&&(a.stencilMaskSeparate(a.BACK,_e.writeMask),s.dss.stencilWriteMaskBack=_e.writeMask);break;case Kr.STENCIL_COMPARE_MASK:var fe=o.stencilStatesFront,pe=o.stencilStatesBack;s.dss.stencilRefFront===fe.reference&&s.dss.stencilReadMaskFront===fe.compareMask||(a.stencilFuncSeparate(a.FRONT,OG[s.dss.stencilFuncFront],fe.reference,fe.compareMask),s.dss.stencilRefFront=fe.reference,s.dss.stencilReadMaskFront=fe.compareMask),s.dss.stencilRefBack===pe.reference&&s.dss.stencilReadMaskBack===pe.compareMask||(a.stencilFuncSeparate(a.BACK,OG[s.dss.stencilFuncBack],pe.reference,pe.compareMask),s.dss.stencilRefBack=pe.reference,s.dss.stencilReadMaskBack=pe.compareMask)}}function XG(e,t){var n=e.gl,i=VG.gpuInputAssembler,r=VG.glPrimitive;if(i)if(i.gpuIndirectBuffer)for(var o=i.gpuIndirectBuffer.indirects,a=0;a<o.length;a++){var s=o[a],c=i.gpuIndexBuffer;if(s.instanceCount)if(c){if(s.indexCount>0){var l=s.firstIndex*c.stride;n.drawElementsInstanced(r,s.indexCount,i.glIndexType,l,s.instanceCount)}}else s.vertexCount>0&&n.drawArraysInstanced(r,s.firstVertex,s.vertexCount,s.instanceCount);else if(c){if(s.indexCount>0){var u=s.firstIndex*c.stride;n.drawElements(r,s.indexCount,i.glIndexType,u)}}else s.vertexCount>0&&n.drawArrays(r,s.firstVertex,s.vertexCount)}else if(t.instanceCount)if(i.gpuIndexBuffer){if(t.indexCount>0){var h=t.firstIndex*i.gpuIndexBuffer.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(i.gpuIndexBuffer){if(t.indexCount>0){var _=t.firstIndex*i.gpuIndexBuffer.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}var qG=new Array(IG.COUNT);function YG(e,t){qG.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=qG[i]++;switch(i){case IG.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];WG(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case IG.BIND_STATES:var a=t.bindStatesCmds.array[r];jG(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case IG.DRAW:XG(e,t.drawCmds.array[r].drawInfo);break;case IG.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];HG(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case IG.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];KG(e,c.buffers,c.gpuTexture,c.regions)}}}function KG(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=aa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ir.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var QG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Ar.INDIRECT&&(this._indirectBuffer=new xo),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&Ar.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&wr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Ar.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=VG.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Ar.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=VG.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Ar.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=VG.gpuInputAssembler=null),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=VG.gpuInputAssembler=null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&wr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Ar.VERTEX?(e.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=VG.gpuInputAssembler=null),i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&Ar.INDEX?(e.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=VG.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Ar.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Ar.INDIRECT||t.usage&Ar.TRANSFER_DST||t.usage&Ar.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Ar.INDIRECT?0:e.byteLength,HG(this._device,this._gpuBuffer,e,0,n))},k(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(va),ZG=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new te(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),JG=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new ZG(BG,1),this.bindStatesCmdPool=new ZG(FG,1),this.drawCmdPool=new ZG(zG,1),this.updateBufferCmdPool=new ZG(UG,1),this.copyBufferToTextureCmdPool=new ZG(kG,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),$G=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new GG,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ia,t._isStateInvalied=!1,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null);return!0},n.destroy=function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)},n.begin=function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._webGLAllocator.beginRenderPassCmdPool.alloc(BG);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(IG.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Qr.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Qr.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Qr.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Qr.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===$r.PRIMARY&&this._isInRenderPass||this._type===$r.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(zG);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(IG.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===$r.PRIMARY&&!this._isInRenderPass||this._type===$r.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._webGLAllocator.updateBufferCmdPool.alloc(UG),a=0;e.usage&Ar.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(IG.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===$r.PRIMARY&&!this._isInRenderPass||this._type===$r.SECONDARY){var i=t.gpuTexture;if(i){var r=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(kG);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(IG.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(FG);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(IG.BIND_STATES),this._isStateInvalied=!1},k(t,[{key:"webGLDevice",get:function(){return this._device}}]),t}(ga),eH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;return e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var n=e.gl,i=[],r=n.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var a=t.gpuColorTextures[o];a&&(a.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+o,a.glTarget,a.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+o,n.RENDERBUFFER,a.glRenderbuffer),i.push(n.COLOR_ATTACHMENT0+o))}var s=t.gpuDepthStencilTexture;if(s){var c=aa[s.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;s.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,c,s.glTarget,s.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,c,n.RENDERBUFFER,s.glRenderbuffer)}n.drawBuffers(i);var l=n.checkFramebufferStatus(n.FRAMEBUFFER);if(l!==n.FRAMEBUFFER_COMPLETE)switch(l){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},k(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Sa),tH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=AG(o.format,n),l=aa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:aa[o.format].count,stride:s.stride,componentCount:PG(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(this._device,this._gpuInputAssembler),!0},n.destroy=function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.gl.deleteVertexArray(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},k(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Aa),nH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&la)for(var _=0;_<h.count;_++)l.push(h.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t},!0},n.destroy=function(){this._bindings.length=0},k(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ca),iH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}return this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r},!0},n.destroy=function(){this._setLayouts.length=0},k(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(wa),rH=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],oH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);return this._gpuPipelineState={glPrimitive:rH[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r},!0},n.destroy=function(){this._gpuPipelineState=null},k(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Na),aH=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){WG(this._device,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),XG(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Ar.INDIRECT?0:t.byteLength,HG(this._device,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&KG(this._device,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];YG(this._device,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){jG(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}($G),sH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return this._type=e.type,!0},n.destroy=function(){},n.submit=function(e){if(!this._isAsync)for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Ma),cH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0},n.destroy=function(){this._gpuRenderPass=null},k(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(La),lH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuSampler=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){var t,n,i,r;return this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias,this._gpuSampler={glSampler:null,minFilter:this._minFilter,magFilter:this._magFilter,mipFilter:this._mipFilter,addressU:this._addressU,addressV:this._addressV,addressW:this._addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},t=this._device,n=this._gpuSampler,(r=(i=t.gl).createSampler())&&(n.minFilter===Dr.LINEAR||n.minFilter===Dr.ANISOTROPIC?n.mipFilter===Dr.LINEAR||n.mipFilter===Dr.ANISOTROPIC?n.glMinFilter=i.LINEAR_MIPMAP_LINEAR:n.mipFilter===Dr.POINT?n.glMinFilter=i.LINEAR_MIPMAP_NEAREST:n.glMinFilter=i.LINEAR:n.mipFilter===Dr.LINEAR||n.mipFilter===Dr.ANISOTROPIC?n.glMinFilter=i.NEAREST_MIPMAP_LINEAR:n.mipFilter===Dr.POINT?n.glMinFilter=i.NEAREST_MIPMAP_NEAREST:n.glMinFilter=i.NEAREST,n.magFilter===Dr.LINEAR||n.magFilter===Dr.ANISOTROPIC?n.glMagFilter=i.LINEAR:n.glMagFilter=i.NEAREST,n.glWrapS=EG[n.addressU],n.glWrapT=EG[n.addressV],n.glWrapR=EG[n.addressW],n.glSampler=r,i.samplerParameteri(r,i.TEXTURE_MIN_FILTER,n.glMinFilter),i.samplerParameteri(r,i.TEXTURE_MAG_FILTER,n.glMagFilter),i.samplerParameteri(r,i.TEXTURE_WRAP_S,n.glWrapS),i.samplerParameteri(r,i.TEXTURE_WRAP_T,n.glWrapT),i.samplerParameteri(r,i.TEXTURE_WRAP_R,n.glWrapR),i.samplerParameterf(r,i.TEXTURE_MIN_LOD,0),i.samplerParameterf(r,i.TEXTURE_MAX_LOD,1e3)),!0},n.destroy=function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},k(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Ba),uH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}return function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Ur.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ur.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,m=f.name.indexOf("[");p=-1!==m?f.name.substr(0,m):f.name;var g=n.getAttribLocation(t.glProgram,p),y=wG(f.type,n),S=RG(f.type,n);t.glInputs[_]={name:p,type:y,stride:S,count:f.size,size:S*f.size,glType:f.type,glLoc:g}}}var T,E,x,A,b=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(b){t.glBlocks=new Array(b);for(var C=0;C<b;++C){var w=(T=n.getActiveUniformBlockName(t.glProgram,C)).indexOf("[");-1!==w&&(T=T.substr(0,w)),A=null;for(var R=0;R<t.blocks.length;R++)if(t.blocks[R].name===T){A=t.blocks[R];break}if(A){E=C,x=n.getActiveUniformBlockParameter(t.glProgram,E,n.UNIFORM_BLOCK_DATA_SIZE);var P=A.binding+(e.bindingMappingInfo.bufferOffsets[A.set]||0);n.uniformBlockBinding(t.glProgram,E,P),t.glBlocks[C]={set:A.set,binding:A.binding,idx:E,name:T,size:x,glBinding:P}}else d("Block '"+T+"' does not bound")}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var I=0;I<t.samplerTextures.length;++I){var O=t.samplerTextures[I];t.glSamplerTextures[I]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:CG(O.type,n),glLoc:null}}}for(var D=[],N=[],M=e.stateCache.texUnitCacheMap,L=0,B=0;B<t.blocks.length;++B)t.blocks[B].set===e.bindingMappingInfo.flexibleSet&&L++;for(var F=0,z=0;z<t.samplerTextures.length;++z){var U=t.samplerTextures[z],k=n.getUniformLocation(t.glProgram,U.name);if(null===k||"number"!=typeof k&&-1===k.id||(D.push(t.glSamplerTextures[z]),N.push(k)),void 0===M[U.name]){var G=U.binding+e.bindingMappingInfo.samplerOffsets[U.set]+F;U.set===e.bindingMappingInfo.flexibleSet&&(G-=L),M[U.name]=G%e.capabilities.maxTextureUnits,F+=U.count-1}}if(D.length){for(var H=[],V=0;V<D.length;++V){var W=D[V],j=M[W.name];if(void 0!==j){W.glLoc=N[V];for(var X=0;X<W.count;++X){for(;H[j];)j=(j+1)%e.capabilities.maxTextureUnits;W.units.push(j),H[j]=!0}}}for(var q=0,Y=0;Y<D.length;++Y){var K=D[Y];if(!K.glLoc){for(K.glLoc=N[Y];H[q];)q++;for(var Q=0;Q<K.count;++Q){for(;H[q];)q=(q+1)%e.capabilities.maxTextureUnits;void 0===M[K.name]&&(M[K.name]=q),K.units.push(q),H[q]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var Z=0;Z<D.length;Z++){var J=D[Z];J.glUnits=new Int32Array(J.units),n.uniform1iv(J.glLoc,J.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=D}}(this._device,this._gpuShader),!0},n.destroy=function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},k(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Fa),hH=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new mo,this.scissorRect=new co(0,0,0,0),this.rs=new Ra,this.dss=new Pa,this.bs=new Oa,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),_H=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ua(this._width)&&ua(this._height),this._size=_a(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case Tr.A8:return t.ALPHA;case Tr.L8:return t.LUMINANCE;case Tr.LA8:return t.LUMINANCE_ALPHA;case Tr.R8:return t.R8;case Tr.R8SN:return t.R8_SNORM;case Tr.R8UI:return t.R8UI;case Tr.R8I:return t.R8I;case Tr.RG8:return t.RG8;case Tr.RG8SN:return t.RG8_SNORM;case Tr.RG8UI:return t.RG8UI;case Tr.RG8I:return t.RG8I;case Tr.RGB8:return t.RGB8;case Tr.RGB8SN:return t.RGB8_SNORM;case Tr.RGB8UI:return t.RGB8UI;case Tr.RGB8I:return t.RGB8I;case Tr.BGRA8:case Tr.RGBA8:return t.RGBA8;case Tr.RGBA8SN:return t.RGBA8_SNORM;case Tr.RGBA8UI:return t.RGBA8UI;case Tr.RGBA8I:return t.RGBA8I;case Tr.R16I:return t.R16I;case Tr.R16UI:return t.R16UI;case Tr.R16F:return t.R16F;case Tr.RG16I:return t.RG16I;case Tr.RG16UI:return t.RG16UI;case Tr.RG16F:return t.RG16F;case Tr.RGB16I:return t.RGB16I;case Tr.RGB16UI:return t.RGB16UI;case Tr.RGB16F:return t.RGB16F;case Tr.RGBA16I:return t.RGBA16I;case Tr.RGBA16UI:return t.RGBA16UI;case Tr.RGBA16F:return t.RGBA16F;case Tr.R32I:return t.R32I;case Tr.R32UI:return t.R32UI;case Tr.R32F:return t.R32F;case Tr.RG32I:return t.RG32I;case Tr.RG32UI:return t.RG32UI;case Tr.RG32F:return t.RG32F;case Tr.RGB32I:return t.RGB32I;case Tr.RGB32UI:return t.RGB32UI;case Tr.RGB32F:return t.RGB32F;case Tr.RGBA32I:return t.RGBA32I;case Tr.RGBA32UI:return t.RGBA32UI;case Tr.RGBA32F:return t.RGBA32F;case Tr.R5G6B5:return t.RGB565;case Tr.RGB5A1:return t.RGB5_A1;case Tr.RGBA4:return t.RGBA4;case Tr.SRGB8:return t.SRGB8;case Tr.SRGB8_A8:return t.SRGB8_ALPHA8;case Tr.RGB10A2:return t.RGB10_A2;case Tr.RGB10A2UI:return t.RGB10_A2UI;case Tr.R11G11B10F:return t.R11F_G11F_B10F;case Tr.D16:return t.DEPTH_COMPONENT16;case Tr.D16S8:return t.DEPTH24_STENCIL8;case Tr.D24:return t.DEPTH_COMPONENT24;case Tr.D24S8:return t.DEPTH24_STENCIL8;case Tr.D32F:return t.DEPTH_COMPONENT32F;case Tr.D32F_S8:return t.DEPTH32F_STENCIL8;case Tr.BC1:return Ck.COMPRESSED_RGB_S3TC_DXT1_EXT;case Tr.BC1_ALPHA:return Ck.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Tr.BC1_SRGB:return Ck.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Tr.BC1_SRGB_ALPHA:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Tr.BC2:return Ck.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Tr.BC2_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Tr.BC3:return Ck.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Tr.BC3_SRGB:return Ck.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Tr.ETC_RGB8:return Ck.COMPRESSED_RGB_ETC1_WEBGL;case Tr.ETC2_RGB8:return Ck.COMPRESSED_RGB8_ETC2;case Tr.ETC2_SRGB8:return Ck.COMPRESSED_SRGB8_ETC2;case Tr.ETC2_RGB8_A1:return Ck.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_SRGB8_A1:return Ck.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_RGBA8:return Ck.COMPRESSED_RGBA8_ETC2_EAC;case Tr.ETC2_SRGB8_A8:return Ck.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Tr.EAC_R11:return Ck.COMPRESSED_R11_EAC;case Tr.EAC_R11SN:return Ck.COMPRESSED_SIGNED_R11_EAC;case Tr.EAC_RG11:return Ck.COMPRESSED_RG11_EAC;case Tr.EAC_RG11SN:return Ck.COMPRESSED_SIGNED_RG11_EAC;case Tr.PVRTC_RGB2:return Ck.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGBA2:return Ck.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGB4:return Ck.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Tr.PVRTC_RGBA4:return Ck.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Tr.ASTC_RGBA_4X4:return Ck.COMPRESSED_RGBA_ASTC_4x4_KHR;case Tr.ASTC_RGBA_5X4:return Ck.COMPRESSED_RGBA_ASTC_5x4_KHR;case Tr.ASTC_RGBA_5X5:return Ck.COMPRESSED_RGBA_ASTC_5x5_KHR;case Tr.ASTC_RGBA_6X5:return Ck.COMPRESSED_RGBA_ASTC_6x5_KHR;case Tr.ASTC_RGBA_6X6:return Ck.COMPRESSED_RGBA_ASTC_6x6_KHR;case Tr.ASTC_RGBA_8X5:return Ck.COMPRESSED_RGBA_ASTC_8x5_KHR;case Tr.ASTC_RGBA_8X6:return Ck.COMPRESSED_RGBA_ASTC_8x6_KHR;case Tr.ASTC_RGBA_8X8:return Ck.COMPRESSED_RGBA_ASTC_8x8_KHR;case Tr.ASTC_RGBA_10X5:return Ck.COMPRESSED_RGBA_ASTC_10x5_KHR;case Tr.ASTC_RGBA_10X6:return Ck.COMPRESSED_RGBA_ASTC_10x6_KHR;case Tr.ASTC_RGBA_10X8:return Ck.COMPRESSED_RGBA_ASTC_10x8_KHR;case Tr.ASTC_RGBA_10X10:return Ck.COMPRESSED_RGBA_ASTC_10x10_KHR;case Tr.ASTC_RGBA_12X10:return Ck.COMPRESSED_RGBA_ASTC_12x10_KHR;case Tr.ASTC_RGBA_12X12:return Ck.COMPRESSED_RGBA_ASTC_12x12_KHR;case Tr.ASTC_SRGBA_4X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Tr.ASTC_SRGBA_5X4:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Tr.ASTC_SRGBA_5X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Tr.ASTC_SRGBA_6X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Tr.ASTC_SRGBA_6X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Tr.ASTC_SRGBA_8X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Tr.ASTC_SRGBA_8X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Tr.ASTC_SRGBA_8X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Tr.ASTC_SRGBA_10X5:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Tr.ASTC_SRGBA_10X6:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Tr.ASTC_SRGBA_10X8:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Tr.ASTC_SRGBA_10X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Tr.ASTC_SRGBA_12X10:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Tr.ASTC_SRGBA_12X12:return Ck.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=bG(t.format,n),t.glType=AG(t.format,n);var i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.samples===Or.X1){var a=n.createTexture();if(a&&t.size>0){t.glTexture=a;var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),t.glInternalFmt===Ck.COMPRESSED_RGB_ETC1_WEBGL){var c=ha(t.format,2,2,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,0,t.glInternalFmt,2,2,0,l)}else if(t.flags&Ir.IMMUTABLE)n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r);else if(aa[t.format].isCompressed)for(var u=0;u<t.mipLevel;++u){var h=ha(t.format,i,r,1),_=new Uint8Array(h);n.compressedTexImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,_),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var f=0;f<t.mipLevel;++f)n.texImage2D(n.TEXTURE_2D,f,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.deleteTexture(a)}else{var p=n.createRenderbuffer();p&&t.size>0&&(t.glRenderbuffer=p,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height))}break;case Rr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var d=Math.max(i,r);d>e.capabilities.maxCubeMapTextureSize&&C(9100,d,e.capabilities.maxTextureSize);var m=n.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),t.glInternalFmt===Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){var y=ha(t.format,2,2,1),S=new Uint8Array(y);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,t.glInternalFmt,2,2,0,S)}else if(t.flags&Ir.IMMUTABLE)n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r);else if(aa[t.format].isCompressed)for(var T=0;T<t.mipLevel;++T){for(var E=ha(t.format,i,r,1),x=new Uint8Array(E),A=0;A<6;++A)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+A,T,t.glInternalFmt,i,r,0,x);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var b=0;b<t.mipLevel;++b){for(var w=0;w<6;++w)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+w,b,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)},n.destroy=function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=_a(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Rr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.samples===Or.X1){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),aa[t.format].isCompressed){if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var c=ha(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else t.glRenderbuffer&&t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Rr.CUBE:t.type=Rr.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&C(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),aa[t.format].isCompressed){if(t.glInternalFmt!==Ck.COMPRESSED_RGB_ETC1_WEBGL)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ha(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Rr.TEX2D,t.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=n,this._device.memoryStatus.textureSize+=this._size)},k(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(za),fH="webglcontextlost",pH=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new hH,t.cmdAllocator=new JG,t.nullTex2D=null,t.nullTexCube=null,t._webGL2RC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!0,t._bindingMappingInfo=new go,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._OES_texture_float_linear=null,t._OES_texture_half_float_linear=null,t._EXT_color_buffer_float=null,t._EXT_disjoint_timer_query_webgl2=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_renderer_info=null,t._WEBGL_texture_storage_multisample=null,t._WEBGL_debug_shaders=null,t._WEBGL_lose_context=null,t}H(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:nt.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(fH,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=gr.WEBGL2,this._deviceName="WebGL2";var n=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=n.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=n.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=n.getParameter(n.RENDERER),this._vendor=n.getParameter(n.VENDOR)),this._version=n.getParameter(n.VERSION),this._caps.maxVertexAttributes=n.getParameter(n.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=n.getParameter(n.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=n.getParameter(n.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=n.getParameter(n.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._caps.depthBits=n.getParameter(n.DEPTH_BITS),this._caps.stencilBits=n.getParameter(n.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxUniformBufferBindings,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=e.width,this._height=e.height,this._colorFmt=Tr.RGBA8,32===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Tr.D32F_S8:this._depthStencilFmt=Tr.D32F:24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Tr.D24S8:this._depthStencilFmt=Tr.D24:8===this._caps.stencilBits?this._depthStencilFmt=Tr.D16S8:this._depthStencilFmt=Tr.D16,this._extensions=n.getSupportedExtensions();var i="";if(this._extensions){for(var r,o=Q(this._extensions);!(r=o()).done;)i+=r.value+" ";v("EXTENSIONS: "+i)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[Sr.TEXTURE_FLOAT]=!0,this._features[Sr.TEXTURE_HALF_FLOAT]=!0,this._features[Sr.FORMAT_R11G11B10F]=!0,this._features[Sr.FORMAT_SRGB]=!0,this._features[Sr.FORMAT_RGB8]=!0,this._features[Sr.ELEMENT_INDEX_UINT]=!0,this._features[Sr.INSTANCED_ARRAYS]=!0,this._features[Sr.MULTIPLE_RENDER_TARGETS]=!0,this._features[Sr.BLEND_MINMAX]=!0,this._EXT_color_buffer_float&&(this._features[Sr.COLOR_FLOAT]=!0,this._features[Sr.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Sr.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Sr.TEXTURE_HALF_FLOAT_LINEAR]=!0);var a="";this._WEBGL_compressed_texture_etc1&&(this._features[Sr.FORMAT_ETC1]=!0,a+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Sr.FORMAT_ETC2]=!0,a+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Sr.FORMAT_DXT]=!0,a+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Sr.FORMAT_PVRTC]=!0,a+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Sr.FORMAT_ASTC]=!0,a+="astc "),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+this._version),v("DPR: "+this._devicePixelRatio),v("SCREEN_SIZE: "+this._width+" x "+this._height),v("MAX_VERTEX_ATTRIBS: "+this._caps.maxVertexAttributes),v("MAX_VERTEX_UNIFORM_VECTORS: "+this._caps.maxVertexUniformVectors),v("MAX_FRAGMENT_UNIFORM_VECTORS: "+this._caps.maxFragmentUniformVectors),v("MAX_TEXTURE_IMAGE_UNITS: "+this._caps.maxTextureUnits),v("MAX_VERTEX_TEXTURE_IMAGE_UNITS: "+this._caps.maxVertexTextureUnits),v("MAX_UNIFORM_BUFFER_BINDINGS: "+this._caps.maxUniformBufferBindings),v("MAX_UNIFORM_BLOCK_SIZE: "+this._caps.maxUniformBlockSize),v("DEPTH_BITS: "+this._caps.depthBits),v("STENCIL_BITS: "+this._caps.stencilBits),v("UNIFORM_BUFFER_OFFSET_ALIGNMENT: "+this._caps.uboOffsetAlignment),this._EXT_texture_filter_anisotropic&&v("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),v("USE_VAO: "+this._useVAO),v("COMPRESSED_FORMAT: "+a),this.initStates(n),this._queue=this.createQueue(new $o(Jr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Jo(this._queue)),this.nullTex2D=this.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED,Tr.RGBA8,2,2,Ir.GEN_MIPMAP)),this.nullTexCube=new _H(this),this.nullTexCube.initialize(new Ao(Rr.CUBE,Pr.SAMPLED,Tr.RGBA8,2,2,Ir.GEN_MIPMAP,6));var s=new po;s.texExtent.width=2,s.texExtent.height=2;var c=new Uint8Array(this.nullTex2D.size);return c.fill(0),this.copyBuffersToTexture([c],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([c,c,c,c,c,c],this.nullTexCube,[s]),!0},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(fH,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGL2RC=null},n.resize=function(e,t){this._width===e&&this._height===t||(v("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)},n.flushCommands=function(){},n.acquire=function(){this.cmdAllocator.releaseCmds()},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===$r.PRIMARY?aH:$G)(this);return t.initialize(e)?t:null},n.createBuffer=function(e){var t=new QG(this);return t.initialize(e)?t:null},n.createTexture=function(e){var t=new _H(this);return t.initialize(e)?t:null},n.createSampler=function(e){var t=new lH(this);return t.initialize(e)?t:null},n.createDescriptorSet=function(e){var t=new TG(this);return t.initialize(e)?t:null},n.createShader=function(e){var t=new uH(this);return t.initialize(e)?t:null},n.createInputAssembler=function(e){var t=new tH(this);return t.initialize(e)?t:null},n.createRenderPass=function(e){var t=new cH(this);return t.initialize(e)?t:null},n.createFramebuffer=function(e){var t=new eH(this);return t.initialize(e)?t:null},n.createDescriptorSetLayout=function(e){var t=new nH(this);return t.initialize(e)?t:null},n.createPipelineLayout=function(e){var t=new iH(this);return t.initialize(e)?t:null},n.createPipelineState=function(e){var t=new oH(this);return t.initialize(e)?t:null},n.createQueue=function(e){var t=new sH(this);return t.initialize(e)?t:null},n.createGlobalBarrier=function(e){var t=new Ua(this);return t.initialize(e)?t:null},n.createTextureBarrier=function(e){var t=new ka(this);return t.initialize(e)?t:null},n.copyBuffersToTexture=function(e,t,n){KG(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ir.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},n.copyFramebufferToBuffer=function(e,t,n){var i=this._webGL2RC,r=e.gpuFramebuffer,o=r.gpuColorTextures[0].format,a=bG(o,i),s=AG(o,i),c=da(aa[o]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);for(var u,h=new c(t),_=Q(n);!(u=_()).done;){var f=u.value,p=f.texExtent.width,d=f.texExtent.height;i.readPixels(f.texOffset.x,f.texOffset.y,p,d,a,s,h)}this.stateCache.glFramebuffer!==l&&(i.bindFramebuffer(i.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)},n.blitFramebuffer=function(e,t,n,i,r){!function(e,t,n,i,r,o){var a=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(a.bindFramebuffer(a.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var s=n.glFramebuffer!==e.stateCache.glFramebuffer;s&&a.bindFramebuffer(a.DRAW_FRAMEBUFFER,n.glFramebuffer);var c=0;t.gpuColorTextures.length>0&&(c|=a.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(c|=a.DEPTH_BUFFER_BIT,aa[t.gpuDepthStencilTexture.format].hasStencil&&(c|=a.STENCIL_BUFFER_BIT));var l=o===Dr.LINEAR||o===Dr.ANISOTROPIC?a.LINEAR:a.NEAREST;a.blitFramebuffer(i.x,i.y,i.x+i.width,i.y+i.height,r.x,r.y,r.x+r.width,r.y+r.height,c,l),s&&a.bindFramebuffer(a.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,n,i,r)},n.getExtension=function(e){for(var t=["","WEBKIT_","MOZ_"],n=0;n<t.length;++n){var i=this.gl.getExtension(t[n]+e);if(i)return i}return null},n.initStates=function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)},n._onWebGLContextLost=function(e){A(11e3),p(e)},k(t,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_texture_storage_multisample",get:function(){return this._WEBGL_texture_storage_multisample}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}}]),t}(ya));i.WebGL2Device=pH;var dH=new Zn,mH=new _i;function vH(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData,h=o.iData;e.getWorldMatrix(mH);for(var _=0;_<s;_++){var f=r[_];Zn.set(dH,f.x,f.y,0),Zn.transformMat4(dH,dH,mH),u[a++]=dH.x,u[a++]=dH.y,u[a++]=dH.z,u[a++]=f.u,u[a++]=f.v,Kn.toArray(u,i,a),a+=4}for(var p=0,d=s/4;p<d;p++){var m=l+4*p;h[c++]=m,h[c++]=m+1,h[c++]=m+2,h[c++]=m+1,h[c++]=m+3,h[c++]=m+2}}var gH=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new yH;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,r=this._innerTextureInfos[n.getId()],o=t.x,a=t.y;if(r)o+=r.x,a+=r.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,a+=this._y,this._x+=s+2}var l={x:o,y:a,texture:this._texture};return this._innerSpriteFrames.push(e),l},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),yH=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=Jd.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new po;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(av),SH=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new gH(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=this._atlases[this._atlasIndex];t||(t=this.newAtlas());var n=t.insertSpriteFrame(e);return n||this._atlasIndex===this._maxAtlasCount?n:(t=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){var t=e._original._texture;this.deleteAtlasTexture(t)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(!t._original&&t.packable){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},k(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();SH.instance=void 0;var TH,EH=e("dynamicAtlasManager",SH.instance=new SH);i.internal.dynamicAtlasManager=EH;var xH,AH,bH,CH,wH=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],RH=e("SpriteFrame",Zc("cc.SpriteFrame")(TH=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.uvHash=0,t.unbiasUV=[],t.uvSliced=[],t._rect=new bi,t._offset=new mi,t._originalSize=new xi,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}H(t,e),t.createWithImage=function(e){var n=e instanceof vm?e:new vm(e),i=new av;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerHash=function(){return this._texture.getSamplerHash()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(C(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(C(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&EH&&EH.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,t=this.texture,n=t.width,i=t.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,s=this._capInsets[1],c=this._capInsets[3],l=e.height-s-c,u=this.uvSliced;if(u.length=0,this._rotated){wH[0].u=e.x/n,wH[1].u=(e.x+c)/n,wH[2].u=(e.x+c+l)/n,wH[3].u=(e.x+e.height)/n,wH[3].v=e.y/i,wH[2].v=(e.y+r)/i,wH[1].v=(e.y+r+a)/i,wH[0].v=(e.y+e.width)/i;for(var h=0;h<4;++h)for(var _=wH[h],f=0;f<4;++f){var p=wH[3-f];u.push({u:_.u,v:p.v})}}else{wH[0].u=e.x/n,wH[1].u=(e.x+r)/n,wH[2].u=(e.x+r+a)/n,wH[3].u=(e.x+e.width)/n,wH[3].v=e.y/i,wH[2].v=(e.y+s)/i,wH[1].v=(e.y+s+l)/i,wH[0].v=(e.y+e.height)/i;for(var d=0;d<4;++d)for(var m=wH[d],v=0;v<4;++v){var g=wH[v];u.push({u:g.u,v:m.v})}}},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var p=0===r?0:e.x/r,d=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):this._isFlipUVX?(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v):this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,S=0===o?1:(e.y+e.height)/o,T=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=T,n[2]=g,n[3]=T,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVX?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=T,n[6]=g,n[7]=T):this._isFlipUVY?(n[0]=g,n[1]=T,n[2]=y,n[3]=T,n[4]=g,n[5]=S,n[6]=y,n[7]=S):(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=T,n[6]=y,n[7]=T)}for(var E="",x=0;x<t.length;x++)E+=t[x];this.uvHash=xa(E,666);var A=this.vertices;if(A){A.nu.length=0,A.nv.length=0;for(var b=0;b<A.u.length;b++)A.nu[b]=A.u[b]/r,A.nv[b]=A.v[b]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=EH;if(e){var t=this._texture;if(t instanceof av&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new bi(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new mi(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new xi(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),l.uvHash=this.uvHash,(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new bi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new xi(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new av;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},k(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Cu))||TH);i.SpriteFrame=RH;var PH,IH=e("SpriteAtlas",Zc("cc.SpriteAtlas")((CH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",bH,Y(t)),t}H(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Se();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],Xe(RH))},t}(Cu),bH=J((AH=CH).prototype,"spriteFrames",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Se()}}),xH=AH))||xH);i.SpriteAtlas=IH;var OH,DH,NH,MH,LH=e("Font",Zc("cc.Font")(PH=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(Cu))||PH);i.Font=LH;var BH,FH,zH,UH,kH,GH,HH,VH,WH,jH=e("TTFFont",Zc("cc.TTFFont")((MH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",NH,Y(t)),t}return H(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},k(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:zi(this._native),__isNative__:!0}}}]),t}(LH),NH=J((DH=MH).prototype,"_fontFamily",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J(DH.prototype,"_nativeAsset",[Ul,Rl],Object.getOwnPropertyDescriptor(DH.prototype,"_nativeAsset"),DH.prototype),J(DH.prototype,"_nativeDep",[Ul],Object.getOwnPropertyDescriptor(DH.prototype,"_nativeDep"),DH.prototype),OH=DH))||OH);i.TTFFont=jH;var XH,qH=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},YH=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new qH;Oe(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),KH=e("BitmapFont",(BH=Zc("cc.BitmapFont"),FH=Pl(RH),BH((WH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",kH,Y(t)),Z(t,"spriteFrame",GH,Y(t)),Z(t,"fontSize",HH,Y(t)),Z(t,"fntConfig",VH,Y(t)),t}return H(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new YH(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new qH,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else p("The fnt config is not exists!")},t}(LH),kH=J((UH=WH).prototype,"fntDataStr",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),GH=J(UH.prototype,"spriteFrame",[FH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HH=J(UH.prototype,"fontSize",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),VH=J(UH.prototype,"fntConfig",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zH=UH))||zH));i.BitmapFont=KH;var QH=e("LabelAtlas",Zc("cc.LabelAtlas")(XH=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(KH))||XH);i.LabelAtlas=QH;var ZH=e("BASELINE_RATIO",.26),JH=e("MIDDLE_RATIO",(ZH+1)/2-ZH);var $H=new qe(2);$H.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var eV,tV=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=$H.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,$H.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),nV=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,iV=/^[!,.:;'}\]%\?>、‘“》？。，！]/,rV=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,oV=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,aV=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function sV(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function cV(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function lV(e,t,n){var i=(n||e.font)+"🎮"+t,r=tV.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return tV.put(i,a),a}function uV(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function hV(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=uV(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=t-i(s=uV(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=nV.exec(s);u=_?_[0].length:1,l=s}c=t-i(s=uV(o,a+=u))}0==(a-=u)?(a=1,l=uV(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=uV(o,2));var f=uV(o,0,a),p=void 0;iV.test(l||s)&&(0==(a-=(p=rV.exec(f))?p[0].length:0)&&(a=1),l=uV(o,a),f=uV(o,0,a)),aV.test(l)&&(p=oV.exec(f))&&f!==p[0]&&(l=uV(o,a-=p[0].length),f=uV(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var _V,fV,pV,dV,mV,vV,gV,yV,SV,TV,EV,xV,AV,bV,CV,wV=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return eV||(eV=new e),eV};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=nt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),RV=Kn.WHITE.clone(),PV=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},IV="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",OV=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=wV.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=lV(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+ZH)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*ZH/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new vm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=IV,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*JH+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||RV;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),DV=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=Jd.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new po;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(av),NV=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new DV;n.initWithSize(e,t),this.fontDefDictionary=new YH(n),this._halfBleed=1,this._width=e,this._height=t,DD.on(OD.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=DD.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return A(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new PV;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new DV;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new OV(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},k(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),MV={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Kn.WHITE.clone(),isOutlined:!1,out:Kn.WHITE.clone(),margin:0},LV=function(){this.material=null,this.vertexCount=0,this.indicesCount=0},BV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._data=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}H(t,e),t.add=function(){return UV.add()},t.remove=function(e){var t=UV.data.indexOf(e);-1!==t&&(UV.data[t].clear(),UV.removeAt(t))};var n=t.prototype;return n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0},k(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)zV.free(t[i]);for(i=n;i<e;i++)t[i]=zV.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(LV),FV=function(e){function t(t){var n;return void 0===t&&(t=9),(n=e.call(this)||this).vData=void 0,n.iData=void 0,n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n.lastFilledIndices=0,n.lastFilledVertex=0,n._formatByte=void 0,n._formatByte=t*Float32Array.BYTES_PER_ELEMENT,n.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n}H(t,e),t.add=function(){return kV.add()},t.remove=function(e){var t=kV.data.indexOf(e);-1!==t&&(kV.data[t].reset(),kV.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this.byteCount+e*this._formatByte;return this.reserve(e,t),this.vertexCount+=e,this.indicesCount+=t,this.byteCount=n,!0},n.reserve=function(e,t){var n=this.byteCount+e*this._formatByte,i=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.advance=function(e,t){this.vertexCount+=e,this.indicesCount+=t,this.byteCount+=e*this._formatByte},n.reset=function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),this.iData.set(i,0)},k(t,[{key:"formatByte",get:function(){return this._formatByte},set:function(e){this._formatByte=e}},{key:"floatStride",get:function(){return this._formatByte>>2}},{key:"vDataOffset",get:function(){return this.byteCount>>>2}}]),t}(LV),zV=(function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;n._fillQuadBuffer=function(){for(var e=this.iData.length/6,t=this.iData,n=0,i=0;n<e;n++){var r=4*n;t[i++]=r,t[i++]=r+1,t[i++]=r+2,t[i++]=r+1,t[i++]=r+3,t[i++]=r+2}},n._reallocBuffer=function(t,n){e.prototype._reallocBuffer.call(this,t,n),this._fillQuadBuffer()}}(FV),new $((function(){return{x:0,y:0,z:0,u:0,v:0,color:Kn.WHITE.clone()}}),128)),UV=new ee((function(){return new BV}),32),kV=new ee((function(){return new FV}),32),GV=new mi,HV=new mi,VV=new _i,WV=new _i,jV=new _i,XV=new _i(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),qV=new bi,YV=function(t){return e({UITransform:t,UITransformComponent:t}),t}((_V=Zc("cc.UITransform"),fV=_l(),pV=$c(110),dV=cl(),mV=El(),vV=ml(),gV=El(),yV=ml(),_V(SV=fV(SV=pV(SV=dV(SV=el(SV=sl((bV=AV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,Z(t,"_contentSize",EV,Y(t)),Z(t,"_anchorPoint",xV,Y(t)),t}H(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(NA.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(NA.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(NA.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(NA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e,t){for(var n=this._contentSize.width,i=this._contentSize.height,r=GV,o=HV,a=this._getRenderScene().cameras,s=0;s<a.length;s++){var c=a[s];if(c.visibility&this.node.layer){c.node.getWorldRT(VV);var l=VV.m12,u=VV.m13,h=hD.center;if(VV.m12=h.x-(VV.m00*l+VV.m04*u),VV.m13=h.y-(VV.m01*l+VV.m05*u),_i.invert(VV,VV),mi.transformMat4(r,e,VV),this.node.getWorldMatrix(jV),_i.invert(VV,jV),!_i.strictEquals(VV,XV)){mi.transformMat4(o,r,VV),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var _=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(_=!0,t&&t.mask))for(var f=t.mask,p=this.node,d=f?f.length:0,m=0,v=0;p&&v<d;++m,p=p.parent){var g=f[v];if(m===g.index){if(p!==g.comp.node){f.length=v;break}var y=g.comp;if(y&&y._enabled&&!y.isHit(r)){_=!1;break}v++}else if(m>g.index){f.length=v;break}}if(_)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(jV),_i.invert(VV,jV),t||(t=new Zn),Zn.transformMat4(t,e,VV)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(jV),t||(t=new Zn),Zn.transformMat4(t,e,jV)},n.getBoundingBox=function(){_i.fromRTS(WV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new bi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(WV),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(jV),this.getBoundingBoxTo(jV)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){_i.fromRTS(WV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new bi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(_i.multiply(jV,e,WV),r.transformMat4(jV),!this.node.children)return r;for(var o,a=Q(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&bi.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;qV.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),qV.transformMat4(this.node.worldMatrix);var i=qV.x+.5*qV.width,r=qV.y+.5*qV.height,o=this.node.worldPosition.z,a=qV.width/2,s=qV.height/2;return null!=e?(Rc.set(e,i,r,o,a,s,.001),e):new Rc(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&e.markForUpdateRenderData()},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},k(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(NA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(NA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(NA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(NA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(NA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(NA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?A(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=DD.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=DD.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(qu),AV.EventType=NA,AV.priorityChangeNodeMap=new Map,J((TV=bV).prototype,"contentSize",[mV,vV],Object.getOwnPropertyDescriptor(TV.prototype,"contentSize"),TV.prototype),J(TV.prototype,"anchorPoint",[gV,yV],Object.getOwnPropertyDescriptor(TV.prototype,"anchorPoint"),TV.prototype),EV=J(TV.prototype,"_contentSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xi(100,100)}}),xV=J(TV.prototype,"_anchorPoint",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(.5,.5)}}),SV=TV))||SV)||SV)||SV)||SV)||SV)||SV));DD.on(OD.EVENT_AFTER_UPDATE,YV._sortSiblings),DD.on(OD.EVENT_BEFORE_SCENE_LAUNCH,YV._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(CV||(CV={}));var KV,QV,ZV,JV,$V,eW,tW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,pW=e("StencilManager",function(){function e(){this.stage=CV.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Mr.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Lr.KEEP,zFailOp:Lr.KEEP,passOp:Lr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?CV.CLEAR_INVERTED:CV.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?CV.ENTER_LEVEL_INVERTED:CV.ENTER_LEVEL},t.enableMask=function(){this.stage=CV.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=CV.DISABLED:this.stage=CV.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=CV.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Mr.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new Pa(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===CV.DISABLED?(t.stencilTest=!1,t.func=Mr.ALWAYS,t.failOp=Lr.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===CV.ENABLED?(t.func=Mr.EQUAL,t.failOp=Lr.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===CV.CLEAR?(t.func=Mr.NEVER,t.failOp=Lr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===CV.CLEAR_INVERTED||e===CV.ENTER_LEVEL?(t.func=Mr.NEVER,t.failOp=Lr.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===CV.ENTER_LEVEL_INVERTED&&(t.func=Mr.NEVER,t.failOp=Lr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},k(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());pW.sharedManager=null,pW.sharedManager=new pW,et(Br),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(fW||(fW=e("InstanceMaterialType",{})));var dW,mW,vW,gW,yW,SW,TW,EW,xW,AW,bW,CW,wW,RW,PW,IW,OW,DW,NW,MW,LW,BW,FW,zW,UW,kW,GW,HW,VW,WW,jW,XW,qW,YW,KW,QW,ZW,JW,$W,ej,tj,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,_j,fj,pj,dj,mj,vj,gj,yj,Sj,Tj,Ej,xj,Aj,bj=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((KV=Zc("cc.Renderable2D"),QV=Jc(YV),ZV=pl(),JV=Pl(Ag),$V=Pl(Ag),eW=El(),tW=dl(),nW=El(),iW=ml(),KV(rW=QV(rW=el(rW=sl((_W=hW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_materials",aW,Y(t)),Z(t,"_customMaterial",sW,Y(t)),t.stencilStage=CV.DISABLED,Z(t,"_srcBlendFactor",cW,Y(t)),Z(t,"_dstBlendFactor",lW,Y(t)),Z(t,"_color",uW,Y(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=fW.ADD_COLOR_AND_TEXTURE,t._blendState=new Oa,t._blendHash=0,t._colorDirty=!0,t._cacheAlpha=1,t._lastParent=null,t}H(t,e);var n=t.prototype;return n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._updateBlendFunc()},n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(NA.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(NA.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender()},n.onDisable=function(){this.node.off(NA.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(NA.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++)this._materialInstances[e]&&this._materialInstances[e].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)},n.requestRenderData=function(){var e=BV.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(BV.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))},n.postUpdateAssembler=function(e){this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._checkAndUpdateRenderData=function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0},n._postCanRender=function(){},n._updateColor=function(){var e=this._cacheAlpha<=0;this._updateWorldAlpha(),this._colorDirty&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),e&&(this._renderFlag=this._canRender()),this._colorDirty=!1)},n._updateWorldAlpha=function(){var e=this.color.a/255;1===e&&(e=this.node._uiProps.localOpacity);var t=this.node._uiProps.opacity*e;this.node._uiProps.opacity=t,this._colorDirty=this._colorDirty||t!==this._cacheAlpha,this._cacheAlpha=t},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Ia,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Br.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case fW.ADD_COLOR:e=Gv.get("ui-base-material");break;case fW.GRAYSCALE:e=Gv.get("ui-sprite-gray-material");break;case fW.USE_ALPHA_SEPARATED:e=Gv.get("ui-sprite-alpha-sep-material");break;case fW.USE_ALPHA_SEPARATED_AND_GRAY:e=Gv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Gv.get("ui-sprite-material")}return e},n._setCacheAlpha=function(e){this._cacheAlpha=e},k(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&A(12001),this._srcBlendFactor},set:function(e){this._customMaterial?A(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&A(12001),this._dstBlendFactor},set:function(e){this._customMaterial?A(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._colorDirty=!0)}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),t}(qL),hW.BlendState=Br,hW.Assembler=null,hW.PostAssembler=null,aW=J((oW=_W).prototype,"_materials",[Ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),J(oW.prototype,"sharedMaterials",[Ul,ZV],Object.getOwnPropertyDescriptor(oW.prototype,"sharedMaterials"),oW.prototype),sW=J(oW.prototype,"_customMaterial",[JV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J(oW.prototype,"customMaterial",[$V,eW,tW],Object.getOwnPropertyDescriptor(oW.prototype,"customMaterial"),oW.prototype),J(oW.prototype,"color",[nW,iW],Object.getOwnPropertyDescriptor(oW.prototype,"color"),oW.prototype),cW=J(oW.prototype,"_srcBlendFactor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Br.SRC_ALPHA}}),lW=J(oW.prototype,"_dstBlendFactor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Br.ONE_MINUS_SRC_ALPHA}}),uW=J(oW.prototype,"_color",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kn.WHITE.clone()}}),rW=oW))||rW)||rW)||rW)||rW));i.internal.Renderable2D=bj,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(Tj||(Tj=e("HorizontalTextAlignment",{}))),et(Tj),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(Ej||(Ej=e("VerticalTextAlignment",{}))),et(Ej),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(xj||(xj=e("Overflow",{}))),et(xj),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(Aj||(Aj=e("CacheMode",{}))),et(Aj);var Cj,wj,Rj,Pj=function(t){return e({Label:t,LabelComponent:t}),t}((dW=Zc("cc.Label"),mW=_l(),vW=$c(110),gW=cl(),yW=El(),SW=ml(),TW=Pl(Tj),EW=El(),xW=ml(),AW=Pl(Ej),bW=El(),CW=ml(),wW=El(),RW=ml(),PW=El(),IW=pl(),OW=ml(),DW=El(),NW=ml(),MW=Pl(xj),LW=El(),BW=ml(),FW=El(),zW=ml(),UW=Pl(LH),kW=El(),GW=pl(),HW=ml(),VW=El(),WW=ml(),jW=Pl(Aj),XW=El(),qW=ml(),YW=El(),KW=ml(),QW=El(),ZW=ml(),JW=El(),$W=ml(),ej=pl(),dW(tj=mW(tj=vW(tj=gW((Sj=yj=function(e){function t(){var t;return Z(t=e.call(this)||this,"_string",ij,Y(t)),Z(t,"_horizontalAlign",rj,Y(t)),Z(t,"_verticalAlign",oj,Y(t)),Z(t,"_actualFontSize",aj,Y(t)),Z(t,"_fontSize",sj,Y(t)),Z(t,"_fontFamily",cj,Y(t)),Z(t,"_lineHeight",lj,Y(t)),Z(t,"_overflow",uj,Y(t)),Z(t,"_enableWrapText",hj,Y(t)),Z(t,"_font",_j,Y(t)),Z(t,"_isSystemFontUsed",fj,Y(t)),t._spacingX=0,Z(t,"_isItalic",pj,Y(t)),Z(t,"_isBold",dj,Y(t)),Z(t,"_isUnderline",mj,Y(t)),Z(t,"_underlineHeight",vj,Y(t)),Z(t,"_cacheMode",gj,Y(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}H(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var t=this._ttfSpriteFrame.texture;if(t&&null===this._ttfSpriteFrame.original){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this._texture,this._assembler,null)},n._updateColor=function(){this._updateWorldAlpha(),this._colorDirty&&(this.updateRenderData(!1),this._colorDirty=!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof KH){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof KH){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===Aj.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new RH,this._assemblerData=this._assembler.getAssemblerData();var n=new vm(this._assemblerData.canvas),i=new av;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==Aj.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==Aj.CHAR){var t=this._texture.texture;if(t instanceof Fm){var n=t.getPixelFormat();e=n===Jd.RGBA_ETC1||n===Jd.RGB_A_PVRTC_4BPPV1||n===Jd.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?fW.USE_ALPHA_SEPARATED:fW.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},k(t,[{key:"string",get:function(){return this._string},set:function(e){e?e+="":e="",this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==Aj.BITMAP||this._font instanceof KH||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===Aj.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof KH?this._font.fontSize:-1}}]),t}(bj),yj.HorizontalAlign=Tj,yj.VerticalAlign=Ej,yj.Overflow=xj,yj.CacheMode=Aj,yj._canvasPool=wV.getInstance(),J((nj=Sj).prototype,"string",[yW,SW,xl],Object.getOwnPropertyDescriptor(nj.prototype,"string"),nj.prototype),J(nj.prototype,"horizontalAlign",[TW,EW,xW],Object.getOwnPropertyDescriptor(nj.prototype,"horizontalAlign"),nj.prototype),J(nj.prototype,"verticalAlign",[AW,bW,CW],Object.getOwnPropertyDescriptor(nj.prototype,"verticalAlign"),nj.prototype),J(nj.prototype,"fontSize",[wW,RW],Object.getOwnPropertyDescriptor(nj.prototype,"fontSize"),nj.prototype),J(nj.prototype,"fontFamily",[PW,IW,OW],Object.getOwnPropertyDescriptor(nj.prototype,"fontFamily"),nj.prototype),J(nj.prototype,"lineHeight",[DW,NW],Object.getOwnPropertyDescriptor(nj.prototype,"lineHeight"),nj.prototype),J(nj.prototype,"overflow",[MW,LW,BW],Object.getOwnPropertyDescriptor(nj.prototype,"overflow"),nj.prototype),J(nj.prototype,"enableWrapText",[FW,zW],Object.getOwnPropertyDescriptor(nj.prototype,"enableWrapText"),nj.prototype),J(nj.prototype,"font",[UW,kW,GW,HW],Object.getOwnPropertyDescriptor(nj.prototype,"font"),nj.prototype),J(nj.prototype,"useSystemFont",[VW,WW],Object.getOwnPropertyDescriptor(nj.prototype,"useSystemFont"),nj.prototype),J(nj.prototype,"cacheMode",[jW,XW,qW],Object.getOwnPropertyDescriptor(nj.prototype,"cacheMode"),nj.prototype),J(nj.prototype,"isBold",[YW,KW],Object.getOwnPropertyDescriptor(nj.prototype,"isBold"),nj.prototype),J(nj.prototype,"isItalic",[QW,ZW],Object.getOwnPropertyDescriptor(nj.prototype,"isItalic"),nj.prototype),J(nj.prototype,"isUnderline",[JW,$W],Object.getOwnPropertyDescriptor(nj.prototype,"isUnderline"),nj.prototype),J(nj.prototype,"underlineHeight",[ej,fl],Object.getOwnPropertyDescriptor(nj.prototype,"underlineHeight"),nj.prototype),ij=J(nj.prototype,"_string",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),rj=J(nj.prototype,"_horizontalAlign",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tj.CENTER}}),oj=J(nj.prototype,"_verticalAlign",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ej.CENTER}}),aj=J(nj.prototype,"_actualFontSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sj=J(nj.prototype,"_fontSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),cj=J(nj.prototype,"_fontFamily",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),lj=J(nj.prototype,"_lineHeight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),uj=J(nj.prototype,"_overflow",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xj.NONE}}),hj=J(nj.prototype,"_enableWrapText",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_j=J(nj.prototype,"_font",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fj=J(nj.prototype,"_isSystemFontUsed",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pj=J(nj.prototype,"_isItalic",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dj=J(nj.prototype,"_isBold",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mj=J(nj.prototype,"_isUnderline",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vj=J(nj.prototype,"_underlineHeight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),gj=J(nj.prototype,"_cacheMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aj.NONE}}),tj=nj))||tj)||tj)||tj)||tj));!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(Cj||(Cj={})),et(Cj),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(wj||(wj={})),et(wj),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(Rj||(Rj={})),et(Rj);var Ij=Math.PI,Oj=Math.min,Dj=Math.max,Nj=Math.cos,Mj=Math.sin,Lj=Math.abs,Bj=Math.sign,Fj=.5522847493;function zj(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*Fj,t-i*Fj,n+r,t,n+r),e.bezierCurveTo(t+i*Fj,n+r,t+i,n+r*Fj,t+i,n),e.bezierCurveTo(t+i,n-r*Fj,t+i*Fj,n-r,t,n-r),e.bezierCurveTo(t-i*Fj,n-r,t-i,n-r*Fj,t-i,n),e.close()}function Uj(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,p,d,m,v,g,y,S,T,E,x,A,b,C;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(p=.5*(r+a))),((b=Lj((i-s)*(A=c-n)-(r-c)*(x=s-t)))+(C=Lj((o-s)*A-(a-c)*x)))*(b+C)<e.tessTol*(x*x+A*A)?e.addPoint(s,c,0===u?u|Rj.PT_BEVEL:u):(Uj(e,t,n,h,_,v,g,T=.5*(v+(y=.5*(f+d))),E=.5*(g+(S=.5*(p+m))),l+1,0),Uj(e,T,E,y,S,d,m,s,c,l+1,u)))}var kj,Gj,Hj,Vj,Wj,jj,Xj,qj,Yj,Kj,Qj,Zj,Jj,$j,eX,tX,nX,iX,rX,oX,aX,sX,cX=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return H(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(mi),lX=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),uX=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Kn.WHITE.clone(),this.lineCap=Cj.BUTT,this.strokeColor=Kn.BLACK.clone(),this.lineJoin=wj.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,Rj.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,Rj.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(Uj(this,s.x,s.y,e,t,n,i,r,o,0,Rj.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,S=0,T=0,E=0;if(u=o-r,a=a||!1)if(Lj(u)>=2*Ij)u=2*Ij;else for(;u<0;)u+=2*Ij;else if(Lj(u)>=2*Ij)u=2*-Ij;else for(;u>0;)u-=2*Ij;for(c=0|Dj(1,Oj(Lj(u)/(.5*Ij)+.5,5)),h=Lj(4/3*(1-Nj(s=u/c/2))/Mj(s)),a||(h=-h),E=0;E<=c;E++)p=t+(_=Nj(l=r+u*(E/c)))*i,d=n+(f=Mj(l))*i,m=-f*i*h,v=_*i*h,0===E?e.moveTo(p,d):e.bezierCurveTo(g+S,y+T,p-m,d-v,p,d),g=p,y=d,S=m,T=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){zj(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){zj(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=Oj(o,.5*Lj(i))*Bj(i),s=Oj(o,.5*Lj(r))*Bj(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-Fj),t+a*(1-Fj),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-Fj),n+r,t+i,n+r-s*(1-Fj),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-Fj),t+i-a*(1-Fj),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-Fj),n,t,n+s*(1-Fj),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&FV.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=FV.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new cX(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new lX,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),hX=[new Bo(ro.ATTR_POSITION,Tr.RGB32F)],_X=[new Bo(ro.ATTR_POSITION,Tr.RGB32F),new Bo(ro.ATTR_COLOR,Tr.RGBA32F)],fX=[new Bo(ro.ATTR_POSITION,Tr.RGB32F),new Bo(ro.ATTR_TEX_COORD,Tr.RG32F),new Bo(ro.ATTR_COLOR,Tr.RGBA32F)],pX=[new Bo(ro.ATTR_POSITION,Tr.RGB32F),new Bo(ro.ATTR_TEX_COORD,Tr.RG32F),new Bo(ro.ATTR_COLOR,Tr.RGBA32F),new Bo(ro.ATTR_COLOR2,Tr.RGBA32F)];function dX(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=aa[i.format].count}return t}function mX(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=aa[i.format].size}return t}i.internal.vfmtPosUvColor=fX,i.internal.vfmtPosUvTwoColor=pX,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:hX,vfmtPosColor:_X,vfmtPosUvColor:fX,vfmtPosUvTwoColor:pX,getComponentPerVertex:dX,getAttributeStride:mX}));var vX,gX,yX,SX,TX,EX,xX,AX,bX,CX,wX,RX,PX,IX,OX,DX,NX,MX,LX,BX,FX,zX,UX,kX,GX,HX,VX=_X.concat([new Bo("a_dist",Tr.R32F)]),WX=dX(VX),jX=mX(VX),XX=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((kj=Zc("cc.Graphics"),Gj=_l(),Hj=$c(110),Vj=cl(),Wj=Pl(wj),jj=ml(),Xj=Pl(Cj),qj=ml(),Yj=ml(),Kj=ml(),Qj=ml(),Zj=pl(),kj(Jj=Gj(Jj=Hj(Jj=Vj((sX=aX=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,Z(t,"_lineWidth",eX,Y(t)),Z(t,"_strokeColor",tX,Y(t)),Z(t,"_lineJoin",nX,Y(t)),Z(t,"_lineCap",iX,Y(t)),Z(t,"_fillColor",rX,Y(t)),Z(t,"_miterLimit",oX,Y(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=fW.ADD_COLOR,t.impl=new uX,t}H(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=DD.root.createModel(ig),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&(DD.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Gv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=i.director.root.device,n=t.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.DEVICE,65535*jX,jX)),r=t.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new Iw([n],VX,jr.TRIANGLE_LIST,r);o.subMeshIdx=0,this.model.initSubModel(e,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else A(4500,this.node.name)},n._uploadData=function(e){var t=this.impl;if(t){var n=t&&t.getRenderDataList();if(!(n.length<=0)&&this.model){for(var i=this.model.subModels,r=0;r<n.length;r++){var o=n[r],a=i[r].inputAssembler;if(o.lastFilledVertex!==o.vertexStart){var s=new Float32Array(o.vData.buffer,0,o.vertexStart*WX);a.vertexBuffers[0].update(s),a.vertexCount=o.vertexStart;var c=new Uint16Array(o.iData.buffer,0,o.indicesStart);a.indexBuffer.update(c),a.indexCount=o.indicesStart,o.lastFilledVertex=o.vertexStart,o.lastFilledIndices=o.indicesStart}}e.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}e.addUploadBuffersFunc(this,this._uploadData)}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},k(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(bj),aX.LineJoin=wj,aX.LineCap=Cj,J(($j=sX).prototype,"lineWidth",[fl],Object.getOwnPropertyDescriptor($j.prototype,"lineWidth"),$j.prototype),J($j.prototype,"lineJoin",[Wj,jj],Object.getOwnPropertyDescriptor($j.prototype,"lineJoin"),$j.prototype),J($j.prototype,"lineCap",[Xj,qj],Object.getOwnPropertyDescriptor($j.prototype,"lineCap"),$j.prototype),J($j.prototype,"strokeColor",[Yj],Object.getOwnPropertyDescriptor($j.prototype,"strokeColor"),$j.prototype),J($j.prototype,"fillColor",[Kj],Object.getOwnPropertyDescriptor($j.prototype,"fillColor"),$j.prototype),J($j.prototype,"miterLimit",[Qj],Object.getOwnPropertyDescriptor($j.prototype,"miterLimit"),$j.prototype),J($j.prototype,"color",[Ul,Zj],Object.getOwnPropertyDescriptor($j.prototype,"color"),$j.prototype),eX=J($j.prototype,"_lineWidth",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tX=J($j.prototype,"_strokeColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kn.BLACK.clone()}}),nX=J($j.prototype,"_lineJoin",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wj.MITER}}),iX=J($j.prototype,"_lineCap",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cj.BUTT}}),rX=J($j.prototype,"_fillColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kn.WHITE.clone()}}),oX=J($j.prototype,"_miterLimit",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Jj=$j))||Jj)||Jj)||Jj)||Jj)),qX=new _i,YX=new mi,KX=new _i,QX=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(HX||(HX={})),et(HX);var ZX=function(t){return e({Mask:t,MaskComponent:t}),t}((vX=Zc("cc.Mask"),gX=_l(),yX=$c(110),SX=cl(),TX=Pl(HX),EX=El(),xX=ml(),AX=El(),bX=ml(),CX=pl(),wX=Pl(RH),RX=pl(),PX=pl(),IX=vl(),OX=pl(),DX=pl(),vX(NX=gX(NX=yX(NX=SX((GX=kX=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,Z(t,"_type",LX,Y(t)),Z(t,"_inverted",BX,Y(t)),Z(t,"_segments",FX,Y(t)),Z(t,"_spriteFrame",zX,Y(t)),Z(t,"_alphaThreshold",UX,Y(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=fW.ADD_COLOR,t}H(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&(DD.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=YX;this.node.getWorldMatrix(qX),_i.invert(KX,qX),mi.transformMat4(o,e,KX);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===HX.RECT||this.type===HX.GRAPHICS_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===HX.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==HX.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new XX;e._objFlags|=Zt.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=Kn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===HX.RECT||this._type===HX.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===HX.RECT)t.rect(a,s,i,r);else if(this._type===HX.ELLIPSE){for(var c=function(e,t,n){QX.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)QX.push(new Zn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return QX}(new Zn(a+i/2,s+r/2,0),new Zn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Gv.get("default-clear-stencil");this._clearStencilMtl=new kg({parent:e,owner:this,subModelIdx:0}),this._clearModel=DD.root.createModel(ig),this._clearModel.node=this._clearModel.transform=this.node;var t=mX(hX),n=i.director.root.device,r=n.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.DEVICE,4*t,t)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(o);var a=n.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);a.update(s),this._clearModelMesh=new Iw([r],hX,jr.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=CV.DISABLED,this._type===HX.IMAGE_STENCIL?(e=Gv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Gv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==HX.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},k(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==HX.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=CV.DISABLED,this._graphics&&(this._graphics.stencilStage=CV.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=In(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===HX.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===HX.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(bj),kX.Type=HX,J((MX=GX).prototype,"type",[TX,EX,xX],Object.getOwnPropertyDescriptor(MX.prototype,"type"),MX.prototype),J(MX.prototype,"inverted",[AX,bX],Object.getOwnPropertyDescriptor(MX.prototype,"inverted"),MX.prototype),J(MX.prototype,"segments",[CX],Object.getOwnPropertyDescriptor(MX.prototype,"segments"),MX.prototype),J(MX.prototype,"spriteFrame",[wX,RX],Object.getOwnPropertyDescriptor(MX.prototype,"spriteFrame"),MX.prototype),J(MX.prototype,"alphaThreshold",[PX,IX,Tl],Object.getOwnPropertyDescriptor(MX.prototype,"alphaThreshold"),MX.prototype),J(MX.prototype,"color",[Ul,OX],Object.getOwnPropertyDescriptor(MX.prototype,"color"),MX.prototype),J(MX.prototype,"customMaterial",[Ul,DX],Object.getOwnPropertyDescriptor(MX.prototype,"customMaterial"),MX.prototype),LX=J(MX.prototype,"_type",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HX.RECT}}),BX=J(MX.prototype,"_inverted",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FX=J(MX.prototype,"_segments",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),zX=J(MX.prototype,"_spriteFrame",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UX=J(MX.prototype,"_alphaThreshold",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),NX=MX))||NX)||NX)||NX)||NX));sI._comp=ZX,i.Mask=ZX;var JX,$X,eq,tq,nq,iq,rq,oq,aq,sq,cq,lq,uq,hq,_q,fq,pq,dq,mq,vq,gq,yq,Sq,Tq,Eq,xq,Aq,bq,Cq,wq,Rq,Pq,Iq,Oq,Dq,Nq,Mq,Lq,Bq,Fq,zq,Uq,kq,Gq,Hq,Vq,Wq,jq,Xq,qq,Yq,Kq,Qq,Zq,Jq,$q=/^(click)(\s)*=|(param)(\s)*=/,eY=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,tY=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=eY.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=eY.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=$q.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=$q.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=Q(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),nY=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((JX=Zc("cc.LabelOutline"),$X=_l(),eq=$c(110),tq=cl(),nq=Jc(Pj),iq=ml(),rq=ml(),JX(oq=$X(oq=eq(oq=tq(oq=nq(oq=sl((lq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_color",sq,Y(t)),Z(t,"_width",cq,Y(t)),t}H(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Pj);e&&e.updateRenderData(!0)},k(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(qu),sq=J((aq=lq).prototype,"_color",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0,0,255)}}),cq=J(aq.prototype,"_width",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),J(aq.prototype,"color",[iq],Object.getOwnPropertyDescriptor(aq.prototype,"color"),aq.prototype),J(aq.prototype,"width",[rq],Object.getOwnPropertyDescriptor(aq.prototype,"width"),aq.prototype),oq=aq))||oq)||oq)||oq)||oq)||oq)||oq));!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(Kq||(Kq={})),et(Kq),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(Qq||(Qq={})),et(Qq),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(Zq||(Zq={})),et(Zq),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(Jq||(Jq={}));var iY,rY,oY,aY,sY,cY,lY,uY,hY,_Y,fY,pY,dY,mY,vY=function(t){return e({Sprite:t,SpriteComponent:t}),t}((uq=Zc("cc.Sprite"),hq=_l(),_q=$c(110),fq=cl(),pq=Pl(IH),dq=El(),mq=ml(),vq=Pl(RH),gq=El(),yq=ml(),Sq=Pl(Kq),Tq=El(),Eq=ml(),xq=Pl(Qq),Aq=ml(),bq=ml(),Cq=vl(),wq=ml(),Rq=vl(),Pq=ml(),Iq=El(),Oq=ml(),Dq=Pl(Zq),Nq=El(),Mq=ml(),uq(Lq=hq(Lq=_q(Lq=fq((Yq=qq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",Fq,Y(t)),Z(t,"_type",zq,Y(t)),Z(t,"_fillType",Uq,Y(t)),Z(t,"_sizeMode",kq,Y(t)),Z(t,"_fillCenter",Gq,Y(t)),Z(t,"_fillStart",Hq,Y(t)),Z(t,"_fillRange",Vq,Y(t)),Z(t,"_isTrimmedMode",Wq,Y(t)),Z(t,"_useGrayscale",jq,Y(t)),Z(t,"_atlas",Xq,Y(t)),t}H(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial(),this._markForUpdateUvDirty()},n.onDestroy=function(){this.destroyRenderData(),e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Fm){var i=e.getPixelFormat();n=i===Jd.RGBA_ETC1||i===Jd.RGB_A_PVRTC_4BPPV1||i===Jd.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=fW.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=fW.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=fW.GRAYSCALE:this._instanceMaterialType=fW.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof hE){var n=G({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Ag;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(Zq.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Zq.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._applySpriteFrame=function(e){var t=this._spriteFrame;this._renderData&&(this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty);var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&this.changeMaterialForDefine(),this._applySpriteSize())},n._markForUpdateUvDirty=function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)},k(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===Qq.RADIAL||this._fillType===Qq.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===Kq.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=In(e,-1,1),this._type===Kq.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=In(e,-1,1),this._type===Kq.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===Kq.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?fW.GRAYSCALE:fW.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Zq.CUSTOM&&this._applySpriteSize())}}]),t}(bj),qq.FillType=Qq,qq.Type=Kq,qq.SizeMode=Zq,qq.EventType=Jq,J((Bq=Yq).prototype,"spriteAtlas",[pq,dq,mq],Object.getOwnPropertyDescriptor(Bq.prototype,"spriteAtlas"),Bq.prototype),J(Bq.prototype,"spriteFrame",[vq,gq,yq],Object.getOwnPropertyDescriptor(Bq.prototype,"spriteFrame"),Bq.prototype),J(Bq.prototype,"type",[Sq,Tq,Eq],Object.getOwnPropertyDescriptor(Bq.prototype,"type"),Bq.prototype),J(Bq.prototype,"fillType",[xq,Aq],Object.getOwnPropertyDescriptor(Bq.prototype,"fillType"),Bq.prototype),J(Bq.prototype,"fillCenter",[bq],Object.getOwnPropertyDescriptor(Bq.prototype,"fillCenter"),Bq.prototype),J(Bq.prototype,"fillStart",[Cq,wq],Object.getOwnPropertyDescriptor(Bq.prototype,"fillStart"),Bq.prototype),J(Bq.prototype,"fillRange",[Rq,Pq],Object.getOwnPropertyDescriptor(Bq.prototype,"fillRange"),Bq.prototype),J(Bq.prototype,"trim",[Iq,Oq],Object.getOwnPropertyDescriptor(Bq.prototype,"trim"),Bq.prototype),J(Bq.prototype,"grayscale",[fl],Object.getOwnPropertyDescriptor(Bq.prototype,"grayscale"),Bq.prototype),J(Bq.prototype,"sizeMode",[Dq,Nq,Mq],Object.getOwnPropertyDescriptor(Bq.prototype,"sizeMode"),Bq.prototype),Fq=J(Bq.prototype,"_spriteFrame",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zq=J(Bq.prototype,"_type",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kq.SIMPLE}}),Uq=J(Bq.prototype,"_fillType",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qq.HORIZONTAL}}),kq=J(Bq.prototype,"_sizeMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zq.TRIMMED}}),Gq=J(Bq.prototype,"_fillCenter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(0,0)}}),Hq=J(Bq.prototype,"_fillStart",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vq=J(Bq.prototype,"_fillRange",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wq=J(Bq.prototype,"_isTrimmedMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jq=J(Bq.prototype,"_useGrayscale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xq=J(Bq.prototype,"_atlas",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lq=Bq))||Lq)||Lq)||Lq)||Lq)),gY=e("RenderRoot2D",Zc("cc.RenderRoot2D")(iY=$c(100)(iY=cl()(iY=Jc(YV)(iY=el(iY=sl(iY=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.onEnable=function(){i.director.root.batcher2D.addScreen(this)},n.onDisable=function(){i.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){i.director.root.batcher2D.removeScreen(this)},t}(qu))||iY)||iY)||iY)||iY)||iY)||iY),yY=new Zn,SY=Ze({OVERLAY:0,INTERSPERSE:1}),TY=function(t){return e({Canvas:t,CanvasComponent:t}),t}((rY=Zc("cc.Canvas"),oY=_l(),aY=$c(100),sY=cl(),cY=Pl(FL),lY=ml(),uY=ml(),hY=Pl(FL),rY(_Y=oY(_Y=aY(_Y=sY(_Y=sl(_Y=el((J((fY=function(e){function t(){var t;return Z(t=e.call(this)||this,"_cameraComponent",pY,Y(t)),Z(t,"_alignCanvasWithScreen",dY,Y(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new Zn,t._renderMode=SY.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(Y(t)),t}H(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(FL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(NA.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(FL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(FL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(NA.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){var e=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(e.width,e.height),this._cameraComponent.orthoHeight=hD.height/2}else if(uD.canvas){var t=uD.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(t.width,t.height),this._cameraComponent.orthoHeight=uD.canvas.height/yD.getScaleY()/2}this.node.getWorldPosition(yY),this._cameraComponent.node.setWorldPosition(yY.x,yY.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===SY.OVERLAY?t|1<<30:t&~(1<<30)}return 0},k(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(gY)).prototype,"cameraComponent",[cY,lY],Object.getOwnPropertyDescriptor(fY.prototype,"cameraComponent"),fY.prototype),J(fY.prototype,"alignCanvasWithScreen",[uY],Object.getOwnPropertyDescriptor(fY.prototype,"alignCanvasWithScreen"),fY.prototype),pY=J(fY.prototype,"_cameraComponent",[hY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dY=J(fY.prototype,"_alignCanvasWithScreen",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_Y=fY))||_Y)||_Y)||_Y)||_Y)||_Y)||_Y));i.Canvas=TY;var EY,xY,AY,bY,CY,wY,RY,PY,IY,OY,DY,NY,MY,LY,BY,FY,zY,UY,kY,GY,HY,VY,WY,jY,XY,qY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK=e("UIComponent",Zc("cc.UIComponent")(mY=Jc(YV)(mY=$c(110)(mY=el(mY=sl(mY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=CV.DISABLED,t}H(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},t}(qu))||mY)||mY)||mY)||mY)||mY);vn(iK.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),mn(TY.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:Kn.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),gn(bj.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),gn(YV.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),i.UITransformComponent=YV,Ke.setClassAlias(YV,"cc.UITransformComponent"),Ke.setClassAlias(bj,"cc.RenderComponent"),i.CanvasComponent=TY,Ke.setClassAlias(TY,"cc.CanvasComponent");var rK=new tY,oK="RICHTEXT_CHILD",aK="RICHTEXT_Image_CHILD",sK=new qe((function(e){if(!i.isValid(e.node))return!1;var t=e.node.getComponent(nY);return t&&(t.width=0),!0}),20),cK=new qe((function(e){return i.isValid(e.node)}),10);function lK(e){return{node:new qC(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function uK(e,t){var n;e===oK?n=sK._get():e===aK&&(n=cK._get());var i=(n=n||lK(e)).node;return i||(i=new qC(e)),i.hideFlags|=Zt.Flags.DontSave|Zt.Flags.HideInHierarchy,e===aK?(n.comp=i.getComponent(vY)||i.addComponent(vY),n.comp.spriteFrame=t,n.comp.type=vY.Type.SLICED,n.comp.sizeMode=vY.SizeMode.CUSTOM):(n.comp=i.getComponent(Pj)||i.addComponent(Pj),n.comp.string=t,n.comp.horizontalAlign=Tj.LEFT,n.comp.verticalAlign=Ej.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var hK,_K=function(t){return e({RichText:t,RichTextComponent:t}),t}((EY=Zc("cc.RichText"),xY=_l(),AY=$c(110),bY=cl(),CY=ml(),wY=Pl(Tj),RY=ml(),PY=ml(),IY=ml(),OY=Pl(LH),DY=ml(),NY=ml(),MY=Pl(Aj),LY=ml(),BY=ml(),FY=ml(),zY=Pl(IH),UY=ml(),kY=ml(),EY(GY=xY(GY=AY(GY=bY(GY=sl((nK=tK=function(e){function t(){var t;return Z(t=e.call(this)||this,"_lineHeight",VY,Y(t)),Z(t,"_string",WY,Y(t)),Z(t,"_horizontalAlign",jY,Y(t)),Z(t,"_fontSize",XY,Y(t)),Z(t,"_maxWidth",qY,Y(t)),Z(t,"_fontFamily",YY,Y(t)),Z(t,"_font",KY,Y(t)),Z(t,"_isSystemFontUsed",QY,Y(t)),Z(t,"_userDefinedFont",ZY,Y(t)),Z(t,"_cacheMode",JY,Y(t)),Z(t,"_imageAtlas",$Y,Y(t)),Z(t,"_handleTouchEvent",eK,Y(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}H(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(NA.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(NA.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=Q(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===oK?sK.put(n):n.type===aK&&cK.put(n)}this.node.off(NA.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(NA.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(NA.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(NA.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return uK(oK,e)},n._createImage=function(e){return uK(aK,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(Pj).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(qu),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=Q(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(YV);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===oK||n.name===aK){n.parent===this.node?n.parent=null:e.splice(t,1);var i=lK(n.name);i.node=n,n.name===oK?(i.comp=n.getComponent(Pj),sK.put(i)):(i.comp=n.getComponent(vY),cK.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==oK&&n.name!==aK||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(Pj);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this._applyTextAttribute(n),this.node.addChild(n.node),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=hV(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else A(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=rK.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+ZH)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(sV(i)||cV(i))return 1;for(var r=1,o=t+1;o<n&&!cV(i=e.charAt(o))&&!sV(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case Tj.LEFT:break;case Tj.CENTER:l-=this._linesWidth[c-1]/2;break;case Tj.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(vY)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+ZH);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(nY);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return Kn[t]?Kn[t]:(new Kn).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(Pj);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(nY);r||(r=e.node.addComponent(nY)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof LH&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=Q(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=Kn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},k(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(iK),tK.HorizontalAlign=Tj,tK.VerticalAlign=Ej,J((HY=nK).prototype,"string",[xl,CY],Object.getOwnPropertyDescriptor(HY.prototype,"string"),HY.prototype),J(HY.prototype,"horizontalAlign",[wY,RY],Object.getOwnPropertyDescriptor(HY.prototype,"horizontalAlign"),HY.prototype),J(HY.prototype,"fontSize",[PY],Object.getOwnPropertyDescriptor(HY.prototype,"fontSize"),HY.prototype),J(HY.prototype,"fontFamily",[IY],Object.getOwnPropertyDescriptor(HY.prototype,"fontFamily"),HY.prototype),J(HY.prototype,"font",[OY,DY],Object.getOwnPropertyDescriptor(HY.prototype,"font"),HY.prototype),J(HY.prototype,"useSystemFont",[NY],Object.getOwnPropertyDescriptor(HY.prototype,"useSystemFont"),HY.prototype),J(HY.prototype,"cacheMode",[MY,LY],Object.getOwnPropertyDescriptor(HY.prototype,"cacheMode"),HY.prototype),J(HY.prototype,"maxWidth",[BY],Object.getOwnPropertyDescriptor(HY.prototype,"maxWidth"),HY.prototype),J(HY.prototype,"lineHeight",[FY],Object.getOwnPropertyDescriptor(HY.prototype,"lineHeight"),HY.prototype),J(HY.prototype,"imageAtlas",[zY,UY],Object.getOwnPropertyDescriptor(HY.prototype,"imageAtlas"),HY.prototype),J(HY.prototype,"handleTouchEvent",[kY],Object.getOwnPropertyDescriptor(HY.prototype,"handleTouchEvent"),HY.prototype),VY=J(HY.prototype,"_lineHeight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),WY=J(HY.prototype,"_string",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),jY=J(HY.prototype,"_horizontalAlign",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tj.LEFT}}),XY=J(HY.prototype,"_fontSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),qY=J(HY.prototype,"_maxWidth",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YY=J(HY.prototype,"_fontFamily",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),KY=J(HY.prototype,"_font",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QY=J(HY.prototype,"_isSystemFontUsed",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZY=J(HY.prototype,"_userDefinedFont",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JY=J(HY.prototype,"_cacheMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aj.NONE}}),$Y=J(HY.prototype,"_imageAtlas",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eK=J(HY.prototype,"_handleTouchEvent",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GY=HY))||GY)||GY)||GY)||GY)||GY)),fK=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Zc("cc.UIMeshRenderer")(hK=_l()(hK=$c(110)(hK=cl()(hK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t}H(t,e);var n=t.prototype;return n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onEnable=function(){e.prototype.onEnable.call(this)},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=Q(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Ep.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},k(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(iK))||hK)||hK)||hK)||hK),pK=e("MeshBuffer",function(){function e(e){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=e}var t=e.prototype;return t.initialize=function(e,t){this._outOfCallback=t;var n=dX(e);this._vertexFormatBytes=n*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;var i=Float32Array.BYTES_PER_ELEMENT*n;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new yo(Ar.VERTEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,i,i)));var r=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new yo(Ar.INDEX|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,r,r))),this._attributes=e,this._iaInfo=new zo(this.attributes,this.vertexBuffers,this.indexBuffer),this.vData&&this.iData||this._reallocBuffer()},t.request=function(e,t){void 0===e&&(e=4),void 0===t&&(t=6),this.lastByteOffset=this.byteOffset;var n=this.byteOffset+e*this._vertexFormatBytes,i=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;var r=this.vData.byteLength,o=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=n,this._dirty=!0,!0},t.reset=function(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(var e=0;e<this._hInputAssemblers.length;e++)this._hInputAssemblers[e].destroy();this._hInputAssemblers.length=0},t.recordBatch=function(){var e=this.indicesOffset-this.indicesStart;if(!e)return null;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(this._batcher.device.createInputAssembler(this._iaInfo));var t=this._hInputAssemblers[this._nextFreeIAHandle++];return t.firstIndex=this.indicesStart,t.indexCount=e,t},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t),this._dirty=!1}},t._reallocBuffer=function(){this._reallocVData(!0),this._reallocIData(!0)},t._reallocVData=function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var n=new Uint8Array(this.vData.buffer),i=0,r=t.length;i<r;i++)n[i]=t[i]},t._reallocIData=function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var n=this.iData,i=0,r=t.length;i<r;i++)n[i]=t[i]},k(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}());pK.OPACITY_OFFSET=8;var dK,mK,vK,gK,yK,SK,TK,EK,xK,AK,bK,CK,wK,RK,PK,IK,OK,DK,NK,MK,LK,BK,FK,zK,UK=Sp.Enum.NONE|Sp.Enum.UI_3D,kK=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=UK,this._inputAssember=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=UK,this.renderScene=null},t.fillPasses=function(e,t,n,r,o,a){if(e){var s=e.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new Xv(i.director.root));var u=s[l],h=this._passes[l];u.update(),t||(t=u.depthStencilState,n=0),r||(r=u.blendState,o=0),-1===o&&(o=0),c=n<<16|o,h._initPassFromTarget(u,t,r,c),this._shaders[l]=h.getShaderVariant(a)}}},k(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssember},set:function(e){this._inputAssember=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),GK=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((dK=Zc("cc.UIStaticBatch"),mK=_l(),vK=cl(),gK=$c(110),yK=pl(),dK(SK=mK(SK=vK(SK=gK((J((TK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._meshBuffer=null,t._dirty=!0,t._lastMeshBuffer=null,t._uiDrawBatchList=[],t}H(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._getBatcher();if(e){var t=fX,n=new pK(e);n.initialize(t,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=n}},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)},n.updateAssembler=function(e){e.currIsStatic=!0,this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))},n.postUpdateAssembler=function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),e.currIsStatic=!1},n.markAsDirty=function(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())},n._requireDrawBatch=function(){var e=new kK;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return DD.root&&DD.root.batcher2D?DD.root.batcher2D:(A(9301),null)},n._arrivalMaxBuffer=function(){var e=this._getBatcher();e&&e.autoMergeBatches(),A(9300)},k(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(bj)).prototype,"color",[Ul,yK],Object.getOwnPropertyDescriptor(TK.prototype,"color"),TK.prototype),SK=TK))||SK)||SK)||SK)||SK)),HK=e("LabelShadow",(EK=Zc("cc.LabelShadow"),xK=_l(),AK=$c(110),bK=cl(),CK=Jc(Pj),wK=ml(),RK=ml(),PK=ml(),EK(IK=xK(IK=AK(IK=bK(IK=CK(IK=sl((LK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_color",DK,Y(t)),Z(t,"_offset",NK,Y(t)),Z(t,"_blur",MK,Y(t)),t}H(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Pj);e&&e.updateRenderData(!0)},k(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(qu),DK=J((OK=LK).prototype,"_color",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0,0,255)}}),NK=J(OK.prototype,"_offset",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(2,2)}}),MK=J(OK.prototype,"_blur",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),J(OK.prototype,"color",[wK],Object.getOwnPropertyDescriptor(OK.prototype,"color"),OK.prototype),J(OK.prototype,"offset",[RK],Object.getOwnPropertyDescriptor(OK.prototype,"offset"),OK.prototype),J(OK.prototype,"blur",[PK],Object.getOwnPropertyDescriptor(OK.prototype,"blur"),OK.prototype),IK=OK))||IK)||IK)||IK)||IK)||IK)||IK)),VK=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}(Zc("cc.UIOpacity")(BK=_l()(BK=$c(110)(BK=cl()(BK=sl((J((FK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_opacity",zK,Y(t)),t}H(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},k(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=pt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(qu)).prototype,"opacity",[fl],Object.getOwnPropertyDescriptor(FK.prototype,"opacity"),FK.prototype),zK=J(FK.prototype,"_opacity",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),BK=FK))||BK)||BK)||BK)||BK)||BK);i.MaskComponent=ZX,Ke.setClassAlias(ZX,"cc.MaskComponent"),i.LabelComponent=Pj,Ke.setClassAlias(Pj,"cc.LabelComponent"),i.LabelOutlineComponent=nY,Ke.setClassAlias(nY,"cc.LabelOutlineComponent"),i.RichTextComponent=_K,Ke.setClassAlias(_K,"cc.RichTextComponent"),i.SpriteComponent=vY,Ke.setClassAlias(vY,"cc.SpriteComponent"),i.UIModelComponent=fK,Ke.setClassAlias(fK,"cc.UIModelComponent"),i.GraphicsComponent=XX,Ke.setClassAlias(XX,"cc.GraphicsComponent"),Ke.setClassAlias(GK,"cc.UIStaticBatchComponent"),Ke.setClassAlias(VK,"cc.UIOpacityComponent");var WK=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function jK(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=lQ(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=lQ(o,e[o],e[o+1],a);return a&&oQ(a,a.next)&&(uQ(a),a=a.next),a}function XK(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!oQ(n,n.next)&&0!==rQ(n.prev,n,n.next))n=n.next;else{if(uQ(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function qK(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=eQ(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?KK(e,i,r,o):YK(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),uQ(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?qK(e=QK(e,t,n),t,n,i,r,o,2):2===a&&ZK(e,t,n,i,r,o):qK(XK(e),t,n,i,r,o,1);break}}}function YK(e){var t=e.prev,n=e,i=e.next;if(rQ(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(nQ(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&rQ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function KK(e,t,n,i){var r=e.prev,o=e,a=e.next;if(rQ(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=eQ(s,c,t,n,i),_=eQ(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&nQ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&rQ(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&nQ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&rQ(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function QK(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!oQ(r,o)&&aQ(r,i,i.next,o)&&sQ(r,o)&&sQ(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),uQ(i),uQ(i.next),i=e=o),i=i.next}while(i!==e);return i}function ZK(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&iQ(a,s)){var c=cQ(a,s);return a=XK(a,a.next),c=XK(c,c.next),qK(a,t,n,i,r,o),void qK(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function JK(e,t){return e.x-t.x}function $K(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&nQ(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&sQ(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=cQ(t,e);XK(n,n.next)}}function eQ(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function tQ(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function nQ(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function iQ(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&aQ(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&sQ(e,t)&&sQ(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function rQ(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function oQ(e,t){return e.x===t.x&&e.y===t.y}function aQ(e,t,n,i){return!!(oQ(e,t)&&oQ(n,i)||oQ(e,i)&&oQ(n,t))||rQ(e,t,n)>0!=rQ(e,t,i)>0&&rQ(n,i,e)>0!=rQ(n,i,t)>0}function sQ(e,t){return rQ(e.prev,e,e.next)<0?rQ(e,t,e.next)>=0&&rQ(e,e.prev,t)>=0:rQ(e,t,e.prev)<0||rQ(e,e.next,t)<0}function cQ(e,t){var n=new WK(e.i,e.x,e.y),i=new WK(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function lQ(e,t,n,i){var r=new WK(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function uQ(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function hQ(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=jK(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=jK(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(tQ(s)));if(o.sort(JK),!n)return n;for(a=0;a<o.length;a++)$K(o[a],n),n=XK(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var p=n;p<r;p+=n)(h=e[p])<s&&(s=h),(_=e[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return qK(o,a,n,s,c,f),a}for(var _Q=Math.PI,fQ=Math.min,pQ=Math.max,dQ=Math.ceil,mQ=Math.acos,vQ=Math.cos,gQ=Math.sin,yQ=Math.atan2,SQ=null,TQ=null,EQ=new Kn,xQ=[],AQ=0;AQ<4;AQ++)xQ.push(new Zn);function bQ(e,t,n){return e<t?t:e>n?n:e}var CQ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!TQ)return null;var n=TQ.getRenderDataList(),i=n[TQ.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++TQ.dataOffset,TQ.dataOffset<n.length?i=n[TQ.dataOffset]:(i=TQ.requestRenderData(),n[TQ.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){Kn.copy(EQ,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Kn.copy(EQ,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,n,i,r,o=.5*e.lineWidth,a=e.lineCap,s=e.lineJoin,c=e.miterLimit;if(TQ=e.impl){var l=(t=o,n=_Q,i=TQ.tessTol,r=2*mQ(t/(t+i)),pQ(2,dQ(n/r)));this._calculateJoins(TQ,o,s,c);for(var u=TQ.paths,h=0,_=TQ.pathOffset,f=TQ.pathLength;_<f;_++){var p=u[_],d=p.points.length;s===wj.ROUND?h+=2*(d+p.bevel*(l+2)+1):h+=2*(d+5*p.bevel+1),p.closed||(a===Cj.ROUND?h+=2*(2*l+2):h+=12)}var m=SQ=this.getRenderData(e,h);if(m){for(var v=m.vData,g=m.iData,y=TQ.pathOffset,S=TQ.pathLength;y<S;y++){var T=u[y],E=T.points,x=E.length,A=m.vertexStart,b=void 0,C=void 0,w=0,R=0,P=T.closed;if(P?(b=E[x-1],C=E[0],w=0,R=x):(b=E[0],C=E[1],w=1,R=x-1),C=C||b,!P){var I=new cX(C.x,C.y);I.subtract(b),I.normalize();var O=I.x,D=I.y;a===Cj.BUTT?this._buttCapStart(b,O,D,o,0):a===Cj.SQUARE?this._buttCapStart(b,O,D,o,o):a===Cj.ROUND&&this._roundCapStart(b,O,D,o,l)}for(var N=w;N<R;++N)s===wj.ROUND?this._roundJoin(b,C,o,o,l):0!=(C.flags&(Rj.PT_BEVEL|Rj.PT_INNERBEVEL))?this._bevelJoin(b,C,o,o):(this._vSet(C.x+C.dmx*o,C.y+C.dmy*o,1),this._vSet(C.x-C.dmx*o,C.y-C.dmy*o,-1)),b=C,C=E[N+1];if(P){var M=8*A;this._vSet(v[M],v[M+1],1),this._vSet(v[M+8],v[M+8+1],-1)}else{var L=new cX(C.x,C.y);L.subtract(b),L.normalize();var B=L.x,F=L.y;a===Cj.BUTT?this._buttCapEnd(C,B,F,o,0):a===Cj.SQUARE?this._buttCapEnd(C,B,F,o,o):a===Cj.ROUND&&this._roundCapEnd(C,B,F,o,l)}for(var z=m.indicesStart,U=A+2,k=m.vertexStart;U<k;U++)g[z++]=U-2,g[z++]=U-1,g[z++]=U;m.indicesStart=z}SQ=null,TQ=null}}},_expandFill:function(e){if(TQ=e.impl){for(var t=TQ.paths,n=0,i=TQ.pathOffset,r=TQ.pathLength;i<r;i++)n+=t[i].points.length;var o=SQ=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=TQ.pathOffset,u=TQ.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var p=o.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=o.indicesStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var S=8*g;v.push(s[S++]),v.push(s[S++]),v.push(s[S++])}var T=hQ(v,null,3);if(!T||0===T.length)continue;for(var E=0,x=T.length;E<x;E++)c[m++]=T[E]+p}else for(var A=p,b=p+2,C=a.vertexStart;b<C;b++)c[m++]=A,c[m++]=b-1,c[m++]=b;a.indicesStart=m}}SQ=null,TQ=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var S=1/p;S>600&&(S=600),_.dmx*=S,_.dmy*=S}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=Rj.PT_LEFT),p*(d=pQ(11,fQ(h.len,_.len)*r))*d<1&&(_.flags|=Rj.PT_INNERBEVEL),_.flags&Rj.PT_CORNER&&(p*i*i<1||n===wj.BEVEL||n===wj.ROUND)&&(_.flags|=Rj.PT_BEVEL),0!=(_.flags&(Rj.PT_BEVEL|Rj.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new cX(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*_Q,h=vQ(u)*i,_=gQ(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*_Q,h=vQ(u)*i,_=gQ(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&Rj.PT_LEFT)){var h=this._chooseBevel(t.flags&Rj.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],p=h[2],d=h[3],m=yQ(-a,-o),v=yQ(-c,-s);v>m&&(v-=2*_Q),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=bQ(dQ((m-v)/_Q)*r,2,r),y=0;y<g;y++){var S=m+y/(g-1)*(v-m),T=l+vQ(S)*i,E=u+gQ(S)*i;this._vSet(l,u,0),this._vSet(T,E,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var x=this._chooseBevel(t.flags&Rj.PT_INNERBEVEL,e,t,-i),A=x[0],b=x[1],C=x[2],w=x[3],R=yQ(a,o),P=yQ(c,s);P<R&&(P+=2*_Q),this._vSet(l+o*i,u+a*i,1),this._vSet(A,b,-1);for(var I=bQ(dQ((P-R)/_Q)*r,2,r),O=0;O<I;O++){var D=R+O/(I-1)*(P-R),N=l+vQ(D)*n,M=u+gQ(D)*n;this._vSet(N,M,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(C,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,p=t.dy,d=-t.dx;if(t.flags&Rj.PT_LEFT){var m=this._chooseBevel(t.flags&Rj.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-p*i,t.y-d*i,-1)}else{var v=this._chooseBevel(t.flags&Rj.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+p*n,t.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),SQ){var i=SQ,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,Kn.toArray(o,EQ,r),r+=4,o[r++]=n,i.vertexStart++}}},wQ=e("graphicsAssembler",{getAssembler:function(){return CQ}});XX.Assembler=wQ;var RQ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},PQ=new bi,IQ=null,OQ=null,DQ=[],NQ=[],MQ=[],LQ=[],BQ=new xi,FQ=new xi,zQ=new mi,UQ=null,kQ=0,GQ=0,HQ=0,VQ=0,WQ=0,jQ=1,XQ=null,qQ="",YQ=0,KQ=0,QQ=0,ZQ=0,JQ=0,$Q=0,eZ=0,tZ=!1,nZ=0,iZ=0,rZ=0,oZ={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&IQ!==e&&(OQ=(IQ=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),IQ.actualFontSize=YQ,OQ.setContentSize(FQ),IQ.renderData.vertDirty=IQ.renderData.uvDirty=!1,IQ.markForUpdateRenderData(!1),IQ=null,this._resetProperties())},_updateFontScale:function(){jQ=YQ/KQ},_updateFontFamily:function(e){var t=e.font;XQ=t.spriteFrame,UQ=t.fntConfig,MV.fontAtlas=t.fontDefDictionary,EH.packToDynamicAtlas(e,XQ)},_updateLabelInfo:function(){MV.hash="",MV.margin=0},_updateProperties:function(e){qQ=e.string.toString(),YQ=e.fontSize,KQ=UQ?UQ.fontSize:e.fontSize,QQ=e.horizontalAlign,ZQ=e.verticalAlign,JQ=e.spacingX,eZ=e.overflow,$Q=e._lineHeight;var t=OQ.contentSize;FQ.width=t.width,FQ.height=t.height,eZ===xj.NONE?(tZ=!1,FQ.width+=2*MV.margin,FQ.height+=2*MV.margin):eZ===xj.RESIZE_HEIGHT?(tZ=!0,FQ.height+=2*MV.margin):tZ=e.enableWrapText,MV.lineHeight=$Q,MV.fontSize=YQ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){UQ=null,XQ=null,MV.hash="",MV.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=qQ,t=e.length,n=UQ.kerningDict,i=DQ,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=qQ.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=qQ.charAt(u);if("\n"!==h){for(var _=e(qQ,u,t),f=s,p=c,d=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=qQ.charAt(y)))if(l=MV.fontAtlas.getLetterDefinitionForChar(h,MV)){var S=m+l.offsetX*jQ-MV.margin;if(tZ&&rZ>0&&i>0&&S+l.w*jQ>rZ&&!cV(h)){MQ.push(a),a=0,n++,i=0,r-=$Q*this._getFontScale()+0,v=!0;break}zQ.x=S,zQ.y=r-l.offsetY*jQ,this._recordLetterInfo(zQ,h,y,n),y+1<DQ.length&&y<t-1&&(m+=DQ[y+1]),m+=l.xAdvance*jQ+JQ,d=zQ.x+l.w*jQ,f<zQ.y&&(f=zQ.y),p>zQ.y-l.h*jQ&&(p=zQ.y-l.h*jQ)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+UQ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>p&&(c=p),o<(a=d)&&(o=a),u+=_)}else MQ.push(a),a=0,n++,i=0,r-=$Q*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return MQ.push(a),GQ=(kQ=n+1)*$Q*this._getFontScale(),kQ>1&&(GQ+=0*(kQ-1)),FQ.width=nZ,FQ.height=iZ,nZ<=0&&(FQ.width=parseFloat(o.toFixed(2))+2*MV.margin),iZ<=0&&(FQ.height=parseFloat(GQ.toFixed(2))+2*MV.margin),VQ=FQ.height,WQ=0,s>0&&(VQ=FQ.height+s),c<-GQ&&(WQ=GQ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return eZ===xj.SHRINK?jQ:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(sV(i)||"\n"===i||cV(i))return 1;var r=1,o=MV.fontAtlas.getLetterDefinitionForChar(i,MV);if(!o)return r;for(var a=o.xAdvance*jQ+JQ,s=t+1;s<n&&(i=e.charAt(s),o=MV.fontAtlas.getLetterDefinitionForChar(i,MV));++s){if(a+o.offsetX*jQ+o.w*jQ>rZ&&!cV(i)&&rZ>0)return r;if(a+=o.xAdvance*jQ+JQ,"\n"===i||cV(i)||sV(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=NQ.length){var n=new RQ;NQ.push(n)}NQ[e].char=t,NQ[e].hash=t.charCodeAt(0)+MV.hash,NQ[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=NQ.length){var r=new RQ;NQ.push(r)}var o=t.charCodeAt(0)+MV.hash;NQ[n].line=i,NQ[n].char=t,NQ[n].hash=o,NQ[n].valid=MV.fontAtlas.getLetter(o).valid,NQ[n].x=e.x,NQ[n].y=e.y},_alignText:function(){GQ=0,MQ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),eZ===xj.SHRINK&&YQ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||eZ===xj.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),YQ=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|YQ,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;jQ=r/KQ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return GQ>FQ.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=qQ.length;t<n;++t){var i=NQ[t];if(i.valid){var r=MV.fontAtlas.getLetterDefinitionForChar(i.char,MV);if(!r)continue;var o=i.x+r.w/2*jQ,a=i.line;if(nZ>0)if(tZ){if(MQ[a]>FQ.width&&(o>FQ.width||o<0)){e=!0;break}}else if(o>FQ.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=MQ[t],i=e>FQ.width||e<0;return tZ?n>FQ.width&&i:i},_updateQuads:function(){if(!IQ)return!1;var e=XQ?XQ.texture:MV.fontAtlas.getTexture(),t=IQ.renderData;t.dataLength=t.vertexCount=t.indicesCount=0;for(var n=OQ.anchorPoint,i=FQ,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=qQ.length;s<c;++s){var l=NQ[s];if(l.valid){var u=MV.fontAtlas.getLetter(l.hash);if(u){PQ.height=u.h,PQ.width=u.w,PQ.x=u.u,PQ.y=u.v;var h=l.y+HQ;if(iZ>0){if(h>VQ){var _=h-VQ;PQ.y+=_,PQ.height-=_,h-=_}h-u.h*jQ<WQ&&eZ===xj.CLAMP&&(PQ.height=h<WQ?0:(h-WQ)/jQ)}var f=l.line,p=l.x+u.w/2*jQ+LQ[f];if(nZ>0&&this._isHorizontalClamped(p,f))if(eZ===xj.CLAMP)PQ.width=0;else if(eZ===xj.SHRINK){if(FQ.width>u.w){a=!1;break}PQ.width=0}if(PQ.height>0&&PQ.width>0){var d=this._determineRect(),m=l.x+LQ[l.line];this.appendQuad(IQ,e,PQ,d,m-r,h-o,jQ)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=XQ.isRotated(),t=XQ.getOriginalSize(),n=XQ.getRect(),i=XQ.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=PQ.x;PQ.x=n.x+n.height-PQ.y-PQ.height-o,PQ.y=a+n.y-r,PQ.y<0&&(PQ.height+=o)}else PQ.x+=n.x-r,PQ.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(LQ.length=0,QQ){case Tj.LEFT:for(var e=0;e<kQ;++e)LQ.push(0);break;case Tj.CENTER:for(var t=0,n=MQ.length;t<n;t++)LQ.push((FQ.width-MQ[t])/2);break;case Tj.RIGHT:for(var i=0,r=MQ.length;i<r;i++)LQ.push(FQ.width-MQ[i])}if(HQ=FQ.height,ZQ!==Ej.TOP){var o=FQ.height-GQ+$Q*this._getFontScale()-KQ*jQ;ZQ===Ej.BOTTOM?HQ-=o:HQ-=o/2}},_setupBMFontOverflowMetrics:function(){var e=FQ.width,t=FQ.height;eZ===xj.RESIZE_HEIGHT&&(t=0),eZ===xj.NONE&&(e=0,t=0),nZ=e,iZ=t,BQ.width=e,BQ.height=t,rZ=e}},aZ=new Kn(255,255,255,255),sZ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){var n=e.node;e._setCacheAlpha(n._uiProps.opacity),aZ.set(e.color),aZ.a=255*n._uiProps.opacity,vH(n,t,e.renderData,aZ)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.vertexCount=s.dataLength,s.indicesCount=s.dataLength/2*3;var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}}};Ie(sZ,oZ);var cZ=null,lZ=Oe(oZ,{getAssemblerData:function(){return cZ||(cZ=new NV(1024,1024)),cZ.getTexture()},_updateFontFamily:function(e){MV.fontAtlas=cZ,MV.fontFamily=this._getFontFamily(e);var t=e.getComponent(nY);t&&t.enabled?(MV.isOutlined=!0,MV.margin=t.width,MV.out=t.color.clone(),MV.out.a=t.color.a*e.color.a/255):(MV.isOutlined=!1,MV.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){MV.fontDesc=this._getFontDesc(),MV.color=e.color,MV.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(MV)},_getFontDesc:function(){return MV.fontSize.toString()+"px "+MV.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),uZ=new Kn(255,255,255,255),hZ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var n=e.node;e._setCacheAlpha(n._uiProps.opacity),uZ.a=255*n._uiProps.opacity,vH(n,t,e.renderData,uZ)}},appendQuad:sZ.appendQuad};Ie(hZ,lZ);var _Z=Pj.Overflow,fZ=(1/255).toFixed(3),pZ=null,dZ=null,mZ=null,vZ="",gZ="",yZ=0,SZ=0,TZ=[],EZ=new xi,xZ=0,AZ=0,bZ=0,CZ=new Kn,wZ=1,RZ="",PZ=_Z.NONE,IZ=!1,OZ=null,DZ=Kn.BLACK.clone(),NZ=null,MZ=Kn.BLACK.clone(),LZ=new bi,BZ=xi.ZERO.clone(),FZ=xi.ZERO.clone(),zZ=mi.ZERO.clone(),UZ=mi.ZERO.clone(),kZ=0,GZ=0,HZ=!1,VZ=!1,WZ=!1,jZ=["left","center","right"],XZ={getAssemblerData:function(){return Pj._canvasPool.get()},resetAssemblerData:function(e){e&&Pj._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData&&e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(e),this._updateTexture(e),this.updateOpacity(e),e._setCacheAlpha(wZ),this._calDynamicAtlas(e),e.actualFontSize=yZ,t.setContentSize(EZ),this.updateVertexData(e),this.updateUvs(e),e.markForUpdateRenderData(!1),pZ=null,dZ=null,mZ=null}},updateVertexData:function(){},updateUvs:function(){},updateOpacity:function(e){for(var t=e.renderData.vData,n=5,i=e.node._uiProps.opacity,r=0;r<4;r++)t[n+3]=i,n+=9},_updateFontFamily:function(e){RZ=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(pZ=n.context,dZ=n.canvas,mZ=e.spriteFrame,gZ=e.string.toString(),yZ=e.fontSize,SZ=yZ,PZ=e.overflow,FZ.width=EZ.width=t.width,FZ.height=EZ.height=t.height,GZ=e.underlineHeight,xZ=e.lineHeight,AZ=e.horizontalAlign,bZ=e.verticalAlign,CZ=e.color,wZ=e.node._uiProps.opacity,HZ=e.isBold,VZ=e.isItalic,WZ=e.isUnderline,IZ=PZ!==_Z.NONE&&(PZ===_Z.RESIZE_HEIGHT||e.enableWrapText),(OZ=(OZ=nY&&e.getComponent(nY))&&OZ.enabled&&OZ.width>0?OZ:null)&&DZ.set(OZ.color),(NZ=(NZ=HK&&e.getComponent(HK))&&NZ.enabled?NZ:null)&&MZ.set(NZ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(BZ.width=BZ.height=0,OZ&&(e=t=n=i=r=OZ.width,BZ.width=BZ.height=2*r),NZ){var o=NZ.blur+r,a=NZ.offset.x,s=NZ.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(VZ){var c=SZ*Math.tan(.20943951);i+=c,BZ.width+=c}LZ.x=n,LZ.y=e,LZ.width=n+i,LZ.height=e+t},_calculateFillTextStartPosition:function(){var e=0;AZ===Tj.RIGHT?e=EZ.width-LZ.width:AZ===Tj.CENTER&&(e=(EZ.width-LZ.width)/2);var t=this._getLineHeight()*(TZ.length-1),n=yZ*(1-ZH/2);if(bZ!==Ej.TOP){var i=t+LZ.height+yZ-EZ.height;bZ===Ej.BOTTOM?n-=i+=ZH/2*yZ:n-=i/2}n+=0*yZ,zZ.set(e+LZ.x,n+LZ.y)},_updateTexture:function(e){if(pZ&&dZ){pZ.clearRect(0,0,dZ.width,dZ.height),pZ.font=vZ,this._calculateFillTextStartPosition();var t=this._getLineHeight();pZ.lineJoin="round",OZ?(pZ.fillStyle="rgba("+DZ.r+", "+DZ.g+", "+DZ.b+", "+fZ+")",pZ.fillRect(0,0,dZ.width,dZ.height)):e._srcBlendFactor===Br.SRC_ALPHA&&(pZ.fillStyle="rgba("+CZ.r+", "+CZ.g+", "+CZ.b+", "+fZ+")",pZ.fillRect(0,0,dZ.width,dZ.height)),pZ.fillStyle="rgb("+CZ.r+", "+CZ.g+", "+CZ.b+")";var n,r=zZ.x,o=0;this._drawTextEffect(zZ,t);for(var a=0;a<TZ.length;++a)o=zZ.y+a*t,OZ&&pZ.strokeText(TZ[a],r,o),pZ.fillText(TZ[a],r,o);NZ&&(pZ.shadowColor="transparent"),mZ&&(n=mZ instanceof RH?mZ.texture:mZ,0!==dZ.width&&0!==dZ.height&&(n.reset({width:dZ.width,height:dZ.height,mipmapLevel:1}),n.uploadData(dZ),mZ instanceof RH&&(mZ.rect=new bi(0,0,dZ.width,dZ.height),mZ._calculateUV()),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))}},_resetDynamicAtlas:function(e){if(e.cacheMode===Pj.CacheMode.BITMAP){var t=e.ttfSpriteFrame;EH.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}},_calDynamicAtlas:function(e){if(e.cacheMode===Pj.CacheMode.BITMAP){var t=e.ttfSpriteFrame;EH.packToDynamicAtlas(e,t),e.renderData.uvDirty=!0}},_setupOutline:function(){pZ.strokeStyle="rgba("+DZ.r+", "+DZ.g+", "+DZ.b+", "+DZ.a/255+")",pZ.lineWidth=2*OZ.width},_setupShadow:function(){pZ.shadowColor="rgba("+MZ.r+", "+MZ.g+", "+MZ.b+", "+MZ.a/255+")",pZ.shadowBlur=NZ.blur,pZ.shadowOffsetX=NZ.offset.x,pZ.shadowOffsetY=-NZ.offset.y},_drawTextEffect:function(e,t){if(NZ||OZ||WZ){var n=TZ.length>1&&NZ,i=this._measureText(pZ,vZ),r=0,o=0;NZ&&this._setupShadow(),OZ&&this._setupOutline();for(var a=0;a<TZ.length;++a)r=e.x,o=e.y+a*t,n&&(OZ&&pZ.strokeText(TZ[a],r,o),pZ.fillText(TZ[a],r,o)),WZ&&(kZ=i(TZ[a]),AZ===Tj.RIGHT?UZ.x=e.x-kZ:AZ===Tj.CENTER?UZ.x=e.x-kZ/2:UZ.x=e.x,UZ.y=o+SZ/8,pZ.fillRect(UZ.x,UZ.y,kZ,GZ));n&&(pZ.shadowColor="transparent")}},_updateLabelDimensions:function(){EZ.width=Math.min(EZ.width,2048),EZ.height=Math.min(EZ.height,2048);var e=!1;dZ.width!==EZ.width&&(dZ.width=EZ.width,e=!0),dZ.height!==EZ.height&&(dZ.height=EZ.height,e=!0),e&&(pZ.font=vZ),pZ.textAlign=jZ[AZ],pZ.textBaseline="alphabetic"},_getFontDesc:function(){var e=yZ.toString()+"px ";return e+=RZ,HZ&&(e="bold "+e),VZ&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===xZ?yZ:xZ*yZ/SZ)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=Q(e);!(n=r()).done;){var o=lV(t,n.value,vZ);i.push(o)}return i},_measureText:function(e,t){return function(n){return lV(e,n,t)}},_calculateShrinkFont:function(e){if(pZ){var t=this._calculateParagraphLength(e,pZ),n=0,i=0,r=0;if(IZ){var o=FZ.width,a=FZ.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|yZ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){E(4003);break}yZ=l,vZ=this._getFontDesc(),pZ.font=vZ;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=lV(pZ,e[n],vZ);i+=hV(e[n],h,o,this._measureText(pZ,vZ)).length*u}i>a?c=l-1:s=l}0===s?E(4003):(yZ=s,vZ=this._getFontDesc(),pZ.font=vZ)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(EZ.width-LZ.width)/r,f=EZ.height/i;yZ=SZ*Math.min(1,_,f)|0,vZ=this._getFontDesc(),pZ.font=vZ}}},_calculateWrapText:function(e){if(IZ&&pZ){TZ=[];for(var t=FZ.width,n=0;n<e.length;++n){var i=lV(pZ,e[n],vZ),r=hV(e[n],i,t,this._measureText(pZ,vZ));TZ=TZ.concat(r)}}},_calculateLabelFont:function(){if(pZ){var e=gZ.split("\n");switch(TZ=e,vZ=this._getFontDesc(),pZ.font=vZ,PZ){case _Z.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=lV(pZ,e[i],vZ);t=t>r?t:r}n=(TZ.length+ZH)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));EZ.width=o+LZ.width,EZ.height=a+LZ.height,FZ.width=o+BZ.width,FZ.height=a+BZ.height;break;case _Z.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case _Z.CLAMP:this._calculateWrapText(e);break;case _Z.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(TZ.length+ZH)*this._getLineHeight();EZ.height=s+LZ.height,FZ.height=s+BZ.height}}}},qZ=Kn.WHITE.clone(),YZ={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;var n=t.vData=new Float32Array(36);n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Kn.toArray(n,qZ,i),i+=9;return t},fillBuffers:function(e,t){var n=e.renderData,i=n.data,r=e.node,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=o.indicesOffset,c=o.vertexOffset;o.request()||(o=t.currBufferBatch,s=0,c=0,a=0);var l=o.vData,u=o.iData,h=n.vData,_=i[0],f=i[3];r.updateWorldTransform();var p=r._pos,d=r._rot,m=r._scale,v=_.x*m.x,g=f.x*m.x,y=_.y*m.y,S=f.y*m.y,T=d.x,E=d.y,x=d.z,A=d.w,b=T*E,C=x*A,w=T*T-E*E,R=A*A-x*x,P=R+w,I=2*(b-C),O=R-w,D=2*(b+C),N=p.x,M=p.y;h[0]=P*v+I*y+N,h[1]=O*y+D*v+M,h[9]=P*g+I*y+N,h[10]=O*y+D*g+M,h[18]=P*v+I*S+N,h[19]=O*S+D*v+M,h[27]=P*g+I*S+N,h[28]=O*S+D*g+M,l.set(h,a),u[s++]=c,u[s++]=c+1,u[s++]=c+2,u[s++]=c+2,u[s++]=c+1,u[s++]=c+3},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[3].x=i-o,s[3].y=r-a}},updateUvs:function(e){var t=e.renderData;if(t){var n=t.vData;if(n&&t.uvDirty){var i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1}}}};Ie(YZ,XZ);var KZ=e("labelAssembler",{getAssembler:function(e){var t=YZ;return e.font instanceof KH?t=sZ:e.cacheMode===Pj.CacheMode.CHAR&&(t=hZ),t}});Pj.Assembler=KZ;var QZ=vY.FillType,ZZ=new _i,JZ=new Kn(255,255,255,255),$Z={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame;EH.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){var i=n.uvDirty,r=n.vertDirty;if(!i&&!r)return;var o=e.fillStart,a=e.fillRange;a<0&&(o+=a,a=-a),a=(a=(a=o+a)>1?1:a)<0?0:a;var s=(o=(o=o>1?1:o)<0?0:o)+(a=(a-=o)<0?0:a);s=s>1?1:s,i&&this.updateUVs(e,o,s),r&&(this.updateVertexData&&this.updateVertexData(e,o,s),this.updateWorldVertexData(e))}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData,o=r.data,a=i.width,s=i.height,c=i.getRect(),l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0;switch(i.isRotated()?(l=c.x/a,u=(c.y+c.width)/s,h=f=l,d=v=(c.x+c.height)/a,p=g=u,_=m=c.y/s):(l=c.x/a,u=(c.y+c.height)/s,h=d=l,f=v=(c.x+c.width)/a,_=p=u,m=g=c.y/s),e.fillType){case QZ.HORIZONTAL:o[0].u=h+(f-h)*t,o[0].v=_+(p-_)*t,o[1].u=h+(f-h)*n,o[1].v=_+(p-_)*n,o[2].u=d+(v-d)*t,o[2].v=m+(g-m)*t,o[3].u=d+(v-d)*n,o[3].v=m+(g-m)*n;break;case QZ.VERTICAL:o[0].u=h+(d-h)*t,o[0].v=_+(m-_)*t,o[1].u=f+(v-f)*t,o[1].v=p+(g-p)*t,o[2].u=h+(d-h)*n,o[2].v=_+(m-_)*n,o[3].u=f+(v-f)*n,o[3].v=p+(g-p)*n;break;default:C(2626)}r.uvDirty=!1},updateVertexData:function(e,t,n){var i=e.renderData,r=i.data,o=e.node._uiProps.uiTransformComp,a=o.width,s=o.height,c=o.anchorX*a,l=o.anchorY*s,u=-c,h=-l,_=a-c,f=s-l,p=0;switch(e.fillType){case QZ.HORIZONTAL:p=u+(_-u)*n,u+=(_-u)*t,_=p;break;case QZ.VERTICAL:p=h+(f-h)*n,h+=(f-h)*t,f=p;break;default:C(2626)}r[4].x=u,r[4].y=h,r[5].x=_,r[5].y=h,r[6].x=u,r[6].y=f,r[7].x=_,r[7].y=f,i.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;for(var n,i=Q(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(ZZ);for(var i=0;i<4;i++){var r=n[i+4],o=n[i];Zn.transformMat4(o,r,ZZ)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=e.node;JZ.set(e.color),JZ.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);for(var u=o.vData,h=0;h<s;h++){var _=r[h];u[a++]=_.x,u[a++]=_.y,u[a++]=_.z,u[a++]=_.u,u[a++]=_.v,Kn.toArray(u,i,a),a+=4}var f=o.iData;f[c++]=l,f[c++]=l+1,f[c++]=l+2,f[c++]=l+1,f[c++]=l+3,f[c++]=l+2}(0,t,e.renderData,JZ)},updateColor:function(){}},eJ=2*Math.PI,tJ=1e-6,nJ=new Kn(255,255,255,255),iJ=[new mi,new mi,new mi,new mi],rJ=new Array(4),oJ=new Array(8),aJ=[new mi,new mi,new mi,new mi],sJ=[new mi,new mi,new mi,new mi],cJ=new mi,lJ=[new mi,new mi,new mi,new mi];function uJ(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>tJ?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>tJ?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function hJ(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function _J(e,t,n,i,r){var o=rJ,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,fJ((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),fJ((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),fJ((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function fJ(e,t,n,i){var r=oJ,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var pJ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;EH.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t&&(n.vertDirty||n.uvDirty)){var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=eJ)+(o*=eJ);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=rJ;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=cJ.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=cJ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;iJ[0].x=iJ[3].x=a,iJ[1].x=iJ[2].x=c,iJ[0].y=iJ[1].y=s,iJ[2].y=iJ[3].y=l;for(var p,d=Q(lJ);!(p=d()).done;){var m=p.value;mi.set(m,0,0)}_!==u[0]&&mi.set(lJ[0],3,0),_!==u[2]&&mi.set(lJ[2],1,2),f!==u[1]&&mi.set(lJ[1],0,1),f!==u[3]&&mi.set(lJ[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=oJ;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),uJ(rJ[0],rJ[2],rJ[1],rJ[3],cJ,r,aJ),uJ(rJ[0],rJ[2],rJ[1],rJ[3],cJ,r+o,sJ);for(var s=0,c=0;c<4;++c){var l=lJ[c];if(l)if(o>=eJ)n.dataLength=s+3,_J(i,s,cJ,iJ[l.x],iJ[l.y]),s+=3;else{var u=hJ(cJ,iJ[l.x]),h=hJ(cJ,iJ[l.y]);h<u&&(h+=eJ),u-=eJ,h-=eJ;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,_J(i,s,cJ,iJ[l.x],h>=a?sJ[c]:iJ[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,_J(i,s,cJ,aJ[c],iJ[l.y]),s+=3):(n.dataLength=s+3,_J(i,s,cJ,aJ[c],sJ[c]),s+=3))),u+=eJ,h+=eJ}}n.indicesCount=n.vertexCount=s,n.vertDirty=n.uvDirty=!1}},fillBuffers:function(e,t){var n=e.node,i=e.renderData;nJ.set(e.color),nJ.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData;e.getWorldMatrix(mH);for(var h=0;h<s;h++){var _=r[h];Zn.set(dH,_.x,_.y,0),Zn.transformMat4(dH,dH,mH),u[a++]=dH.x,u[a++]=dH.y,u[a++]=dH.z,u[a++]=_.u,u[a++]=_.v,Kn.toArray(u,i,a),a+=4}for(var f=o.iData,p=0;p<n.dataLength;p++)f[c+p]=l+p}(n,t,i,nJ)},updateColor:function(){}},dJ=[],mJ=0;mJ<4;mJ++)dJ.push(new Zn);for(var vJ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame;EH.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.uvDirty&&this.updateUvs(e))},updateWorldVerts:function(e,t){var n=e.renderData.data,i=e.node,r=n[0],o=n[3],a=i.worldMatrix,s=a.m00,c=a.m01,l=a.m04,u=a.m05,h=1===s&&0===c&&0===l&&1===u,_=a.m12,f=a.m13,p=r.x,d=o.x,m=r.y,v=o.y;if(h){var g=p+_,y=d+_,S=m+f,T=v+f;t[0]=g,t[1]=S,t[9]=y,t[10]=S,t[18]=g,t[19]=T,t[27]=y,t[28]=T}else{var E=s*p,x=s*d,A=c*p,b=c*d,C=l*m+_,w=l*v+_,R=u*m+f,P=u*v+f;t[0]=E+C,t[1]=A+R,t[9]=x+C,t[10]=b+R,t[18]=E+w,t[19]=A+P,t[27]=x+w,t[28]=b+P}i._uiProps.uiTransformDirty=!1},fillBuffers:function(e,t){if(null!==e){var n=e.renderData.vData;e.node._uiProps.uiTransformDirty&&this.updateWorldVerts(e,n);var i=t.acquireBufferBatch(),r=i.byteOffset>>2,o=i.indicesOffset,a=i.vertexOffset;i.request()||(i=t.currBufferBatch,r=0,o=0,a=0);var s=i.vData,c=i.iData;s.set(n,r);var l=a,u=a+1,h=a+2,_=a+3;c[o++]=l,c[o++]=u,c[o++]=h,c[o++]=h,c[o++]=u,c[o++]=_}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),S=r/d,T=o/m,E=y.x+(d-v)/2,x=y.x-(d-v)/2;c=E*S-a,l=(y.y+(m-g)/2)*T-s,u=r+x*S-a,h=o+(y.y-(m-g)/2)*T-s}i[0].x=c,i[0].y=l,i[3].x=u,i[3].y=h,t.vertDirty=!1,this.updateWorldVerts(e,t.vData)}},updateUvs:function(e){var t=e.renderData,n=t.vData,i=e.spriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,n=5,i=e.color,r=i.r/255,o=i.g/255,a=i.b/255,s=e.node._uiProps.opacity,c=0;c<4;c++)t[n]=r,t[n+1]=o,t[n+2]=a,t[n+3]=s,n+=9}},gJ=new Zn,yJ=new _i,SJ={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData:function(e){var t=e.spriteFrame;EH.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&n.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e))},updateVertexData:function(e){var t=e.renderData,n=t.data,i=e.node._uiProps.uiTransformComp,r=i.width,o=i.height,a=i.anchorX*r,s=i.anchorY*o,c=e.spriteFrame,l=c.insetLeft,u=c.insetRight,h=c.insetTop,_=c.insetBottom,f=r-l-u,p=o-h-_,d=r/(l+u),m=o/(h+_);d=Number.isNaN(d)||d>1?1:d,m=Number.isNaN(m)||m>1?1:m,f=f<0?0:f,p=p<0?0:p,n[0].x=-a,n[0].y=-s,n[1].x=l*d-a,n[1].y=_*m-s,n[2].x=n[1].x+f,n[2].y=n[1].y+p,n[3].x=r-a,n[3].y=o-s,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=t.acquireBufferBatch(),i=e.renderData,r=i.data,o=n.byteOffset>>2,a=i.vertexCount,s=n.indicesOffset,c=n.vertexOffset,l=e.spriteFrame.uvSliced;n.request(a,i.indicesCount)||(n=t.currBufferBatch,o=0,s=0,c=0);for(var u=n.vData,h=n.iData,_=4;_<20;++_){var f=r[_],p=l[_-4];u[o++]=f.x,u[o++]=f.y,u[o++]=f.z,u[o++]=p.u,u[o++]=p.v,Kn.toArray(u,r[_].color,o),o+=4}for(var d=0;d<3;++d)for(var m=0;m<3;++m){var v=c+4*d+m;h[s++]=v,h[s++]=v+1,h[s++]=v+4,h[s++]=v+1,h[s++]=v+5,h[s++]=v+4}},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(yJ);for(var i=0;i<4;++i)for(var r=n[i],o=0;o<4;++o){var a=n[o],s=n[4+4*i+o];Zn.set(gJ,a.x,r.y,0),Zn.transformMat4(s,gJ,yJ)}},updateColor:function(e){for(var t=e.renderData.data,n=e.color,i=n.r,r=n.g,o=n.b,a=255*e.node._uiProps.opacity,s=4;s<20;s++)t[s].color.r=i,t[s].color.g=r,t[s].color.b=o,t[s].color.a=a}},TJ=[],EJ=0;EJ<4;EJ++)TJ.push(new Zn);var xJ={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.uvDirty||t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,p=o-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,p,v,g),t.vertexCount=v*g*4,t.indicesCount=v*g*6,t.uvDirty=!1,t.vertDirty=!1,this.updateColor(e)}},fillBuffers:function(e,t){var n=e.node,i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=e.renderData,s=t.acquireBufferBatch(),c=s.indicesOffset,l=s.byteOffset>>2,u=s.vertexOffset,h=a.vertexCount,_=a.indicesCount,f=s.vData,p=s.iData;s.request(h,_)||(s=t.currBufferBatch,l=0,c=0,u=0);var d=e.spriteFrame,m=d.isRotated(),v=d.uv,g=e.spriteFrame.uvSliced,y=d.getRect(),S=d.insetLeft,T=d.insetRight,E=y.width-S-T,x=d.insetTop,A=d.insetBottom,b=y.height-x-A,C=r-S-T,w=o-x-A;C=C>0?C:0,w=w>0?w:0;var R=0===E?C:C/E,P=0===b?w:w/b,I=Math.ceil(P+2),O=Math.ceil(R+2),D=n.worldMatrix,N=a.data;this.fillVertices(f,l,D,I,O,N);for(var M=0,L=0,B=[],F=[],z=0,U=I;z<U;++z){L=w>b?w>=z*b?1:P%1:P;for(var k=0,G=O;k<G;++k){M=C>E?C>=k*E?1:R%1:R;var H=l+3,V=H+1;m?(0===z?(B[0]=g[0].u,B[1]=g[0].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z<I-1?(B[0]=g[4].u,B[1]=g[4].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z===I-1&&(B[0]=g[8].u,B[1]=g[8].u,B[2]=g[12].u),0===k?(F[0]=g[0].v,F[1]=g[1].v+(g[2].v-g[1].v)*M,F[2]=g[0].v):k<O-1?(F[0]=g[1].v,F[1]=g[1].v+(g[2].v-g[1].v)*M,F[2]=g[1].v):k===O-1&&(F[0]=g[2].v,F[1]=g[3].v,F[2]=g[2].v),B[3]=B[2],F[3]=F[1]):(0===k?(B[0]=g[0].u,B[1]=g[1].u+(g[2].u-g[1].u)*M,B[2]=v[0]):k<O-1?(B[0]=g[1].u,B[1]=g[1].u+(g[2].u-g[1].u)*M,B[2]=g[1].u):k===O-1&&(B[0]=g[2].u,B[1]=g[3].u,B[2]=g[2].u),0===z?(F[0]=g[0].v,F[1]=g[0].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z<I-1?(F[0]=g[4].v,F[1]=g[4].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z===I-1&&(F[0]=g[8].v,F[1]=g[8].v,F[2]=g[12].v),B[3]=B[1],F[3]=F[2]),f[H]=B[0],f[V]=F[0],f[H+9]=B[1],f[V+9]=F[1],f[H+18]=B[2],f[V+18]=F[2],f[H+27]=B[3],f[V+27]=F[3],Kn.toArray(f,N[0].color,V+1),Kn.toArray(f,N[0].color,V+9+1),Kn.toArray(f,N[0].color,V+18+1),Kn.toArray(f,N[0].color,V+27+1),l+=36}}for(var W=0;W<_;W+=6)p[c++]=u,p[c++]=u+1,p[c++]=u+2,p[c++]=u+1,p[c++]=u+3,p[c++]=u+2,u+=4},fillVertices:function(e,t,n,i,r,o){for(var a=0,s=0,c=0,l=0,u=0,h=i;u<h;++u){c=o[u].y,l=o[u+1].y;for(var _=0,f=r;_<f;++_){a=o[_].x,s=o[_+1].x,Zn.set(TJ[0],a,c,0),Zn.set(TJ[1],s,c,0),Zn.set(TJ[2],a,l,0),Zn.set(TJ[3],s,l,0);for(var p=0;p<4;p++){var d=TJ[p];Zn.transformMat4(d,d,n);var m=9*p;e[t+m]=d.x,e[t+m+1]=d.y,e[t+m+2]=d.z}t+=36}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.getRect(),h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,S=u.height-g-y,T=s.width/(d+m)>1?1:s.width/(d+m),E=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=S>0?Math.floor(1e3*n)/1e3%S==0?S:n%S:n;for(var x=0;x<=r;x++)0===x?c[x].x=-f:x>0&&x<r?c[x].x=1===x?d*T+Math.min(v,t)-f:v>0?x===r-1?d+o+v*(x-2)-f:d+Math.min(v,t)+v*(x-2)-f:d+t-f:x===r&&(c[x].x=Math.min(d+t+m,h)-f);for(var A=0;A<=i;A++)0===A?c[A].y=-p:A>0&&A<i?c[A].y=1===A?y*E+Math.min(S,n)-p:S>0?A===i-1?y+a+(A-2)*S-p:y+Math.min(S,n)+(A-2)*S-p:y+n-p:A===i&&(c[A].y=Math.min(y+n+g,_)-p)},updateColor:function(e){var t=e.renderData.data,n=t.length;if(0!==n)for(var i=e.color,r=i.r,o=i.g,a=i.b,s=255*e.node._uiProps.opacity,c=0;c<n;c++)t[c].color.r=r,t[c].color.g=o,t[c].color.b=a,t[c].color.a=s}},AJ=vY.Type,bJ=vY.FillType,CJ=e("spriteAssembler",{getAssembler:function(e){var t=vJ,n=e;switch(n.type){case AJ.SLICED:t=SJ;break;case AJ.TILED:t=xJ;break;case AJ.FILLED:t=n.fillType===bJ.RADIAL?pJ:$Z}return t}});vY.Assembler=CJ;var wJ=pW.sharedManager,RJ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){e.type===HX.IMAGE_STENCIL&&(vJ.updateRenderData(e),vJ.updateColor(e))},fillBuffers:function(e,t){(e.type!==HX.IMAGE_STENCIL||e.spriteFrame)&&(wJ.pushMask(e),t.finishMergeBatches(),function(e,t){wJ.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(wJ.enterLevel(e),e.type===HX.IMAGE_STENCIL){vJ.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),wJ.enableMask())}},PJ={fillBuffers:function(){wJ.exitMask()}},IJ={getAssembler:function(){return RJ}},OJ={getAssembler:function(){return PJ}};ZX.Assembler=IJ,ZX.PostAssembler=OJ;var DJ=new Ko(null),NJ=new _i,MJ=e("UI",function(){var e=t.prototype;function t(e){var t=this;this.device=void 0,this._screens=[],this._bufferBatchPool=new ee((function(){return new pK(t)}),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new Ag,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currOpacity=1,this._descriptorSetCache=new BJ,this._root=e,this.device=e.device,this._batches=new te(64),this._drawBatchPool=new $((function(){return new kK}),128)}return e.acquireBufferBatch=function(e){void 0===e&&(e=fX);var t=e===fX?36:mX(e);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===t||this._requireBufferBatch(e),this._currMeshBuffer},e.registerCustomBuffer=function(e,t){var n;e instanceof pK?n=e:(n=this._bufferBatchPool.add()).initialize(e,t||this._recreateMeshBuffer.bind(this,e));var i=n.vertexFormatBytes,r=this._customMeshBuffers.get(i);return r||(r=[],this._customMeshBuffers.set(i,r)),r.push(n),n},e.unRegisterCustomBuffer=function(e){var t=this._customMeshBuffers.get(e.vertexFormatBytes);if(t)for(var n=0;n<t.length;n++)if(t[n]===e){t.splice(n,1);break}var i=this._bufferBatchPool.data.indexOf(e);-1!==i&&(e.reset(),this._bufferBatchPool.removeAt(i))},e.initialize=function(){return!0},e.destroy=function(){for(var e=this,t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(var n,i=Q(this._meshBuffers.keys());!(n=i()).done;){var r=n.value,o=this._meshBuffers.get(r);o&&o.forEach((function(e){return e.destroy()}))}this._drawBatchPool&&this._drawBatchPool.destroy((function(t){t.destroy(e)})),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),pW.sharedManager.destroy()},e.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},e.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.addUploadBuffersFunc=function(e,t){this._doUploadBuffersCall.set(e,t)},e.removeUploadBuffersFunc=function(e){this._doUploadBuffersCall.delete(e)},e.update=function(){for(var e=this._screens,t=0;t<e.length;++t){var n=e[t];n.enabledInHierarchy&&(this._currOpacity=1,this._recursiveScreenNode(n.node))}var i=0;if(this._batches.length)for(var r=0;r<this._batches.length;++r){var o=this._batches.array[r];if(o.renderScene){if(o.model)for(var a=o.model.subModels,s=0;s<a.length;s++)a[s].priority=i++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);o.renderScene.addBatch(o)}}},e.uploadBuffers=function(){var e=this;this._batches.length>0&&(this._doUploadBuffersCall.forEach((function(t,n){t.call(n,e)})),this._meshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._customMeshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._descriptorSetCache.update())},e.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._currOpacity=1,this._meshBufferUseCount.clear(),this._batches.clear(),pW.sharedManager.reset(),this._descriptorSetCache.reset()},e.commitComp=function(e,t,n,i){var r,o,a=e,s=0,c=0;t?(r=t.getGFXTexture(),o=t.getGFXSampler(),s=t.getHash(),c=t.getSamplerHash()):(r=null,o=null);var l=a._getRenderScene(),u=a.getRenderMaterial(0);a.stencilStage=pW.sharedManager.stage;var h=a.blendHash,_=a.stencilStage;this._currScene===l&&this._currLayer===e.node.layer&&this._currMaterial===u&&this._currBlendTargetHash===h&&this._currDepthStencilStateStage===_&&this._currTextureHash===s&&this._currSamplerHash===c&&this._currTransform===i||(this.autoMergeBatches(this._currComponent),this._currScene=l,this._currComponent=a,this._currTransform=i,this._currMaterial=u,this._currTexture=r,this._currSampler=o,this._currTextureHash=s,this._currSamplerHash=c,this._currBlendTargetHash=h,this._currDepthStencilStateStage=_,this._currLayer=e.node.layer),n&&n.fillBuffers(a,this)},e.commitModel=function(e,t,n){var r;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var o=0;n&&(e.stencilStage!==CV.ENABLED&&e.stencilStage!==CV.DISABLED||(e.stencilStage=pW.sharedManager.stage),r=pW.sharedManager.getStencilStage(e.stencilStage,n),o=pW.sharedManager.getStencilHash(e.stencilStage));var a=i.director.getTotalFrames();t&&(t.updateTransform(a),t.updateUBOs(a));for(var s=0;s<t.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=t.subModels[s];c.renderScene=e._getRenderScene(),c.visFlags=e.node.layer,c.model=t,c.bufferBatch=null,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,o,null,0,l.patches),c.descriptorSet=l.descriptorSet,c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,this._batches.push(c)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(e){var t=this.currBufferBatch,n=null==t?void 0:t.recordBatch(),i=this._currMaterial;if(n&&i&&t){var r,o,a=0,s=0;e&&(r=-1===e.blendHash?null:e.getBlendState(),s=e.blendHash,o=null!==e.customMaterial?pW.sharedManager.getStencilStage(e.stencilStage,i):pW.sharedManager.getStencilStage(e.stencilStage),a=pW.sharedManager.getStencilHash(e.stencilStage));var c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=t,c.texture=this._currTexture,c.sampler=this._currSampler,c.inputAssembler=n,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(i,o,a,r,s,null),this._batches.push(c),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset,Ni.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}},e.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=t.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this._currScene=n._getRenderScene(),this.autoMergeBatches(n)},e.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.flushMaterial=function(e){this._currMaterial=e},e.walk=function(e,t){void 0===t&&(t=0);var n=e.children.length;if(this._preProcess(e),n>0&&!e._static)for(var i=e.children,r=0;r<i.length;++r){this._currOpacity=e._uiProps.opacity;var o=i[r];this.walk(o,t)}this._postProcess(e),t+=1},e._preProcess=function(e){var t=e._uiProps.uiComp,n=e._uiProps.localOpacity;e._uiProps.opacity=this._currOpacity*n,e._uiProps.uiTransformComp&&t&&t.enabledInHierarchy&&t.updateAssembler(this)},e._postProcess=function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)},e._recursiveScreenNode=function(e){this.walk(e),this.autoMergeBatches(this._currComponent)},e._createMeshBuffer=function(e){var t=this._bufferBatchPool.add();t.initialize(e,this._recreateMeshBuffer.bind(this,e));var n=mX(e),i=this._meshBuffers.get(n);return i||(i=[],this._meshBuffers.set(n,i)),i.push(t),t},e._recreateMeshBuffer=function(e,t,n){this.autoMergeBatches(),this._requireBufferBatch(e,t,n)},e._requireBufferBatch=function(e,t,n){var i=mX(e),r=this._meshBuffers.get(i);r||(r=[],this._meshBuffers.set(i,r));var o=this._meshBufferUseCount.get(i)||0;(t&&n||Ni.__isWebIOS14OrIPadOS14Env)&&o++,this._currMeshBuffer=r[o],this._currMeshBuffer||(this._currMeshBuffer=this._createMeshBuffer(e)),this._meshBufferUseCount.set(i,o),t&&n&&this._currMeshBuffer.request(t,n)},e._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},k(t,[{key:"currBufferBatch",get:function(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),t}()),LJ=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=i.director.root.device;this._localData=new Float32Array(ud.COUNT),this._localBuffer=e.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,ud.SIZE,ud.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=i.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,DJ.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(DJ),this._descriptorSet.bindBuffer(ud.BINDING,this._localBuffer);var n=Ip.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.updateLocal=function(){this._transform&&this.uploadLocalData()},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&e.updateWorldTransform(),this._transformUpdate){var t=e._mat;_i.toArray(this._localData,t,ud.MAT_WORLD_OFFSET),_i.inverseTranspose(NJ,t);var n=_i.determinant(NJ),i=1/Math.sqrt(n);_i.multiplyScalar(NJ,NJ,i),_i.toArray(this._localData,NJ,ud.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},k(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),BJ=function(){function e(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new $((function(){return new LJ}),16)}var t=e.prototype;return t.getDescriptorSet=function(e){var t=i.director.root;if(e.useLocalData){for(var n=this._localDescriptorSetCache,r=0,o=n.length;r<o;r++){var a=n[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}var c=this._descriptorSetCache.get(e.textureHash);if(c&&c.has(e.samplerHash))return c.get(e.samplerHash);i.director.root.device,DJ.layout=e.passes[0].localSetLayout;var l=t.device.createDescriptorSet(DJ),u=Ip.SAMPLER_SPRITE;return l.bindTexture(u,e.texture),l.bindSampler(u,e.sampler),l.update(),c?this._descriptorSetCache.get(e.textureHash).set(e.samplerHash,l):this._descriptorSetCache.set(e.textureHash,new Map([[e.samplerHash,l]])),l},t.update=function(){this._localDescriptorSetCache.forEach((function(e){e.updateLocal()}))},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).forEach((function(e){e.destroy()})),this._descriptorSetCache.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.forEach((function(e){e.destroy()}))})),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy((function(e){e.destroy()}))},e}();i.internal.Batcher2D=MJ;var FJ,zJ,UJ,kJ,GJ,HJ,VJ,WJ,jJ,XJ,qJ,YJ,KJ,QJ,ZJ,JJ,$J,e$,t$,n$,i$,r$,o$,a$,s$,c$,l$,u$,h$,_$,f$,p$,d$,m$,v$,g$,y$,S$,T$,E$,x$,A$,b$,C$,w$,R$,P$,I$,O$,D$,N$,M$=null,L$=-1,B$="BES bswy:->@123丁ぁᄁ",F$=Object.create(null),z$=[],U$=3e3;function k$(){for(var e=!0,t=Date.now(),n=z$.length-1;n>=0;n--){var i=z$[n],r=i.fontFamilyName;if(t-i.startTime>U$)A(4933,r),i.onComplete(null,r),z$.splice(n,1);else{var o=i.refWidth,a="40px "+r;M$.font=a,o!==lV(M$,B$,a)?(z$.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(L$),L$=-1)}function G$(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(F$[i])n(null,i);else{if(!M$){var r=document.createElement("canvas");r.width=100,r.height=100,M$=r.getContext("2d")}var o=lV(M$,B$,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===FJ)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);FJ=e?parseInt(e[1],10)>42:!t}else FJ=!1;return FJ}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=U$?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,U$)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){A(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};z$.push(u),-1===L$&&(L$=setInterval(k$,100))}F$[i]=a}}function H$(e,t,n,i){var r=new jH;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}fN.register({".font":G$,".eot":G$,".ttf":G$,".woff":G$,".svg":G$,".ttc":G$}),SN.register({".font":H$,".eot":H$,".ttf":H$,".woff":H$,".svg":H$,".ttc":H$}),i.UI={MeshBuffer:pK,spriteAssembler:CJ,graphicsAssembler:wQ,labelAssembler:KZ};var V$,W$,j$,X$=new Kn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(V$||(V$={})),et(V$),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(W$||(W$={})),function(e){e.CLICK="click"}(j$||(j$={}));var q$,Y$,K$,Q$=function(t){return e({Button:t,ButtonComponent:t}),t}((zJ=Zc("cc.Button"),UJ=_l(),kJ=$c(110),GJ=cl(),HJ=Jc(YV),VJ=Pl(qC),WJ=El(),jJ=ml(),XJ=El(),qJ=ml(),YJ=Pl(V$),KJ=El(),QJ=ml(),ZJ=ml(),JJ=ml(),$J=ml(),e$=ml(),t$=gl(),n$=yl(),i$=ml(),r$=ml(),o$=Pl(RH),a$=ml(),s$=Pl(RH),c$=ml(),l$=Pl(RH),u$=ml(),h$=Pl(RH),_$=ml(),f$=Pl([gL]),p$=El(),d$=ml(),zJ(m$=UJ(m$=kJ(m$=GJ(m$=HJ(m$=sl((N$=D$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",g$,Y(t)),Z(t,"_interactable",y$,Y(t)),Z(t,"_transition",S$,Y(t)),Z(t,"_normalColor",T$,Y(t)),Z(t,"_hoverColor",E$,Y(t)),Z(t,"_pressedColor",x$,Y(t)),Z(t,"_disabledColor",A$,Y(t)),Z(t,"_normalSprite",b$,Y(t)),Z(t,"_hoverSprite",C$,Y(t)),Z(t,"_pressedSprite",w$,Y(t)),Z(t,"_disabledSprite",R$,Y(t)),Z(t,"_duration",P$,Y(t)),Z(t,"_zoomScale",I$,Y(t)),Z(t,"_target",O$,Y(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new Kn,t._toColor=new Kn,t._time=0,t._transitionFinished=!0,t._fromScale=new Zn,t._toScale=new Zn,t._originalScale=null,t._sprite=null,t._targetScale=new Zn,t}H(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(vY);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===V$.COLOR||this._transition===V$.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===V$.COLOR){var i=t._uiProps.uiComp;Kn.lerp(X$,this._fromColor,this._toColor,n),i&&(i.color=X$)}else this.transition===V$.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Dn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=Dn(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===V$.COLOR&&this._interactable){var n=e.getComponent(bj);n&&(n.color=this._normalColor)}else t===V$.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(NA.TOUCH_START,this._onTouchBegan,this),this.node.on(NA.TOUCH_MOVE,this._onTouchMove,this),this.node.on(NA.TOUCH_END,this._onTouchEnded,this),this.node.on(NA.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(NA.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(NA.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(NA.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(NA.TOUCH_START,this._onTouchBegan,this),this.node.off(NA.TOUCH_MOVE,this._onTouchMove,this),this.node.off(NA.TOUCH_END,this._onTouchEnded,this),this.node.off(NA.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(NA.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(NA.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(NA.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(vY)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Zn),Zn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===V$.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case W$.NORMAL:this._normalSprite=e;break;case W$.HOVER:this._hoverSprite=e;break;case W$.PRESSED:this._pressedSprite=e;break;case W$.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===V$.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case W$.NORMAL:this._normalColor=e;break;case W$.HOVER:this._hoverColor=e;break;case W$.PRESSED:this._pressedColor=e;break;case W$.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&eg.SCALE&&this._originalScale&&this._transition===V$.SCALE&&this._transitionFinished&&Zn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===V$.SCALE&&this.target&&this._originalScale?i?(Zn.copy(this._fromScale,this._originalScale),Zn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?W$.PRESSED:W$.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(gL.emitEvents(this.clickEvents,e),this.node.emit(j$.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==V$.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=W$.NORMAL;return this._interactable?this._pressed?e=W$.PRESSED:this._hovered&&(e=W$.HOVER):e=W$.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(bj);i&&(e===W$.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===W$.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Zn.copy(this._fromScale,this._originalScale),Zn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Zn.copy(this._fromScale,this.target.getScale()),Zn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===V$.COLOR?this._updateColorTransition(e):t===V$.SPRITE?this._updateSpriteTransition(e):t===V$.SCALE&&this._updateScaleTransition(e)},k(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===V$.COLOR?this._updateColorTransition(W$.NORMAL):this._transition===V$.SPRITE&&this._updateSpriteTransition(W$.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(vY);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(qu),D$.Transition=V$,D$.EventType=j$,J((v$=N$).prototype,"target",[VJ,WJ,jJ],Object.getOwnPropertyDescriptor(v$.prototype,"target"),v$.prototype),J(v$.prototype,"interactable",[XJ,qJ],Object.getOwnPropertyDescriptor(v$.prototype,"interactable"),v$.prototype),J(v$.prototype,"transition",[YJ,KJ,QJ],Object.getOwnPropertyDescriptor(v$.prototype,"transition"),v$.prototype),J(v$.prototype,"normalColor",[ZJ],Object.getOwnPropertyDescriptor(v$.prototype,"normalColor"),v$.prototype),J(v$.prototype,"pressedColor",[JJ],Object.getOwnPropertyDescriptor(v$.prototype,"pressedColor"),v$.prototype),J(v$.prototype,"hoverColor",[$J],Object.getOwnPropertyDescriptor(v$.prototype,"hoverColor"),v$.prototype),J(v$.prototype,"disabledColor",[e$],Object.getOwnPropertyDescriptor(v$.prototype,"disabledColor"),v$.prototype),J(v$.prototype,"duration",[t$,n$,i$],Object.getOwnPropertyDescriptor(v$.prototype,"duration"),v$.prototype),J(v$.prototype,"zoomScale",[r$],Object.getOwnPropertyDescriptor(v$.prototype,"zoomScale"),v$.prototype),J(v$.prototype,"normalSprite",[o$,a$],Object.getOwnPropertyDescriptor(v$.prototype,"normalSprite"),v$.prototype),J(v$.prototype,"pressedSprite",[s$,c$],Object.getOwnPropertyDescriptor(v$.prototype,"pressedSprite"),v$.prototype),J(v$.prototype,"hoverSprite",[l$,u$],Object.getOwnPropertyDescriptor(v$.prototype,"hoverSprite"),v$.prototype),J(v$.prototype,"disabledSprite",[h$,_$],Object.getOwnPropertyDescriptor(v$.prototype,"disabledSprite"),v$.prototype),g$=J(v$.prototype,"clickEvents",[f$,il,p$,d$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),y$=J(v$.prototype,"_interactable",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S$=J(v$.prototype,"_transition",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V$.NONE}}),T$=J(v$.prototype,"_normalColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kn.WHITE.clone()}}),E$=J(v$.prototype,"_hoverColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(211,211,211,255)}}),x$=J(v$.prototype,"_pressedColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kn.WHITE.clone()}}),A$=J(v$.prototype,"_disabledColor",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(124,124,124,255)}}),b$=J(v$.prototype,"_normalSprite",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C$=J(v$.prototype,"_hoverSprite",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w$=J(v$.prototype,"_pressedSprite",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R$=J(v$.prototype,"_disabledSprite",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P$=J(v$.prototype,"_duration",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),I$=J(v$.prototype,"_zoomScale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),O$=J(v$.prototype,"_target",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m$=v$))||m$)||m$)||m$)||m$)||m$)||m$)),Z$=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();Z$._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(q$||(q$={})),Ze(q$),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(Y$||(Y$={})),Ze(Y$),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(K$||(K$={})),Ze(K$);var J$,$$,e0,t0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,_0,f0,p0,d0,m0,v0,g0,y0,S0,T0,E0,x0,A0,b0,C0,w0,R0,P0,I0,O0,D0,N0,M0,L0,B0,F0,z0,U0,k0,G0,H0,V0,W0,j0,X0,q0,Y0,K0,Q0,Z0,J0,$0,e1,t1,n1,i1,r1,o1=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),a1=new _i,s1=new _i,c1=new Zn,l1=null,u1=0,h1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++u1,t}H(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===Y$.ANY?this._createTextArea():this._createInput(),Z$.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),this.__autoResize=yD._resizeWithBrowserSize)},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),Z$.remove(this),l1===this&&(l1=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,Z$.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){l1&&l1!==this&&l1.setFocus(!1),this._editing=!0,l1=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){i.GAME_VIEW&&this._edTxt?(i.gameView.container.appendChild(this._edTxt),i.gameView.head.appendChild(this._placeholderStyleSheet)):uD.container&&this._edTxt&&(uD.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(i.GAME_VIEW?ut(i.gameView.container,this._edTxt):ut(uD.container,this._edTxt))&&this._edTxt&&(i.GAME_VIEW?i.gameView.container.removeChild(this._edTxt):uD.container.removeChild(this._edTxt)),(i.GAME_VIEW?ut(i.gameView.head,this._placeholderStyleSheet):ut(document.head,this._placeholderStyleSheet))&&(i.GAME_VIEW?i.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Ni.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Ni.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){Ni.os!==B.ANDROID&&Ni.os!==B.OHOS||(this.__autoResize&&yD.resizeWithBrowserSize(!1),this._adjustWindowScroll())},n._hideDomOnMobile=function(){Ni.os!==B.ANDROID&&Ni.os!==B.OHOS||this.__autoResize&&yD.resizeWithBrowserSize(!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){Ni.browserType!==N.WECHAT||Ni.os!==B.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=yD.getScaleX(),n=yD.getScaleY(),r=1,o=1;i.GAME_VIEW&&(r=i.gameView.canvas.width/i.game.canvas.width,o=i.gameView.canvas.height/i.game.canvas.height),t*=r,n*=o;var a=yD.getViewportRect(),s=yD.getDevicePixelRatio();e.getWorldMatrix(a1);var c=e._uiProps.uiTransformComp;if(c&&Zn.set(c1,-c.anchorX*c.width,-c.anchorY*c.height,c1.z),_i.transform(a1,a1,c1),e._uiProps.uiTransformComp){var l=DD.root.batcher2D.getFirstRenderCamera(e);if(l){l.node.getWorldRT(s1);var u=s1.m12,h=s1.m13,_=hD.center;s1.m12=_.x-(s1.m00*u+s1.m04*h),s1.m13=_.y-(s1.m01*u+s1.m05*h),_i.multiply(s1,s1,a1),t/=s,n/=s;var f=i.GAME_VIEW?i.gameView.container:uD.container,p=s1.m00*t,d=a1.m01,m=a1.m04,v=s1.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=a.x*r/s;var y=parseInt(f&&f.style.paddingBottom||"0");y+=a.y/s;var S="matrix("+p+","+-d+","+-m+","+v+","+(s1.m12*t+g)+","+-(s1.m13*n+y)+")";this._edTxt.style.transform=S,this._edTxt.style["-webkit-transform"]=S,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===K$.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===K$.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===K$.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===Y$.EMAIL_ADDR?a="email":t===Y$.NUMERIC||t===Y$.DECIMAL?a="number":t===Y$.PHONE_NUMBER?(a="number",r.pattern="[0-9]*"):t===Y$.URL?a="url":(a="text",i===q$.SEARCH&&(a="search")),r.type=a;var s="none";n===K$.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===K$.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof KH?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case Pj.HorizontalAlign.LEFT:i.style.textAlign="left";break;case Pj.HorizontalAlign.CENTER:i.style.textAlign="center";break;case Pj.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof KH?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case Pj.HorizontalAlign.LEFT:a="left";break;case Pj.HorizontalAlign.CENTER:a="center";break;case Pj.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",Ni.browserType===N.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&Ni.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===FO.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===FO.TAB&&(n.propagationStopped=!0,n.preventDefault(),Z$.next(e))},i.onBlur=function(){Ni.isMobile&&n&&i.compositionEnd(),e._editing=!1,l1=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(o1);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(r1||(r1={}));var _1,f1,p1,d1,m1,v1,g1,y1,S1,T1,E1,x1,A1,b1,C1,w1,R1,P1,I1,O1,D1,N1,M1,L1,B1,F1,z1,U1,k1,G1,H1,V1,W1,j1,X1,q1,Y1,K1,Q1,Z1,J1,$1,e2,t2,n2,i2,r2,o2,a2,s2,c2,l2,u2,h2,_2,f2,p2,d2,m2,v2,g2=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((J$=Zc("cc.EditBox"),$$=_l(),e0=$c(110),t0=cl(),n0=Jc(YV),i0=El(),r0=ml(),o0=El(),a0=ml(),s0=Pl(Pj),c0=El(),l0=ml(),u0=Pl(Pj),h0=El(),_0=ml(),f0=Pl(RH),p0=El(),d0=ml(),m0=Pl(K$),v0=El(),g0=ml(),y0=Pl(Y$),S0=El(),T0=ml(),E0=Pl(q$),x0=El(),A0=ml(),b0=El(),C0=ml(),w0=El(),R0=ml(),P0=Pl([gL]),I0=El(),O0=ml(),D0=Pl([gL]),N0=El(),M0=ml(),L0=Pl([gL]),B0=El(),F0=ml(),z0=Pl([gL]),U0=El(),k0=ml(),J$(G0=$$(G0=e0(G0=t0(G0=n0(G0=sl((i1=n1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",V0,Y(t)),Z(t,"textChanged",W0,Y(t)),Z(t,"editingDidEnded",j0,Y(t)),Z(t,"editingReturn",X0,Y(t)),t._impl=null,t._background=null,Z(t,"_textLabel",q0,Y(t)),Z(t,"_placeholderLabel",Y0,Y(t)),Z(t,"_returnType",K0,Y(t)),Z(t,"_string",Q0,Y(t)),Z(t,"_tabIndex",Z0,Y(t)),Z(t,"_backgroundImage",J0,Y(t)),Z(t,"_inputFlag",$0,Y(t)),Z(t,"_inputMode",e1,Y(t)),Z(t,"_maxLength",t1,Y(t)),t._isLabelVisible=!1,t}H(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){gL.emitEvents(this.editingDidBegan,this),this.node.emit(r1.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){gL.emitEvents(this.editingDidEnded,this),this.node.emit(r1.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,gL.emitEvents(this.textChanged,e,this),this.node.emit(r1.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){gL.emitEvents(this.editingReturn,this),this.node.emit(r1.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(NA.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(vY);e||(e=this.node.addComponent(vY)),e!==this._background&&(e.type=vY.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new qC("TEXT_LABEL")),(e=t.getComponent(Pj))||(e=t.addComponent(Pj)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=Pj.Overflow.CLAMP,this._inputMode===Y$.ANY?(e.verticalAlign=Ej.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new qC("PLACEHOLDER_LABEL")),(e=t.getComponent(Pj))||(e=t.addComponent(Pj)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=Pj.Overflow.CLAMP,this._inputMode===Y$.ANY?(e.verticalAlign=Ej.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==K$.PASSWORD)i===K$.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===K$.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===K$.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="●";e=r}return e},n._registerEvent=function(){this.node.on(NA.TOUCH_START,this._onTouchBegan,this),this.node.on(NA.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(NA.TOUCH_START,this._onTouchBegan,this),this.node.off(NA.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(vY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(vY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===Y$.ANY&&(o.verticalAlign=Ej.TOP),o.enableWrapText=this._inputMode===Y$.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===Y$.ANY&&(r.verticalAlign=Ej.TOP),r.enableWrapText=this._inputMode===Y$.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize)},k(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(qu),n1._EditBoxImpl=o1,n1.KeyboardReturnType=q$,n1.InputFlag=K$,n1.InputMode=Y$,n1.EventType=r1,J((H0=i1).prototype,"string",[i0,r0],Object.getOwnPropertyDescriptor(H0.prototype,"string"),H0.prototype),J(H0.prototype,"placeholder",[o0,a0],Object.getOwnPropertyDescriptor(H0.prototype,"placeholder"),H0.prototype),J(H0.prototype,"textLabel",[s0,c0,l0],Object.getOwnPropertyDescriptor(H0.prototype,"textLabel"),H0.prototype),J(H0.prototype,"placeholderLabel",[u0,h0,_0],Object.getOwnPropertyDescriptor(H0.prototype,"placeholderLabel"),H0.prototype),J(H0.prototype,"backgroundImage",[f0,p0,d0],Object.getOwnPropertyDescriptor(H0.prototype,"backgroundImage"),H0.prototype),J(H0.prototype,"inputFlag",[m0,v0,g0],Object.getOwnPropertyDescriptor(H0.prototype,"inputFlag"),H0.prototype),J(H0.prototype,"inputMode",[y0,S0,T0],Object.getOwnPropertyDescriptor(H0.prototype,"inputMode"),H0.prototype),J(H0.prototype,"returnType",[E0,x0,A0],Object.getOwnPropertyDescriptor(H0.prototype,"returnType"),H0.prototype),J(H0.prototype,"maxLength",[b0,C0],Object.getOwnPropertyDescriptor(H0.prototype,"maxLength"),H0.prototype),J(H0.prototype,"tabIndex",[w0,R0],Object.getOwnPropertyDescriptor(H0.prototype,"tabIndex"),H0.prototype),V0=J(H0.prototype,"editingDidBegan",[P0,il,I0,O0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),W0=J(H0.prototype,"textChanged",[D0,il,N0,M0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),j0=J(H0.prototype,"editingDidEnded",[L0,il,B0,F0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X0=J(H0.prototype,"editingReturn",[z0,il,U0,k0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),q0=J(H0.prototype,"_textLabel",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y0=J(H0.prototype,"_placeholderLabel",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K0=J(H0.prototype,"_returnType",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q$.DEFAULT}}),Q0=J(H0.prototype,"_string",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Z0=J(H0.prototype,"_tabIndex",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J0=J(H0.prototype,"_backgroundImage",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$0=J(H0.prototype,"_inputFlag",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return K$.DEFAULT}}),e1=J(H0.prototype,"_inputMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y$.ANY}}),t1=J(H0.prototype,"_maxLength",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),G0=H0))||G0)||G0)||G0)||G0)||G0)||G0));"object"==typeof window&&"object"==typeof document&&(g2._EditBoxImpl=h1),function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(_2||(_2={})),et(_2),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(f2||(f2={})),et(f2),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(p2||(p2={})),et(p2),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(d2||(d2={})),et(d2),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(m2||(m2={})),et(m2),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(v2||(v2={})),et(v2);var y2,S2,T2,E2,x2,A2,b2,C2,w2,R2,P2,I2,O2,D2,N2,M2,L2,B2,F2,z2,U2,k2,G2,H2=new Zn,V2=function(t){return e({Layout:t,LayoutComponent:t}),t}((_1=Zc("cc.Layout"),f1=_l(),p1=$c(110),d1=cl(),m1=Jc(YV),v1=pl(),g1=ml(),y1=pl(),S1=ml(),T1=Pl(_2),E1=ml(),x1=Pl(f2),A1=pl(),b1=ml(),C1=pl(),w1=ml(),R1=Pl(p2),P1=ml(),I1=ml(),O1=ml(),D1=ml(),N1=ml(),M1=ml(),L1=ml(),B1=Pl(d2),F1=ml(),z1=Pl(m2),U1=ml(),k1=Pl(v2),G1=pl(),H1=ml(),V1=pl(),W1=ml(),j1=ml(),_1(X1=f1(X1=p1(X1=d1(X1=m1(X1=sl((h2=u2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",Y1,Y(t)),Z(t,"_layoutType",K1,Y(t)),Z(t,"_cellSize",Q1,Y(t)),Z(t,"_startAxis",Z1,Y(t)),Z(t,"_paddingLeft",J1,Y(t)),Z(t,"_paddingRight",$1,Y(t)),Z(t,"_paddingTop",e2,Y(t)),Z(t,"_paddingBottom",t2,Y(t)),Z(t,"_spacingX",n2,Y(t)),Z(t,"_spacingY",i2,Y(t)),Z(t,"_verticalDirection",r2,Y(t)),Z(t,"_horizontalDirection",o2,Y(t)),Z(t,"_constraint",a2,Y(t)),Z(t,"_constraintNum",s2,Y(t)),Z(t,"_affectedByScale",c2,Y(t)),Z(t,"_isAlign",l2,Y(t)),t._layoutSize=new xi(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}H(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(xi.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){DD.on(OD.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(NA.SIZE_CHANGED,this._resized,this),this.node.on(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(NA.CHILD_ADDED,this._childAdded,this),this.node.on(NA.CHILD_REMOVED,this._childRemoved,this),this.node.on(NA.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){DD.off(OD.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(NA.SIZE_CHANGED,this._resized,this),this.node.off(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(NA.CHILD_ADDED,this._childAdded,this),this.node.off(NA.CHILD_REMOVED,this._childRemoved,this),this.node.off(NA.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(NA.SIZE_CHANGED,this._doLayoutDirty,this),n.on(NA.TRANSFORM_CHANGED,this._transformDirty,this),n.on(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on("active-in-hierarchy-changed",this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(NA.SIZE_CHANGED,this._doLayoutDirty,this),n.off(NA.TRANSFORM_CHANGED,this._transformDirty,this),n.off(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off("active-in-hierarchy-changed",this._childrenChanged,this)}},n._childAdded=function(e){e.on(NA.SIZE_CHANGED,this._doLayoutDirty,this),e.on(NA.TRANSFORM_CHANGED,this._transformDirty,this),e.on(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(NA.SIZE_CHANGED,this._doLayoutDirty,this),e.off(NA.TRANSFORM_CHANGED,this._transformDirty,this),e.off(NA.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===m2.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==_2.GRID&&this._resizeMode===f2.CHILDREN&&(m=(e-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],T=S.node,E=T.scale,x=this._getUsedScaleValue(E.x),A=this._getUsedScaleValue(E.y);this._resizeMode===f2.CHILDREN&&(S.width=m/x,this._layoutType===_2.GRID&&(S.height=this._cellSize.height/A));var b=Math.abs(this._horizontalDirection-S.anchorX),C=S.width*x,w=S.height*A;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(b*C+this._spacingX);var R=a*(1-b)*C;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(C>e-v)l>c+a*b*C&&(p=!0);else{var P=(1-this._horizontalDirection-r.x)*e,I=l+R+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(I)>Math.abs(P)}p&&(l=c+a*b*C,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var O=n(T,S,u);i&&T.setPosition(l,O),l+=R}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===d2.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==_2.GRID&&this._resizeMode===f2.CHILDREN&&(m=(e-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],T=S.node,E=T.scale,x=this._getUsedScaleValue(E.x),A=this._getUsedScaleValue(E.y);this._resizeMode===f2.CHILDREN&&(S.height=m/A,this._layoutType===_2.GRID&&(S.width=this._cellSize.width/x));var b=Math.abs(this._verticalDirection-S.anchorY),C=S.width*x,w=S.height*A;C>u&&(h=Math.max(u,h),_=u||C,u=C),l+=a*(b*w+this._spacingY);var R=a*(1-b)*w;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>e-v)l>c+a*b*w&&(p=!0);else{var P=(1-this._verticalDirection-r.y)*e,I=l+R+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(I)>Math.abs(P)}p&&(l=c+a*b*w,C!==u&&(_=u),f+=_+this._spacingX,_=u=C)}var O=n(T,S,f);i&&(T.getPosition(H2),T.setPosition(O,l,H2.z)),l+=R}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===d2.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===f2.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===d2.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===f2.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===m2.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===f2.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===m2.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===f2.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===p2.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===p2.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===f2.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===f2.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===_2.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?Zn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===_2.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?Zn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===_2.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&eg.SCALE&&e&eg.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==_2.GRID||this._constraint===v2.NONE||this._constraintNum<=0)return 0;var e=this._constraint===v2.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===p2.VERTICAL&&(e=this._constraint===v2.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},k(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===_2.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===_2.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==_2.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==_2.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==v2.NONE&&this._constraintNum!==e&&(e<=0&&p("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(qu),u2.Type=_2,u2.VerticalDirection=d2,u2.HorizontalDirection=m2,u2.ResizeMode=f2,u2.AxisDirection=p2,u2.Constraint=v2,J((q1=h2).prototype,"alignHorizontal",[v1,g1],Object.getOwnPropertyDescriptor(q1.prototype,"alignHorizontal"),q1.prototype),J(q1.prototype,"alignVertical",[y1,S1],Object.getOwnPropertyDescriptor(q1.prototype,"alignVertical"),q1.prototype),J(q1.prototype,"type",[T1,E1],Object.getOwnPropertyDescriptor(q1.prototype,"type"),q1.prototype),J(q1.prototype,"resizeMode",[x1,A1,b1],Object.getOwnPropertyDescriptor(q1.prototype,"resizeMode"),q1.prototype),J(q1.prototype,"cellSize",[C1,w1],Object.getOwnPropertyDescriptor(q1.prototype,"cellSize"),q1.prototype),J(q1.prototype,"startAxis",[R1,P1],Object.getOwnPropertyDescriptor(q1.prototype,"startAxis"),q1.prototype),J(q1.prototype,"paddingLeft",[I1],Object.getOwnPropertyDescriptor(q1.prototype,"paddingLeft"),q1.prototype),J(q1.prototype,"paddingRight",[O1],Object.getOwnPropertyDescriptor(q1.prototype,"paddingRight"),q1.prototype),J(q1.prototype,"paddingTop",[D1],Object.getOwnPropertyDescriptor(q1.prototype,"paddingTop"),q1.prototype),J(q1.prototype,"paddingBottom",[N1],Object.getOwnPropertyDescriptor(q1.prototype,"paddingBottom"),q1.prototype),J(q1.prototype,"spacingX",[M1],Object.getOwnPropertyDescriptor(q1.prototype,"spacingX"),q1.prototype),J(q1.prototype,"spacingY",[L1],Object.getOwnPropertyDescriptor(q1.prototype,"spacingY"),q1.prototype),J(q1.prototype,"verticalDirection",[B1,F1],Object.getOwnPropertyDescriptor(q1.prototype,"verticalDirection"),q1.prototype),J(q1.prototype,"horizontalDirection",[z1,U1],Object.getOwnPropertyDescriptor(q1.prototype,"horizontalDirection"),q1.prototype),J(q1.prototype,"constraint",[k1,G1,H1],Object.getOwnPropertyDescriptor(q1.prototype,"constraint"),q1.prototype),J(q1.prototype,"constraintNum",[V1,W1],Object.getOwnPropertyDescriptor(q1.prototype,"constraintNum"),q1.prototype),J(q1.prototype,"affectedByScale",[j1],Object.getOwnPropertyDescriptor(q1.prototype,"affectedByScale"),q1.prototype),Y1=J(q1.prototype,"_resizeMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f2.NONE}}),K1=J(q1.prototype,"_layoutType",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _2.NONE}}),Q1=J(q1.prototype,"_cellSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xi(40,40)}}),Z1=J(q1.prototype,"_startAxis",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p2.HORIZONTAL}}),J1=J(q1.prototype,"_paddingLeft",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$1=J(q1.prototype,"_paddingRight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e2=J(q1.prototype,"_paddingTop",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t2=J(q1.prototype,"_paddingBottom",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n2=J(q1.prototype,"_spacingX",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i2=J(q1.prototype,"_spacingY",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r2=J(q1.prototype,"_verticalDirection",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d2.TOP_TO_BOTTOM}}),o2=J(q1.prototype,"_horizontalDirection",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return m2.LEFT_TO_RIGHT}}),a2=J(q1.prototype,"_constraint",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return v2.NONE}}),s2=J(q1.prototype,"_constraintNum",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),c2=J(q1.prototype,"_affectedByScale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l2=J(q1.prototype,"_isAlign",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X1=q1))||X1)||X1)||X1)||X1)||X1)||X1));!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(G2||(G2={})),Ze(G2);var W2,j2,X2,q2,Y2,K2,Q2,Z2,J2,$2,e4,t4,n4,i4,r4,o4,a4,s4,c4,l4,u4,h4,_4,f4,p4,d4=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((y2=Zc("cc.ProgressBar"),S2=_l(),T2=$c(110),E2=cl(),x2=Jc(YV),A2=Pl(vY),b2=ml(),C2=Pl(G2),w2=ml(),R2=ml(),P2=vl(),I2=ml(),O2=ml(),y2(D2=S2(D2=T2(D2=E2(D2=x2((k2=U2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",M2,Y(t)),Z(t,"_mode",L2,Y(t)),Z(t,"_totalLength",B2,Y(t)),Z(t,"_progress",F2,Y(t)),Z(t,"_reverse",z2,Y(t)),t}H(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===vY.FillType.RADIAL&&(this._mode=G2.FILLED),this._mode===G2.HORIZONTAL?this.totalLength=r.width:this._mode===G2.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new mi(0,.5),a=On(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case G2.HORIZONTAL:this._reverse&&(o=new mi(1,.5)),c=new xi(s,i.height),l=this._totalLength,u=i.height;break;case G2.VERTICAL:o=this._reverse?new mi(.5,1):new mi(.5,0),c=new xi(i.width,s),l=i.width,u=this._totalLength}if(this._mode===G2.FILLED)this._barSprite.type!==vY.Type.FILLED?p("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==vY.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new Zn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else p("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},k(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===G2.HORIZONTAL?this.totalLength=n.width:this._mode===G2.VERTICAL?this.totalLength=n.height:this._mode===G2.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===G2.FILLED&&(e=On(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(qu),U2.Mode=G2,J((N2=k2).prototype,"barSprite",[A2,b2],Object.getOwnPropertyDescriptor(N2.prototype,"barSprite"),N2.prototype),J(N2.prototype,"mode",[C2,w2],Object.getOwnPropertyDescriptor(N2.prototype,"mode"),N2.prototype),J(N2.prototype,"totalLength",[R2],Object.getOwnPropertyDescriptor(N2.prototype,"totalLength"),N2.prototype),J(N2.prototype,"progress",[P2,Tl,I2],Object.getOwnPropertyDescriptor(N2.prototype,"progress"),N2.prototype),J(N2.prototype,"reverse",[O2],Object.getOwnPropertyDescriptor(N2.prototype,"reverse"),N2.prototype),M2=J(N2.prototype,"_barSprite",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L2=J(N2.prototype,"_mode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G2.HORIZONTAL}}),B2=J(N2.prototype,"_totalLength",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),F2=J(N2.prototype,"_progress",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),z2=J(N2.prototype,"_reverse",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D2=N2))||D2)||D2)||D2)||D2)||D2)),m4=new Zn,v4=new Zn,g4=new Zn,y4=new mi,S4=new Kn,T4=new mi;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(p4||(p4={})),et(p4);var E4,x4,A4,b4,C4,w4,R4,P4,I4,O4,D4,N4,M4,L4,B4,F4,z4,U4,k4,G4,H4,V4,W4,j4,X4,q4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,_3,f3,p3,d3,m3,v3=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((W2=Zc("cc.ScrollBar"),j2=_l(),X2=$c(110),q2=cl(),Y2=Jc(YV),K2=Pl(vY),Q2=El(),Z2=ml(),J2=Pl(p4),$2=El(),e4=ml(),t4=El(),n4=ml(),i4=El(),r4=ml(),W2(o4=j2(o4=X2(o4=q2(o4=Y2((f4=_4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",s4,Y(t)),Z(t,"_handle",c4,Y(t)),Z(t,"_direction",l4,Y(t)),Z(t,"_enableAutoHide",u4,Y(t)),Z(t,"_autoHideTime",h4,Y(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}H(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=T4;u.set(0,0),this._direction===p4.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===p4.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=T4;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(vY);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){m4.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(m4,v4);var r=n.convertToNodeSpaceAR(v4);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(mi.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(vY);t&&(S4.set(t.color),S4.a=e,t.color=S4),(t=this._handle.getComponent(vY))&&(S4.set(t.color),S4.a=e,t.color=S4)}},n._updateHandlerPosition=function(e){if(this._handle){var t=g4;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Zn.set(m4,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(m4,v4),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===p4.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===p4.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===p4.HORIZONTAL||e.height<=t.height&&this._direction===p4.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=On(c=r/s));var l=(i-a)*c;this._direction===p4.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===y4.x&&i.y===y4.y||t.setAnchorPoint(y4),this._direction===p4.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},k(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(mi.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(mi.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(qu),_4.Direction=p4,J((a4=f4).prototype,"handle",[K2,Q2,Z2],Object.getOwnPropertyDescriptor(a4.prototype,"handle"),a4.prototype),J(a4.prototype,"direction",[J2,$2,e4],Object.getOwnPropertyDescriptor(a4.prototype,"direction"),a4.prototype),J(a4.prototype,"enableAutoHide",[t4,n4],Object.getOwnPropertyDescriptor(a4.prototype,"enableAutoHide"),a4.prototype),J(a4.prototype,"autoHideTime",[i4,r4],Object.getOwnPropertyDescriptor(a4.prototype,"autoHideTime"),a4.prototype),s4=J(a4.prototype,"_scrollView",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c4=J(a4.prototype,"_handle",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l4=J(a4.prototype,"_direction",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p4.HORIZONTAL}}),u4=J(a4.prototype,"_enableAutoHide",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h4=J(a4.prototype,"_autoHideTime",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),o4=a4))||o4)||o4)||o4)||o4)||o4)),g3=e("ViewGroup",Zc("cc.ViewGroup")(E4=$c(110)(E4=function(e){function t(){return e.apply(this,arguments)||this}return H(t,e),t}(qu))||E4)||E4);i.ViewGroup=g3;var y3,S3=1e-4,T3=new Zn,E3=new Zn,x3=new mi,A3=new mi,b3=function(){return(new Date).getMilliseconds()},C3={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(y3||(y3={}));var w3,R3,P3,I3,O3,D3,N3,M3,L3,B3,F3,z3,U3,k3,G3,H3,V3,W3,j3,X3,q3,Y3,K3=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((x4=Zc("cc.ScrollView"),A4=_l(),b4=$c(110),C4=cl(),w4=Jc(YV),R4=vl(),P4=El(),I4=ml(),O4=vl(),D4=El(),N4=ml(),M4=El(),L4=ml(),B4=El(),F4=ml(),z4=Pl(qC),U4=El(),k4=ml(),G4=El(),H4=ml(),V4=Pl(v3),W4=El(),j4=ml(),X4=El(),q4=ml(),Y4=Pl(v3),K4=El(),Q4=ml(),Z4=El(),J4=ml(),$4=Pl([gL]),e3=El(),t3=ml(),x4(n3=A4(n3=b4(n3=C4(n3=w4((m3=d3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",r3,Y(t)),Z(t,"brake",o3,Y(t)),Z(t,"elastic",a3,Y(t)),Z(t,"inertia",s3,Y(t)),Z(t,"horizontal",c3,Y(t)),Z(t,"vertical",l3,Y(t)),Z(t,"cancelInnerEvents",u3,Y(t)),Z(t,"scrollEvents",h3,Y(t)),t._autoScrolling=!1,t._scrolling=!1,Z(t,"_content",_3,Y(t)),Z(t,"_horizontalScrollBar",f3,Y(t)),Z(t,"_verticalScrollBar",p3,Y(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Zn,t._autoScrollTargetDelta=new Zn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Zn,t._outOfBoundaryAmount=new Zn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Zn,t._deltaPos=new Zn,t}H(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new mi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new mi(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new mi(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return mi.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new mi(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new mi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new mi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new mi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<S3&&Math.abs(e.y-t.y)<S3||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Zn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return S3},n.start=function(){this._calculateBoundary(),this._content&&DD.once(OD.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(NA.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(NA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(NA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(NA.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(NA.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(NA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(NA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(NA.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(NA.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(NA.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(NA.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(NA.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(NA.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(NA.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(NA.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(NA.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(NA.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(NA.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new Zn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(x3);if(i.subtract(n.getUIStartLocation(A3)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new qO(e.getTouches(),e.bubbles,AA.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(y3.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(V2);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==du.CAPTURING_PHASE)return!1;if(t)for(var n,i=Q(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(g3));if(r.getComponent(g3))return!0}return!1},n._startInertiaScroll=function(e){var t=new Zn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Zn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Zn.ZERO,S3)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new Zn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(Zn.ZERO);else{var n=new Zn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);T3.set(this._getContentPosition()),T3.add(n),T3.set(Math.floor(1e4*T3.x)*S3,Math.floor(1e4*T3.y)*S3,T3.z),this._setContentPosition(T3);var i=this._getHowMuchOutOfBoundary();x3.set(i.x,i.y),this._updateScrollBar(x3),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new Zn).equals(Zn.ZERO,S3)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Zn;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(Zn.ZERO,S3)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===y3.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===y3.SCROLL_TO_TOP||e===y3.SCROLL_TO_BOTTOM||e===y3.SCROLL_TO_LEFT||e===y3.SCROLL_TO_RIGHT){var t=1<<C3[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}gL.emitEvents(this.scrollEvents,this,C3[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();T3.set(this._getContentPosition()),T3.add(e),this._content.setPosition(T3),this._updateScrollBar(mi.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===du.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(y3.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new Zn;n&&(t.getUILocation(x3),t.getUIPreviousLocation(A3),T3.set(x3.x,x3.y,0),E3.set(A3.x,A3.y,0),n.convertToNodeSpaceAR(T3,T3),n.convertToNodeSpaceAR(E3,E3),Zn.subtract(i,T3,E3)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n,i=e;if(this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t)),this._content){var r=this._content._uiProps.uiTransformComp,o=r.anchorX,a=r.anchorY,s=r.width,c=r.height,l=this._content.position||Zn.ZERO;i.y>0?l.y-a*c+i.y>=this._bottomBoundary&&(n=y3.SCROLL_TO_BOTTOM):i.y<0&&l.y-a*c+c+i.y<=this._topBoundary&&(n=y3.SCROLL_TO_TOP),i.x<0?l.x-o*s+s+i.x<=this._rightBoundary&&(n=y3.SCROLL_TO_RIGHT):i.x>0&&l.x-o*s+i.x>=this._leftBoundary&&(n=y3.SCROLL_TO_LEFT)}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(y3.SCROLL_BEGAN)),this._dispatchEvent(y3.SCROLLING)),n&&n.length>0&&this._dispatchEvent(n)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(y3.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=b3(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=b3();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(Zn.ZERO,S3))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(y3.BOUNCE_TOP),e.y<0&&this._dispatchEvent(y3.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(y3.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(y3.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(T3,S3)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Zn.ZERO,S3)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=S3;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(y3.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Zn.ZERO,S3)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(y3.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(y3.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(Zn.ZERO,S3))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(y3.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(y3.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(mi.ZERO,mi.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Zn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new Zn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===eg.SCALE&&this._calculateBoundary()},k(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):E(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(mi.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(mi.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(g3),d3.EventType=y3,r3=J((i3=m3).prototype,"bounceDuration",[il,R4,P4,I4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),o3=J(i3.prototype,"brake",[il,O4,D4,N4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),a3=J(i3.prototype,"elastic",[il,M4,L4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),s3=J(i3.prototype,"inertia",[il,B4,F4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J(i3.prototype,"content",[z4,U4,k4],Object.getOwnPropertyDescriptor(i3.prototype,"content"),i3.prototype),c3=J(i3.prototype,"horizontal",[il,G4,H4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J(i3.prototype,"horizontalScrollBar",[V4,W4,j4],Object.getOwnPropertyDescriptor(i3.prototype,"horizontalScrollBar"),i3.prototype),l3=J(i3.prototype,"vertical",[il,X4,q4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J(i3.prototype,"verticalScrollBar",[Y4,K4,Q4],Object.getOwnPropertyDescriptor(i3.prototype,"verticalScrollBar"),i3.prototype),u3=J(i3.prototype,"cancelInnerEvents",[il,Z4,J4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h3=J(i3.prototype,"scrollEvents",[$4,il,e3,t3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_3=J(i3.prototype,"_content",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f3=J(i3.prototype,"_horizontalScrollBar",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),p3=J(i3.prototype,"_verticalScrollBar",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n3=i3))||n3)||n3)||n3)||n3)||n3)),Q3=new Zn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Y3||(Y3={})),et(Y3);var Z3,J3,$3,e5,t5,n5,i5,r5,o5,a5,s5,c5,l5,u5,h5,_5,f5,p5,d5,m5,v5=function(t){return e({Slider:t,SliderComponent:t}),t}((w3=Zc("cc.Slider"),R3=_l(),P3=$c(110),I3=cl(),O3=Jc(YV),D3=Pl(vY),N3=ml(),M3=Pl(Y3),L3=ml(),B3=vl(),F3=ml(),z3=Pl([gL]),U3=ml(),w3(k3=R3(k3=P3(k3=I3(k3=O3((q3=X3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",H3,Y(t)),Z(t,"_handle",V3,Y(t)),Z(t,"_direction",W3,Y(t)),Z(t,"_progress",j3,Y(t)),t._offset=new Zn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new Zn,t._touchPos=new Zn,t}H(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(NA.TOUCH_START,this._onTouchBegan,this),this.node.on(NA.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(NA.TOUCH_END,this._onTouchEnded,this),this.node.on(NA.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(NA.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(NA.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(NA.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(NA.TOUCH_START,this._onTouchBegan,this),this.node.off(NA.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(NA.TOUCH_END,this._onTouchEnded,this),this.node.off(NA.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(NA.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(NA.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(NA.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Zn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Zn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){gL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();Zn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,Q3);this.direction===Y3.Horizontal?this.progress=On(.5+(i.x-this._offset.x)/n.width):this.progress=On(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===Y3.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===Y3.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},k(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(qu),X3.Direction=Y3,J((G3=q3).prototype,"handle",[D3,N3],Object.getOwnPropertyDescriptor(G3.prototype,"handle"),G3.prototype),J(G3.prototype,"direction",[M3,L3],Object.getOwnPropertyDescriptor(G3.prototype,"direction"),G3.prototype),J(G3.prototype,"progress",[Tl,B3,F3],Object.getOwnPropertyDescriptor(G3.prototype,"progress"),G3.prototype),H3=J(G3.prototype,"slideEvents",[z3,il,U3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),V3=J(G3.prototype,"_handle",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W3=J(G3.prototype,"_direction",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y3.Horizontal}}),j3=J(G3.prototype,"_progress",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),k3=G3))||k3)||k3)||k3)||k3)||k3));function g5(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}!function(e){e.TOGGLE="toggle"}(m5||(m5={}));var y5,S5,T5,E5,x5,A5,b5,C5,w5,R5,P5,I5,O5,D5,N5,M5,L5,B5,F5,z5,U5,k5,G5,H5,V5,W5,j5,X5,q5,Y5,K5,Q5,Z5,J5,$5,e8,t8,n8,i8,r8,o8,a8,s8,c8,l8,u8,h8,_8,f8,p8,d8,m8,v8,g8,y8,S8,T8,E8,x8,A8=function(t){return e({Toggle:t,ToggleComponent:t}),t}((Z3=Zc("cc.Toggle"),J3=_l(),$3=$c(110),e5=cl(),t5=Jc(YV),n5=El(),i5=ml(),r5=Pl(vY),o5=El(),a5=ml(),s5=Pl([gL]),c5=ml(),Z3(l5=J3(l5=$3(l5=e5(l5=t5((d5=p5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",h5,Y(t)),Z(t,"_isChecked",_5,Y(t)),Z(t,"_checkMark",f5,Y(t)),t}H(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&gL.emitEvents(this.checkEvents,this)},k(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return i.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(Q$),p5.EventType=g5(m5,j$),J((u5=d5).prototype,"isChecked",[n5,i5],Object.getOwnPropertyDescriptor(u5.prototype,"isChecked"),u5.prototype),J(u5.prototype,"checkMark",[r5,o5,a5],Object.getOwnPropertyDescriptor(u5.prototype,"checkMark"),u5.prototype),h5=J(u5.prototype,"checkEvents",[s5,il,c5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_5=J(u5.prototype,"_isChecked",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),f5=J(u5.prototype,"_checkMark",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l5=u5))||l5)||l5)||l5)||l5)||l5)),b8=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((y5=Zc("cc.ToggleContainer"),S5=_l(),T5=$c(110),E5=cl(),x5=ml(),A5=Pl([gL]),b5=ml(),y5(C5=S5(C5=T5(C5=E5(C5=sl((I5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",R5,Y(t)),Z(t,"checkEvents",P5,Y(t)),t}H(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(NA.CHILD_ADDED,this.ensureValidState,this),this.node.on(NA.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(NA.CHILD_ADDED,this.ensureValidState,this),this.node.off(NA.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var r=this.toggleItems[n];r!==e&&(t?r.isChecked=!1:r.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},k(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(qu),R5=J((w5=I5).prototype,"_allowSwitchOff",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),J(w5.prototype,"allowSwitchOff",[x5],Object.getOwnPropertyDescriptor(w5.prototype,"allowSwitchOff"),w5.prototype),P5=J(w5.prototype,"checkEvents",[A5,il,b5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),C5=w5))||C5)||C5)||C5)||C5)||C5)),C8=new mi;function w8(e){return e instanceof AI?hD:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:xi.ZERO}function R8(e,t,n,i){e.parent?C8.set(e.parent.getScale().x,e.parent.getScale().y):C8.set(0,0);for(var r=C8.x,o=C8.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?C8.set(c.getScale().x,c.getScale().y):C8.set(0,0);var u=C8.x,h=C8.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(E8||(E8={})),et(E8),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(x8||(x8={}));var P8,I8,O8,D8,N8,M8,L8,B8,F8,z8,U8,k8,G8,H8,V8,W8,j8,X8,q8,Y8=x8.TOP|x8.BOT,K8=x8.LEFT|x8.RIGHT,Q8=function(t){return e({Widget:t,WidgetComponent:t}),t}((O5=Zc("cc.Widget"),D5=_l(),N5=$c(110),M5=cl(),L5=Jc(YV),B5=Pl(qC),F5=ml(),z5=ml(),U5=ml(),k5=ml(),G5=ml(),H5=ml(),V5=ml(),W5=pl(),j5=pl(),X5=ml(),q5=ml(),Y5=ml(),K5=ml(),Q5=ml(),Z5=ml(),J5=Pl(E8),$5=ml(),O5(e8=D5(e8=N5(e8=M5(e8=L5(e8=sl((T8=S8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new Zn,t._lastSize=new xi,t._dirty=!0,t._hadAlignOnce=!1,Z(t,"_alignFlags",n8,Y(t)),Z(t,"_target",i8,Y(t)),Z(t,"_left",r8,Y(t)),Z(t,"_right",o8,Y(t)),Z(t,"_top",a8,Y(t)),Z(t,"_bottom",s8,Y(t)),Z(t,"_horizontalCenter",c8,Y(t)),Z(t,"_verticalCenter",l8,Y(t)),Z(t,"_isAbsLeft",u8,Y(t)),Z(t,"_isAbsRight",h8,Y(t)),Z(t,"_isAbsTop",_8,Y(t)),Z(t,"_isAbsBottom",f8,Y(t)),Z(t,"_isAbsHorizontalCenter",p8,Y(t)),Z(t,"_isAbsVerticalCenter",d8,Y(t)),Z(t,"_originalWidth",m8,Y(t)),Z(t,"_originalHeight",v8,Y(t)),Z(t,"_alignMode",g8,Y(t)),Z(t,"_lockFlags",y8,Y(t)),t}H(t,e);var n=t.prototype;return n.updateAlignment=function(){i._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(NA.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(NA.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(NA.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(NA.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(NA.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(NA.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(NA.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(NA.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:hD;this.isAlignLeft&&e===x8.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===x8.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===x8.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===x8.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===x8.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===x8.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(YV)&&(e.on(NA.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(NA.SIZE_CHANGED,this._setDirtyByMode,this),e.on(NA.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(NA.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(NA.SIZE_CHANGED,this._setDirtyByMode,this),e.off(NA.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(NA.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(NA.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===E8.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&K8)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},k(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&x8.TOP)>0},set:function(e){this._setAlign(x8.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&x8.BOT)>0},set:function(e){this._setAlign(x8.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&x8.LEFT)>0},set:function(e){this._setAlign(x8.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&x8.RIGHT)>0},set:function(e){this._setAlign(x8.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&x8.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=x8.MID):this._alignFlags&=~x8.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&x8.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=x8.CENTER):this._alignFlags&=~x8.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&K8)===K8}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Y8)===Y8}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(x8.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(x8.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(x8.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(x8.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(x8.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(x8.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(qu),S8.AlignMode=E8,J((t8=T8).prototype,"target",[B5,F5],Object.getOwnPropertyDescriptor(t8.prototype,"target"),t8.prototype),J(t8.prototype,"isAlignTop",[z5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignTop"),t8.prototype),J(t8.prototype,"isAlignBottom",[U5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignBottom"),t8.prototype),J(t8.prototype,"isAlignLeft",[k5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignLeft"),t8.prototype),J(t8.prototype,"isAlignRight",[G5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignRight"),t8.prototype),J(t8.prototype,"isAlignVerticalCenter",[H5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignVerticalCenter"),t8.prototype),J(t8.prototype,"isAlignHorizontalCenter",[V5],Object.getOwnPropertyDescriptor(t8.prototype,"isAlignHorizontalCenter"),t8.prototype),J(t8.prototype,"isStretchWidth",[W5],Object.getOwnPropertyDescriptor(t8.prototype,"isStretchWidth"),t8.prototype),J(t8.prototype,"isStretchHeight",[j5],Object.getOwnPropertyDescriptor(t8.prototype,"isStretchHeight"),t8.prototype),J(t8.prototype,"top",[X5],Object.getOwnPropertyDescriptor(t8.prototype,"top"),t8.prototype),J(t8.prototype,"editorTop",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorTop"),t8.prototype),J(t8.prototype,"bottom",[q5],Object.getOwnPropertyDescriptor(t8.prototype,"bottom"),t8.prototype),J(t8.prototype,"editorBottom",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorBottom"),t8.prototype),J(t8.prototype,"left",[Y5],Object.getOwnPropertyDescriptor(t8.prototype,"left"),t8.prototype),J(t8.prototype,"editorLeft",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorLeft"),t8.prototype),J(t8.prototype,"right",[K5],Object.getOwnPropertyDescriptor(t8.prototype,"right"),t8.prototype),J(t8.prototype,"editorRight",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorRight"),t8.prototype),J(t8.prototype,"horizontalCenter",[Q5],Object.getOwnPropertyDescriptor(t8.prototype,"horizontalCenter"),t8.prototype),J(t8.prototype,"editorHorizontalCenter",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorHorizontalCenter"),t8.prototype),J(t8.prototype,"verticalCenter",[Z5],Object.getOwnPropertyDescriptor(t8.prototype,"verticalCenter"),t8.prototype),J(t8.prototype,"editorVerticalCenter",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"editorVerticalCenter"),t8.prototype),J(t8.prototype,"isAbsoluteTop",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteTop"),t8.prototype),J(t8.prototype,"isAbsoluteBottom",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteBottom"),t8.prototype),J(t8.prototype,"isAbsoluteLeft",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteLeft"),t8.prototype),J(t8.prototype,"isAbsoluteRight",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteRight"),t8.prototype),J(t8.prototype,"isAbsoluteHorizontalCenter",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteHorizontalCenter"),t8.prototype),J(t8.prototype,"isAbsoluteVerticalCenter",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"isAbsoluteVerticalCenter"),t8.prototype),J(t8.prototype,"alignMode",[J5,$5],Object.getOwnPropertyDescriptor(t8.prototype,"alignMode"),t8.prototype),J(t8.prototype,"alignFlags",[fl],Object.getOwnPropertyDescriptor(t8.prototype,"alignFlags"),t8.prototype),n8=J(t8.prototype,"_alignFlags",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i8=J(t8.prototype,"_target",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r8=J(t8.prototype,"_left",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o8=J(t8.prototype,"_right",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a8=J(t8.prototype,"_top",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s8=J(t8.prototype,"_bottom",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c8=J(t8.prototype,"_horizontalCenter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l8=J(t8.prototype,"_verticalCenter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u8=J(t8.prototype,"_isAbsLeft",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h8=J(t8.prototype,"_isAbsRight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_8=J(t8.prototype,"_isAbsTop",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),f8=J(t8.prototype,"_isAbsBottom",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p8=J(t8.prototype,"_isAbsHorizontalCenter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),d8=J(t8.prototype,"_isAbsVerticalCenter",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m8=J(t8.prototype,"_originalWidth",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v8=J(t8.prototype,"_originalHeight",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g8=J(t8.prototype,"_alignMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return E8.ON_WINDOW_RESIZE}}),y8=J(t8.prototype,"_lockFlags",[il,rl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e8=t8))||e8)||e8)||e8)||e8)||e8)||e8));i.internal.computeInverseTransForTarget=R8,i.internal.getReadonlyNodeSize=w8;var Z8,J8=new Kn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Z8||(Z8={})),et(Z8);var $8,e6,t6,n6,i6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,p6,d6,m6,v6,g6,y6,S6,T6,E6,x6,A6,b6,C6,w6,R6,P6,I6,O6,D6,N6,M6,L6,B6,F6,z6,U6,k6,G6,H6,V6,W6=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((P8=Zc("cc.PageViewIndicator"),I8=_l(),O8=$c(110),D8=cl(),N8=Pl(RH),M8=ml(),L8=Pl(Z8),B8=ml(),F8=Pl(xi),z8=ml(),U8=ml(),P8(k8=I8(k8=O8(k8=D8((q8=X8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"spacing",H8,Y(t)),Z(t,"_spriteFrame",V8,Y(t)),Z(t,"_direction",W8,Y(t)),Z(t,"_cellSize",j8,Y(t)),t._layout=null,t._pageView=null,t._indicators=[],t}H(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(V2),this._layout||(this._layout=this.addComponent(V2));var e=this._layout;this.direction===Z8.HORIZONTAL?(e.type=V2.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Z8.VERTICAL&&(e.type=V2.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=V2.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new qC;e.layer=this.node.layer;var t=e.addComponent(vY);return t.spriteFrame=this.spriteFrame,t.sizeMode=vY.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;J8.set(r.color),J8.a=127.5,r.color=J8}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;J8.set(o.color),J8.a=255,o.color=J8}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},k(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(qu),X8.Direction=Z8,J((G8=q8).prototype,"spriteFrame",[N8,M8],Object.getOwnPropertyDescriptor(G8.prototype,"spriteFrame"),G8.prototype),J(G8.prototype,"direction",[L8,B8],Object.getOwnPropertyDescriptor(G8.prototype,"direction"),G8.prototype),J(G8.prototype,"cellSize",[F8,z8],Object.getOwnPropertyDescriptor(G8.prototype,"cellSize"),G8.prototype),H8=J(G8.prototype,"spacing",[il,U8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V8=J(G8.prototype,"_spriteFrame",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W8=J(G8.prototype,"_direction",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.HORIZONTAL}}),j8=J(G8.prototype,"_cellSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xi(20,20)}}),k8=G8))||k8)||k8)||k8)||k8)),j6=new mi;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(G6||(G6={})),et(G6),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(H6||(H6={})),et(H6),function(e){e.PAGE_TURNING="page-turning"}(V6||(V6={}));var X6=function(t){return e({PageView:t,PageViewComponent:t}),t}(($8=Zc("cc.PageView"),e6=_l(),t6=$c(110),n6=cl(),i6=Pl(G6),r6=ml(),o6=Pl(H6),a6=ml(),s6=vl(),c6=ml(),l6=vl(),u6=ml(),h6=Pl(W6),_6=ml(),f6=ml(),p6=Pl(v3),d6=pl(),m6=Pl(v3),v6=pl(),g6=pl(),y6=pl(),S6=pl(),T6=Pl([gL]),E6=pl(),x6=Pl([gL]),A6=ml(),$8(b6=e6(b6=t6(b6=n6((k6=U6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",w6,Y(t)),Z(t,"horizontal",R6,Y(t)),Z(t,"vertical",P6,Y(t)),Z(t,"cancelInnerEvents",I6,Y(t)),Z(t,"scrollEvents",O6,Y(t)),Z(t,"pageTurningSpeed",D6,Y(t)),Z(t,"pageEvents",N6,Y(t)),Z(t,"_sizeMode",M6,Y(t)),Z(t,"_direction",L6,Y(t)),Z(t,"_scrollThreshold",B6,Y(t)),Z(t,"_pageTurningEventTiming",F6,Y(t)),Z(t,"_indicator",z6,Y(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Zn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new mi,t._touchEndPosition=new mi,t}H(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(NA.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(NA.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):E(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void E(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):A(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(V2);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===H6.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===G6.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(j6),mi.set(this._touchBeganPosition,j6.x,j6.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(j6),mi.set(this._touchEndPosition,j6.x,j6.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(j6),mi.set(this._touchEndPosition,j6.x,j6.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===H6.Horizontal,this.vertical=this.direction===H6.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(V2);if(t){if(this._sizeMode===G6.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===H6.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===H6.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,gL.emitEvents(this.pageEvents,this,V6.PAGE_TURNING),this.node.emit(V6.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===H6.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===H6.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new mi;if(this._sizeMode===G6.Free)this.direction===H6.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===H6.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===H6.Horizontal?t.x=e*n.width:this.direction===H6.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===H6.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===G6.Free){var i=0,r=0;if(this.direction===H6.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===H6.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===H6.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===H6.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new mi;mi.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},k(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(K3),U6.SizeMode=G6,U6.Direction=H6,U6.EventType=g5(V6,y3),J((C6=k6).prototype,"sizeMode",[i6,r6],Object.getOwnPropertyDescriptor(C6.prototype,"sizeMode"),C6.prototype),J(C6.prototype,"direction",[o6,a6],Object.getOwnPropertyDescriptor(C6.prototype,"direction"),C6.prototype),J(C6.prototype,"scrollThreshold",[Tl,s6,c6],Object.getOwnPropertyDescriptor(C6.prototype,"scrollThreshold"),C6.prototype),J(C6.prototype,"pageTurningEventTiming",[Tl,l6,u6],Object.getOwnPropertyDescriptor(C6.prototype,"pageTurningEventTiming"),C6.prototype),J(C6.prototype,"indicator",[h6,_6],Object.getOwnPropertyDescriptor(C6.prototype,"indicator"),C6.prototype),w6=J(C6.prototype,"autoPageTurningThreshold",[il,f6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),J(C6.prototype,"verticalScrollBar",[p6,Ul,d6],Object.getOwnPropertyDescriptor(C6.prototype,"verticalScrollBar"),C6.prototype),J(C6.prototype,"horizontalScrollBar",[m6,Ul,v6],Object.getOwnPropertyDescriptor(C6.prototype,"horizontalScrollBar"),C6.prototype),R6=J(C6.prototype,"horizontal",[Ul,il,g6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),P6=J(C6.prototype,"vertical",[Ul,il,y6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I6=J(C6.prototype,"cancelInnerEvents",[Ul,il,S6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O6=J(C6.prototype,"scrollEvents",[T6,il,Ul,E6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),D6=J(C6.prototype,"pageTurningSpeed",[il,fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),N6=J(C6.prototype,"pageEvents",[x6,il,A6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M6=J(C6.prototype,"_sizeMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G6.Unified}}),L6=J(C6.prototype,"_direction",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return H6.Horizontal}}),B6=J(C6.prototype,"_scrollThreshold",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),F6=J(C6.prototype,"_pageTurningEventTiming",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),z6=J(C6.prototype,"_indicator",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b6=C6))||b6)||b6)||b6)||b6)),q6=new Zn,Y6=new mi,K6=new mi,Q6=new mi(1,1),Z6=new mi,J6=new mi;function $6(e,t){if(!t._hadAlignOnce){t.alignMode===E8.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=K6,o=Q6;i?R8(e,n=i,r,o):n=e.parent;var a=w8(n),s=n instanceof AI||!n.getComponent(YV),c=s?Y6:n.getComponent(YV).anchorPoint,l=s;e.getPosition(q6);var u=e._uiProps.uiTransformComp,h=q6.x,_=q6.y,f=u.anchorPoint,p=e.getScale();if(t.alignFlags&x8.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=hD.left.x,m=hD.right.x):m=(d=-c.x*v)+v,d+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,S=p.x;if(S<0&&(y=1-y,S=-S),t.isStretchWidth)g=m-d,0!==S&&(u.width=g/S),h=d+y*g;else if(g=u.width*S,t.isAlignHorizontalCenter){var T=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,E=(.5-c.x)*a.width;i&&(T*=o.x,E+=r.x,E*=o.x),h=E+(y-.5)*g+T}else h=t.isAlignLeft?d+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&x8.VERTICAL){var x=0,A=0,b=a.height;l?(A=hD.bottom.y,x=hD.top.y):x=(A=-c.y*b)+b,A+=t.isAbsoluteBottom?t.bottom:t.bottom*b,x-=t.isAbsoluteTop?t.top:t.top*b,i&&(A+=r.y,A*=o.y,x+=r.y,x*=o.y);var C=0,w=f.y,R=p.y;if(R<0&&(w=1-w,R=-R),t.isStretchHeight)C=x-A,0!==R&&(u.height=C/R),_=A+w*C;else if(C=u.height*R,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*b,I=(.5-c.y)*a.height;i&&(P*=o.y,I+=r.y,I*=o.y),_=I+(w-.5)*C+P}else _=t.isAlignBottom?A+w*C:x+(w-1)*C;t._lastSize.height=C}e.setPosition(h,_,q6.z),Zn.set(t._lastPos,h,_,q6.z)}}function e7(e){var t=e.getComponent(Q8);if(t&&t.enabled){if(!i.isValid(e,!0))return;i7.push(t)}for(var n,r=Q(e.children);!(n=r()).done;){var o=n.value;o.active&&e7(o)}}function t7(){var e=DD.getScene();if(e){r7.isAligning=!0,r7._nodesOrderDirty&&(i7.length=0,e7(e),r7._nodesOrderDirty=!1);var t=null,n=r7._activeWidgetsIterator;for(n.i=0;n.i<i7.length;++n.i)(t=i7[n.i])._dirty&&($6(t.node,t),t._dirty=!1);r7.isAligning=!1}}var n7,i7=[],r7=e("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ye.MutableForwardIterator(i7),animationState:null,init:function(){DD.on(OD.EVENT_AFTER_SCENE_LAUNCH,t7),DD.on(OD.EVENT_AFTER_UPDATE,t7),dD.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);dD.instance.on("canvas-resize",e),Ii.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=DD.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=qC.isNode(e)&&e.getComponent(Q8);t&&t.enabled&&(t.alignMode===E8.ON_WINDOW_RESIZE||t.alignMode===E8.ALWAYS)&&t.setDirty();for(var n,i=Q(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=Z6;o.set(0,0);var a=J6;if(a.set(1,1),e.target&&R8(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Y6,l=i._uiProps.uiTransformComp,u=w8(r),h=l.anchorPoint,_=i.getPosition(),f=x8,p=i.getScale(),d=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=_.x-h.x*l.width*p.x-m,e.isAbsoluteLeft||(d/=u.width),d/=a.x,e.left=n(e.left,d)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(_.x+(1-h.x)*l.width*p.x),e.isAbsoluteRight||(d/=u.width),d/=a.x,e.right=n(e.right,d)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(_.y+(1-h.y)*l.height*p.y),e.isAbsoluteTop||(d/=u.height),d/=a.y,e.top=n(e.top,d)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=_.y-h.y*l.height*p.y-y,e.isAbsoluteBottom||(d/=u.height),d/=a.y,e.bottom=n(e.bottom,d)}}},updateAlignment:function e(t){var n=t.parent;n&&qC.isNode(n)&&e(n);var i=t.getComponent(Q8);i&&n&&$6(t,i)},AlignMode:E8,AlignFlags:x8});DD.on(OD.EVENT_INIT,(function(){r7.init()}));var o7,a7,s7,c7,l7,u7,h7,_7,f7,p7,d7,m7,v7,g7,y7,S7,T7,E7,x7,A7,b7=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Zc("cc.SafeArea")(n7=_l()(n7=$c(110)(n7=sl(n7=cl()(n7=Jc(Q8)(n7=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),Ii.on("window-resize",this.updateArea,this),Ii.on("orientation-change",this.updateArea,this)},n.onDisable=function(){Ii.off("window-resize",this.updateArea,this),Ii.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(Q8),t=this.node.getComponent(YV);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=yD.getVisibleSize(),o=r.width,a=r.height,s=Ni.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),r7.add(e)}},t}(qu))||n7)||n7)||n7)||n7)||n7)||n7),C7=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((o7=Zc("cc.UICoordinateTracker"),a7=_l(),s7=cl(),c7=$c(110),l7=Pl(qC),u7=ml(),h7=Pl(FL),_7=ml(),f7=ml(),p7=ml(),d7=Pl([gL]),m7=ml(),o7(v7=a7(v7=s7(v7=c7((J((g7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",y7,Y(t)),Z(t,"_target",S7,Y(t)),Z(t,"_camera",T7,Y(t)),Z(t,"_useScale",E7,Y(t)),Z(t,"_distance",x7,Y(t)),t._transformPos=new Zn,t._viewPos=new Zn,t._canMove=!0,t._lastWPos=new Zn,t._lastCameraPos=new Zn,t}H(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&Zn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);gL.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},k(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(qu)).prototype,"target",[l7,u7],Object.getOwnPropertyDescriptor(g7.prototype,"target"),g7.prototype),J(g7.prototype,"camera",[h7,_7],Object.getOwnPropertyDescriptor(g7.prototype,"camera"),g7.prototype),J(g7.prototype,"useScale",[f7],Object.getOwnPropertyDescriptor(g7.prototype,"useScale"),g7.prototype),J(g7.prototype,"distance",[p7],Object.getOwnPropertyDescriptor(g7.prototype,"distance"),g7.prototype),y7=J(g7.prototype,"syncEvents",[d7,il,m7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S7=J(g7.prototype,"_target",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T7=J(g7.prototype,"_camera",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E7=J(g7.prototype,"_useScale",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x7=J(g7.prototype,"_distance",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),v7=g7))||v7)||v7)||v7)||v7)),w7=[NA.TOUCH_START,NA.TOUCH_END,NA.TOUCH_MOVE,NA.MOUSE_DOWN,NA.MOUSE_MOVE,NA.MOUSE_UP,NA.MOUSE_ENTER,NA.MOUSE_LEAVE,NA.MOUSE_WHEEL];function R7(e){e.propagationStopped=!0}var P7,I7,O7,D7,N7,M7,L7,B7,F7,z7,U7,k7,G7=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Zc("cc.BlockInputEvents")(A7=_l()(A7=cl()(A7=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<w7.length;e++)this.node.on(w7[e],R7,this)},n.onDisable=function(){for(var e=0;e<w7.length;e++)this.node.off(w7[e],R7,this)},t}(qu))||A7)||A7)||A7),H7={},V7=e("SubContextView",(P7=Zc("cc.SubContextView"),I7=_l(),O7=$c(110),D7=Jc(YV),N7=cl(),M7=ml(),L7=ml(),P7(B7=I7(B7=O7(B7=D7(B7=N7((J((F7=function(e){function t(){var t;return Z(t=e.call(this)||this,"_fps",z7,Y(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,Z(t,"_designResolutionSize",U7,Y(t)),t._content=new qC("content"),t._content.hideFlags|=Zt.Flags.DontSave|Zt.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new vm,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new av,t}H(t,e);var n=t.prototype;return n.onLoad=function(){H7.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=H7.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(vY),this._sprite||(this._sprite=this._content.addComponent(vY)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new RH;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(YV),t=this._content.getComponent(YV),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=yD.getViewportRect(),a=t.getBoundingBoxToWorld(),s=yD.getVisibleSize(),c=yD.getDevicePixelRatio(),l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(NA.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(NA.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(NA.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(NA.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(NA.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(NA.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},k(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(qu)).prototype,"designResolutionSize",[M7],Object.getOwnPropertyDescriptor(F7.prototype,"designResolutionSize"),F7.prototype),J(F7.prototype,"fps",[L7],Object.getOwnPropertyDescriptor(F7.prototype,"fps"),F7.prototype),z7=J(F7.prototype,"_fps",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),U7=J(F7.prototype,"_designResolutionSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xi(640,960)}}),B7=F7))||B7)||B7)||B7)||B7)||B7));i.SubContextView=V7;var W7=e("UIReorderComponent",Zc("cc.UIReorderComponent")(k7=function(){A(1408,"UIReorderComponent")})||k7);i.UIReorderComponent=W7,i.ButtonComponent=Q$,Ke.setClassAlias(Q$,"cc.ButtonComponent"),i.EditBoxComponent=g2,Ke.setClassAlias(g2,"cc.EditBoxComponent"),i.LayoutComponent=V2,Ke.setClassAlias(V2,"cc.LayoutComponent"),i.ProgressBarComponent=d4,Ke.setClassAlias(d4,"cc.ProgressBarComponent"),i.ScrollViewComponent=K3,Ke.setClassAlias(K3,"cc.ScrollViewComponent"),i.ScrollBarComponent=v3,Ke.setClassAlias(v3,"cc.ScrollBarComponent"),i.SliderComponent=v5,Ke.setClassAlias(v5,"cc.SliderComponent"),i.ToggleComponent=A8,Ke.setClassAlias(A8,"cc.ToggleComponent"),i.ToggleContainerComponent=b8,Ke.setClassAlias(b8,"cc.ToggleContainerComponent"),i.WidgetComponent=Q8,Ke.setClassAlias(Q8,"cc.WidgetComponent"),i.PageViewComponent=X6,Ke.setClassAlias(X6,"cc.PageViewComponent"),i.PageViewIndicatorComponent=W6,Ke.setClassAlias(W6,"cc.PageViewIndicatorComponent"),i.SafeAreaComponent=b7,Ke.setClassAlias(b7,"cc.SafeAreaComponent"),Ke.setClassAlias(C7,"cc.UICoordinateTrackerComponent"),i.BlockInputEventsComponent=G7,Ke.setClassAlias(G7,"cc.BlockInputEventsComponent");var j7,X7,q7,Y7,K7,Q7=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),Z7=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>gd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new $7(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new J7(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(ro.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(ro.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(ro.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=Q(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),J7=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,i9(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=n9(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=Q(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new t9(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=Q(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case ro.ATTR_POSITION:a=Ed;break;case ro.ATTR_NORMAL:a=bd;break;case ro.ATTR_TANGENT:a=Rd;break;default:p("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(gd.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),$7=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];i9(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new e9(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},k(e,[{key:"data",get:function(){return this._attributes}}]),e}(),e9=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new t9(n,0);var i=n9(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=Q(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case ro.ATTR_POSITION:r=Ed;break;case ro.ATTR_NORMAL:r=bd;break;case ro.ATTR_TANGENT:r=Rd;break;default:p("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(gd.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),t9=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(gd.SIZE)),this._remoteBuffer=e.createBuffer(new yo(Ar.UNIFORM|Ar.TRANSFER_DST,wr.HOST|wr.DEVICE,gd.SIZE,gd.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(gd.OFFSET_OF_WEIGHTS+4*t,e[t],i.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(gd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,i.sys.isLittleEndian),this._localBuffer.setFloat32(gd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,i.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(gd.OFFSET_OF_VERTICES_COUNT,e,i.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},k(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function n9(e,t){var n,i,r,o;e.hasFeature(Sr.TEXTURE_FLOAT)?(n=t,r=16,i=av.PixelFormat.RGBA32F,o=Float32Array):(n=4*t,r=4,i=av.PixelFormat.RGBA8888,o=Uint8Array);var a=function(e){e<5&&(e=5);var t=hn(fn(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var t=new ArrayBuffer(s*c*r),n=new Float32Array(t),a=o===Float32Array?n:new o(t),l=new vm({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new av;u.setFilters(av.Filter.NEAREST,av.Filter.NEAREST),u.setMipFilter(av.Filter.NONE),u.setWrapMode(av.WrapMode.CLAMP_TO_EDGE,av.WrapMode.CLAMP_TO_EDGE,av.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||p("Unexpected: failed to create morph texture?");var h=Lm.getSampler(e,u.getSamplerHash());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}function i9(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function r9(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var o9=new Zn,a9=new Zn,s9=new Uint8Array,c9=Zc("cc.Mesh")((K7=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,Z(t,"_struct",q7,Y(t)),Z(t,"_hash",Y7,Y(t)),t._data=s9,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}H(t,e);var n=t.prototype;return n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=i.director.root.device,n=this._createVertexBuffers(t,e),r=[],o=0;o<this._struct.primitives.length;o++){var a=this._struct.primitives[o];if(0!==a.vertexBundelIndices.length){var s=null,c=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!t.hasFeature(Sr.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){A(10001,_,65536);continue}u>>=1,h>>=1}s=t.createBuffer(new yo(Ar.INDEX,wr.DEVICE,h,u)),c=new(r9(l.stride))(e,l.offset,l.count),l.stride!==u&&(c=r9(u).from(c)),s.update(c)}var f=a.vertexBundelIndices.map((function(e){return n[e]})),p=[];if(a.vertexBundelIndices.length>0)for(var d=a.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Bo(g.name,g.format,g.isInstanced,g.stream,g.isInstanced,g.location)}var y=new Iw(f,p,a.primitiveMode,s);y.mesh=this,y.subMeshIdx=o,r.push(y)}}this._renderingSubMeshes=r,this._struct.morph&&(this.morphRendering=function(e,t){return new Z7(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Rc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,ro.ATTR_JOINTS),c=this.readAttribute(a,ro.ATTR_WEIGHTS),l=this.readAttribute(a,ro.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Zn.set(o9,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,p=s[f];if(!(0===c[f]||p>=i.length)){Zn.transformMat4(a9,o9,i[p]),n[p]=!0;var d=t[p];Zn.min(d.center,d.center,a9),Zn.max(d.halfExtents,d.halfExtents,a9)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Rc.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new Zn,r=t&&new ri,o=t&&new Rc;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(Zn.add(o.center,a.maxPosition,a.minPosition),Zn.multiplyScalar(o.center,o.center,.5),Zn.subtract(o.halfExtents,a.maxPosition,a.minPosition),Zn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Rc.transform(o,o,t),Zn.add(a.maxPosition,o.center,o.halfExtents),Zn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===ro.ATTR_POSITION||l.attributes[u].name===ro.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+l9(l.attributes,u)),f=_9(_,h),p=f9(_,h);if(!f||!p)continue;for(var d=l.view.count,m=l.view.stride,v=h9(h),g=0;g<d;g++){var y=g*m,S=y+v,T=S+v;switch(i.set(f(y),f(S),f(T)),l.attributes[u].name){case ro.ATTR_POSITION:i.transformMat4(t);break;case ro.ATTR_NORMAL:Zn.transformQuat(i,i,r)}p(y,i.x),p(S,i.y),p(T,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var E,x,A,b,C,w=new Q7,R=0,P=0,I=0,O=0,D=0,N=0,M=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=e._struct.vertexBundles[z];I=U.view.offset,O=k.view.offset,P=U.view.stride,R=U.view.count+k.view.count,E=new ArrayBuffer(R*P),x=new Uint8Array(E),I+=(A=this._data.subarray(I,I+U.view.length)).length,O+=(b=e._data.subarray(O,O+k.view.length)).length,x.set(A),D=0;for(var G,H=Q(U.attributes);!(G=H()).done;){var V=G.value;M=0,B=!1;for(var W,j=Q(k.attributes);!(W=j()).done;){var X=W.value;if(V.name===X.name&&V.format===X.format){B=!0;break}M+=aa[X.format].size}if(B){L=aa[V.format].size,N=U.view.length+D;for(var q=0;q<k.view.count;++q){if(C=b.subarray(M,M+L),x.set(C,N),(V.name===ro.ATTR_POSITION||V.name===ro.ATTR_NORMAL)&&t){var Y=new Float32Array(x.buffer,N,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case ro.ATTR_POSITION:i.transformMat4(t);break;case ro.ATTR_NORMAL:Zn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}N+=U.view.stride,M+=k.view.stride}}D+=aa[V.format].size}F[z]={attributes:U.attributes,view:{offset:w.getLength(),length:E.byteLength,count:R,stride:P}},w.addBuffer(E)}for(var K,Z,J,$=0,ee=2,te=0,ne=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var re=this._struct.primitives[ie],oe=e._struct.primitives[ie];ne[ie]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var ae,se=Q(re.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;te=Math.max(te,this._struct.vertexBundles[ce].view.count)}if(re.indexView&&oe.indexView){$=re.indexView.count,$+=oe.indexView.count,I=re.indexView.offset,O=oe.indexView.offset,ee=$<256?1:$<65536?2:4;var le=new ArrayBuffer($*ee);if(K=2===ee?new Uint16Array(le):1===ee?new Uint8Array(le):new Uint32Array(le),Z=2===re.indexView.stride?new Uint16Array(this._data.buffer,I,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,I,re.indexView.count):new Uint32Array(this._data.buffer,I,re.indexView.count),ee===re.indexView.stride)K.set(Z);else for(var ue=0;ue<re.indexView.count;++ue)K[ue]=Z[ue];I+=re.indexView.length,J=2===oe.indexView.stride?new Uint16Array(e._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,O,oe.indexView.count):new Uint32Array(e._data.buffer,O,oe.indexView.count);for(var he=0;he<oe.indexView.count;++he)K[re.indexView.count+he]=te+J[he];O+=oe.indexView.length,ne[ie].indexView={offset:w.getLength(),length:le.byteLength,count:$,stride:ee},w.setNextAlignment(ee),w.addBuffer(le)}}var _e={vertexBundles:F,primitives:ne,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(Zn.add(o.center,e._struct.maxPosition,e._struct.minPosition),Zn.multiplyScalar(o.center,o.center,.5),Zn.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),Zn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Rc.transform(o,o,t),Zn.add(i,o.center,o.halfExtents),Zn.max(_e.maxPosition,_e.maxPosition,i),Zn.subtract(i,o.center,o.halfExtents),Zn.min(_e.minPosition,_e.minPosition,i)):(Zn.min(_e.minPosition,_e.minPosition,e._struct.minPosition),Zn.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=da(aa[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+l9(e.attributes,t)),c=aa[o],l=_9(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=e.view.stride,f=0;f<r;++f)for(var p=0;p<u;++p)h[u*f+p]=l(_*f+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+l9(e.attributes,t)),u=new DataView(n,r),h=aa[c],_=_9(l,c),f=f9(u,c);if(_&&f){for(var p=h.count,d=e.view.stride,m=h9(c),v=i,g=m,y=0;y<s;++y)for(var S=0;S<p;++S)f(v*y+g*S,_(d*y+m*S));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?Tr.R8UI:2===n.indexView.stride?Tr.R16UI:Tr.R32UI,o=_9(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+aa[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=Q(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new yo(Ar.VERTEX,wr.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:s9})},n.validate=function(){return this.renderingSubMeshes.length>0&&this.data.byteLength>0},k(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=xa(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(Cu),q7=J((X7=K7).prototype,"_struct",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Y7=J(X7.prototype,"_hash",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j7=X7))||j7;function l9(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=aa[r.format].size}return n}i.Mesh=c9;var u9=Ni.isLittleEndian;function h9(e){var t=aa[e];return t.size/t.count}function _9(e,t){var n=aa[t],i=n.size/n.count;switch(n.type){case Er.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,u9)};case 4:return function(t){return e.getUint32(t,u9)}}break;case Er.SNORM:case Er.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,u9)};case 4:return function(t){return e.getInt32(t,u9)}}break;case Er.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,u9)};case 4:return function(t){return e.getUint32(t,u9)}}break;case Er.FLOAT:return function(t){return e.getFloat32(t,u9)}}return null}function f9(e,t){var n=aa[t],i=n.size/n.count;switch(n.type){case Er.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,u9)};case 4:return function(t,n){return e.setUint32(t,n,u9)}}break;case Er.SNORM:case Er.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,u9)};case 4:return function(t,n){return e.setInt32(t,n,u9)}}break;case Er.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,u9)};case 4:return function(t,n){return e.setUint32(t,n,u9)}}break;case Er.FLOAT:return function(t,n){return e.setFloat32(t,n,u9)}}return null}var p9,d9,m9,v9,g9,y9,S9,T9,E9,x9,A9,b9,C9,w9,R9,P9,I9,O9,D9,N9,M9,L9,B9,F9,z9,U9,k9,G9,H9,V9,W9,j9,X9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}H(t,e);var n=t.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):null},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(ig),q9=Ze({OFF:0,ON:1}),Y9=Ze({OFF:0,ON:1}),K9=(p9=Zc("cc.ModelLightmapSettings"),d9=tl(ol({formerlySerializedAs:"_recieveShadow"})),p9((A9=function(){function e(){Z(this,"texture",g9,this),Z(this,"uvParam",y9,this),Z(this,"_bakeable",S9,this),Z(this,"_castShadow",T9,this),Z(this,"_receiveShadow",E9,this),Z(this,"_lightmapSize",x9,this)}return k(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),g9=J((v9=A9).prototype,"texture",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y9=J(v9.prototype,"uvParam",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Si}}),S9=J(v9.prototype,"_bakeable",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T9=J(v9.prototype,"_castShadow",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E9=J(v9.prototype,"_receiveShadow",[d9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x9=J(v9.prototype,"_lightmapSize",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),J(v9.prototype,"bakeable",[fl],Object.getOwnPropertyDescriptor(v9.prototype,"bakeable"),v9.prototype),J(v9.prototype,"castShadow",[fl],Object.getOwnPropertyDescriptor(v9.prototype,"castShadow"),v9.prototype),J(v9.prototype,"receiveShadow",[fl],Object.getOwnPropertyDescriptor(v9.prototype,"receiveShadow"),v9.prototype),J(v9.prototype,"lightmapSize",[fl],Object.getOwnPropertyDescriptor(v9.prototype,"lightmapSize"),v9.prototype),m9=v9))||m9),Q9=(b9=Zc("cc.MeshRenderer"),C9=_l(),w9=$c(100),R9=cl(),P9=Pl(q9),I9=ml(),O9=Pl(Y9),D9=ml(),N9=Pl(c9),M9=ml(),L9=pl(),b9(B9=C9(B9=w9(B9=R9(B9=sl((W9=V9=function(e){function t(){var t;return Z(t=e.call(this)||this,"lightmapSettings",z9,Y(t)),Z(t,"_mesh",U9,Y(t)),Z(t,"_shadowCastingMode",k9,Y(t)),Z(t,"_shadowReceivingMode",G9,Y(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,Z(t,"_enableMorph",H9,Y(t)),t._modelType=ig,t}H(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===ig?X9:this._modelType,t=this._model=i.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof X9&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=eg.POSITION,this._model.transform.hasChangedFlags|=eg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return Gv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===q9.OFF?this._model.castShadow=!1:(this._shadowCastingMode,q9.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===Y9.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof X9&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},k(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(qL),V9.ShadowCastingMode=q9,V9.ShadowReceivingMode=Y9,z9=J((F9=W9).prototype,"lightmapSettings",[il,fl,Al],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K9}}),U9=J(F9.prototype,"_mesh",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k9=J(F9.prototype,"_shadowCastingMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q9.OFF}}),G9=J(F9.prototype,"_shadowReceivingMode",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y9.ON}}),J(F9.prototype,"shadowCastingMode",[P9,I9,Al],Object.getOwnPropertyDescriptor(F9.prototype,"shadowCastingMode"),F9.prototype),J(F9.prototype,"receiveShadow",[O9,D9,Al],Object.getOwnPropertyDescriptor(F9.prototype,"receiveShadow"),F9.prototype),J(F9.prototype,"mesh",[N9,M9],Object.getOwnPropertyDescriptor(F9.prototype,"mesh"),F9.prototype),J(F9.prototype,"enableMorph",[L9,Al],Object.getOwnPropertyDescriptor(F9.prototype,"enableMorph"),F9.prototype),H9=J(F9.prototype,"_enableMorph",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),B9=F9))||B9)||B9)||B9)||B9)||B9);!function(e){e[e.positions=ro.ATTR_POSITION]="positions",e[e.normals=ro.ATTR_NORMAL]="normals",e[e.uvs=ro.ATTR_TEX_COORD]="uvs",e[e.colors=ro.ATTR_COLOR]="colors"}(j9||(j9={}));var Z9,J9,$9,eee,tee,nee=[new Bo(ro.ATTR_POSITION,Tr.RGB32F),new Bo(ro.ATTR_NORMAL,Tr.RGB32F),new Bo(ro.ATTR_TEX_COORD,Tr.RG32F),new Bo(ro.ATTR_TANGENT,Tr.RGBA32F),new Bo(ro.ATTR_COLOR,Tr.RGBA32F)],iee=new Zn,ree=function(){function e(e,t,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=n}var t=e.prototype;return t.sample=function(e){this._average(this._value,e)},t.human=function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},t.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},t._average=function(e,t){if(void 0===t&&(t=0),this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},k(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),oee=Zc("cc.PerfCounter")(Z9=function(e){function t(t,n,i){var r;return(r=e.call(this,t,n,i)||this)._time=void 0,r._time=i,r}H(t,e);var n=t.prototype;return n.start=function(e){void 0===e&&(e=0),this._time=e},n.end=function(e){void 0===e&&(e=0),this._value=e-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))},t}(ree))||Z9,aee="0123456789. ",see=500,cee={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},lee={fps:{desc:"Framerate (FPS)",below:30,average:see,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:see},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:see,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:see},render:{desc:"Renderer (ms)",min:0,max:50,average:see,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},uee=e("Profiler",function(){function e(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new po,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(lee).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var t=e.prototype;return t.isShowingStats=function(){return this._showFPS},t.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),i.game.off(i.Game.EVENT_RESTART,this.generateNode,this),i.director.off(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.off(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.off(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.off(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.off(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.off(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,i.game.config.showFPS=!1)},t.showStats=function(){this._showFPS||(this._device||(this._device=i.director.root.device),this.generateCanvas(),this.generateStats(),i.game.once(i.Game.EVENT_ENGINE_INITED,this.generateNode,this),i.game.on(i.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),i.director.on(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.on(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.on(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.on(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.on(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.on(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,i.game.config.showFPS=!0)},t.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Ao(Rr.TEX2D,Pr.SAMPLED|Pr.TRANSFER_DST,Tr.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},t.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in lee){var i=lee[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new oee(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<aee.length;++r){var o=this._ctx.measureText(aee[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<aee.length;++a)this._ctx.fillText(aee[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=lee,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},t.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new qC("PROFILER_NODE"),i.game.addPersistRootNode(this._rootNode);var e=new qC("Profiler_Camera");e.setPosition(0,0,1.5),e.parent=this._rootNode;var t=e.addComponent("cc.Camera");t.projection=FL.ProjectionType.ORTHO,t.orthoHeight=1,t.near=1,t.far=2,t.visibility=Sp.BitMask.PROFILER,t.clearFlags=eo.NONE,t.priority=4294967295;var n=new qC("Profiler_Root");n.parent=this._rootNode;for(var r=.4,o=r/this._totalLines,a=r/this._wordHeight,s=o/23,c=this._eachNumWidth*this._canvas.width*s,l=[0,r,0,a,r,0,a,0,0,0,0,0],u=[0,2,1,0,3,2],h=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],_=0,f=0;f<this._totalLines;f++)for(var p=0;p<8;p++){l.push(a+p*c,r-f*o,0),l.push(a+(p+1)*c,r-f*o,0),l.push(a+(p+1)*c,r-(f+1)*o,0),l.push(a+p*c,r-(f+1)*o,0),_=4*(8*f+p+1),u.push(0+_,2+_,1+_,0+_,3+_,2+_);var d=8*f+p,m=Math.floor(d/4),v=d-4*m;h.push(0,this._wordHeight,m,v),h.push(this._eachNumWidth,this._wordHeight,m,v),h.push(this._eachNumWidth,1,m,v),h.push(0,1,m,v)}var g=n.addComponent(Q9);g.mesh=function(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=Q(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===ro.ATTR_POSITION){i=h;break}}i||(i=nee[0]),r.push(i);var _=aa[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,p=Q(e.attributes);!(f=p()).done;){var d=f.value;if(d.name===ro.ATTR_NORMAL){i=d;break}}i||(i=nee[1]);var m=aa[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=Q(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===ro.ATTR_TEX_COORD){i=y;break}}i||(i=nee[2]);var S=aa[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var T,E=Q(e.attributes);!(T=E()).done;){var x=T.value;if(x.name===ro.ATTR_TANGENT){i=x;break}}i||(i=nee[3]);var A=aa[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/A.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=A.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var b,C=Q(e.attributes);!(b=C()).done;){var w=b.value;if(w.name===ro.ATTR_COLOR){i=w;break}}i||(i=nee[4]);var R=aa[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/R.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=R.size}if(e.customAttributes)for(var P,I=Q(e.customAttributes);!(P=I()).done;){var O=P.value,D=aa[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/D.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=D.size}for(var N=new Q7,M=new ArrayBuffer(s*o),L=new DataView(M),B=0,F=a;B<F.length;B++){var z=F[B];Rw(L,z.data,z.attribute.format,z.offset,o)}N.setNextAlignment(0);var U={attributes:r,view:{offset:N.getLength(),length:M.byteLength,count:s,stride:o}};N.addBuffer(M);var k=null,G=0;if(e.indices){var H=e.indices;G=H.length,k=new ArrayBuffer(2*G),Rw(new DataView(k),H,Tr.R16UI)}var V={primitiveMode:e.primitiveMode||jr.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(N.setNextAlignment(2),V.indexView={offset:N.getLength(),length:k.byteLength,count:G,stride:2},N.addBuffer(k));var W=e.minPos;if(!W&&n.calculateBounds){W=Zn.set(new Zn,1/0,1/0,1/0);for(var j=0;j<s;++j)Zn.set(iee,c[3*j+0],c[3*j+1],c[3*j+2]),Zn.min(W,W,iee)}var X=e.maxPos;if(!X&&n.calculateBounds){X=Zn.set(new Zn,-1/0,-1/0,-1/0);for(var q=0;q<s;++q)Zn.set(iee,c[3*q+0],c[3*q+1],c[3*q+2]),Zn.max(X,X,iee)}var Y={vertexBundles:[U],primitives:[V]};return W&&(Y.minPosition=new Zn(W.x,W.y,W.z)),X&&(Y.maxPosition=new Zn(X.x,X.y,X.z)),t||(t=new c9),t.reset({struct:Y,data:new Uint8Array(N.getCombined())}),t}({positions:l,indices:u,colors:h});var y=new Ag;y.initialize({effectName:"profiler"});var S=this.pass=y.passes[0],T=S.getBinding("mainTexture"),E=S.getBinding("digits"),x=S.getBinding("offset");S.bindTexture(T,this._texture),this.digitsData=S.blocks[E],this.offsetData=S.blocks[x],this.offsetData[3]=-1,g.material=y,g.node.layer=Sp.Enum.PROFILER,this._inited=!0}},t.beforeUpdate=function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}},t.afterUpdate=function(){if(this._stats){var e=performance.now();i.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}},t.beforePhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}},t.afterPhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}},t.beforeDraw=function(){if(this._stats){var e=this._device.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=hi[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0);var r=performance.now();this._stats.render.counter.start(r)}},t.afterDraw=function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<see)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(e);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=cee[l];void 0===u&&(u=11),i[c]=u}n++}}}},e}()),hee=e("profiler",new uee);i.profiler=hee;var _ee=e("VideoClip",Zc("cc.VideoClip")((tee=function(e){function t(){var t;return Z(t=e.call(this)||this,"_duration",eee,Y(t)),t._video=null,t}return H(t,e),k(t,[{key:"_nativeAsset",get:function(){return this._video},set:function(e){this._video=e,this._duration=e?e.duration:0}}]),t}(Cu),eee=J(($9=tee).prototype,"_duration",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J9=$9))||J9);function fee(e,t,n){var i=document.createElement("video"),r=document.createElement("source");i.appendChild(r);var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status||0===this.status?(r.src=URL.createObjectURL(this.response),n(null,i)):n(new Error(o.status+"(no response)"))},o.onerror=function(){var t="load video failure - "+e;f(t),n(new Error(t))},o.send()}function pee(e,t,n,i){var r=new _ee;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}fN.register({".mp4":fee,".avi":fee,".mov":fee,".mpg":fee,".mpeg":fee,".rm":fee,".rmvb":fee}),SN.register({".mp4":pee,".avi":pee,".mov":pee,".mpg":pee,".mpeg":pee,".rm":pee,".rmvb":pee});var dee,mee,vee=Ze({REMOTE:0,LOCAL:1});!function(e){e.NONE="none",e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped",e.COMPLETED="completed",e.META_LOADED="meta-loaded",e.READY_TO_PLAY="ready-to-play",e.ERROR="error",e.CLICKED="clicked"}(dee||(dee={})),function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(mee||(mee={}));var gee=function(){function e(e){var t=this;this._componentEventList=new Map,this._state=dee.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=e,this._node=e.node,this._uiTrans=e.node.getComponent(YV),this._onHide=function(){t.video&&t._state===dee.PLAYING&&(t.video.pause(),t._interrupted=!0)},this._onShow=function(){t._interrupted&&t.video&&(t.video.play(),t._interrupted=!1)},i.game.on(i.Game.EVENT_HIDE,this._onHide),i.game.on(i.Game.EVENT_SHOW,this._onShow)}var t=e.prototype;return t.onLoadedMetadata=function(e){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(dee.META_LOADED);var t=e.target;this._keepAspectRatio&&t&&this.syncUITransform(t.videoWidth,t.videoHeight),this.delayedFullScreen(),this.delayedPlay()},t.onCanPlay=function(){this._loaded=!0,this.dispatchEvent(dee.READY_TO_PLAY)},t.onPlay=function(){this._playing=!0,this.dispatchEvent(dee.PLAYING)},t.onPlaying=function(){this.dispatchEvent(dee.PLAYING)},t.onPause=function(){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(dee.PAUSED))},t.onStoped=function(){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(dee.STOPPED)},t.onEnded=function(){this.dispatchEvent(dee.COMPLETED)},t.onClick=function(){this.dispatchEvent(dee.CLICKED)},t.onError=function(e){this.dispatchEvent(dee.ERROR);var t=e.target;t&&t.error&&d("Error "+t.error.code+"; details: "+t.error.message)},t.play=function(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0},t.delayedPlay=function(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)},t.syncFullScreenOnAwake=function(e){this._fullScreenOnAwake=e,this._loadedMeta||this._loaded?this.canFullScreen(e):this._waitingFullscreen=!0},t.delayedFullScreen=function(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)},t.dispatchEvent=function(e){var t=this._componentEventList.get(e);t&&(this._state=e,t.call(this))},t.syncUITransform=function(e,t){this._uiTrans&&(this._uiTrans.width=e,this._uiTrans.height=t)},t.syncCurrentTime=function(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)},t.destroy=function(){this.removeVideoPlayer(),this._componentEventList.clear(),i.game.off(i.Game.EVENT_HIDE,this._onHide),i.game.off(i.Game.EVENT_SHOW,this._onShow)},k(e,[{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"video",get:function(){return this._video}},{key:"state",get:function(){return this._state}},{key:"isPlaying",get:function(){return this._playing}},{key:"UICamera",get:function(){return DD.root.batcher2D.getFirstRenderCamera(this._node)}}]),e}();i.internal.VideoPlayerImpl=gee;var yee,See,Tee,Eee,xee,Aee,bee,Cee,wee,Ree,Pee,Iee,Oee,Dee,Nee,Mee,Lee,Bee,Fee,zee,Uee,kee,Gee,Hee,Vee,Wee,jee,Xee,qee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,nte,ite,rte=-Math.pow(2,15),ote=di(),ate=function(e){function t(t){var n;return(n=e.call(this,t)||this)._eventList=new Map,n._clearColorA=-1,n._clearFlag=void 0,n}H(t,e);var n=t.prototype;return n.addListener=function(e,t){this._video&&(this._eventList.set(e,t),this._video.addEventListener(e,t))},n.removeAllListeners=function(){var e=this;this._eventList.forEach((function(t,n){e._video&&e._video.removeEventListener(n,t)})),this._eventList.clear()},n.canPlay=function(){var e=this;if(this.video){var t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((function(){})).then((function(){e.syncCurrentTime()}))}},n.pause=function(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)},n.resume=function(){this.play()},n.stop=function(){var e=this;this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((function(){e._ignorePause=!1,e.dispatchEvent(dee.STOPPED)}),0))},n.syncClip=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e.nativeUrl)},n.syncURL=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e)},n.syncPlaybackRate=function(e){Ni.browserType!==N.UC?this.video&&(this.video.playbackRate=e):p("playbackRate is not supported by the uc mobile browser.")},n.syncVolume=function(e){this.video&&(this.video.volume=e)},n.syncMute=function(e){this.video&&(this.video.muted=e)},n.syncLoop=function(e){this.video&&(this.video.loop=e)},n.getDuration=function(){return this.video?this.video.duration:0},n.getCurrentTime=function(){return this.video?this.video.currentTime:-1},n.seekTo=function(e){this.video&&(this.video.currentTime=e)},n.canFullScreen=function(e){var t=this,n=this._video;if(n&&n.readyState===mee.HAVE_ENOUGH_DATA)return Ni.os===B.IOS&&Ni.isBrowser?(e?n.webkitEnterFullscreen&&n.webkitEnterFullscreen():n.webkitExitFullscreen&&n.webkitExitFullscreen(),void(this._fullScreenOnAwake=n.webkitDisplayingFullscreen)):fD.supportsFullScreen?void(e?(Ni.browserType===N.IE&&(n.style.transform=""),n.setAttribute("x5-video-player-fullscreen","true"),fD.requestFullScreen(n,(function(e){var i=Ni.browserType===N.IE?e.msFullscreenElement:e.fullscreenElement;t._fullScreenOnAwake=i===n}),(function(){t._fullScreenOnAwake=!1}))):(n.removeAttribute("x5-video-player-fullscreen"),fD.exitFullScreen())):(this._fullScreenOnAwake=e,this._forceUpdate=!0,void this.syncMatrix())},n.syncStayOnBottom=function(e){this._video&&(this._video.style["z-index"]=e?rte:0,this._stayOnBottom=e),this._dirty=!0},n.syncKeepAspectRatio=function(e){this._keepAspectRatio=e,e&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)},n.removeVideoPlayer=function(){var e=this._video;e&&ut(uD.container,e)&&(uD.container.removeChild(e),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null},n.createVideoPlayer=function(e){var t=this._video=document.createElement("video");t.className="cocosVideo",t.style.visibility="hidden",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style["transform-origin"]="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",t.setAttribute("preload","auto"),t.setAttribute("webkit-playsinline",""),t.setAttribute("x5-playsinline",""),t.setAttribute("playsinline",""),this._bindDomEvent(),uD.container.appendChild(t);var n=document.createElement("source");t.appendChild(n),n.src=e},n._bindDomEvent=function(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))},n.onCanPlay=function(t){var n=t.target;if(!this._loaded||!n)switch(n.readyState){case mee.HAVE_METADATA:case mee.HAVE_ENOUGH_DATA:e.prototype.onCanPlay.call(this,t)}},n.enable=function(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}},n.disable=function(e){if(this._video){if(!e&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}},n.syncMatrix=function(){if(this._video&&this._visible&&this._component){var e=this.UICamera;if(e&&!fD.fullScreen()){this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=e.clearColor.w,this._clearFlag=e.clearFlag,e.clearColor.w=0,e.clearFlag=eo.ALL):this._clearFlag&&(e.clearColor.w=this._clearColorA,e.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(ote),e.update(!0),e.worldMatrixToScreen(ote,ote,uD.canvas.width,uD.canvas.height);var t=0,n=0;if(this._fullScreenOnAwake?(t=hD.width,n=hD.height):(t=this._uiTrans.contentSize.width,n=this._uiTrans.contentSize.height),this._forceUpdate||this._m00!==ote.m00||this._m01!==ote.m01||this._m04!==ote.m04||this._m05!==ote.m05||this._m12!==ote.m12||this._m13!==ote.m13||this._w!==t||this._h!==n){this._m00=ote.m00,this._m01=ote.m01,this._m04=ote.m04,this._m05=ote.m05,this._m12=ote.m12,this._m13=ote.m13,this._w=t,this._h=n;var i=yD.getDevicePixelRatio(),r=1/i,o=1/i,a=uD.container,s=ote.m00*r,c=ote.m01,l=ote.m04,u=ote.m05*o;this._video.style.width=this._w+"px",this._video.style.height=this._h+"px",Ni.browserType!==N.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":p("keepAspectRatio is not supported by the qq mobile browser.");var h=this._w*r,_=this._h*o,f=this._uiTrans.anchorPoint,d=f.x,m=f.y,v=h*ote.m00*d,g=_*ote.m05*m,y=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,S=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0,T="matrix("+s+","+-c+","+-l+","+u+","+(ote.m12*r-v+y)+","+-(ote.m13*o-g+S)+")";this._video.style.transform=T,this._video.style["-webkit-transform"]=T,Ni.browserType!==N.IE&&(this._forceUpdate=!1)}}}},t}(gee),ste=function(){function e(){}return e.getImpl=function(e){return new ate(e)},e}();i.internal.VideoPlayerImplManager=ste;var cte=e("VideoPlayer",(yee=Zc("cc.VideoPlayer"),See=_l(),Tee=cl(),Eee=Jc(YV),xee=Pl(_ee),Aee=Pl(vee),bee=ml(),Cee=ml(),wee=Pl(_ee),Ree=ml(),Pee=ml(),Iee=vl(),Oee=ml(),Dee=vl(),Nee=ml(),Mee=ml(),Lee=ml(),Bee=ml(),Fee=ml(),zee=ml(),Uee=Pl([gL]),kee=El(),Gee=ml(),yee(Hee=See(Hee=Tee(Hee=Eee(Hee=sl((ite=nte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return Z(t=e.call.apply(e,[this].concat(i))||this,"_resourceType",Wee,Y(t)),Z(t,"_remoteURL",jee,Y(t)),Z(t,"_clip",Xee,Y(t)),Z(t,"_playOnAwake",qee,Y(t)),Z(t,"_volume",Yee,Y(t)),Z(t,"_mute",Kee,Y(t)),Z(t,"_playbackRate",Qee,Y(t)),Z(t,"_loop",Zee,Y(t)),Z(t,"_fullScreenOnAwake",Jee,Y(t)),Z(t,"_stayOnBottom",$ee,Y(t)),Z(t,"_keepAspectRatio",ete,Y(t)),t._impl=null,t._cachedCurrentTime=0,Z(t,"videoPlayerEvent",tte,Y(t)),t}H(t,e);var n=t.prototype;return n.syncSource=function(){this._impl&&(this._resourceType===vee.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))},n.__preload=function(){this._impl=ste.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(dee.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(dee.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(dee.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(dee.PAUSED,this.onPasued.bind(this)),this._impl.componentEventList.set(dee.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(dee.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(dee.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},n.onMetaLoaded=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.META_LOADED),this.node.emit("meta-loaded",this)},n.onReadyToPlay=function(){this._playOnAwake&&!this.isPlaying&&this.play(),gL.emitEvents(this.videoPlayerEvent,this,dee.READY_TO_PLAY),this.node.emit(dee.READY_TO_PLAY,this)},n.onPlaying=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.PLAYING),this.node.emit(dee.PLAYING,this)},n.onPasued=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.PAUSED),this.node.emit(dee.PAUSED,this)},n.onStopped=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.STOPPED),this.node.emit(dee.STOPPED,this)},n.onCompleted=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.COMPLETED),this.node.emit(dee.COMPLETED,this)},n.onError=function(){gL.emitEvents(this.videoPlayerEvent,this,dee.ERROR),this.node.emit(dee.ERROR,this)},n.play=function(){this._impl&&this._impl.play()},n.resume=function(){this._impl&&this._impl.resume()},n.pause=function(){this._impl&&this._impl.pause()},n.stop=function(){this._impl&&this._impl.stop()},k(t,[{key:"resourceType",get:function(){return this._resourceType},set:function(e){this._resourceType!==e&&(this._resourceType=e,this.syncSource())}},{key:"remoteURL",get:function(){return this._remoteURL},set:function(e){this._remoteURL!==e&&(this._remoteURL=e,this.syncSource())}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.syncSource())}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"playbackRate",get:function(){return this._playbackRate},set:function(e){this._playbackRate=e,this._impl&&this._impl.syncPlaybackRate(e)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._impl&&this._impl.syncVolume(e)}},{key:"mute",get:function(){return this._mute},set:function(e){this._mute=e,this._impl&&this._impl.syncMute(e)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._impl&&this._impl.syncLoop(e)}},{key:"keepAspectRatio",get:function(){return this._keepAspectRatio},set:function(e){this._keepAspectRatio!==e&&(this._keepAspectRatio=e,this._impl&&this._impl.syncKeepAspectRatio(e))}},{key:"fullScreenOnAwake",get:function(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake},set:function(e){this._fullScreenOnAwake!==e&&(this._fullScreenOnAwake=e,this._impl&&this._impl.syncFullScreenOnAwake(e))}},{key:"stayOnBottom",get:function(){return this._stayOnBottom},set:function(e){this._stayOnBottom!==e&&(this._stayOnBottom=e,this._impl&&this._impl.syncStayOnBottom(e))}},{key:"nativeVideo",get:function(){return this._impl&&this._impl.video||null}},{key:"currentTime",get:function(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime},set:function(e){Number.isNaN(e)?p("illegal video time! value:"+e):(e=In(e,0,this.duration),this._cachedCurrentTime=e,this._impl&&this._impl.seekTo(e))}},{key:"duration",get:function(){return this._impl?this._impl.getDuration():0}},{key:"state",get:function(){return this._impl?this._impl.state:dee.NONE}},{key:"isPlaying",get:function(){return!!this._impl&&this._impl.isPlaying}}]),t}(qu),nte.EventType=dee,nte.ResourceType=vee,Wee=J((Vee=ite).prototype,"_resourceType",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vee.LOCAL}}),jee=J(Vee.prototype,"_remoteURL",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xee=J(Vee.prototype,"_clip",[xee,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qee=J(Vee.prototype,"_playOnAwake",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yee=J(Vee.prototype,"_volume",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Kee=J(Vee.prototype,"_mute",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qee=J(Vee.prototype,"_playbackRate",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Zee=J(Vee.prototype,"_loop",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jee=J(Vee.prototype,"_fullScreenOnAwake",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$ee=J(Vee.prototype,"_stayOnBottom",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ete=J(Vee.prototype,"_keepAspectRatio",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J(Vee.prototype,"resourceType",[Aee,bee],Object.getOwnPropertyDescriptor(Vee.prototype,"resourceType"),Vee.prototype),J(Vee.prototype,"remoteURL",[Cee],Object.getOwnPropertyDescriptor(Vee.prototype,"remoteURL"),Vee.prototype),J(Vee.prototype,"clip",[wee,Ree],Object.getOwnPropertyDescriptor(Vee.prototype,"clip"),Vee.prototype),J(Vee.prototype,"playOnAwake",[Pee],Object.getOwnPropertyDescriptor(Vee.prototype,"playOnAwake"),Vee.prototype),J(Vee.prototype,"playbackRate",[Tl,Iee,Oee],Object.getOwnPropertyDescriptor(Vee.prototype,"playbackRate"),Vee.prototype),J(Vee.prototype,"volume",[Tl,Dee,Nee],Object.getOwnPropertyDescriptor(Vee.prototype,"volume"),Vee.prototype),J(Vee.prototype,"mute",[Mee],Object.getOwnPropertyDescriptor(Vee.prototype,"mute"),Vee.prototype),J(Vee.prototype,"loop",[Lee],Object.getOwnPropertyDescriptor(Vee.prototype,"loop"),Vee.prototype),J(Vee.prototype,"keepAspectRatio",[Bee],Object.getOwnPropertyDescriptor(Vee.prototype,"keepAspectRatio"),Vee.prototype),J(Vee.prototype,"fullScreenOnAwake",[Fee],Object.getOwnPropertyDescriptor(Vee.prototype,"fullScreenOnAwake"),Vee.prototype),J(Vee.prototype,"stayOnBottom",[zee],Object.getOwnPropertyDescriptor(Vee.prototype,"stayOnBottom"),Vee.prototype),tte=J(Vee.prototype,"videoPlayerEvent",[il,Uee,kee,Gee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hee=Vee))||Hee)||Hee)||Hee)||Hee)||Hee));i.internal.VideoPlayer=cte;var lte=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){E(1006)},t.update=function(){E(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return E(1008),null},t.retain=function(){},t.release=function(){},e}();lte.TAG_INVALID=-1;var ute=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}H(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(lte),hte=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}H(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(C(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){lte.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),lte.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(lte),0),_te=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},fte=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new _te),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+hte++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else C(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t.removeActionByTag=function(e,t){var n=this;e===lte.TAG_INVALID&&E(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.getActionByTag=function(e,t){e===lte.TAG_INVALID&&E(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}E(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){i.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof Zt&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),pte=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new fte,t}return H(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},k(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(ED));pte.ID="TWEEN",pte.instance=void 0,DD.on(OD.EVENT_INIT,(function(){var e=new pte;pte.instance=e,DD.registerSystem(pte.ID,e,ED.Priority.MEDIUM)}));var dte=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(ute),mte=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(qL),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new vte},n.clone=function(){return new t},t}(dte),vte=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(qL),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new mte},n.clone=function(){return new t},t}(dte);!function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(qL),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(dte);var gte=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}H(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(dte),yte=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}H(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(dte),Ste=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}H(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?nt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){lte.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return E(1010),this},n.setAmplitudeRate=function(){E(1011)},n.getAmplitudeRate=function(){return E(1012),0},n.speed=function(e){return e<=0?(E(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(E(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(ute),Tte=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return C(1019),Y(i);var o=r.length-1;if(o>=0&&null==r[o]&&E(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}H(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return C(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){Ste.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),lte.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(Ste);function Ete(e){var t=e instanceof Array?e:arguments;if(1===t.length)return C(1019),null;var n=t.length-1;n>=0&&null==t[n]&&E(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=Tte._actionOneTwo(i,t[r]))}return i}Tte._actionOneTwo=function(e,t){var n=new Tte;return n.initWithTwoActions(e,t),n};var xte=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}H(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof dte&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Ste.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),lte.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Ste),Ate=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}H(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(C(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){Ste.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Ste),bte=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return C(1020),Y(i);var o=r.length-1;if(o>=0&&null==r[o]&&E(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}H(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return C(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=Tte._actionOneTwo(t,Rte(i-r)):i<r&&(this._one=Tte._actionOneTwo(e,Rte(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){Ste.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),lte.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(Ste);function Cte(e){var t=e instanceof Array?e:arguments;if(1===t.length)return C(1020),null;t.length>0&&null==t[t.length-1]&&E(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=bte._actionOneTwo(n,t[i]));return n}bte._actionOneTwo=function(e,t){var n=new bte;return n.initWithTwoActions(e,t),n};var wte=function(e){function t(){return e.apply(this,arguments)||this}H(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(Ste);function Rte(e){return new wte(e)}var Pte=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}H(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(C(1029),!1):!!Ste.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(C(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){Ste.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),lte.prototype.stop.call(this)},t}(Ste),Ite=function(e){function t(t,n,i){var o;if((o=e.call(this)||this)._opts=void 0,o._props=void 0,o._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+r,i=e;i.delay&&p(t+"delay"+n),i.repeat&&p(t+"repeat"+n),i.repeatDelay&&p(t+"repeatDelay"+n),i.interpolation&&p(t+"interpolation"+n),i.onStop&&p(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=o.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=k_[a],i.easing||A(1031,a)}for(var s in o._opts=i,o._props=Object.create(null),n)if(n.hasOwnProperty(s)){var c=n[s];if("function"==typeof c&&(c=c()),null!=c&&"string"!=typeof c){var l=void 0,u=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=k_[c.easing])||A(1031,c.easing):l=c.easing,u=c.progress,c=c.value);var h=Object.create(null);h.value=c,h.easing=l,h.progress=u,o._props[s]=h}}return o._originProps=n,o.initWithDuration(t),o}H(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){Ste.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(Ste),Ote=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}H(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(dte),Dte=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=lte.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof lte?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&pte.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),pte.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(p("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&pte.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return Nte(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new Ite(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new Ite(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new Ote(e);return this._actions.push(t),this},t.delay=function(e){var t=Rte(e);return this._actions.push(t),this},t.call=function(e){var t=new yte(e,undefined,undefined);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t==1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new xte(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Ate(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Pte(e)}(n)),this},t.hide=function(){var e=new vte;return this._actions.push(e),this},t.show=function(){var e=new mte;return this._actions.push(e),this},t.removeSelf=function(){var e=new gte(!1);return this._actions.push(e),this},e.stopAll=function(){pte.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){pte.instance.ActionManager.removeActionByTag(e,t)},e.stopAllByTarget=function(e){pte.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:Ete(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Ete.apply(Ete,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Cte.apply(Cte,t)},e}());function Nte(e){return new Dte(e)}function Mte(e){return p("tweenUtil' is deprecated, please use 'tween' instead "),new Dte(e)}Dte._tmp_args=[],i.Tween=Dte,i.tween=Nte,i.tweenUtil=Mte}}}));
